(function(){var d=0;var Y=96/72;var A=0.25;var ai=4;var z=YAHOO.util.Dom,P=YAHOO.util.Event,ab=YAHOO.util.Element;var e=Alfresco.util.encodeHTML;Alfresco.WebPreview.prototype.Plugins.PdfJs=function(aF,aE){this.pages=[];this.pageText=[];this.widgets={};this.documentConfig={};this.wp=aF;this.wp.id=aF.id;this.attributes=YAHOO.lang.merge(Alfresco.util.deepCopy(this.attributes),aE);this.onPdfLoaded=new YAHOO.util.CustomEvent("pdfLoaded",this);this.onResize=new YAHOO.util.CustomEvent("resize",this);return this};Alfresco.WebPreview.prototype.Plugins.PdfJs.prototype={attributes:{src:null,srcMaxSize:"",skipbrowsertest:"false",defaultScale:"auto",scaleDelta:"1.1",autoMinScale:"0.65",autoMinScaleMobile:"0.525",autoMaxScale:"1.25",pageLayout:"multi",disableTextLayer:"false",useLocalStorage:"true",autoSearch:"false",progressiveLoading:"false",disabledPageLinking:true},pdfDocument:null,pageNum:1,pages:[],pageText:[],numPages:0,widgets:{},maximized:false,documentConfig:{},inDashlet:false,workerSrc:"",currentScaleSelection:null,report:function h(){var aE=true,aG=this.attributes.skipbrowsertest==="true",aF=this.attributes.srcMaxSize;if(aF.match(/^\d+$/)&&this.wp.options.size>parseInt(aF)){return this.wp.msg("PdfJs.tooLargeFile",Alfresco.util.formatFileSize(this.wp.options.size),parseInt(aF))}if(!aG){if(this._isCanvasSupported()){if(YAHOO.env.ua.webkit>0&&YAHOO.env.ua.webkit<534){aE=false}if(YAHOO.env.ua.ie>0&&YAHOO.env.ua.ie<10){aE=false}if(YAHOO.env.ua.gecko>0&&YAHOO.env.ua.gecko<5){aE=false}}else{aE=false}}if(!aE){return this.wp.msg("label.browserReport","&lt;canvas&gt; element")}},_isCanvasSupported:function n(){var aE=document.createElement("canvas");return !!(aE.getContext&&aE.getContext("2d"))},display:function X(){this.inDashlet=z.getAncestorByClassName(this.wp.getPreviewerElement(),"body")!=null||z.getAncestorByClassName(this.wp.getPreviewerElement(),"yui-panel")!=null;Alfresco.util.YUILoaderHelper.require(["tabview"],this.onComponentsLoaded,this);Alfresco.util.YUILoaderHelper.loadComponents();this.wp.getPreviewerElement().innerHTML="";return null},onComponentsLoaded:function f(){this.workerSrc=Alfresco.constants.URL_CONTEXT+"res/components/preview/pdfjs/pdf.worker"+(Alfresco.constants.DEBUG?".js":"-min.js");var aE=document.getElementsByTagName("script");for(var aH=0,aG=aE.length;aH<aG;aH++){if(aE[aH].src.indexOf("components/preview/pdfjs/pdf.worker_")>-1){this.workerSrc=aE[aH].src;break}}this._loadDocumentConfig();this.attributes.disabledPageLinking=(Alfresco.constants.PAGEID==="document-details")?false:true;var aF=Alfresco.util.getQueryStringParameters(window.location.hash.replace("#",""));if(this.disabledPageLinking){this.pageNum=this.documentConfig.pageNum?parseInt(this.documentConfig.pageNum):this.pageNum}else{this.pageNum=aF.page||(this.documentConfig.pageNum?parseInt(this.documentConfig.pageNum):this.pageNum)}this.pageNum=parseInt(this.pageNum);Alfresco.util.Ajax.request({url:Alfresco.constants.URL_SERVICECONTEXT+"components/preview/pdfjs?htmlid="+encodeURIComponent(this.wp.id),successCallback:{fn:this.onViewerLoaded,scope:this},failureMessage:this.wp.msg("error.viewerload")});P.addListener(window,"resize",this.onRecalculatePreviewLayout,this,true);P.addListener(window,"hashchange",this.onWindowHashChange,this,true);P.addListener(window,"beforeunload",this.onWindowUnload,this,true)},onViewerLoaded:function p(aK){this.wp.getPreviewerElement().innerHTML=aK.serverResponse.responseText;this.controls=z.get(this.wp.id+"-controls");this.pageNumber=z.get(this.wp.id+"-pageNumber");this.sidebar=z.get(this.wp.id+"-sidebar");this.viewer=z.get(this.wp.id+"-viewer");if(this.attributes.pageLayout=="multi"){z.addClass(this.viewer,"multiPage")}this.widgets.sidebarButton=Alfresco.util.createYUIButton(this,"sidebarBtn",this.onSidebarToggle,{type:"checkbox",disabled:true,style:"display:none;"},this.wp.id+"-sidebarBtn");this.widgets.nextButton=Alfresco.util.createYUIButton(this,"next",this.onPageNext,{disabled:true},this.wp.id+"-next");this.widgets.turnButton=Alfresco.util.createYUIButton(this,"turn",this.onTurn,{disabled:false},this.wp.id+"-turn");this.widgets.previousButton=Alfresco.util.createYUIButton(this,"previous",this.onPagePrevious,{disabled:true},this.wp.id+"-previous");P.addListener(this.wp.id+"-pageNumber","change",this.onPageChange,this,true);this.widgets.zoomOutButton=Alfresco.util.createYUIButton(this,"zoomOut",this.onZoomOut,{disabled:true},this.wp.id+"-zoomOut");this.widgets.zoomInButton=Alfresco.util.createYUIButton(this,"zoomIn",this.onZoomIn,{disabled:true},this.wp.id+"-zoomIn");this.widgets.scaleMenu=new YAHOO.widget.Button(this.wp.id+"-scaleSelectBtn",{type:"menu",menu:this.wp.id+"-scaleSelect",disabled:true});this.widgets.scaleMenu.getMenu().subscribe("click",this.onZoomChange,null,this);var aE=[{text:this.wp.msg("link.download"),value:"",onclick:{fn:this.onDownloadClick,scope:this}},{text:"Печать",value:"",onclick:{fn:this.print,scope:this}},];if(this.attributes.src){aE.push({text:this.wp.msg("link.downloadPdf"),value:"",onclick:{fn:this.onDownloadPDFClick,scope:this}})}this.widgets.downloadButton=new YAHOO.widget.Button(this.wp.id+"-download",{type:"menu",menu:aE});if(Alfresco.constants.PAGEID==="document-details"||Alfresco.constants.PAGEID==="documentlibrary"||window.location.pathname.match("/document-details$")){this.widgets.maximize=Alfresco.util.createYUIButton(this,"fullpage",this.onMaximizeClick,{title:this.wp.msg("button.maximize.tip",YAHOO.env.ua.os=="macintosh"?this.wp.msg("key.meta"):this.wp.msg("key.ctrl"))},this.wp.id+"-fullpage");z.getElementsByClassName("maximizebutton","span",this.controls,function aJ(aL){z.setStyle(aL,"display","inline")});z.getElementsByClassName("maximizebuttonSep","span",this.controls,function aJ(aL){z.setStyle(aL,"display","inline")})}if(Alfresco.constants.PAGEID==="document-details"){z.getElementsByClassName("linkbutton","span",this.controls,function aJ(aL){z.setStyle(aL,"display","inline")});this.widgets.linkBn=Alfresco.util.createYUIButton(this,"link",this.onLinkClick,{type:"checkbox"},this.wp.id+"-link")}P.addListener(this.wp.id+"-findInput","change",this.onFindChange,this,true);var aI=this;P.addListener(this.wp.id+"-findInput","keypress",function(aL){if(aL.keyCode==13){P.stopEvent(aL);aI.onFindChange("find")}});this.widgets.previousSearchButton=Alfresco.util.createYUIButton(this,"findPrevious",this.onFindChange,{},this.wp.id+"-findPrevious");this.widgets.nextSearchButton=Alfresco.util.createYUIButton(this,"findNext",this.onFindChange,{},this.wp.id+"-findNext");this.widgets.searchHighlight=Alfresco.util.createYUIButton(this,"findHighlightAll",this.onFindChangeHighlight,{type:"checkbox"},this.wp.id+"-findHighlightAll");this.widgets.searchMatchCase=Alfresco.util.createYUIButton(this,"findMatchCase",this.onFindChangeMatchCase,{type:"checkbox"},this.wp.id+"-findMatchCase");this.widgets.searchBarToggle=Alfresco.util.createYUIButton(this,"searchBarToggle",this.onToggleSearchBar,{type:"checkbox",disabled:true,title:this.wp.msg("button.search.tip",YAHOO.env.ua.os=="macintosh"?this.wp.msg("key.meta"):this.wp.msg("key.ctrl"))},this.wp.id+"-searchBarToggle");this.onPdfLoaded.subscribe(function aF(aM,aL){this.widgets.sidebarButton.set("disabled",false);this.widgets.scaleMenu.set("disabled",false);this.widgets.searchBarToggle.set("disabled",false)},this,true);this._setPreviewerElementHeight();this._setViewerHeight();this._loadPdf();if(Alfresco.constants.PAGEID==="document-details"){var aH=function aH(aM,aL){var aN=aL[1];if((aN.ctrlKey||aN.metaKey)&&this.widgets.searchBarToggle){P.stopEvent(aN);aN.newValue=(!this.widgets.searchDialog||!this.widgets.searchDialog.cfg.getProperty("visible"));this.widgets.searchBarToggle.set("checked",!this.widgets.searchBarToggle.get("checked"))}};var aG=function aG(aM,aL){var aN=aL[1];if(aN.ctrlKey||aN.metaKey){P.stopEvent(aN);this.onFullScreen(aN)}};new YAHOO.util.KeyListener(document,{keys:37},{fn:this.onPagePrevious,scope:this,correctScope:true}).enable();new YAHOO.util.KeyListener(document,{keys:39},{fn:this.onPageNext,scope:this,correctScope:true}).enable();new YAHOO.util.KeyListener(document,{keys:70,ctrl:true},{fn:aH,scope:this,correctScope:true}).enable();new YAHOO.util.KeyListener(document,{keys:13,ctrl:true},{fn:aG,scope:this,correctScope:true}).enable();if(YAHOO.env.ua.os=="macintosh"){new YAHOO.util.KeyListener(document,{keys:13},{fn:aG,scope:this,correctScope:true}).enable();new YAHOO.util.KeyListener(document,{keys:70},{fn:aH,scope:this,correctScope:true}).enable()}P.addListener(window,"fullscreenchange",this.onFullScreenChange,this,true);P.addListener(window,"mozfullscreenchange",this.onFullScreenChange,this,true);P.addListener(window,"webkitfullscreenchange",this.onFullScreenChange,this,true)}new YAHOO.util.KeyListener(document,{keys:27},{fn:function(aL){if(this.maximized){this.onMaximizeClick()}},scope:this,correctScope:true}).enable()},print:function ay(){var aE=this.attributes.src?this.wp.getThumbnailUrl(this.attributes.src):this.wp.getContentUrl();document.WinPrint=window.open(aE,"","left=50,top=50,width=800,height=640,toolbar=0,scrollbars=1,status=0");document.WinPrint.focus();document.WinPrint.print()},_setPreviewerElementHeight:function aj(){if(!this.maximized){var aI;if(this.inDashlet){z.setStyle(this.wp.getPreviewerElement(),"height",(z.getClientHeight()-64)+"px")}else{if(aI=z.getAncestorByClassName(this.wp.getPreviewerElement(),"dijitDialogPaneContent")){var aJ=z.getStyle(aI,"height");var aE=(parseInt(aJ)-42)+"px"}else{var aH=new YAHOO.util.Element(this.wp.getPreviewerElement()),aG=z.getDocumentHeight(),aF=z.getClientHeight();var aE=((aG<aF)?aG:aF)-220;z.setStyle(this.wp.getPreviewerElement(),"height","98vh")}}}else{if(this.fullscreen){}else{z.setStyle(this.wp.getPreviewerElement(),"height",(window.innerHeight||z.getViewportHeight()).toString()+"px")}}},_setViewerHeight:function ao(){var aH=z.getRegion(this.viewer.parentNode),aM=z.getRegion(this.controls),aE=!this.fullscreen?aM.height:0,aF=aH.height-aE-1;if(aF===0){if(!this.maximized){var aI;if(aI=z.getAncestorByClassName(this.wp.getPreviewerElement(),"dijitDialogPaneContent")){var aJ=z.getStyle(aI,"height");var aL=(parseInt(aJ)-42-10-aE-1)+"px";z.setStyle(this.wp.getPreviewerElement(),"height",aL)}else{var aG=new YAHOO.util.Element(this.wp.getPreviewerElement()),aN=z.getDocumentHeight(),aK=z.getClientHeight();var aL=((aN<aK)?aN:aK)-220;aF=aL-10-aE-1}}else{aF=z.getViewportHeight()-aE-1}}if(!this.fullscreen){if(Alfresco.logger.isDebugEnabled()){Alfresco.logger.debug("Setting viewer height to "+aF+"px (toolbar "+aE+"px, container "+aH.height+"px")}z.setStyle(this.viewer,"height",aF.toString()+"px");z.setStyle(this.sidebar,"height",aF.toString()+"px")}else{if(Alfresco.logger.isDebugEnabled()){Alfresco.logger.debug("Setting viewer height to 100% (full-screen)")}z.setStyle(this.viewer,"height","100%")}},_loadPdf:function V(aG){this.wp.options.name=this.wp.options.name.replace(/[^\w_\-\. ]/g,"");var aF=this,aE=this.attributes.src?this.wp.getThumbnailUrl(this.attributes.src):this.wp.getContentUrl();if(aE.substr(0,4).toLowerCase()!=="http"){aE=window.location.protocol+"//"+window.location.host+aE}aG=aG||{};aG.url=aE;if(typeof window.Spinner==="function"){this.spinner=new Spinner({lines:13,length:7,width:4,radius:10,corners:1,rotate:0,color:"#666",speed:1,trail:60,shadow:false,hwaccel:false,className:"spinner",zIndex:2000000000,top:"auto",left:"auto"}).spin(this.viewer);this.onPdfLoaded.subscribe(function aH(aJ,aI){this.spinner.stop()},this,true)}else{Alfresco.logger.error("spinner.js is not loaded!")}PDFJS.workerSrc=this.workerSrc;PDFJS.cMapUrl="./cmaps/";PDFJS.cMapPacked=true;if(this.attributes.progressiveLoading=="true"&&PDFJS.disableRange!=true){PDFJS.disableRange=false;PDFJS.disableAutoFetch=false}else{PDFJS.disableRange=true}if(Alfresco.logger.isDebugEnabled()){Alfresco.logger.debug("Using PDFJS.disableRange="+PDFJS.disableRange+" PDFJS.disableAutoFetch:"+PDFJS.disableAutoFetch);Alfresco.logger.debug("Loading PDF file from "+aE)}PDFJS.getDocument(aG).then(Alfresco.util.bind(this._onGetDocumentSuccess,this),Alfresco.util.bind(this._onGetDocumentFailure,this))},_onGetDocumentSuccess:function al(aE){this.pdfDocument=aE;this.numPages=this.pdfDocument.numPages;if(Alfresco.logger.isDebugEnabled()){Alfresco.logger.debug("Rendering PDF with fingerprint "+aE.fingerprint+" for "+this.wp.options.name)}this._renderPdf();this._updatePageControls();this.onPdfLoaded.fire(aE)},_onGetDocumentFailure:function ag(aP,aH){if(this.spinner){this.spinner.stop()}if(aH&&aH.name==="PasswordException"){var aJ="prompt.password.text";if(aH.code==="incorrectpassword"){aJ="error.incorrectpassword"}if(aH.code==="needpassword"||aH.code==="incorrectpassword"){var aI=this,aF=Alfresco.util.generateDomId(),aM=Alfresco.util.bind(function(aQ){if(aQ&&aQ.length>0){this._loadPdf({password:aQ})}},this),aG=Alfresco.util.PopupManager.getUserInput({title:this.wp.msg("prompt.password.title"),html:'<label for="'+aF+'">'+e(this.wp.msg(aJ))+'</label><br/><br/><input id="'+aF+'" tabindex="0" type="password" value=""/>',buttons:[{text:Alfresco.util.message("button.ok",this.name),handler:function aN(){aM(z.get(aF).value);this.destroy()},isDefault:true},{text:Alfresco.util.message("button.cancel",this.name),handler:function aK(){this.destroy()}}]}),aL=aG.getButtons()[0];YAHOO.util.Event.addListener(aF,"keyup",function(aQ,aR){if(aR!=null){aR.set("disabled",YAHOO.lang.trim(this.value||this.text||"").length==0)}},aL);new YAHOO.util.KeyListener(aF,{keys:[YAHOO.util.KeyListener.KEY.ENTER]},function aO(aQ){aM(z.get(aF).value);aG.destroy()}).enable();if(z.get(aF)){z.get(aF).focus()}return}}var aE=this.wp.msg("error.pdfload");if(aH&&aH.name==="InvalidPDFException"){aE=this.wp.msg("error.invalidpdf")}Alfresco.util.PopupManager.displayMessage({text:aE});Alfresco.logger.error("Could not load PDF due to error "+aH.name+" (code "+aH.code+"): "+aP)},_renderPdf:function ar(){var aH=[],aI={},aE=this.numPages;for(var aK=1;aK<=aE;aK++){aH.push(this.pdfDocument.getPage(aK))}var aN=Promise.all(aH);var aM=this.pdfDocument.getDestinations();var aG=Alfresco.util.bind(function(aU){var aO=this;this.documentView=new H(this.wp.id+"-viewer",{name:"documentView",pageLayout:this.attributes.pageLayout,currentScale:d,defaultScale:this.documentConfig.scale?this.documentConfig.scale:this.attributes.defaultScale,disableTextLayer:this.attributes.disableTextLayer=="true"||YAHOO.env.ua.ios||YAHOO.env.ua.android,autoMinScale:parseFloat(z.getClientWidth()>1024?this.attributes.autoMinScale:this.attributes.autoMinScaleMobile),autoMaxScale:parseFloat(this.attributes.autoMaxScale),pdfJsPlugin:aO,pdfDocument:this.pdfDocument});this.documentView.onScrollChange.subscribe(function aS(){var aV=this.documentView.getScrolledPageNumber();if(this.pageNum!=aV){this.pageNum=aV;this._updatePageControls();this.documentView.setActivePage(this.pageNum)}},this,true);this.thumbnailView=null;this.pages=aU;this.documentView.addPages(aU);for(var aQ=0;aQ<aU.length;aQ++){var aR=aU[aQ],aT=aR.ref;aI[aT.num+" "+aT.gen+" R"]=aQ}this.documentView.render();if(this.pageNum>this.pdfDocument.numPages){this.pageNum=this.pdfDocument.numPages;this._updatePageControls()}this.documentView.scrollTo(this.pageNum);this.documentView.setActivePage(this.pageNum);this._updateZoomControls();z.get(this.wp.id+"-numPages").textContent=this.numPages;z.setAttribute(this.wp.id+"-pageNumber","max",this.numPages);z.setAttribute(this.wp.id+"-pageNumber","disabled",this.numPages>1?null:"disabled");z.get(this.wp.id+"-pageNumber").removeAttribute("disabled");if(this.attributes.autoSearch=="true"&&document.referrer&&document.referrer.indexOf("/search?")>0){var aP=Alfresco.util.getQueryStringParameter("t",document.referrer);if(aP){this.widgets.searchBarToggle.set("checked",true);z.get(this.wp.id+"-findInput").value=aP;this.onFindChange("find")}}},this);var aJ=Alfresco.util.bind(function(aO){this.destinations=aO},this);var aL=Alfresco.util.bind(function(aO){this._addOutline(aO)},this);var aF=Alfresco.util.bind(function(){this.pdfDocument.getOutline().then(aL)},this);aN.then(aG);this.pagesRefMap=aI;aM.then(aJ);Promise.all([aN,aM]).then(aF)},_updatePageControls:function ad(){this.pageNumber.value=this.pageNum;this.widgets.nextButton.set("disabled",this.pageNum>=this.pdfDocument.numPages);this.widgets.previousButton.set("disabled",this.pageNum<=1)},_updateZoomControls:function U(aF){var aE=this.documentView.currentScale;this.widgets.zoomInButton.set("disabled",aE*this.attributes.scaleDelta>ai);this.widgets.zoomOutButton.set("disabled",aE/this.attributes.scaleDelta<A);this.widgets.scaleMenu.set("label",""+Math.round(aE*100)+"%")},_scrollToPage:function aa(aE){this.documentView.removeScrollListener();this.documentView.scrollTo(aE);this.documentView.setActivePage(this.pageNum);this.pageNum=aE;this._updatePageControls();if(this.thumbnailView&&this.thumbnailView.pages&&this.thumbnailView.pages[0]&&this.thumbnailView.pages[0].container){this.thumbnailView.setActivePage(this.pageNum)}YAHOO.lang.later(50,this.documentView,this.documentView.addScrollListener)},_addOutline:function az(aE){var aK=z.get(this.wp.id+"-outlineView");if(aE&&aE.length>0){var aJ=[{parent:aK,items:aE}];while(aJ.length>0){var aF=aJ.shift();var aI,aH=aF.items.length;for(aI=0;aI<aH;aI++){var aN=aF.items[aI];var aG=document.createElement("div");aG.className="outlineItem";var aM=document.createElement("a");z.setAttribute(aM,"href","#");YAHOO.util.Event.addListener(aM,"click",function(aP,aO){YAHOO.util.Event.stopEvent(aP);this._navigateTo(aO)},aN.dest,this);aM.textContent=aN.title;aG.appendChild(aM);if(aN.items.length>0){var aL=document.createElement("div");aL.className="outlineItems";aG.appendChild(aL);aJ.push({parent:aL,items:aN.items})}aF.parent.appendChild(aG)}}}else{aK.innerHTML="<p>"+this.wp.msg("msg.noOutline")+"</p>"}},_navigateTo:function b(aF){if(typeof aF==="string"){aF=this.destinations[aF]}if(aF instanceof Array){var aG=aF[0];var aE=aG instanceof Object?this.pagesRefMap[aG.num+" "+aG.gen+" R"]:(aG+1);if(aE>this.documentView.pages.length-1){aE=this.documentView.pages.length-1}if(typeof aE==="number"){this._scrollToPage(aE+1)}}},_loadDocumentConfig:function av(){if(this.attributes.useLocalStorage!="true"||!this._browserSupportsHtml5Storage()){this.documentConfig={}}else{var aE="org.alfresco.pdfjs.document."+this.wp.options.nodeRef.replace(":/","").replace("/",".")+".";this.documentConfig={pageNum:window.localStorage[aE+"pageNum"],scale:window.localStorage[aE+"scale"]};if(this.documentConfig.scale=="null"){this.documentConfig.scale=null}}},_browserSupportsHtml5Storage:function aA(){try{return"localStorage" in window&&window.localStorage!==null}catch(aE){return false}},onSidebarToggle:function am(aH){var aE=z.getStyle(this.sidebar,"display")=="block";z.setStyle(this.sidebar,"display",aE?"none":"block");if(aE){z.removeClass(this.viewer,"sideBarVisible")}else{z.addClass(this.viewer,"sideBarVisible");if(!this.thumbnailView){this.thumbnailView=new H(this.wp.id+"-thumbnailView",{name:"thumbnailView",pageLayout:"single",defaultScale:"page-width",disableTextLayer:true,pdfJsPlugin:this});this.thumbnailView.addPages(this.pages)}}this.documentView.alignRows();this.documentView.setScale(this.documentView.parseScale(this.currentScaleSelection?this.currentScaleSelection:this.attributes.defaultScale));this._scrollToPage(this.pageNum);this.documentView.renderVisiblePages();var aG=function aG(aJ,aI){YAHOO.util.Event.stopEvent(aJ);this._scrollToPage(aI.pn)};this.widgets.tabview=this.widgets.tabview||new YAHOO.widget.TabView(this.wp.id+"-sidebarTabView");if(this.thumbnailView&&this.thumbnailView.pages.length>0&&!this.thumbnailView.pages[0].container){this.thumbnailView.render();for(var aF=0;aF<this.thumbnailView.pages.length;aF++){YAHOO.util.Event.addListener(this.thumbnailView.pages[aF].container,"click",function(aJ,aI){this.thumbnailView.setActivePage(aI.pn);this.documentView.scrollTo(aI.pn)},{pn:aF+1},this)}this.thumbnailView.scrollTo(this.pageNum);this.thumbnailView.setActivePage(this.pageNum)}},onPagePrevious:function k(aE){if(this.pageNum<=1){return}this.pageNum--;this._scrollToPage(this.pageNum)},onPageNext:function L(aE){if(this.pageNum<this.pdfDocument.numPages){this.pageNum++;this._scrollToPage(this.pageNum)}},onTurn:function aD(aE){if(this.documentView.pages[0].container.style.transform=="rotate(90deg)"){this.turnPages("rotate(180deg)")}else{if(this.documentView.pages[0].container.style.transform=="rotate(180deg)"){this.turnPages("rotate(-90deg)")}else{if(this.documentView.pages[0].container.style.transform=="rotate(-90deg)"){this.turnPages("none")}else{this.turnPages("rotate(90deg)")}}}},turnPages:function ac(aE){for(var aF=0;aF<this.documentView.pages.length;aF++){this.documentView.pages[aF].container.style.transform=aE}},onFullScreen:function T(aF){var aE=this.viewer;if((document.fullScreenElement&&document.fullScreenElement!==null)||(!document.mozFullScreenElement&&!document.webkitFullScreenElement&&!document.webkitFullscreenElement)){P.removeListener(window,"resize",this.onRecalculatePreviewLayout,this,true);if(aE.requestFullScreen){aE.requestFullScreen()}else{if(aE.mozRequestFullScreen){aE.mozRequestFullScreen()}else{if(aE.webkitRequestFullScreen){aE.webkitRequestFullScreen(ab.ALLOW_KEYBOARD_INPUT)}}}}else{if(document.cancelFullScreen){document.cancelFullScreen()}else{if(document.mozCancelFullScreen){document.mozCancelFullScreen()}else{if(document.webkitCancelFullScreen){document.webkitCancelFullScreen()}}}}},onFullScreenChange:function a(aE){if((document.fullScreenElement&&document.fullScreenElement!==null)||(!document.mozFullScreenElement&&!document.webkitFullScreenElement&&!document.webkitFullscreenElement)){Alfresco.logger.debug("Leaving full screen mode");this.fullscreen=false;this.documentView.fullscreen=false;this.documentView.setScale(this.oldScale);this._setViewerHeight();this.onResize.fire();this.documentView.alignRows();this._scrollToPage(this.pageNum);P.addListener(window,"resize",this.onRecalculatePreviewLayout,this,true)}else{Alfresco.logger.debug("Entering full screen mode");this.documentView.fullscreen=true;this.fullscreen=true;this.oldScale=this.documentView.currentScale;this.oldPageNum=this.pageNum;this._setViewerHeight();this.onResize.fire();this.documentView.setScale(this.documentView.parseScale("page-fit"));this.documentView.alignRows();this._scrollToPage(this.pageNum)}},onPageChange:function ax(aF){var aE=parseInt(aF.currentTarget.value);if(aE<1||aE>this.numPages){Alfresco.util.PopupManager.displayMessage({text:this.wp.msg("error.badpage")})}else{this.pageNum=aE;this._scrollToPage(this.pageNum)}},onToggleSearchBar:function N(aF){if(!this.widgets.searchDialog){this.widgets.searchDialog=new YAHOO.widget.SimpleDialog(this.wp.id+"-searchDialog",{close:false,draggable:false,effect:null,modal:false,visible:false,width:"265px",context:[this.viewer,"tr","tr",["beforeShow","windowResize"],[-20,3]],underlay:"none"});this.widgets.searchDialog.render();new YAHOO.util.KeyListener(z.get(this.wp.id+"-searchDialog"),{keys:27},{fn:function(aH,aG){if(this.widgets.searchBarToggle.get("checked")){var aI=aG[1];P.stopEvent(aI);this.widgets.searchBarToggle.set("checked",false)}},scope:this,correctScope:true}).enable()}if(this.widgets.linkBn&&this.widgets.linkBn.get("checked")===true){this.widgets.linkBn.set("checked",false)}if(aF.newValue===true){this.widgets.searchDialog.show();this.widgets.searchDialog.bringToTop();var aE=z.get(this.wp.id+"-findInput");aE.focus();aE.select();if(!q.pdfPageSource){q.initialize({pdfPageSource:this.documentView});q.resolveFirstPage()}q.reset();q.extractText()}else{this.widgets.searchDialog.hide();q.active=false}},onFindChangeMatchCase:function i(aE){this.onFindChange("casesensitivitychange")},onFindChangeHighlight:function v(aE){this.onFindChange("highlightallchange")},onFindChange:function at(aL){var aK=z.get(this.wp.id+"-findInput").value;if(!aK){return}var aJ=document.createEvent("CustomEvent"),aI=false,aH="find",aG=this.widgets.searchHighlight.get("checked"),aE=this.widgets.searchMatchCase.get("checked"),aF;if(aL.currentTarget){aF=aL.currentTarget.id}else{aF=aL}switch(aF){case this.wp.id+"-findNext":aH+="again";break;case this.wp.id+"-findPrevious":aH+="again";aI=true;break;case"highlightallchange":aH+="highlightallchange";break;case"casesensitivitychange":aH+="casesensitivitychange";break;default:if(aK===this.lastSearchQuery){aH+="again";break}else{break}}this.lastSearchQuery=aK;aJ.initCustomEvent(aH,true,true,{query:aK,caseSensitive:aE,highlightAll:aG,findPrevious:aI});window.dispatchEvent(aJ)},onZoomOut:function r(aF){var aE=Math.max(A,this.documentView.currentScale/this.attributes.scaleDelta);this.documentView.setScale(this.documentView.parseScale(aE));this._scrollToPage(this.pageNum);this._updateZoomControls()},onZoomIn:function Q(aF){var aE=Math.min(ai,this.documentView.currentScale*this.attributes.scaleDelta);this.documentView.setScale(this.documentView.parseScale(aE));this._scrollToPage(this.pageNum);this._updateZoomControls()},onZoomChange:function c(aG,aF){var aE=aF[0],aH=aF[1];this.currentScaleSelection=aH.value;this.documentView.setScale(this.documentView.parseScale(aH.value));this._scrollToPage(this.pageNum);this._updateZoomControls()},onDownloadClick:function an(aE){window.location.href=this.wp.getContentUrl(true).replace("api/node","slingshot/node")},onDownloadPDFClick:function W(aE){window.location.href=this.wp.getThumbnailUrl(this.attributes.src)+"&a=true"},onMaximizeClick:function y(aE){this.maximized=!this.maximized;if(this.maximized){z.addClass(this.wp.getPreviewerElement(),"fullPage");this.widgets.maximize.set("label",this.wp.msg("button.minimize"));this.widgets.maximize.set("title",this.wp.msg("button.minimize.tip",YAHOO.env.ua.os=="macintosh"?this.wp.msg("key.meta"):this.wp.msg("key.ctrl")))}else{z.removeClass(this.wp.getPreviewerElement(),"fullPage");this.widgets.maximize.set("label",this.wp.msg("button.maximize"));this.widgets.maximize.set("title",this.wp.msg("button.maximize.tip",YAHOO.env.ua.os=="macintosh"?this.wp.msg("key.meta"):this.wp.msg("key.ctrl")))}this._setPreviewerElementHeight();this._setViewerHeight();this.onResize.fire();this.documentView.setScale(this.documentView.parseScale(this.currentScaleSelection?this.currentScaleSelection:this.attributes.defaultScale));this._scrollToPage(this.pageNum);this.documentView.alignRows();this.documentView.renderVisiblePages();if(this.thumbnailView){this.thumbnailView.renderVisiblePages()}if(this.widgets.searchDialog){this.widgets.searchDialog.align("tr","tr")}if(this.widgets.linkDialog){this.widgets.linkDialog.align("tr","tr")}},onLinkClick:function g(aL){var aK=this.wp.id+"-linkDialog",aI=aK+"-input";var aE=function aF(){var aP=this.widgets.linkDialogBg.get("checkedButton").get("id");var aO=window.location.href.replace(window.location.hash,"")+(aP.indexOf("-doc")>0?"":"#page="+this.pageNum);var aN=z.get(aI);aN.value=aO;aN.focus();aN.select()};if(!this.widgets.linkDialog){var aM=new YAHOO.widget.SimpleDialog(aK,{close:false,draggable:false,effect:null,modal:false,visible:false,context:[this.viewer,"tr","tr",["beforeShow","windowResize"],[-20,3]],width:"40em",underlay:"none"});var aG=window.location.href.replace(window.location.hash,"")+"#page="+this.pageNum;aM.render();new YAHOO.util.KeyListener(z.get(aK),{keys:27},{fn:function(aO,aN){if(this.widgets.linkBn.get("checked")){var aP=aN[1];P.stopEvent(aP);this.widgets.linkBn.set("checked",false)}},scope:this,correctScope:true}).enable();var aJ=new YAHOO.widget.ButtonGroup(aK+"-bg");for(var aH=0;aH<aJ.getCount();aH++){aJ.getButton(aH).addListener("click",aE,null,this)}this.widgets.linkDialogBg=aJ;this.widgets.linkDialog=aM;YAHOO.util.Event.addListener(aI,"click",function(){this.focus();this.select()})}if(this.widgets.searchBarToggle.get("checked")===true){this.widgets.searchBarToggle.set("checked",false)}if(!this.widgets.linkDialog.cfg.getProperty("visible")){this.widgets.linkDialog.show();this.widgets.linkDialog.bringToTop();aE.call(this)}else{this.widgets.linkDialog.hide()}},onRecalculatePreviewLayout:function aq(aE){if(this.documentView){Alfresco.logger.debug("onRecalculatePreviewLayout");this._setPreviewerElementHeight();this._setViewerHeight();this.onResize.fire();this.documentView.setScale(this.documentView.parseScale(this.currentScaleSelection?this.currentScaleSelection:this.attributes.defaultScale));this._scrollToPage(this.pageNum);this.documentView.alignRows();this.documentView.renderVisiblePages()}if(this.thumbnailView){this.thumbnailView.renderVisiblePages()}},onWindowHashChange:function M(aF){if(this.disabledPageLinking){return}var aE=Alfresco.util.getQueryStringParameters(window.location.hash.replace("#",""));pn=aE.page;if(pn){if(pn>this.pdfDocument.numPages){pn=this.pdfDocument.numPages}else{if(pn<1){pn=1}}this.pageNum=parseInt(pn);this._scrollToPage(this.pageNum)}},onWindowUnload:function o(){if(this.attributes.useLocalStorage=="true"&&this._browserSupportsHtml5Storage()&&this.documentView){var aE="org.alfresco.pdfjs.document."+this.wp.options.nodeRef.replace(":/","").replace("/",".")+".";if(this.pageNum){window.localStorage[aE+"pageNum"]=this.pageNum}if(this.documentView.lastScale){window.localStorage[aE+"scale"]=this.documentView.lastScale}if(this.widgets.sidebarButton){window.localStorage[aE+"sidebar-enabled"]=this.widgets.sidebarButton.get("checked")}}}};var t=function(aI,aH,aG,aF,aE){this.id=aI;this.content=aH;this.parent=aG;this.canvas=null;this.container=null;this.loadingIconDiv=null;this.textLayerDiv=null;this.config=aF||{};this.textContent=null;this.textLayerDiv=null;this.pdfJsPlugin=aE};t.prototype={render:function B(){var aF=document.createElement("div");aF.id=this.parent.id+"-pageContainer-"+this.id;z.addClass(aF,"page");this.parent.viewer.appendChild(aF);var aE=document.createElement("div");z.addClass(aE,"loadingIcon");aF.appendChild(aE);this.container=aF;this.loadingIconDiv=aE;this._setPageSize()},getRegion:function j(){return z.getRegion(this.container)},getVPos:function ah(aE){return this.container.getBoundingClientRect().top+z.getDocumentScrollTop()-this.parent.viewerRegion.top},renderContent:function s(){var aO=this.getRegion(),aF=document.createElement("canvas");aF.id=this.container.id.replace("-pageContainer-","-canvas-");aF.mozOpaque=true;this.container.appendChild(aF);this.canvas=aF;z.setStyle(aF,"visibility","hidden");aF.width=aO.width;aF.height=aO.height;var aM=this.content.getViewport(this.parent.currentScale);var aI=null;if(!this.parent.config.disableTextLayer){aI=document.createElement("div");aI.className="textLayer";this.container.appendChild(aI)}this.textLayerDiv=aI;this.textLayer=aI?new ak(aI,this.id-1,this.pdfJsPlugin,aM):null;var aL=this.content,aP=aL.view,aQ=aF.getContext("2d");var aG={canvasContext:aQ,viewport:aM,textLayer:this.textLayer};var aE=0;if(Alfresco.logger.isDebugEnabled()){aE=Date.now()}var aH=Alfresco.util.bind(function aJ(aR){this.textLayer.setTextContent(aR)},this);var aK=Alfresco.util.bind(function aN(){if(this.textLayer){this.getTextContent().then(aH)}if(this.loadingIconDiv){z.setStyle(this.loadingIconDiv,"display","none")}z.setStyle(this.canvas,"visibility","visible");if(Alfresco.logger.isDebugEnabled()){Alfresco.logger.debug("Rendered "+this.parent.name+" page "+this.id+" in "+(Date.now()-aE)+"ms")}},this);aL.render(aG).promise.then(aK)},_setPageSize:function F(aE){var aF=this.content.getViewport(this.parent.currentScale);z.setStyle(this.container,"height",Math.floor(aF.height)+"px");z.setStyle(this.container,"width",Math.floor(aF.width)+"px")},reset:function m(){this._setPageSize();if(this.canvas){this.container.removeChild(this.canvas);delete this.canvas;this.canvas=null}if(this.loadingIconDiv){z.setStyle(this.loadingIconDiv,"display","block")}},getTextContent:function E(){if(!this.textContent){this.textContent=this.content.getTextContent()}return this.textContent},scrollIntoView:function C(aF,aE){var aG=0;if(Alfresco.logger.isDebugEnabled()){Alfresco.logger.debug("Page Scroll")}if(aF){aG+=aF.offsetTop;if(Alfresco.logger.isDebugEnabled()){Alfresco.logger.debug("Page Scroll offsetTop "+aF.offsetTop)}}if(aE){if(Alfresco.logger.isDebugEnabled()){Alfresco.logger.debug("Page Scroll spot "+aE.top)}aG+=aE.top}if(Alfresco.logger.isDebugEnabled()){Alfresco.logger.debug("Page Scroll "+aG)}this.parent.scrollTo(this.id,aG)}};var H=function(aG,aF){this.id=aG;this.config=aF||{};this.pages=[];this.viewer=z.get(aG);this.viewerRegion=z.getRegion(this.viewer);this.currentScale=aF.currentScale||d;this.name=this.config.name||"";this.pdfJsPlugin=aF.pdfJsPlugin;this.pdfDocument=aF.pdfDocument;this.lastScroll=0;var aE=this;this.viewer.addEventListener("scroll",function(){aE.lastScroll=Date.now()},false);this.pdfJsPlugin.onResize.subscribe(this.onResize,this,true);this.addScrollListener();this.onScrollChange=new YAHOO.util.CustomEvent("scrollChange",this)};H.prototype={activePage:null,lastScale:null,renderOnScrollZero:0,addPage:function D(aG,aE){var aF=new t(aG,aE,this,{},this.pdfJsPlugin);this.pages.push(aF)},addPages:function I(aE){for(var aF=0;aF<aE.length;aF++){var aG=aE[aF];this.addPage(aF+1,aG)}},render:function O(){for(var aE=0;aE<this.pages.length;aE++){if(Alfresco.logger.isDebugEnabled()){Alfresco.logger.debug("Rendering "+this.name+" page container "+(aE+1))}this.pages[aE].render()}if(this.currentScale===d){this.setScale(this.parseScale(this.config.defaultScale))}else{this.alignRows()}},reset:function aw(){for(var aE=0;aE<this.pages.length;aE++){this.pages[aE].reset()}this.alignRows()},alignRows:function aB(){var aE=-1,aH=0,aI=0,aL=z.getDocumentScrollTop();if(this.config.pageLayout=="multi"){z.setStyle(this.viewer,"padding-left","0px");for(var aJ=0;aJ<this.pages.length;aJ++){var aK=this.pages[aJ],aF=aK.container,aM=aF.getBoundingClientRect(),aN=aM.top+aL-aK.parent.viewerRegion.top,aG=parseInt(z.getStyle(aF,"margin-left"));if(aN!=aE){aH=aG}aH+=aM.width+aG;aI=Math.max(aI,aH);aE=aN}z.setStyle(this.viewer,"padding-left",Math.floor((this.viewer.clientWidth-aI)/2)+"px")}},renderVisiblePages:function w(){this.viewerRegion=z.getRegion(this.viewer);var aM=this.viewerRegion.height,aL=this.viewerRegion.top,aK=z.getDocumentScrollTop();if(Alfresco.logger.isDebugEnabled()){Alfresco.logger.debug("Render "+this.name+" visible pages: viewer height "+this.viewerRegion.height+"px")}for(var aG=0;aG<this.pages.length;aG++){var aI=this.pages[aG];if(!aI.canvas){var aF=aI.container.getBoundingClientRect(),aJ=aF.top+aK-aL,aE=aJ+aF.height,aH=1.5;if(aJ<0&&0<aE||-aM*aH<aE&&aE<aM||0<aJ&&aJ<aM*(aH+1)){if(Alfresco.logger.isDebugEnabled()){Alfresco.logger.debug("Rendering "+this.name+" page "+(aG+1)+" content (page top:"+aJ+", bottom:"+aE+")")}aI.renderContent()}}}},scrollTo:function u(aI,aH){var aE=this.pages[aI-1].getVPos(),aG=this.pages[0].getVPos();if(Alfresco.logger.isDebugEnabled()){Alfresco.logger.debug("Scrolling "+this.name+" to page "+aI+". New page top is "+aE+"px. First page top is "+aG+"px")}var aF=aE-aG;if(aH){aF+=aH}if(Alfresco.logger.isDebugEnabled()){Alfresco.logger.debug("Old scrollTop was "+this.viewer.scrollTop+"px");Alfresco.logger.debug("Set scrollTop to "+aF+"px");Alfresco.logger.debug("scrollTop offsetY "+aH)}this.viewer.scrollTop=aF;this.pageNum=aI;this.renderVisiblePages()},setScale:function af(aE){if(aE==this.currentScale){return}if(Alfresco.logger.isDebugEnabled()){Alfresco.logger.debug("Scale is now "+aE)}this.currentScale=aE;this.reset();this.alignRows()},parseScale:function Z(aO){var aW=parseFloat(aO);if(aW){this.lastScale=aO;return aW}if(this.pages.length!==0){var aR=this.pages[0],aM=aR.container,aJ=parseInt(z.getStyle(aM,"margin-left"))+parseInt(z.getStyle(aM,"margin-right")),aL=parseInt(z.getStyle(aM,"margin-top")),aN=parseInt(aR.content.pageInfo.view[2]),aQ=parseInt(aR.content.pageInfo.view[3]),aP=aR.content.pageInfo.rotate,aT=this.fullscreen?window.screen.width:this.viewer.clientWidth-1,aI=this.fullscreen?window.screen.height:this.viewer.clientHeight;Alfresco.logger.debug("Client height: "+this.viewer.clientHeight);if(aP===90||aP===270){var aV=aN;aN=aQ;aQ=aV}switch(aO){case"page-width":var aF=(aT-aJ*2)/aN;aW=aF;break;case"two-page-width":var aF=(aT-aJ*3)/aN;aW=aF/2;break;case"page-height":var aE=(aI-aL*2)/aQ;aW=aE;break;case"page-fit":var aF=(aT-aJ*2)/aN,aE=(aI-aL*2)/aQ;aW=Math.min(aF,aE);break;case"two-page-fit":var aF=(aT-aJ*3)/aN,aE=(aI-aL*2)/aQ;aW=Math.min(aF/2,aE);break;case"auto":var aG=this.parseScale("two-page-fit"),aK=this.parseScale("page-fit"),aX=this.parseScale("page-width"),aS=this.parseScale("two-page-width"),aU=this.config.autoMinScale,aH=this.config.autoMaxScale;if(aG>aU&&this.numPages>1){aW=aG}else{if(aK>aU){aW=aK}else{if(aS>aU&&this.numPages>1){aW=aS}else{if(aX>aU){aW=aX}else{aW=aU}}}}if(aH){aW=Math.min(aW,aH)}break;default:throw"Unrecognised zoom level '"+aO+"'"}}else{throw"Unrecognised zoom level - no pages"}this.lastScale=aO;return aW},getScrolledPageNumber:function K(){for(var aE=0;aE<this.pages.length;aE++){var aF=this.pages[aE],aG=aF.getVPos();if(aG+parseInt(aF.container.style.height)/2>0){return aE+1}}return this.pages.length},setActivePage:function l(aE){if(this.activePage){z.removeClass(this.activePage.container,"activePage")}z.addClass(this.pages[aE-1].container,"activePage");this.activePage=this.pages[aE-1]},onResize:function G(){this.viewerRegion=z.getRegion(this.viewer)},addScrollListener:function x(){P.addListener(this.viewer,"scroll",this.onScrollEvent,this,true)},removeScrollListener:function x(){P.removeListener(this.viewer,"scroll",this.onScrollEvent)},onScrollEvent:function au(aE){this.renderOnScrollZero++;YAHOO.lang.later(50,this,this.onScroll,aE)},onScroll:function aC(aE){this.renderOnScrollZero--;if(this.renderOnScrollZero==0){this.renderVisiblePages();this.onScrollChange.fire(this)}}};var S=-50;var J=-400;var ak=function R(aK,aE,aN,aO){var aL=document.createDocumentFragment();this.textDivs=[];this.viewport=aO;this.textLayerDiv=aK;this.layoutDone=false;this.divContentDone=false;this.pageIdx=aE;this.matches=[];this.pdfJsPlugin=aN;this.isViewerInPresentationMode=false;if(typeof q==="undefined"){window.PDFFindController=null}if(typeof this.lastScrollSource==="undefined"){this.lastScrollSource=null}this.renderLayer=function aJ(){var aW=this.textDivs;var aR=document.createElement("canvas");var a0=aR.getContext("2d");var aT=100000;if(aW.length>aT){return}for(var aV=0,aY=aW.length;aV<aY;aV++){var aU=aW[aV];if("isWhitespace" in aU.dataset){continue}a0.font=aU.style.fontSize+" "+aU.style.fontFamily;var aQ=a0.measureText(aU.textContent).width;if(aQ>0){aL.appendChild(aU);var aX=aU.dataset.canvasWidth/aQ;var aZ=aU.dataset.angle;var aS="scale("+aX+", 1)";aS="rotate("+aZ+"deg) "+aS;z.setStyle(aU,"-ms-transform","scale("+aX+", 1)");z.setStyle(aU,"-webkit-transform","scale("+aX+", 1)");z.setStyle(aU,"-moz-transform","scale("+aX+", 1)");z.setStyle(aU,"-ms-transformOrigin","0% 0%");z.setStyle(aU,"-webkit-transformOrigin","0% 0%");z.setStyle(aU,"-moz-transformOrigin","0% 0%")}}this.textLayerDiv.appendChild(aL);this.renderingDone=true;this.updateMatches()};this.setupRenderLayoutTimer=function aP(){var aS=200;var aQ=this;var aR=(this.lastScrollSource===null?0:this.lastScrollSource.lastScroll);if(Date.now()-aR>aS){this.renderLayer()}else{if(this.renderTimer){clearTimeout(this.renderTimer)}this.renderTimer=setTimeout(function(){aQ.setupRenderLayoutTimer()},aS)}};this.appendText=function aF(aT,aW){var aU=aW[aT.fontName];var aR=document.createElement("div");this.textDivs.push(aR);if(!/\S/.test(aT.str)){aR.dataset.isWhitespace=true;return}var aQ=PDFJS.Util.transform(this.viewport.transform,aT.transform);var aX=Math.atan2(aQ[1],aQ[0]);if(aU.vertical){aX+=Math.PI/2}var aV=Math.sqrt((aQ[2]*aQ[2])+(aQ[3]*aQ[3]));var aS=(aU.ascent?aU.ascent*aV:(aU.descent?(1+aU.descent)*aV:aV));aR.style.position="absolute";aR.style.left=(aQ[4]+(aS*Math.sin(aX)))+"px";aR.style.top=(aQ[5]-(aS*Math.cos(aX)))+"px";aR.style.fontSize=aV+"px";aR.style.fontFamily=aU.fontFamily;aR.textContent=aT.str;aR.dataset.fontName=aT.fontName;aR.dataset.angle=aX*(180/Math.PI);if(aU.vertical){aR.dataset.canvasWidth=aT.height*this.viewport.scale}else{aR.dataset.canvasWidth=aT.width*this.viewport.scale}};this.setTextContent=function aM(aS){this.textContent=aS;var aR=aS.items;for(var aQ=0;aQ<aR.length;aQ++){this.appendText(aR[aQ],aS.styles)}this.divContentDone=true;this.setupRenderLayoutTimer()};this.convertMatches=function aG(aW){var aU=0;var aX=0;var aQ=this.textContent.items;var aT=aQ.length-1;var aS=(q===null?0:q.state.query.length);var aY=[];for(var aR=0;aR<aW.length;aR++){var aZ=aW[aR];while(aU!==aT&&aZ>=(aX+aQ[aU].str.length)){aX+=aQ[aU].str.length;aU++}if(aU==aQ.length){console.error("Could not find matching mapping")}var aV={begin:{divIdx:aU,offset:aZ-aX}};aZ+=aS;while(aU!==aT&&aZ>(aX+aQ[aU].str.length)){aX+=aQ[aU].str.length;aU++}aV.end={divIdx:aU,offset:aZ-aX};aY.push(aV)}return aY};this.renderMatches=function aI(aQ){if(aQ.length===0){return}var a5=this.textContent.items;var a0=this.textDivs;var aR=null;var a2=(q===null?false:(this.pageIdx===q.selected.pageIdx));var a6=(q===null?-1:q.selected.matchIdx);var a7=(q===null?false:q.state.highlightAll);var aX={divIdx:-1,offset:undefined};function ba(bc,bb){var bd=bc.divIdx;var be=a0[bd];be.textContent="";aT(bd,0,bc.offset,bb)}function a8(bd,bc,bb){aT(bd.divIdx,bd.offset,bc.offset,bb)}function aT(bh,bc,bb,be){var bi=a0[bh];var bg=a5[bh].str.substring(bc,bb);var bf=document.createTextNode(bg);if(be){var bd=document.createElement("span");bd.className=be;bd.appendChild(bf);bi.appendChild(bd);return}bi.appendChild(bf)}function aU(bc,bb){a0[bc].className=bb}var a3=a6,a1=a3+1,a4;if(a7){a3=0;a1=aQ.length}else{if(!a2){return}}for(a4=a3;a4<a1;a4++){var aV=aQ[a4];var a9=aV.begin;var aS=aV.end;var aW=a2&&a4===a6;var aZ=(aW?" selected":"");if(aW&&!this.isViewerInPresentationMode){this.pdfJsPlugin.documentView.pages[this.pageIdx].scrollIntoView(a0[a9.divIdx],{top:S,left:J})}if(!aR||a9.divIdx!==aR.divIdx){if(aR!==null){a8(aR,aX)}ba(a9)}else{a8(aR,a9)}if(a9.divIdx===aS.divIdx){a8(a9,aS,"highlight"+aZ)}else{a8(a9,aX,"highlight begin"+aZ);for(var aY=a9.divIdx+1;aY<aS.divIdx;aY++){aU(aY,"highlight middle"+aZ)}ba(aS,"highlight end"+aZ)}aR=aS}if(aR){a8(aR,aX)}};this.updateMatches=function aH(){if(!this.renderingDone){return}var aV=this.matches;var aX=this.textDivs;var aR=this.textContent.items;var aY=-1;for(var aU=0;aU<aV.length;aU++){var aW=aV[aU];var aT=Math.max(aY,aW.begin.divIdx);for(var aS=aT;aS<=aW.end.divIdx;aS++){var aQ=aX[aS];aQ.textContent=aR[aS].str;aQ.className=""}aY=aW.end.divIdx+1}if(q===null||!q.active){return}this.matches=aV=(this.convertMatches(q===null?[]:(q.pageMatches[this.pageIdx]||[])));this.renderMatches(this.matches)}};var ap={FIND_FOUND:0,FIND_NOTFOUND:1,FIND_WRAPPED:2,FIND_PENDING:3};var q={startedTextExtraction:false,extractTextPromises:[],pendingFindMatches:{},active:false,pageContents:[],pageMatches:[],selected:{pageIdx:-1,matchIdx:-1},offset:{pageIdx:null,matchIdx:null},resumePageIdx:null,state:null,dirtyMatch:false,findTimeout:null,pdfPageSource:null,integratedFind:false,initialize:function(aE){this.pdfPageSource=aE.pdfPageSource;this.integratedFind=aE.integratedFind;var aG=["find","findagain","findhighlightallchange","findcasesensitivitychange"];this.firstPagePromise=new Promise(function(aH){this.resolveFirstPage=aH}.bind(this));this.handleEvent=this.handleEvent.bind(this);for(var aF=0;aF<aG.length;aF++){window.addEventListener(aG[aF],this.handleEvent)}},reset:function ae(){this.startedTextExtraction=false;this.extractTextPromises=[];this.active=false},calcFindMatch:function(aF){var aI=this.pageContents[aF];var aK=this.state.query;var aG=this.state.caseSensitive;var aE=aK.length;if(aE===0){return}if(!aG){aI=aI.toLowerCase();aK=aK.toLowerCase()}var aJ=[];var aH=-aE;while(true){aH=aI.indexOf(aK,aH+aE);if(aH===-1){break}aJ.push(aH)}this.pageMatches[aF]=aJ;this.updatePage(aF);if(this.resumePageIdx===aF){this.resumePageIdx=null;this.nextPageMatch()}},extractText:function(){if(this.startedTextExtraction){return}this.startedTextExtraction=true;this.pageContents=[];var aI=[];for(var aF=0,aG=this.pdfPageSource.pdfDocument.numPages;aF<aG;aF++){this.extractTextPromises.push(new Promise(function(aJ){aI.push(aJ)}))}var aE=this;function aH(aJ){aE.pdfPageSource.pages[aJ].getTextContent().then(function aK(aN){var aM=aN.items;var aO="";for(var aL=0;aL<aM.length;aL++){aO+=aM[aL].str}aE.pageContents.push(aO);aI[aJ](aJ);if((aJ+1)<aE.pdfPageSource.pages.length){aH(aJ+1)}})}aH(0)},handleEvent:function(aE){if(this.state===null||aE.type!=="findagain"){this.dirtyMatch=true}this.state=aE.detail;this.updateUIState(ap.FIND_PENDING);this.firstPagePromise.then(function(){this.extractText();clearTimeout(this.findTimeout);if(aE.type==="find"){this.findTimeout=setTimeout(this.nextMatch.bind(this),250)}else{this.nextMatch()}}.bind(this))},updatePage:function(aE){var aF=this.pdfPageSource.pages[aE];if(this.selected.pageIdx===aE){aF.scrollIntoView()}if(aF.textLayer){aF.textLayer.updateMatches()}},nextMatch:function(){var aH=this.state.findPrevious;var aK=this.pdfPageSource.pageNum-1;var aF=this.pdfPageSource.pages.length;this.active=true;if(this.dirtyMatch){this.dirtyMatch=false;this.selected.pageIdx=this.selected.matchIdx=-1;this.offset.pageIdx=aK;this.offset.matchIdx=null;this.hadMatch=false;this.resumePageIdx=null;this.pageMatches=[];var aE=this;for(var aG=0;aG<aF;aG++){this.updatePage(aG);if(!(aG in this.pendingFindMatches)){this.pendingFindMatches[aG]=true;this.extractTextPromises[aG].then(function(aL){delete aE.pendingFindMatches[aL];aE.calcFindMatch(aL)})}}}if(this.state.query===""){this.updateUIState(ap.FIND_FOUND);return}if(this.resumePageIdx){return}var aJ=this.offset;if(aJ.matchIdx!==null){var aI=this.pageMatches[aJ.pageIdx].length;if((!aH&&aJ.matchIdx+1<aI)||(aH&&aJ.matchIdx>0)){this.hadMatch=true;aJ.matchIdx=aH?aJ.matchIdx-1:aJ.matchIdx+1;this.updateMatch(true);return}this.advanceOffsetPage(aH)}this.nextPageMatch()},matchesReady:function(aG){var aH=this.offset;var aF=aG.length;var aE=this.state.findPrevious;if(aF){this.hadMatch=true;aH.matchIdx=aE?aF-1:0;this.updateMatch(true);return true}else{this.advanceOffsetPage(aE);if(aH.wrapped){aH.matchIdx=null;if(!this.hadMatch){this.updateMatch(false);return true}}return false}},nextPageMatch:function(){if(this.resumePageIdx!==null){console.error("There can only be one pending page.")}do{var aE=this.offset.pageIdx;var aF=this.pageMatches[aE];if(!aF){this.resumePageIdx=aE;break}}while(!this.matchesReady(aF))},advanceOffsetPage:function(aF){var aG=this.offset;var aE=this.extractTextPromises.length;aG.pageIdx=aF?aG.pageIdx-1:aG.pageIdx+1;aG.matchIdx=null;if(aG.pageIdx>=aE||aG.pageIdx<0){aG.pageIdx=aF?aE-1:0;aG.wrapped=true;return}},updateMatch:function(aH){var aG=ap.FIND_NOTFOUND;var aF=this.offset.wrapped;this.offset.wrapped=false;if(aH){var aE=this.selected.pageIdx;this.selected.pageIdx=this.offset.pageIdx;this.selected.matchIdx=this.offset.matchIdx;aG=aF?ap.FIND_WRAPPED:ap.FIND_FOUND;if(aE!==-1&&aE!==this.selected.pageIdx){this.updatePage(aE)}}this.updateUIState(aG,this.state.findPrevious);if(this.selected.pageIdx!==-1){this.updatePage(this.selected.pageIdx,true)}},updateUIState:function(aH,aG){var aE="";var aF="";if(aH===ap.FIND_FOUND||aH===ap.FIND_PENDING){return}switch(aH){case ap.FIND_FOUND:aE=this.pdfPageSource.pdfJsPlugin.wp.msg("search.message.found");break;case ap.FIND_PENDING:aE=this.pdfPageSource.pdfJsPlugin.wp.msg("search.message.pending");break;case ap.FIND_NOTFOUND:aE=this.pdfPageSource.pdfJsPlugin.wp.msg("search.message.notfound");break;case ap.FIND_WRAPPED:if(aG){aE=this.pdfPageSource.pdfJsPlugin.wp.msg("search.message.wrapped.bottom")}else{aE=this.pdfPageSource.pdfJsPlugin.wp.msg("search.message.wrapped.top")}break}Alfresco.util.PopupManager.displayMessage({text:aE})}}})();