var $grid2Out="";var $Filter2Outgoing="/share/proxy/alfresco/documents/search-regestry-outgoing?q_state="+encodeURI(encodeURI("Активные"));var groupOutgoing=null;var contragentPerson;function show2Out(){require(["jquery","pqgrid","pqselect","jquery-ui.datepicker-ru"],function(b){Alfresco.util.Ajax.request({method:"GET",url:Alfresco.constants.PROXY_URI+"groupPermision?user="+Alfresco.constants.USERNAME+"&group=ALFRESCO_ADMINISTRATORS",successCallback:{fn:function a(c){var d=c.json.result=="true";if(!d){Alfresco.util.Ajax.request({method:"GET",url:Alfresco.constants.PROXY_URI+"groupPermision?user="+Alfresco.constants.USERNAME+"&group=EEO",successCallback:{fn:function e(f){var h=f.json.result=="true";if(!h){Alfresco.util.Ajax.request({method:"GET",url:Alfresco.constants.PROXY_URI+"groupPermision?user="+Alfresco.constants.USERNAME+"&group=CLERK",successCallback:{fn:function g(i){var j=i.json.result=="true";create2Out(j?1:0,0)},scope:this}})}else{create2Out(1,0)}}}})}else{create2Out(1,1)}},scope:this}})})}function create2Out(c,a){$("#tabs").tabs("option","disabled",-1);var e=[];var b=[{"Активные":"Активные"},{"Черновик":"Черновик"},{"Зарегистрирован":"Зарегистрирован"},{"На исполнении":"На исполнении"},{"В архиве":"В архиве"},{"На согласовании":"На согласовании"},{"На подписании":"На подписании"},{"Согласован":"Согласован"},{"На регистрации":"На регистрации"},{"На доработке":"На доработке"},{"Все":"Все"}];var d=[];if(c){d.push({title:"<input type='checkbox' id='selAllOutgoing' onclick='selAllOutgoin()'>",dataIndx:"sel",width:30,align:"center",type:"checkBoxSelection",cls:"ui-state-default",resizable:false,sortable:false})}d.push({title:"nodeRef",width:100,dataType:"string",dataIndx:"nodeRef",hidden:true},{title:"Файл",dataType:"string",dataIndx:"fileExists"},{title:"Рег. номер",minWidth:80,dataType:"string",dataIndx:"btl-document:regNumber",filter:{type:"textbox",condition:"contain",listeners:["change"]}},{title:"Дата регистрации",minWidth:160,width:160,dataType:dateType,dataIndx:"btl-document:regDate",filter:{type:"textbox",condition:"between",init:pqDatePicker,listeners:["change"]}},{title:"Подписант",width:120,dataType:"string",dataIndx:"btl-outgoing:signer-login",filter:{type:"select",style:"height:32px;",condition:"equal",options:document.emploeeDoc,prepend:{"":""},listeners:["change"],init:function(){$(this).pqSelect({singlePlaceholder:"Все",searchRule:"contain",width:"100%"})},}},{title:"Исполнитель",width:120,dataType:"string",dataIndx:"btl-document:author-login",filter:{type:"select",style:"height:32px;",condition:"equal",options:document.emploeeDoc,prepend:{"":""},listeners:["change"],init:function(){$(this).pqSelect({singlePlaceholder:"Все",searchRule:"contain",width:"100%"})},}},{title:"Контрагент",minWidth:160,width:160,dataType:"string",dataIndx:"btl-outgoing:contragentUnit-ref",cls:"just",filter:{type:"select",condition:"contain",options:document.organizations,prepend:{"":""},listeners:["change"],init:function(){$(this).pqSelect({singlePlaceholder:"Все",searchRule:"begin",width:"100%",url:"/share/proxy/alfresco/filters/association?type=btl-contr:contractor-folder&s_field=name&field=name"})}}},{title:"contragentNodeRef",dataIndx:"contragentNodeRef",hidden:true},{title:"Кому",minWidth:120,width:120,dataType:"string",dataIndx:"btl-outgoing:contragentPerson-ref",cls:"just",filter:{type:"select",condition:"equal",options:[],prepend:{"":""},listeners:["change"],init:function(h){$(this).pqSelect({singlePlaceholder:"Все",searchRule:"begin",width:"100%",url:"/share/proxy/alfresco/filters/association?type=btl-person:person-content&s_field=fio&field=fio",urlItem:"/share/proxy/alfresco/picker/associationItem?type=btl-person:person-content&field=fio",value:h.column.filter.value})}}},{title:"В ответ на",minWidth:100,dataType:"string",dataIndx:"btl-document:responseTo-content",filter:{type:"textbox",condition:"contain",listeners:["change"]}},{title:"contragentPersonNodeRef",dataIndx:"contragentPersonNodeRef",hidden:true},{title:"Содержание",width:300,dataType:"string",dataIndx:"btl-document:content",filter:{type:"textbox",condition:"contain",listeners:["change"]}},{title:"Проект",minWidth:160,dataType:"string",dataIndx:"btl-document:project-content",cls:"just",filter:{type:"textbox",condition:"contain",listeners:["change"]}},{title:"Состояние",minWidth:160,width:160,dataType:"string",dataIndx:"state",style:"height:32px;",prepend:{"":""},filter:{type:"select",style:"height:32px;",condition:"equal",options:b,listeners:["change"],init:function(){$(this).pqSelect({singlePlaceholder:"Активные",searchRule:"contain",width:"100%"})},}},{title:"Тип документа",minWidth:130,dataType:"string",dataIndx:"btl-document:docType-ref",filter:{type:"select",condition:"equal",options:typedocOut.result,prepend:{"":""},listeners:["change"],init:function(){$(this).pqSelect({singlePlaceholder:"Все",searchRule:"contain",width:"100%"})}}},{title:"Резолюции",minWidth:130,dataType:"string",dataIndx:"nameTask"});var g={location:"remote",sorting:"local",dataType:"JSON",method:"GET",url:$Filter2Outgoing+"&format=json",getData:function(h){$grid2Out.pqGrid("showLoading");return{curPage:h.curPage,totalRecords:h.totalRecords,data:h.items}}};var f={selectionModel:{type:"none",subtype:"incr",cbHeader:false,cbAll:true},showTop:true,showHeader:true,showTitle:true,flexHeight:true,flexWidth:true,dataModel:g,collapsible:false,pageModel:{type:"remote",rPP:100,strRpp:"{0}",rPPOptions:[25,50,100]},colModel:d,filterModel:{on:true,mode:"AND",header:true},editable:false,columnBorders:true,width:"100%",height:600,beforeFilter:function(h,i){$grid2Out.pqGrid("option","pageModel.curPage",1)},create:function(i){var h=$(this),j=h.find(".pq-grid-bottom").find(".pq-pager");if(j&&j.length){j=j.detach();h.find(".pq-grid-top").append(j)}}};f.title="<button type='button' onclick='backHome()' class='ui-corner-all  ui-button ui-widget ui-state-default ui-button-text-icon-primary'";f.title+="role='button'><span class='ui-button-icon-primary ui-icon ui-icon-home'></span><span class='ui-button-text'>Домой</span></button>";f.title+="<span style='margin-left: 10px ; margin-bottom: -5px' class='pq-separator '></span>";f.title+="<button type='button'  style='margin-left: 10px' onclick='addDocOutgoin()' class='ui-corner-all  ui-button ui-widget ui-state-default ui-button-text-icon-primary'";f.title+="role='button'><span class='ui-button-icon-primary ui-icon ui-icon-plus'></span><span class='ui-button-text'>Создать</span></button>";if(c==1){f.title+="<button type='button'  style='margin-left: 5px'  onclick='toArchOutgoin()' class='ui-corner-all  ui-button ui-widget ui-state-default ui-button-text-icon-primary'";f.title+="role='button'><span class='ui-button-icon-primary ui-icon ui-icon-cancel'></span><span class='ui-button-text'>В архив</span></button>"}if(a==1){f.title+="<button type='button'  style='margin-left: 5px'  onclick='deleteOut()' class='ui-corner-all  ui-button ui-widget ui-state-default ui-button-text-icon-primary'";f.title+="role='button'><span class='ui-button-icon-primary ui-icon ui-icon-cancel'></span><span class='ui-button-text'>Удалить</span></button>"}f.title+="<button type='button'  style='margin-left: 10px' onclick='prnOutgoin()' class='ui-corner-all  ui-button ui-widget ui-state-default ui-button-text-icon-primary'";f.title+="role='button'><span class='ui-button-icon-primary ui-icon ui-icon-print'></span><span class='ui-button-text'>Печать</span></button>";f.toolbar={items:[{type:"<span>Группировка: </span>"},{type:"select",cls:"combo-pg fGroupOut",prepend:{"":""},options:["Контрагент","Состояние","Тип документа"],listeners:[{change:function(h){if($grid2Out.pqGrid("option","groupModel")!=null){$grid2Out.pqGrid("option","groupModel.collapsed",[false,false,false]);$grid2Out.pqGrid("refreshView")}switch($(this).val()){case"Состояние":groupOutgoing="state";break;case"Тип документа":groupOutgoing="btl-document:docType-ref";break;case"Контрагент":groupOutgoing="btl-outgoing:contragentUnit-ref";break;default:groupOutgoing=null}var i=null;if(groupOutgoing!=null){i={dataIndx:[groupOutgoing],collapsed:[true],title:["<b style='font-weight:bold;'>{0} ({1})</b>","{0} - {1}"],dir:["up","down"]}}$grid2Out.pqGrid("option","groupModel",i);$grid2Out.pqGrid("refreshDataAndView")}}]},{type:'<span style="margin-left: 7px"></span>'},{type:"button",label:"Очистить",listeners:[{click:function(h){clearDocFilter($grid2Out)}}],icon:"ui-icon-cancel"}]};$grid2Out=$("#grid_2outgoing").pqGrid(f);$grid2Out.pqGrid({rowDblClick:function(h,i){openModalEdit(i.rowData.nodeRef,$grid2Out)}});$grid2Out.pqGrid({rowRightClick:function(i,j){var k=document.getElementById("contextmenu");k.style.display="block";x=i.pageX;y=i.pageY;k.style.left=x+"px";k.style.top=y+"px";var h=document.getElementById("menuItemCreateCopy");h.nodeRef=j.rowData.nodeRef;h.onclick=function(){var l=document.getElementById("contextmenu");l.style.display="";addDocOutgoinCreate(this.nodeRef)};return false}});$grid2Out.one("pqgridload",function(h,i){$("#tabs").tabs("option","disabled",-1);$grid2Out.pqGrid("refreshHeader")});$(".fGroupOut").pqSelect({singlePlaceholder:"Нет",width:"150px",search:"false"})}document.onclick=function(){document.getElementById("contextmenu").style.display=""};function selAllOutgoin(){require(["jquery"],function(a){if(a("#selAllOutgoing").prop("checked")){a("#selAllOutgoing").prop("checked",false);$grid2Out.pqGrid("selection",{type:"row",all:"all",method:"removeAll"})}else{a("#selAllOutgoing").attr("checked","checked");a("#selAllOutgoing").prop("checked",true);$grid2Out.pqGrid("selection",{type:"row",all:"all",method:"selectAll"})}})}function toArchOutgoin(){var a=window.confirm("Вы действительно хотите изменить статус у выбранных документов?");if(a){var b=$grid2Out.pqGrid("option","dataModel.data");$grid2Out.pqGrid("showLoading");$.each(b,function(c,d){if(d.sel==true){Alfresco.util.Ajax.jsonPost({url:Alfresco.constants.PROXY_URI+"taskDocAction",dataObj:{nodeRef:d.nodeRef,action:"docInArhive",},successCallback:{fn:function(e){}}})}});$grid2Out.pqGrid("hideLoading");$grid2Out.pqGrid("refreshDataAndView");$grid2Out.pqGrid({flexHeight:true})}}function deleteOut(){deleteSelected($grid2Out,"Вы действительно хотите удалить выбранные документы?")}function clearOutDocFilter(){$Filter2Outgoing="/share/proxy/alfresco/documents/search-regestry-out?q_state="+encodeURI(encodeURI("Активные"));$grid2Out.pqGrid("destroy");show2Out()}function filterOutgoing(){require(["jquery"],function($){var paramSearch="/share/proxy/alfresco/documents/search-regestry-out";fieldVal=$("#stateOut").val();if(fieldVal!==""){paramSearch=paramSearch+"?q_state="+encodeURI(encodeURI(fieldVal))}fieldVal=$("#executorOut-cntrl").attr("sub_info");if(fieldVal){var obj=eval("("+fieldVal+")");paramSearch=paramSearch+"&q_autor="+obj.nodeRef}fieldVal=$("#senderOut-cntrl").attr("sub_info");if(fieldVal){var obj=eval("("+fieldVal+")");paramSearch=paramSearch+"&q_sender="+obj.nodeRef}$Filter2Outgoing=paramSearch;paramSearch+="&format=json";exeFilter(paramSearch,groupOutgoing,$grid2Out)})}require(["jquery","combobox"],function(a){a(document).ready(function(){a("#stateOut").ajaxComboBox("/share/proxy/alfresco/documents/state-doc-out?field=name",{db_table:"nation",lang:"en",button_img:"/share/res/js/lib/combobox/btn.png",bind_to:"foo",sub_info:true,instance:true});a("#stateOut").val("Активные");a(".ac_subinfo").css("display","none")})});require(["jquery"],function(a){a("#contentOut").keyup(function(b){if(b.keyCode==13){filterOutgoing()}});a("#stateOut").keyup(function(b){if(b.keyCode==13){filterOutgoing()}});a("#clearFiltersOut").click(function(){clearOutDocFilter()});a("#out_group").change(function(){switch(a("#out_group").val()){case"Контрагент":groupOutgoing="contragent";break;case"Состояние":groupOutgoing="state";break;case"Тип документа":groupOutgoing="docType";break;default:groupOutgoing=null}exeFilter($Filter2Outgoing+"&format=json",groupOutgoing,$grid2Out)})});function prnOutgoin(){var a="/share/proxy/alfresco/documents/search-regestry-out?q_state="+encodeURI(encodeURI("Активные"));window.open(a+"&format=html&q_viewType=1"+prepareLocalFilter($grid2Out),"_blank")}function prepareLocalFilterOut(){var d="";var c="";var b="";var a=$grid2Out.pqGrid("option","dataModel");if(a.data){c=$grid2Out.pqGrid("getColumn",{dataIndx:"contragent"});b=c.filter;if(typeof b.value!="undefined"&&b.value!=""){d+="&q_executionOrganization="+a.data[0].contragentNodeRef}c=$grid2Out.pqGrid("getColumn",{dataIndx:"contragentPerson"});b=c.filter;if(typeof b.value!="undefined"&&b.value!=""){d+="&q_recipient="+a.data[0].contragentPersonNodeRef}return d}else{return 1}}function get2ContragentPerson(){require(["jquery"],function(e){var a="";var d=$grid2Out.pqGrid("getColumn",{dataIndx:"btl-outgoing:contragentUnit-ref"});var c=d.filter;c.cache=null;var b="/share/proxy/alfresco/documents/search-regestry-person?extra=PARENT:'"+c.value+"'";e.ajax({url:b,success:function(g){if(g.result.length!=0){e('div[name="btl-outgoing:contragentPerson-ref"]').css("display","block");d=$grid2Out.pqGrid("getColumn",{dataIndx:"btl-outgoing:contragentPerson-ref"});c=d.filter;c.cache=null;c.options=g.result;$grid2Out.pqGrid("refreshHeader");contragentPerson.pqSelect("enable");contragentPerson.pqSelect({singlePlaceholder:"Все",searchRule:"contain",width:"100%"});contragentPerson.pqSelect("refresh")}else{var f=$grid2Out.pqGrid("getColModel");delete f[8].filter.value;delete f[8].filter.cache;delete f[8].filter.options;contragentPerson.pqSelect("disable");contragentPerson.pqSelect({singlePlaceholder:"Выберите контрагента",searchRule:"contain",width:"100%"});$grid2Out.pqGrid("refreshDataAndView")}}})})}require(["jquery"],function(a){a(document).ready(function(){a("#li_tab12").click(function(){if($grid2Out==""){show2Out($Filter2Outgoing+"&format=json")}})})});