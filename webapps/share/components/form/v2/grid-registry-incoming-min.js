var $grid2Incomming="";function show2Incomming(){require(["jquery","pqgrid","pqselect","jquery-ui.datepicker-ru"],function(){Alfresco.util.Ajax.request({method:"GET",url:Alfresco.constants.PROXY_URI+"v2/groupPermission?username="+Alfresco.constants.USERNAME,successCallback:{fn:function(h){var e=h.json.groups;var g=e.indexOf("GROUP_ALFRESCO_ADMINISTRATORS")!==-1;var i=g||e.indexOf("GROUP_EEO")!==-1||e.indexOf("GROUP_CLERK")!==-1;var f=g||e.indexOf("GROUP_Пользователи СЭД")!==-1;createGrid2Incomming(i,g,f)},scope:this}})})}function createGrid2Incomming(l,i,h){var e=getDefaultPq();var g=[{"Активные":"Активные"},{"Проекты документов":"Проекты документов"},{"Черновик":"Черновик"},{"Зарегистрирован":"Зарегистрирован"},{"На рассмотрении":"На рассмотрении"},{"На исполнении":"На исполнении"},{"Исполнен":"Исполнен"},{"На регистрации":"На регистрации"},{"В архиве":"В архиве"}];if(IDViewReport!=0){g.push({"Дополнительно":"Дополнительно"});g.push({"На исполнении без резолюций":"На исполнении без резолюций"});g.push({"Для списания в архив":"Для списания в архив"});g.push({"Исполнен с незавершенными резолюциями":"Исполнен с незавершенными резолюциями"})}var j=[{title:"regJournalRef",dataType:"string",dataIndx:"regJournalFilter",hidden:true},{title:"executorID",dataType:"string",dataIndx:"btl-document:task-executor-login",hidden:true},{title:"ActualExecutorID",dataType:"string",dataIndx:"btl-document:task-actual-executor-login",hidden:true},{title:"Текущий исполнитель",dataType:"string",dataIndx:"actualExecutor",hidden:true},{title:"Исполнитель",dataType:"string",dataIndx:"executor",hidden:true},{title:"nodeRef",dataType:"string",dataIndx:"nodeRef",hidden:true},{title:"Файл",width:50,dataType:"string",dataIndx:"fileExists"},{title:"Рег. номер",width:100,dataType:"string",dataIndx:"btl-document:reg-info",filter:{type:"textbox",condition:"contain",listeners:["change"]}},{title:"Дата регистрации",width:140,dataType:dateType,dataIndx:"btl-document:regDate",filter:{type:"textbox",condition:"between",init:pqDatePicker,listeners:["change"]}},{title:"Исходящий номер",width:100,dataType:"string",dataIndx:"btl-incomming:outgoingNumber",filter:{type:"textbox",condition:"contain",listeners:["change"]}},{title:"Организация",width:200,dataType:"string",dataIndx:"btl-incomming:contragentUnit-ref",cls:"just",filter:{type:"select",condition:"equal",options:[],prepend:{"":""},listeners:["change"],init:function(m){$(this).pqSelect({singlePlaceholder:"Все",searchRule:"begin",width:"100%",url:"/share/proxy/alfresco/filters/association?type=btl-contr:contractor-folder&s_field=name&field=name",urlItem:"/share/proxy/alfresco/picker/associationItem?type=btl-contr:contractor-folder&field=name",value:m.column.filter.value})}}},{title:"Подписант от контрагента",width:120,dataType:"string",dataIndx:"btl-incomming:contragentPerson-ref",cls:"just",filter:{type:"select",condition:"equal",options:[],prepend:{"":""},listeners:["change"],init:function(m){$(this).pqSelect({singlePlaceholder:"Все",searchRule:"begin",width:"100%",url:"/share/proxy/alfresco/filters/association?type=btl-person:person-content&s_field=fio&field=fio",urlItem:"/share/proxy/alfresco/picker/associationItem?type=btl-person:person-content&field=fio",value:m.column.filter.value})}}},{title:"В ответ на",width:100,dataType:"string",dataIndx:"btl-document:responseTo-content"},{title:"Содержание",width:300,dataType:"string",dataIndx:"btl-document:content",cls:"just",filter:{type:"textbox",condition:"contain",listeners:["change"]}},{title:"Проект",width:150,dataType:"string",dataIndx:"btl-document:project-content",cls:"just",filter:{type:"textbox",condition:"contain",listeners:["change"]}},{title:"Состояние",width:150,dataType:"string",dataIndx:"btl-document:state",filter:{type:"select",style:"height:32px;",condition:"equal",options:g,listeners:["change"],prepend:{"":""},value:"Активные",init:function(){$(this).pqSelect({singlePlaceholder:"Все",search:false,width:"100%"});formatStateFilter()},}},{title:"Кому",width:120,dataType:"string",dataIndx:"btl-incomming:recipient-login",filter:{type:"select",condition:"equal",options:document.emploeeDoc,prepend:{"":""},listeners:["change"],init:function(){$(this).pqSelect({singlePlaceholder:"Все",searchRule:"begin",width:"100%"})},}},{title:"Тип документа",width:100,dataType:"string",dataIndx:"btl-document:docType-ref",filter:{type:"select",condition:"equal",options:typedocIncomming.result,prepend:{"":""},listeners:["change"],init:function(){$(this).pqSelect({singlePlaceholder:"Все",searchRule:"contain",width:"100%"})}}},{title:"Резолюции",width:150,dataType:"string",dataIndx:"nameTask",sortable:false}];if(l){j.unshift({title:"<input type='checkbox' onclick='selectAllInGrid(this, $grid2Incomming)'>",dataIndx:"sel",width:30,align:"center",type:"checkBoxSelection",cls:"ui-state-default",resizable:false,sortable:false})}var k={location:"remote",sorting:"remote",dataType:"JSON",method:"GET",data:e.dataCache,sortIndx:"btl-document:reg-info",sortDir:"down",getUrl:function(m){if($(this).pqGrid("option","isInit2")!==true){$(this).pqGrid("option","isInit2",true);$(this).pqGrid("option","currentCountId","f2IncomingCurrentCount");$(this).pqGrid("option","totalCountId","f2IncomingTotalCount");$(this).pqGrid("option","groupSelectSelector","select.f2IncomingGroup");$(this).pqGrid("option","copyCreateFn",addDocIncommingCreate);$(this).pqGrid("option","dataUrl","/share/proxy/alfresco/documents/v2/search-registry-incoming");$(this).pqGrid("option","additionalFiltersSelector","select.f2Incomming");addPaginationBlock($(this))}return getUrl2($(this),e)},getData:function(m){return getData2($(this),m,e)},error:function(m,o,n){error2(m,o,n)}};var f={selectionModel:{type:"none",subtype:"incr",cbHeader:false,cbAll:true},dataModel:k,collapsible:false,editable:false,colModel:j,filterModel:{on:true,mode:"AND",header:true},width:"100%",height:835,beforeSort:function(m,n){beforeSort2($(this))},beforeFilter:function(m,n){beforeFilter2($(this))},beforeTableView:function(m,n){beforeTableView2(n,e,$(this))},rowRightClick:function(m,n){return rowRightClick2(m,n,$(this).pqGrid("option","copyCreateFn"))},rowDblClick:function(m,n){openModal2Incomminging(n.rowData.nodeRef)}};f.title="";if(h){f.title+="<button type='button' onclick='addDoc2Incomming()' class='ui-corner-all  ui-button ui-widget ui-state-default ui-button-text-icon-primary' role='button'><span class='ui-button-icon-primary ui-icon ui-icon-plus'></span><span class='ui-button-text'>Создать</span></button>"}if(l){f.title+="<button type='button'  style='margin-left: 5px'  onclick='toArchIncomming2()' class='ui-corner-all  ui-button ui-widget ui-state-default ui-button-text-icon-primary' role='button'><span class='ui-button-icon-primary ui-icon ui-icon-cancel'></span><span class='ui-button-text'>В архив</span></button>"}if(i){f.title+="<button type='button'  style='margin-left: 5px'  onclick='deleteIncomming()' class='ui-corner-all  ui-button ui-widget ui-state-default ui-button-text-icon-primary' role='button'><span class='ui-button-icon-primary ui-icon ui-icon-cancel'></span><span class='ui-button-text'>Удалить</span></button>"}f.title+="<button type='button'  style='margin-left: 5px'  onclick='uploadIncommingFiles()' class='ui-corner-all  ui-button ui-widget ui-state-default ui-button-text-icon-primary' role='button'><span class='ui-button-icon-primary ui-icon ui-icon-cancel'></span><span class='ui-button-text'>Скачать вложения</span></button>";f.title+="<span style='margin-left: 10px ; margin-bottom: -5px' class='pq-separator '></span>";f.title+="<button type='button'  style='margin-left: 10px' onclick='prnIncommingInt()' class='ui-corner-all  ui-button ui-widget ui-state-default ui-button-text-icon-primary' role='button'><span class='ui-button-icon-primary ui-icon ui-icon-print'></span><span class='ui-button-text'>Печать</span></button>";if(l){f.title+="<button type='button'  style='margin-left: 5px'  onclick='printNotExe()' class='ui-corner-all  ui-button ui-widget ui-state-default ui-button-text-icon-primary' role='button'><span class='ui-button-icon-primary ui-icon ui-icon-print'></span><span class='ui-button-text'>Неисполненные документы</span></button>";f.title+="<button type='button'  style='margin-left: 5px'  onclick='showA()' class='ui-corner-all  ui-button ui-widget ui-state-default ui-button-text-icon-primary' role='button'><span class='ui-button-icon-primary ui-icon ui-icon-print'></span><span class='ui-button-text'>Отчет по входящим</span></button>"}if(i){f.title+="<button type='button'  style='margin-left: 5px'  onclick='reportSearchKidJasper()' class='ui-corner-all  ui-button ui-widget ui-state-default ui-button-text-icon-primary' role='button'><span class='ui-button-icon-primary ui-icon ui-icon-print'></span><span class='ui-button-text'>Неисполненные документы(J)</span></button>"}f.toolbar={items:[{type:"<span>Группировка: </span>"},{type:"select",cls:"combo-pg f2IncomingGroup",prepend:{"":""},options:["Организация","Подписант от контрагента","Журнал регистрации","Состояние","Кому","Тип документа","Текущий исполнитель","Ответственный исполнитель"],listeners:[{change:function(m){var n;switch($(this).val()){case"Организация":n="btl-incomming:contragentUnit-ref";break;case"Журнал регистрации":n="btl-document:reg-journal";break;case"Подписант от контрагента":n="btl-incomming:contragentPerson-ref";break;case"Состояние":n="btl-document:state";break;case"Кому":n="btl-incomming:recipient-login";break;case"Тип документа":n="btl-document:docType-ref";break;case"Текущий исполнитель":n="actualExecutor";break;case"Ответственный исполнитель":n="executor";break;default:n=null}localGroup(n,$grid2Incomming,e)}}]},{type:"separator"},{type:"<span>Ответственный исполнитель: </span>"},{type:"select",cls:"combo-pg f2Incomming",options:document.emploeeDoc,prepend:{"":""},id:"combo-pg-incomming",listeners:[{change:function(m){var n=[{dataIndx:"btl-document:task-executor-login",condition:"contain",value:$(this).val()}];$grid2Incomming.pqGrid("filter",{oper:"add",data:n})}}]},{type:'<span style="margin-left: 7px">Текущий исполнитель: </span>'},{type:"select",cls:"combo-pg f2Incomming",options:document.emploeeDoc,prepend:{"":""},listeners:[{change:function(m){var n=[{dataIndx:"btl-document:task-actual-executor-login",condition:"contain",value:$(this).val()}];$grid2Incomming.pqGrid("filter",{oper:"add",data:n})}}]},{type:'<span style="margin-left: 7px">Журнал регистрации: </span>'},{type:"select",cls:"combo-pg f2Incomming",options:document.rjsFilterData["0"],prepend:{"":""},listeners:[{change:function(m){var n=[{dataIndx:"regJournalFilter",condition:"equal",value:$(this).val()}];$grid2Incomming.pqGrid("filter",{oper:"add",data:n})}}]},{type:'<span style="margin-left: 7px"></span>'},{type:"button",label:"Очистить",listeners:[{click:function(m){clearGridFilters($grid2Incomming,["select.f2Incomming"])}}],icon:"ui-icon-cancel"},{type:'<span style="margin-left: 7px"></span>'},{type:"button",cls:"registry-refresh-btn",label:"Обновить",listeners:[{click:function(m){refreshDataAndView($grid2Incomming)}}]}]};$grid2Incomming=$("#grid_2_incomming").pqGrid(f);$(".f2Incomming").pqSelect({singlePlaceholder:"Все",searchRule:"begin",width:"150px"});$(".f2IncomingGroup").pqSelect({singlePlaceholder:"Нет",width:"150px",search:"false"})}function prnIncommingInt(){var e=$grid2Incomming;var f=e.pqGrid("option","dataUrl")+".html?"+getGridParamsStr(e,{pq_sort:JSON.stringify(getSort(e.pqGrid("option","dataModel")))});window.open(f,"_blank")}require(["jquery"],function(e){e(document).ready(function(){e("#li_tab8").click(function(){if($grid2Incomming==""){show2Incomming()}})})});function openModal2Incomminging(e){document.frameSave=function(){document.getElementById(modalWindowShadow).style.display="none";document.body.style.overflow="";$grid2Incomming.pqGrid("option","isResetData",true);$grid2Incomming.pqGrid("refreshDataAndView")};document.frameCancel=function(){document.getElementById(modalWindowShadow).style.display="none";document.body.style.overflow="";$grid2Incomming.pqGrid("option","isResetData",true);$grid2Incomming.pqGrid("refreshDataAndView")};var g=document.getElementById(modalWindowShadow);g.style.display="block";var f=document.getElementById(frameBackground);f.innerHTML='<iframe id="viewDocFrame" style="border-radius: 4px;" width="100%" height="100%" src="/share/page/btl-edit-metadata?nodeRef='+e+'&frame=true">'}function toArchIncomming2(){var e=window.confirm("Вы действительно хотите изменить статус у выбранных документов?");if(e){var f=$grid2Incomming.pqGrid("option","dataModel.data");$grid2Incomming.pqGrid("showLoading");$.each(f,function(g,h){if(h.sel==true){Alfresco.util.Ajax.jsonPost({url:Alfresco.constants.PROXY_URI+"taskDocAction",dataObj:{nodeRef:h.nodeRef,action:"docInArhive",},successCallback:{fn:function(i){}}})}});$grid2Incomming.pqGrid("hideLoading");$grid2Incomming.pqGrid("refreshDataAndView")}}function uploadIncommingFiles(){var f=$grid2Incomming.pqGrid("option","dataModel.data");$grid2Incomming.pqGrid("showLoading");var e=[];$.each(f,function(g,h){if(h.sel==true){e.push(h.nodeRef)}});Alfresco.util.Ajax.jsonPost({url:"/share/proxy/alfresco/document/downloadFilesDoc",dataObj:{nodes:e},successCallback:{fn:function(g){window.open(g.json.url,"_blank")}}});$grid2Incomming.pqGrid("hideLoading")}function deleteIncomming(){deleteSelected($grid2Incomming,"Вы действительно хотите удалить выбранные документы?")}function printNotExe(){window.open("/share/proxy/alfresco/documents/search-regestry-kid","_blank")}require(["jquery","pqgrid"],function(e){e("#searchKIDexe").click(function(){var g=e("#emplReport").val();var h=Alfresco.constants.PROXY_URI+"documents/report-kid?q_type=1";if(g&&g!=""){h+="&emplReport="+g}var f="";f=e("#DateKID").val();if(f!==""){h=h+"&q_dateFrom="+f}f=e("#DateKIDTo").val();if(f!==""){h=h+"&q_dateTo="+f}if(e("#finishTaskIn").prop("checked")==true){h=h+"&q_finishTask=1"}if(e("#firstTaskLevel").prop("checked")==true){h=h+"&q_firstTaskLevel=1"}if(e("#taskControl").prop("checked")==true){h=h+"&q_taskControl=1"}if(e("#dateExe").prop("checked")==true){h=h+"&q_dateExe=1"}window.open(h,"_blank")})});function showA(){b.style.filter="alpha(opacity=80)";b.style.opacity=0.8;b.style.display="block";a.style.display="block";a.style.top="50%";a.style.left="50%";a.style.position="absolute";a.style.marginLeft="-100px";a.style.marginTop="-75px"}function hideA(){b.style.display="none";a.style.display="none"}require(["jquery","pqgrid"],function(e){e("#reportKIDJasperexe").click(function(){var h="";var g=e("#emplReportJ").val();if(g!=""){h+="&emplReport="+g}var f="";f=e("#DateKIDJ").val();if(f!==""){h=h+"&q_dateFrom="+f}f=e("#DateKIDToJ").val();if(f!==""){h=h+"&q_dateTo="+f}if(e("#finishTaskInJ").prop("checked")==true){h=h+"&q_finishTask=1"}if(e("#firstTaskLevelJ").prop("checked")==true){h=h+"&q_firstTaskLevel=1"}if(e("#taskControlJ").prop("checked")==true){h=h+"&q_taskControl=1"}if(e("#dateExeJ").prop("checked")==true){h=h+"&q_dateExe=1"}reportKidJasper(h)})});window.onload=function(){a=document.getElementById("a");b=document.getElementById("b");c=document.getElementById("c");d=document.getElementById("d")};function showReportKidJasper(){d.style.filter="alpha(opacity=80)";d.style.opacity=0.8;d.style.display="block";c.style.display="block";c.style.top="50%";c.style.left="50%";c.style.position="absolute";c.style.marginLeft="-100px";c.style.marginTop="-75px"}function hideReportKidJasper(){c.style.display="none";d.style.display="none"}function reportKidJasper(j){var i=Alfresco.constants.PROXY_URI+"documents/report-kid_jasper";var e=""+j;var f="Отчет по входящим";document.frameCancel=function(){document.getElementById(modalWindowShadow).style.display="none";document.body.style.overflow="";$grid2Incomming.pqGrid("refreshDataAndView")};var h=document.getElementById(modalWindowShadow);h.style.display="block";var g=document.getElementById(frameBackground);g.innerHTML='<iframe id="viewReportFrame" style="border-radius: 4px;" width="100%" height="100%" title="'+f+'" src="/share/page/arm/reportpreview?reportUrl='+encodeURIComponent(i)+"&reportParams="+encodeURIComponent(e)+"&reportTitle="+encodeURIComponent(f)+'">'}function reportSearchKidJasper(){var j=Alfresco.constants.PROXY_URI+"documents/search-regestry-kid_jasper";var f="";var g="Неисполненные документы";document.frameCancel=function(){document.getElementById(modalWindowShadow).style.display="none";document.body.style.overflow="";$grid2Incomming.pqGrid("refreshDataAndView")};var i=document.getElementById(modalWindowShadow);i.style.paddingTop="40px";i.style.display="block";var e=document.getElementsByClassName("closeButton");if(e.length>0){e[0].style.display="none"}var h=document.getElementById(frameBackground);h.innerHTML='<iframe id="viewReportFrame" style="border-radius: 4px;" width="100%" height="100%" title="'+g+'" src="/share/page/arm/reportpreview?reportUrl='+encodeURIComponent(j)+"&reportParams="+encodeURIComponent(f)+"&reportTitle="+encodeURIComponent(g)+'">'};