(function(){var Dom=YAHOO.util.Dom,Event=YAHOO.util.Event,Element=YAHOO.util.Element;Alfresco.FormUI=function FormUI_constructor(htmlId,parentId){Alfresco.FormUI.superclass.constructor.call(this,"Alfresco.FormUI",htmlId,["button","menu","container"]);this.parentId=parentId;this.buttons={};this.formsRuntime=null;this.eventGroup=htmlId;YAHOO.Bubbling.on("mandatoryControlValueUpdated",this.onMandatoryControlValueUpdated,this);YAHOO.Bubbling.on("registerValidationHandler",this.onRegisterValidationHandler,this);YAHOO.Bubbling.on("addSubmitElement",this.onAddSubmitElement,this);return this};YAHOO.extend(Alfresco.FormUI,Alfresco.component.Base,{options:{mode:"edit",enctype:"multipart/form-data",fields:[],fieldConstraints:[],arguments:{}},buttons:null,formsRuntime:null,isButtonPopUpClick:false,deleteButtonClick:function(){if(!confirm("Подтвердите удаление")){return}var fnFormLoaded=function(response){if(response.json.result=="ok"){window.location.replace("/share")}};var data={cardId:this.options.arguments.itemId};var dialog=new YAHOO.widget.SimpleDialog("delete_dialog_block_window",{width:"100%",height:"100%",x:0,y:0,modal:true,visible:false,draggable:false,zIndex:10});dialog.render(document.body);dialog.show();Alfresco.util.Ajax.request({url:"/share/proxy/alfresco/delete",dataObj:data,successCallback:{fn:fnFormLoaded,scope:this},scope:this,execScripts:true})},onButtonSubmitClick:function onButtonSubmitClick(){this.options.arguments.forceRedirect=true},onButtonSaveClick:function onButtonSaveClick(){this.options.arguments.forceRedirect=false},onButtonPopUpClick:function onButtonPopUpClick(){this.isButtonPopUpClick=true},onReady:function FormUI_onReady(){if(this.options.mode!=="view"){if(Dom.get(this.id+"-submit")!==null){this.buttons.submit=Alfresco.util.createYUIButton(this,"submit",null,{type:"submit"});Dom.get(this.id+"-submit-button").name="-"}if(this.buttons.submit){this.buttons.submit.on("click",this.onButtonSubmitClick.bind(this))}if(Dom.get(this.id+"-save")!==null){this.buttons.save=Alfresco.util.createYUIButton(this,"save",null,{type:"submit"});Dom.get(this.id+"-save-button").name="-"}if(this.buttons.save){this.buttons.save.on("click",this.onButtonSaveClick.bind(this))}if(Dom.get(this.id+"-savePopUpButton")!==null){this.buttons.savePopUpButton=Alfresco.util.createYUIButton(this,"savePopUpButton",null,{type:"submit"});Dom.get(this.id+"-savePopUpButton-button").name="-"}if(this.buttons.savePopUpButton){this.buttons.savePopUpButton.on("click",this.onButtonPopUpClick.bind(this))}if(Dom.get(this.id+"-reset")!==null){this.buttons.reset=Alfresco.util.createYUIButton(this,"reset",null,{type:"reset"});Dom.get(this.id+"-reset-button").name="-"}if(Dom.get(this.id+"-cancel")!==null){this.buttons.cancel=Alfresco.util.createYUIButton(this,"cancel",null);Dom.get(this.id+"-cancel-button").name="-"}if(Dom.get(this.id+"-delete")!==null){this.buttons.buttonDelete=Alfresco.util.createYUIButton(this,"delete",this.deleteButtonClick);Dom.get(this.id+"-delete-button").name="-"}YAHOO.Bubbling.fire("formContentReady",this);this.formsRuntime=new Alfresco.forms.Form(this.id);this.formsRuntime.setSubmitElements(this.buttons.submit);if(this.options.disableSubmitButton!=null&&this.options.disableSubmitButton==true){this.formsRuntime.setShowSubmitStateDynamically(true)}if(this.options.enctype==="application/json"){this.formsRuntime.setAJAXSubmit(true,{successCallback:{fn:this.onJsonPostSuccess,scope:this},failureCallback:{fn:this.onJsonPostFailure,scope:this}});this.formsRuntime.setSubmitAsJSON(true)}for(var f=0;f<this.options.fields.length;f++){var ff=this.options.fields[f],iconEl=Dom.get(this.parentId+"_"+ff.id+"-help-icon");if(iconEl){Alfresco.util.useAsButton(iconEl,this.toggleHelpText,ff.id,this)}}for(var c=0;c<this.options.fieldConstraints.length;c++){var fc=this.options.fieldConstraints[c];var events=fc.event.split(",");for(var e=0;e<events.length;e++){var trimmedEvent=events[e].replace(" ","");this.formsRuntime.addValidation(fc.fieldId,fc.handler,fc.params,trimmedEvent,fc.message)}}YAHOO.Bubbling.fire("beforeFormRuntimeInit",{eventGroup:this.eventGroup,component:this,runtime:this.formsRuntime});this.formsRuntime.init();YAHOO.Bubbling.fire("afterFormRuntimeInit",{eventGroup:this.eventGroup,component:this,runtime:this.formsRuntime})}},toggleHelpText:function FormUI_toggleHelpText(event,fieldId){Alfresco.util.toggleHelpText(this.parentId+"_"+fieldId+"-help")},onJsonPostSuccess:function FormUI_onJsonPostSuccess(response){responseText=JSON.parse(response.serverResponse.responseText);if(this.isButtonPopUpClick){document.getElementById("buttonCancel").click();if(this.options.arguments.fillField!=null&&this.options.arguments.fillField.length>0){var fnAssociationLoaded=function(response,p_formUI){var n=document.getElementById(this.options.arguments.fillField+"-val");n.value=eval("("+response.serverResponse.responseText+")").item};Alfresco.util.Ajax.request({url:"/share/proxy/alfresco/picker/associationItem?nodeRef="+responseText.persistedObject+this.options.arguments.fillFieldparams,successCallback:{fn:fnAssociationLoaded,scope:this},scope:this,execScripts:true});var n=document.getElementById(this.options.arguments.fillField);if(n){n.value=responseText.persistedObject}n=document.getElementById(this.options.arguments.fillField+"-added");if(n){n.value=responseText.persistedObject}return}}if(this.options.arguments.forceRedirect==true){if(this.options.arguments.redirect.length>0){window.location.assign(this.options.arguments.redirect)}else{if(window.parent.document!=document){window.location.reload()}else{window.location="/share"}}return}if(this.options.arguments.openEditForm==true){if(this.options.arguments.openModalForm==true){var modalEditDiv=Dom.get("modalWindow");if(modalEditDiv){var fnFormLoaded=function(response,p_formUI){modalEditDiv.innerHTML=response.serverResponse.responseText};var data={htmlid:"modalEditDiv_body",itemKind:"node",itemId:responseText.persistedObject,mode:"edit",submitType:"multipart",showCaption:true,showCancelButton:false,formUI:true,redirect:this.options.arguments.redirect,destination:""};Alfresco.util.Ajax.request({url:Alfresco.constants.URL_SERVICECONTEXT+"btlab/components/form",dataObj:data,successCallback:{fn:fnFormLoaded,scope:this},scope:this,execScripts:true});return}}if(this.options.arguments.forceRedirect==true){var modal=document.getElementById("modalWindowShadow");if(modal){modal.style.display="none"}}else{window.location.assign("/share/page/btl-edit-metadata?nodeRef="+responseText.persistedObject+"&redirect="+this.options.arguments.redirect)}return}if(this.options.arguments.fillField!=null&&this.options.arguments.fillField.length>0){var fnAssociationLoaded=function(response,p_formUI){var n=document.getElementById(this.options.arguments.fillField+"-val");n.value=eval("("+response.serverResponse.responseText+")").item};Alfresco.util.Ajax.request({url:"/share/proxy/alfresco/picker/associationItem?nodeRef="+responseText.persistedObject+this.options.arguments.fillFieldparams,successCallback:{fn:fnAssociationLoaded,scope:this},scope:this,execScripts:true});var n=document.getElementById(this.options.arguments.fillField);n.value=responseText.persistedObject;n=document.getElementById(this.options.arguments.fillField+"-added");n.value=responseText.persistedObject;return}},onJsonPostFailure:function FormUI_onJsonPostFailure(response){var errorMsg=this.msg("form.jsonsubmit.failed");if(response.json&&response.json.message){errorMsg=errorMsg+": "+response.json.message}Alfresco.util.PopupManager.displayPrompt({text:errorMsg})},onFormRefresh:function FormUI_onFormRefresh(layer,args){if(this.options.arguments){var itemKind=this.options.arguments.itemKind,itemId=this.options.arguments.itemId,formId=this.options.arguments.formId;if(itemKind&&itemId){var fnFormLoaded=function(response,p_formUI){Alfresco.util.populateHTML([p_formUI.parentId,response.serverResponse.responseText]);var formEl=Dom.get(p_formUI.parentId),me=this;if(formEl){Dom.getElementsByClassName("viewmode-value-date","span",formEl,function(){var showTime=Dom.getAttribute(this,"data-show-time");var dateFormat=(showTime=="false")?me.msg("date-format.defaultDateOnly"):me.msg("date-format.default");this.innerHTML=Alfresco.util.formatDate(Alfresco.util.fromISO8601(Dom.getAttribute(this,"data-date-iso8601")),dateFormat)})}};var data={htmlid:this.parentId,formUI:false,mode:this.options.mode,itemKind:itemKind,itemId:itemId,formId:formId};Alfresco.util.Ajax.request({url:Alfresco.constants.URL_SERVICECONTEXT+"btlab/components/form",dataObj:data,successCallback:{fn:fnFormLoaded,obj:this,scope:this},scope:this,execScripts:true})}}},onMandatoryControlValueUpdated:function FormUI_onMandatoryControlValueUpdated(layer,args){if(this.formsRuntime){this.formsRuntime.validate()}},onRegisterValidationHandler:function FormUI_onRegisterValidationHandler(layer,args){if(this.formsRuntime){var validation=args[1];if(validation&&validation.fieldId&&validation.handler){this.formsRuntime.addValidation(validation.fieldId,validation.handler,validation.args,validation.when,validation.message)}}},onAddSubmitElement:function FormUI_onAddSubmitElement(layer,args){var submitElement=args[1];if(this.formsRuntime!=null){this.formsRuntime.addSubmitElement(submitElement)}}})})();Alfresco.util.updateMultiSelectListValue=function(f,a,g){var d=YUIDom.get(f);if(d!==null){var b=new Array();for(var c=0,e=d.options.length;c<e;c++){if(d.options[c].selected){b.push(d.options[c].value)}}YUIDom.get(a).value=b.join(",");if(g){YAHOO.Bubbling.fire("mandatoryControlValueUpdated",this)}}};Alfresco.util.toggleHelpText=function(b){var a=YUIDom.get(b);if(a){if(a.style.display!="block"){a.style.display="block"}else{a.style.display="none"}}};