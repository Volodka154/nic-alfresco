(function(a){if(typeof module==="object"&&typeof module.exports==="object"){a(require("jquery"),window,document)}else{a(jQuery,window,document)}}(function(c,b,a,d){c.fn.ajaxComboBox=function(g,f){var e=[];this.each(function(){e.push(new c.ajaxComboBox(this,g,f))});return(f!==d&&f.instance!==d&&f.instance)?c(e):this};c.ajaxComboBox=function(e,g,f){this.option=this._setOption(g,f);this._setMessage();this._setCssClass();this._setProp();this._setElem(e);this._setButtonAttrDefault();this._setInitRecord();this._ehButton();this._ehComboInput();this._ehWhole();this._ehTextArea();if(this.option.shorten_btn){this._findUrlToShorten(this)}};c.extend(c.ajaxComboBox.prototype,{_setOption:function(f,e){e=this._setOption1st(f,e);e=this._setOption2nd(e);return e},_setOption1st:function(f,e){return c.extend({source:f,lang:"en",plugin_type:"combobox",init_record:false,db_table:"tbl",field:"name",and_or:"AND",per_page:10,navi_num:5,primary_key:"id",button_img:'<svg class="octicon octicon-chevron-down" viewBox="0 0 10 16" version="1.1" aria-hidden="true"><path fill-rule="evenodd" d="M5 11L0 6l1.5-1.5L5 8.25 8.5 4.5 10 6z"></path></svg>',bind_to:false,navi_simple:false,sub_info:false,sub_as:{},show_field:"",hide_field:"",select_only:false,tags:false,shorten_btn:false,shorten_src:"dist/bitly.php",shorten_min:20,shorten_reg:false},e)},_setOption2nd:function(e){e.search_field=(e.search_field)?e.search_field:e.field;e.and_or=e.and_or.toUpperCase();e.hide_field=this._strToArray(e.hide_field);e.show_field=this._strToArray(e.show_field);e.search_field=this._strToArray(e.search_field);if(e.show_field[0]===""){e.show_field[0]="*"}e.order_by=(e.order_by===d)?e.search_field:e.order_by;e.order_by=this._setOrderbyOption(e.order_by,e.field);if(e.plugin_type=="textarea"){e.shorten_reg=this._setRegExpShort(e.shorten_reg,e.shorten_min)}if(e.tags){e.tags=this._setTagPattern(e)}return e},_strToArray:function(e){return e.replace(/[\s　]+/g,"").split(",")},_setRegExpShort:function(e,g){if(e){return e}var f="(?:^|[\\s|　\\[(<「『（【［＜〈《]+)";f+="(";f+="https:\\/\\/[^\\s|　\\])>」』）】］＞〉》]{"+(g-7)+",}";f+="|";f+="http:\\/\\/[^\\s|　\\])>」』）】］＞〉》]{"+(g-6)+",}";f+="|";f+="ftp:\\/\\/[^\\s|　\\])>」』）】］＞〉》]{"+(g-5)+",}";f+=")";return new RegExp(f,"g")},_setTagPattern:function(f){for(var e=0;e<f.tags.length;e++){f.tags[e]=this._setTagOptions(f,e);f.tags[e].pattern=this._setRegExpTag(f.tags[e].pattern,f.tags[e].space)}return f.tags},_setTagOptions:function(h,f){h.tags[f]=c.extend({space:[true,true],db_table:h.db_table,field:h.field,search_field:h.search_field,primary_key:h.primary_key,sub_info:h.sub_info,sub_as:h.sub_as,show_field:h.show_field,hide_field:h.hide_field},h.tags[f]);var e=["hide_field","show_field","search_field"];for(var g=0;g<e.length;g++){if(typeof h.tags[f][e[g]]!="object"){h.tags[f][e[g]]=this._strToArray(h.tags[f][e[g]])}}h.tags[f].order_by=(h.tags[f].order_by===d)?h.order_by:this._setOrderbyOption(h.tags[f].order_by,h.tags[f].field);return h.tags[f]},_setRegExpTag:function(g,f){var h=g[0].replace(/[\s\S]*/,this._escapeForReg);var e=g[1].replace(/[\s\S]*/,this._escapeForReg);return{left:g[0],right:g[1],reg_left:new RegExp(h+"((?:(?!"+h+"|"+e+")[^\\s　])*)$"),reg_right:new RegExp("^((?:(?!"+h+"|"+e+")[^\\s　])+)"),space_left:new RegExp("^"+h+"$|[\\s　]+"+h+"$"),space_right:new RegExp("^$|^[\\s　]+"),comp_right:new RegExp("^"+e)}},_escapeForReg:function(e){return"\\u"+(65536+e.charCodeAt(0)).toString(16).slice(1)},_setOrderbyOption:function(f,j){var e=[];var h=[];if(typeof f=="object"){for(var g=0;g<f.length;g++){h=c.trim(f[g]).split(" ");e[g]=(h.length==2)?h:[h[0],"ASC"]}}else{h=c.trim(f).split(" ");e[0]=(h.length==2)?h:(h[0].match(/^(ASC|DESC)$/i))?[j,h[0]]:[h[0],"ASC"]}return e},_setMessage:function(){var e;switch(this.option.lang){case"de":e={add_btn:"Hinzufügen-Button",add_title:"Box hinzufügen",del_btn:"Löschen-Button",del_title:"Box löschen",next:"Nächsten",next_title:"Nächsten"+this.option.per_page+" (Pfeil-rechts)",prev:"Vorherigen",prev_title:"Vorherigen"+this.option.per_page+" (Pfeil-links)",first_title:"Ersten (Umschalt + Pfeil-links)",last_title:"Letzten (Umschalt + Pfeil-rechts)",get_all_btn:"alle (Pfeil-runter)",get_all_alt:"(Button)",close_btn:"Schließen (Tab)",close_alt:"(Button)",loading:"lade...",loading_alt:"(lade)",page_info:"num_page_top - num_page_end von cnt_whole",select_ng:"Achtung: Bitte wählen Sie aus der Liste aus.",select_ok:"OK : Richtig ausgewählt.",not_found:"nicht gefunden",ajax_error:"Bei der Verbindung zum Server ist ein Fehler aufgetreten. (ajax-combobox)"};break;case"en":e={add_btn:"Add button",add_title:"add a box",del_btn:"Del button",del_title:"delete a box",next:"Next",next_title:"Next"+this.option.per_page+" (Right key)",prev:"Prev",prev_title:"Prev"+this.option.per_page+" (Left key)",first_title:"First (Shift + Left key)",last_title:"Last (Shift + Right key)",get_all_btn:"Get All (Down key)",get_all_alt:"(button)",close_btn:"Close (Tab key)",close_alt:"(button)",loading:"loading...",loading_alt:"(loading)",page_info:"num_page_top - num_page_end of cnt_whole",select_ng:"Attention : Please choose from among the list.",select_ok:"OK : Correctly selected.",not_found:"not found",ajax_error:"An error occurred while connecting to server. (ajax-combobox)"};break;case"es":e={add_btn:"Agregar boton",add_title:"Agregar una opcion",del_btn:"Borrar boton",del_title:"Borrar una opcion",next:"Siguiente",next_title:"Proximas "+this.option.per_page+" (tecla derecha)",prev:"Anterior",prev_title:"Anteriores "+this.option.per_page+" (tecla izquierda)",first_title:"Primera (Shift + Left)",last_title:"Ultima (Shift + Right)",get_all_btn:"Ver todos (tecla abajo)",get_all_alt:"(boton)",close_btn:"Cerrar (tecla TAB)",close_alt:"(boton)",loading:"Cargando...",loading_alt:"(Cargando)",page_info:"num_page_top - num_page_end de cnt_whole",select_ng:"Atencion: Elija una opcion de la lista.",select_ok:"OK: Correctamente seleccionado.",not_found:"no encuentre",ajax_error:"Un error ocurrió mientras conectando al servidor. (ajax-combobox)"};break;case"pt-br":e={add_btn:"Adicionar botão",add_title:"Adicionar uma caixa",del_btn:"Apagar botão",del_title:"Apagar uma caixa",next:"Próxima",next_title:"Próxima "+this.option.per_page+" (tecla direita)",prev:"Anterior",prev_title:"Anterior "+this.option.per_page+" (tecla esquerda)",first_title:"Primeira (Shift + Left)",last_title:"Última (Shift + Right)",get_all_btn:"Ver todos (Seta para baixo)",get_all_alt:"(botão)",close_btn:"Fechar (tecla TAB)",close_alt:"(botão)",loading:"Carregando...",loading_alt:"(Carregando)",page_info:"num_page_top - num_page_end de cnt_whole",select_ng:"Atenção: Escolha uma opção da lista.",select_ok:"OK: Selecionado Corretamente.",not_found:"não encontrado",ajax_error:"Um erro aconteceu enquanto conectando a servidor. (ajax-combobox)"};break;default:e={add_btn:"追加ボタン",add_title:"入力ボックスを追加します",del_btn:"削除ボタン",del_title:"入力ボックスを削除します",next:"次へ",next_title:"次の"+this.option.per_page+"件 (右キー)",prev:"前へ",prev_title:"前の"+this.option.per_page+"件 (左キー)",first_title:"最初のページへ (Shift + 左キー)",last_title:"最後のページへ (Shift + 右キー)",get_all_btn:"全件取得 (下キー)",get_all_alt:"画像:ボタン",close_btn:"閉じる (Tabキー)",close_alt:"画像:ボタン",loading:"読み込み中...",loading_alt:"画像:読み込み中...",page_info:"num_page_top - num_page_end 件 (全 cnt_whole 件)",select_ng:"注意 : リストの中から選択してください",select_ok:"OK : 正しく選択されました。",not_found:"(0 件)",ajax_error:"サーバとの通信でエラーが発生しました。(ajax-combobox)"}}this.message=e},_setCssClass:function(){var e={container:"ac_container",container_open:"ac_container_open",selected:"ac_selected",re_area:"ac_result_area",navi:"ac_navi",results:"ac_results",re_off:"ac_results_off",select:"ac_over",sub_info:"ac_subinfo",select_ok:"ac_select_ok",select_ng:"ac_select_ng",input_off:"ac_input_off"};switch(this.option.plugin_type){case"combobox":e=c.extend(e,{button:"ac_button",btn_on:"ac_btn_on",btn_out:"ac_btn_out",input:"ac_input"});break;case"simple":e=c.extend(e,{input:"ac_s_input"});break;case"textarea":e=c.extend(e,{input:"ac_textarea",btn_short_off:"ac_btn_short_off"});break}this.css_class=e},_setProp:function(){this.prop={timer_valchange:false,is_suggest:false,page_all:1,page_suggest:1,max_all:1,max_suggest:1,is_paging:false,is_loading:false,reserve_btn:false,reserve_click:false,xhr:false,key_paging:false,key_select:false,prev_value:"",size_navi:null,size_results:null,size_li:null,size_left:null,tag:null}},_setElem:function(e){var f={};f.combo_input=c(e).attr("autocomplete","off").addClass(this.css_class.input).wrap("<div>");f.container=c(f.combo_input).parent().addClass(this.css_class.container);if(this.option.plugin_type=="combobox"){f.button=c("<div>").addClass(this.css_class.button);f.img=(this.option.button_img.match(/^</))?c(this.option.button_img):c("<img>").attr("src",this.option.button_img);console.log(this.option.button_img);console.log(this.option.button_img.match(/^</));console.log(f.img)}else{f.button=false;f.img=false}f.result_area=c("<div>").addClass(this.css_class.re_area);f.navi=c("<div>").addClass(this.css_class.navi);f.navi_info=c("<div>").addClass("info");f.navi_p=c("<p>");f.results=c("<ul>").addClass(this.css_class.results);f.sub_info=c("<div>").addClass(this.css_class.sub_info);if(this.option.plugin_type=="textarea"){f.hidden=false}else{var g=(c(f.combo_input).attr("name")!==d)?c(f.combo_input).attr("name"):c(f.combo_input).attr("id");if(g.match(/\]$/)){g=g.replace(/\]?$/,"_primary_key]")}else{g+="_primary_key"}f.hidden=c('<input type="hidden" />').attr({name:g,id:g}).val("")}switch(this.option.plugin_type){case"combobox":c(f.container).append(f.button).append(f.result_area).append(f.hidden);c(f.button).append(f.img);break;case"simple":c(f.container).append(f.result_area).append(f.hidden);break;case"textarea":c(f.container).append(f.result_area)}c(f.result_area).append(f.navi).append(f.results).append(f.sub_info);c(f.navi).append(f.navi_info).append(f.navi_p);if(this.option.plugin_type=="combobox"){c(f.container).width(c(f.combo_input).outerWidth()+c(f.button).outerWidth())}else{c(f.container).width(c(f.combo_input).outerWidth())}this.elem=f},_setButtonAttrDefault:function(){if(this.option.select_only){if(c(this.elem.combo_input).val()!==""){if(this.option.plugin_type!="textarea"){if(c(this.elem.hidden).val()!==""){c(this.elem.combo_input).attr("title",this.message.select_ok).removeClass(this.css_class.select_ng).addClass(this.css_class.select_ok)}else{c(this.elem.combo_input).attr("title",this.message.select_ng).removeClass(this.css_class.select_ok).addClass(this.css_class.select_ng)}}}else{if(this.option.plugin_type!="textarea"){c(this.elem.hidden).val("")}c(this.elem.combo_input).removeAttr("title").removeClass(this.css_class.select_ng)}}if(this.option.plugin_type=="combobox"){c(this.elem.button).attr("title",this.message.get_all_btn)}},_setInitRecord:function(){if(this.option.init_record===false){return}if(this.option.plugin_type!="textarea"){c(this.elem.hidden).val(this.option.init_record)}if(typeof this.option.source=="object"){var g;for(var f=0;f<this.option.source.length;f++){if(this.option.source[f][this.option.primary_key]==this.option.init_record){g=this.option.source[f];break}}this._afterInit(this,g)}else{var e=this;c.ajax({dataType:"json",url:e.option.source,data:{db_table:this.option.db_table,pkey_name:this.option.primary_key,pkey_val:this.option.init_record},success:function(h){e._afterInit(e,h)},error:function(h,k,j){e._ajaxErrorNotify(e,j)}})}},_afterInit:function(e,f){c(e.elem.combo_input).val(f[e.option.field]);if(e.option.plugin_type!="textarea"){c(e.elem.hidden).val(f[e.option.primary_key])}e.prop.prev_value=f[e.option.field];if(e.option.select_only){c(e.elem.combo_input).attr("title",e.message.select_ok).removeClass(e.css_class.select_ng).addClass(e.css_class.select_ok)}},_ehButton:function(){if(this.option.plugin_type!="combobox"){return}var e=this;c(e.elem.button).mouseup(function(f){if(c(e.elem.result_area).is(":hidden")){clearInterval(e.prop.timer_valchange);e.prop.is_suggest=false;e._suggest(e);c(e.elem.combo_input).focus()}else{e._hideResults(e)}f.stopPropagation()}).mouseover(function(){c(e.elem.button).addClass(e.css_class.btn_on).removeClass(e.css_class.btn_out)}).mouseout(function(){c(e.elem.button).addClass(e.css_class.btn_out).removeClass(e.css_class.btn_on)}).mouseout()},_ehComboInput:function(){var e=this;c(e.elem.combo_input).keydown(function(f){e._processKey(e,f)});c(e.elem.combo_input).focus(function(){e._setTimerCheckValue(e)}).click(function(){e._setCssFocusedInput(e);c(e.elem.results).children("li").removeClass(e.css_class.select)})},_ehWhole:function(){var e=this;var f=false;c(e.elem.container).mousedown(function(){f=true});c("html").mousedown(function(){if(f){f=false}else{e._hideResults(e)}})},_ehResults:function(){var e=this;c(e.elem.results).children("li").mouseover(function(){if(e.prop.key_select){e.prop.key_select=false;return}e._setSubInfo(e,this);c(e.elem.results).children("li").removeClass(e.css_class.select);c(this).addClass(e.css_class.select);e._setCssFocusedResults(e)}).click(function(f){if(e.prop.key_select){e.prop.key_select=false;return}f.preventDefault();f.stopPropagation();e._selectCurrentLine(e,false)})},_ehNaviPaging:function(e){c(e.elem.navi).find(".navi_first").mouseup(function(f){c(e.elem.combo_input).focus();f.preventDefault();e._firstPage(e)});c(e.elem.navi).find(".navi_prev").mouseup(function(f){c(e.elem.combo_input).focus();f.preventDefault();e._prevPage(e)});c(e.elem.navi).find(".navi_page").mouseup(function(f){c(e.elem.combo_input).focus();f.preventDefault();if(!e.prop.is_suggest){e.prop.page_all=parseInt(c(this).text(),10)}else{e.prop.page_suggest=parseInt(c(this).text(),10)}e.prop.is_paging=true;e._suggest(e)});c(e.elem.navi).find(".navi_next").mouseup(function(f){c(e.elem.combo_input).focus();f.preventDefault();e._nextPage(e)});c(e.elem.navi).find(".navi_last").mouseup(function(f){c(e.elem.combo_input).focus();f.preventDefault();e._lastPage(e)})},_ehTextArea:function(){var e=this;if(!e.option.shorten_btn){return}c(e.option.shorten_btn).click(function(){e._getShortURL(e)})},_getShortURL:function(f){c(f.elem.combo_input).attr("disabled","disabled");var k=c(f.elem.combo_input).val();var j=[];var e=null;while((e=f.option.shorten_reg.exec(k))!==null){j[j.length]=e[1]}if(j.length<1){c(f.elem.combo_input).removeAttr("disabled");return}var h={};for(var g=0;g<j.length;g++){h["p_"+g]=j[g]}c.ajax({dataType:"json",url:f.option.shorten_src,data:h,success:function(n){var m=0;var l=k.replace(f.option.shorten_reg,function(){var o=arguments[0].replace(arguments[1],n[m]);m++;return o});c(f.elem.combo_input).val(l);f.prop.prev_value=l;f._disableButtonShort(f)},error:function(l,n,m){f._ajaxErrorNotify(f,m)},complete:function(){c(f.elem.combo_input).removeAttr("disabled").focus()}})},_ajaxErrorNotify:function(e,f){alert(e.message.ajax_error)},_scrollWindow:function(o,l){var e=o._getCurrentLine(o);var n=(e&&!l)?e.offset().top:c(o.elem.container).offset().top;var h;if(o.option.sub_info){var g=c(o.elem.sub_info).children("dl:visible");h=c(g).height()+parseInt(c(g).css("border-top-width"))+parseInt(c(g).css("border-bottom-width"))}else{o.prop.size_li=c(o.elem.results).children("li:first").outerHeight();h=o.prop.size_li}var k=c(b).height();var j=c(b).scrollTop();var f=j+k-h;var m;if(c(e).length){if(n<j||h>k){m=n-j}else{if(n>f){m=n-f}else{return}}}else{if(n<j){m=n-j}}b.scrollBy(0,m)},_setCssFocusedInput:function(e){c(e.elem.results).addClass(e.css_class.re_off);c(e.elem.combo_input).removeClass(e.css_class.input_off);c(e.elem.sub_info).children("dl").hide()},_setCssFocusedResults:function(e){c(e.elem.results).removeClass(e.css_class.re_off);c(e.elem.combo_input).addClass(e.css_class.input_off)},_enableButtonShort:function(e){c(e.option.shorten_btn).removeClass(e.css_class.btn_short_off).removeAttr("disabled")},_disableButtonShort:function(e){c(e.option.shorten_btn).addClass(e.css_class.btn_short_off).attr("disabled","disabled")},_setTimerCheckValue:function(e){e.prop.timer_valchange=setTimeout(function(){e._checkValue(e)},500)},_checkValue:function(h){var f=c(h.elem.combo_input).val();if(f!=h.prop.prev_value){h.prop.prev_value=f;if(h.option.plugin_type=="textarea"){h._findUrlToShorten(h);var e=h._findTag(h,f);if(e){h._setTextAreaNewSearch(h,e);h._suggest(h)}}else{c(h.elem.combo_input).removeAttr("sub_info");if(h.option.plugin_type!="textarea"){c(h.elem.hidden).val("")}if(h.option.select_only){h._setButtonAttrDefault()}h.prop.page_suggest=1;h.prop.is_suggest=true;h._suggest(h)}}else{if(h.option.plugin_type=="textarea"&&c(h.elem.result_area).is(":visible")){var g=h._findTag(h,f);if(!g){h._hideResults(h)}else{if(g.str!=h.prop.tag.str||g.pos_left!=h.prop.tag.pos_left){h._setTextAreaNewSearch(h,g);h._suggest(h)}}}}h._setTimerCheckValue(h)},_setTextAreaNewSearch:function(f,e){f.prop.tag=e;f.prop.page_suggest=1;f.option.search_field=f.option.tags[f.prop.tag.type].search_field;f.option.order_by=f.option.tags[f.prop.tag.type].order_by;f.option.primary_key=f.option.tags[f.prop.tag.type].primary_key;f.option.db_table=f.option.tags[f.prop.tag.type].db_table;f.option.field=f.option.tags[f.prop.tag.type].field;f.option.sub_info=f.option.tags[f.prop.tag.type].sub_info;f.option.sub_as=f.option.tags[f.prop.tag.type].sub_as;f.option.show_field=f.option.tags[f.prop.tag.type].show_field;f.option.hide_field=f.option.tags[f.prop.tag.type].hide_field},_findUrlToShorten:function(g){var f=null;var e=null;while((e=g.option.shorten_reg.exec(c(g.elem.combo_input).val()))!==null){f=true;g.option.shorten_reg.lastIndex=0;break}if(f){g._enableButtonShort(g)}else{g._disableButtonShort(g)}},_findTag:function(n,e){var k=n._getCaretPosition(c(n.elem.combo_input).get(0));var f,h,m,l,j;for(var g=0;g<n.option.tags.length;g++){f=e.substring(0,k);f=f.match(n.option.tags[g].pattern.reg_left);if(!f){continue}f=f[1];h=k-f.length;if(h<0){h=0}m=e.substring(k,e.length);m=m.match(n.option.tags[g].pattern.reg_right);if(m){m=m[1];l=k+m.length}else{m="";l=k}j=f+""+m;n.prop.is_suggest=(j==="")?false:true;return{type:g,str:j,pos_left:h,pos_right:l}}return false},_getCaretPosition:function(f){var g=0;if(a.selection){f.focus();var e=a.selection.createRange();e.moveStart("character",-f.value.length);g=e.text.length}else{if(f.selectionStart||f.selectionStart=="0"){g=f.selectionStart}}return g},_setCaretPosition:function(f,h){var g=c(f.elem.combo_input).get(0);if(g.setSelectionRange){g.focus();g.setSelectionRange(h,h)}else{if(g.createTextRange){var e=g.createTextRange();e.collapse(true);e.moveEnd("character",h);e.moveStart("character",h);e.select()}}},_processKey:function(f,g){if((c.inArray(g.keyCode,[27,38,40,9])>-1&&c(f.elem.result_area).is(":visible"))||(c.inArray(g.keyCode,[37,39,13,9])>-1&&f._getCurrentLine(f))||(g.keyCode==40&&f.option.plugin_type!="textarea")){g.preventDefault();g.stopPropagation();g.cancelBubble=true;g.returnValue=false;switch(g.keyCode){case 37:if(g.shiftKey){f._firstPage(f)}else{f._prevPage(f)}break;case 38:f.prop.key_select=true;f._prevLine(f);break;case 39:if(g.shiftKey){f._lastPage(f)}else{f._nextPage(f)}break;case 40:if(c(f.elem.results).children("li").length){f.prop.key_select=true;f._nextLine(f)}else{f.prop.is_suggest=false;f._suggest(f)}break;case 9:f.prop.key_paging=true;f._hideResults(f);break;case 13:f._selectCurrentLine(f,true);break;case 27:f.prop.key_paging=true;f._hideResults(f);break}}else{if(g.keyCode!=16){f._setCssFocusedInput(f)}f._checkValue(f)}},_abortAjax:function(e){if(e.prop.xhr){e.prop.xhr.abort();e.prop.xhr=false}},_suggest:function(f){var g;if(f.option.plugin_type!="textarea"){g=(f.prop.is_suggest)?c.trim(c(f.elem.combo_input).val()):"";if(g.length<1&&f.prop.is_suggest){f._hideResults(f);return}g=g.split(/[\s　]+/)}else{g=[f.prop.tag.str]}f._abortAjax(f);f._setLoading(f);c(f.elem.sub_info).children("dl").hide();if(f.prop.is_paging){var h=f._getCurrentLine(f);f.prop.is_paging=(h)?c(f.elem.results).children("li").index(h):-1}else{if(!f.prop.is_suggest){f.prop.is_paging=0}}var e=(f.prop.is_suggest)?f.prop.page_suggest:f.prop.page_all;if(typeof f.option.source=="object"){f._searchForJson(f,g,e)}else{f._searchForDb(f,g,e)}},_setLoading:function(e){c(e.elem.navi_info).text(e.message.loading);if(c(e.elem.results).html()===""){c(e.elem.navi).children("p").empty();e._calcWidthResults(e);c(e.elem.container).addClass(e.css_class.container_open)}},_searchForDb:function(f,g,e){f.prop.xhr=c.ajax({dataType:"json",url:f.option.source,data:{q_word:g,page_num:e,per_page:f.option.per_page,search_field:f.option.search_field,and_or:f.option.and_or,order_by:f.option.order_by,db_table:f.option.db_table},success:function(j){j.candidate=[];j.primary_key=[];j.subinfo=[];if(typeof j.result!="object"){f.prop.xhr=null;f._notFoundSearch(f);return}j.cnt_page=j.result.length;for(i=0;i<j.cnt_page;i++){j.subinfo[i]=[];for(var h in j.result[i]){if(h==f.option.primary_key){j.primary_key.push(j.result[i][h])}if(h==f.option.field){j.candidate.push(j.result[i][h])}else{if(c.inArray(h,f.option.hide_field)==-1){if(f.option.show_field!==""&&c.inArray("*",f.option.show_field)==-1&&c.inArray(h,f.option.show_field)==-1){continue}else{j.subinfo[i][h]=j.result[i][h]}}}}}delete (j.result);f._prepareResults(f,j,g,e)},error:function(h,k,j){if(k!="abort"){f._hideResults(f);f._ajaxErrorNotify(f,j)}},complete:function(){f.prop.xhr=null}})},_searchForJson:function(n,k,o){var l=[];var f=[];var e=[];var u={};var r=0;var m=[];do{f[r]=k[r].replace(/\W/g,"\\$&").toString();m[r]=new RegExp(f[r],"gi");r++}while(r<k.length);for(r=0;r<n.option.source.length;r++){var q=false;for(var p=0;p<m.length;p++){if(n.option.source[r][n.option.field].match(m[p])){q=true;if(n.option.and_or=="OR"){break}}else{q=false;if(n.option.and_or=="AND"){break}}}if(q){l.push(n.option.source[r])}}if(l.length===d){n._notFoundSearch(n);return}u.cnt_whole=l.length;var x=new RegExp("^"+f[0]+"$","gi");var v=new RegExp("^"+f[0],"gi");var w=[];var t=[];var s=[];for(r=0;r<l.length;r++){if(l[r][n.option.order_by[0][0]].match(x)){w.push(l[r])}else{if(l[r][n.option.order_by[0][0]].match(v)){t.push(l[r])}else{s.push(l[r])}}}if(n.option.order_by[0][1].match(/^asc$/i)){w=n._sortAsc(n,w);t=n._sortAsc(n,t);s=n._sortAsc(n,s)}else{w=n._sortDesc(n,w);t=n._sortDesc(n,t);s=n._sortDesc(n,s)}e=e.concat(w).concat(t).concat(s);var h=(o-1)*n.option.per_page;var g=h+n.option.per_page;for(r=h,sub=0;r<g;r++,sub++){if(e[r]===d){break}for(var y in e[r]){if(y==n.option.primary_key){if(u.primary_key===d){u.primary_key=[]}u.primary_key.push(e[r][y])}if(y==n.option.field){if(u.candidate===d){u.candidate=[]}u.candidate.push(e[r][y])}else{if(c.inArray(y,n.option.hide_field)==-1){if(n.option.show_field!==""&&c.inArray("*",n.option.show_field)==-1&&c.inArray(y,n.option.show_field)==-1){continue}if(u.subinfo===d){u.subinfo=[]}if(u.subinfo[sub]===d){u.subinfo[sub]=[]}u.subinfo[sub][y]=e[r][y]}}}}if(u.candidate===d){u.candidate=[]}u.cnt_page=u.candidate.length;n._prepareResults(n,u,k,o)},_sortAsc:function(f,e){e.sort(function(h,g){return h[f.option.order_by[0][0]].localeCompare(g[f.option.order_by[0][0]])});return e},_sortDesc:function(f,e){e.sort(function(h,g){return g[f.option.order_by[0][0]].localeCompare(h[f.option.order_by[0][0]])});return e},_notFoundSearch:function(e){c(e.elem.navi_info).text(e.message.not_found);c(e.elem.navi_p).hide();c(e.elem.results).empty();c(e.elem.sub_info).empty();e._calcWidthResults(e);c(e.elem.container).addClass(e.css_class.container_open);e._setCssFocusedInput(e)},_prepareResults:function(h,j,k,f){h._setNavi(h,j.cnt_whole,j.cnt_page,f);if(!j.subinfo||!h.option.sub_info){j.subinfo=false}if(!j.primary_key){j.primary_key=false}if(h.option.select_only&&j.candidate.length===1&&j.candidate[0]==k[0]){if(h.option.plugin_type!="textarea"){c(h.elem.hidden).val(j.primary_key[0])}this._setButtonAttrDefault()}h._displayResults(h,j.candidate,j.subinfo,j.primary_key);if(h.prop.is_paging===false){h._setCssFocusedInput(h)}else{var e=h.prop.is_paging;var g=c(h.elem.results).children("li").length-1;if(e>g){e=g}var l=c(h.elem.results).children("li").eq(e);c(l).addClass(h.css_class.select);h._setSubInfo(h,l);h.prop.is_paging=false;h._setCssFocusedResults(h)}},_setNavi:function(p,n,o,e){var q=p.option.per_page*(e-1)+1;var k=q+o-1;var f=p.message.page_info.replace("cnt_whole",n).replace("num_page_top",q).replace("num_page_end",k);c(p.elem.navi_info).text(f);var j=Math.ceil(n/p.option.per_page);if(j>1){c(p.elem.navi_p).empty();if(p.prop.is_suggest){p.prop.max_suggest=j}else{p.prop.max_all=j}var g=e-Math.ceil((p.option.navi_num-1)/2);var m=e+Math.floor((p.option.navi_num-1)/2);while(g<1){g++;m++}while(m>j){m--}while((m-g<p.option.navi_num-1)&&g>1){g--}if(e==1){if(!p.option.navi_simple){c("<span>").text("<< 1").addClass("page_end").appendTo(p.elem.navi_p)}c("<span>").text(p.message.prev).addClass("page_end").appendTo(p.elem.navi_p)}else{if(!p.option.navi_simple){c("<a>").attr({href:"javascript:void(0)","class":"navi_first"}).text("<< 1").attr("title",p.message.first_title).appendTo(p.elem.navi_p)}c("<a>").attr({href:"javascript:void(0)","class":"navi_prev",title:p.message.prev_title}).text(p.message.prev).appendTo(p.elem.navi_p)}for(var h=g;h<=m;h++){var l=(h==e)?'<span class="current">'+h+"</span>":h;c("<a>").attr({href:"javascript:void(0)","class":"navi_page"}).html(l).appendTo(p.elem.navi_p)}if(e==j){c("<span>").text(p.message.next).addClass("page_end").appendTo(p.elem.navi_p);if(!p.option.navi_simple){c("<span>").text(j+" >>").addClass("page_end").appendTo(p.elem.navi_p)}}else{c("<a>").attr({href:"javascript:void(0)","class":"navi_next"}).text(p.message.next).attr("title",p.message.next_title).appendTo(p.elem.navi_p);if(!p.option.navi_simple){c("<a>").attr({href:"javascript:void(0)","class":"navi_last"}).text(j+" >>").attr("title",p.message.last_title).appendTo(p.elem.navi_p)}}c(p.elem.navi_p).show();p._ehNaviPaging(p)}else{c(p.elem.navi_p).hide()}},_setSubInfo:function(h,j){if(!h.option.sub_info){return}h.prop.size_results=(c(h.elem.results).outerHeight()-c(h.elem.results).height())/2;h.prop.size_navi=c(h.elem.navi).outerHeight();h.prop.size_li=c(h.elem.results).children("li:first").outerHeight();h.prop.size_left=c(h.elem.results).outerWidth();var e=c(h.elem.results).children("li").index(j);c(h.elem.sub_info).children("dl").hide();var f=0;if(c(h.elem.navi).css("display")!="none"){f+=h.prop.size_navi}f+=(h.prop.size_results+h.prop.size_li*e);var g=h.prop.size_left;f+="px";g+="px";c(h.elem.sub_info).children("dl").eq(e).css({position:"absolute",top:f,left:g,display:"block"})},_displayResults:function(r,q,l,m){c(r.elem.results).empty();c(r.elem.sub_info).empty();for(var j=0;j<q.length;j++){var k=c("<li>").text(q[j]).attr({pkey:m[j],title:q[j]});if(r.option.plugin_type!="textarea"&&m[j]==c(r.elem.hidden).val()){c(k).addClass(r.css_class.selected)}c(r.elem.results).append(k);if(l){var n=[];var g=c("<dl>");var f,p;for(var o in l[j]){var e=o.replace("'","\\'");if(l[j][o]===null){l[j][o]=""}else{l[j][o]+=""}var h=l[j][o].replace("'","\\'");n.push("'"+e+"':'"+h+"'");f=(r.option.sub_as[o])?r.option.sub_as[o]:o;f=c("<dt>").text(f);if(r.option.sub_info=="simple"){c(f).addClass("hide")}g.append(f);p=c("<dd>").text(l[j][o]);g.append(p)}n="{"+n.join(",")+"}";c(k).attr("sub_info",n);c(r.elem.sub_info).append(g);if(r.option.sub_info=="simple"&&g.children("dd").text()===""){g.addClass("ac_dl_empty")}}}r._calcWidthResults(r);c(r.elem.container).addClass(r.css_class.container_open);r._ehResults();if(r.option.plugin_type=="combobox"){c(r.elem.button).attr("title",r.message.close_btn)}},_calcWidthResults:function(f){var e;if(f.option.plugin_type=="combobox"){e=c(f.elem.combo_input).outerWidth()+c(f.elem.button).outerWidth()}else{e=c(f.elem.combo_input).outerWidth()}c(f.elem.container).width(e);if(c(f.elem.container).css("position")=="static"){var g=c(f.elem.combo_input).offset();c(f.elem.result_area).css({top:g.top+c(f.elem.combo_input).outerHeight()+"px",left:g.left+"px"})}else{c(f.elem.result_area).css({top:c(f.elem.combo_input).outerHeight()+"px",left:"0px"})}c(f.elem.result_area).width(c(f.elem.container).width()-(c(f.elem.result_area).outerWidth()-c(f.elem.result_area).innerWidth())).show()},_hideResults:function(e){if(e.prop.key_paging){e._scrollWindow(e,true);e.prop.key_paging=false}e._setCssFocusedInput(e);c(e.elem.results).empty();c(e.elem.sub_info).empty();c(e.elem.result_area).hide();c(e.elem.container).removeClass(e.css_class.container_open);e._abortAjax(e);e._setButtonAttrDefault()},_firstPage:function(e){if(!e.prop.is_suggest){if(e.prop.page_all>1){e.prop.page_all=1;e.prop.is_paging=true;e._suggest(e)}}else{if(e.prop.page_suggest>1){e.prop.page_suggest=1;e.prop.is_paging=true;e._suggest(e)}}},_prevPage:function(e){if(!e.prop.is_suggest){if(e.prop.page_all>1){e.prop.page_all--;e.prop.is_paging=true;e._suggest(e)}}else{if(e.prop.page_suggest>1){e.prop.page_suggest--;e.prop.is_paging=true;e._suggest(e)}}},_nextPage:function(e){if(e.prop.is_suggest){if(e.prop.page_suggest<e.prop.max_suggest){e.prop.page_suggest++;e.prop.is_paging=true;e._suggest(e)}}else{if(e.prop.page_all<e.prop.max_all){e.prop.page_all++;e.prop.is_paging=true;e._suggest(e)}}},_lastPage:function(e){if(!e.prop.is_suggest){if(e.prop.page_all<e.prop.max_all){e.prop.page_all=e.prop.max_all;e.prop.is_paging=true;e._suggest(e)}}else{if(e.prop.page_suggest<e.prop.max_suggest){e.prop.page_suggest=e.prop.max_suggest;e.prop.is_paging=true;e._suggest(e)}}},_selectCurrentLine:function(n,l){n._scrollWindow(n,true);var j=n._getCurrentLine(n);if(j){if(n.option.plugin_type!="textarea"){c(n.elem.combo_input).val(c(j).text());if(n.option.sub_info){c(n.elem.combo_input).attr("sub_info",c(j).attr("sub_info"))}if(n.option.select_only){n._setButtonAttrDefault()}c(n.elem.hidden).val(c(j).attr("pkey"))}else{var f=n.prop.prev_value.substring(0,n.prop.tag.pos_left);var m=n.prop.prev_value.substring(n.prop.tag.pos_right);var g,e,h,k;g=c(j).text();if(n.option.tags[n.prop.tag.type].space[0]&&!f.match(n.option.tags[n.prop.tag.type].pattern.space_left)){e=n.option.tags[n.prop.tag.type].pattern.left.length;h=f.length;f=f.substring(0,(h-e))+" "+f.substring((h-e))}if(!m.match(n.option.tags[n.prop.tag.type].pattern.comp_right)){m=n.option.tags[n.prop.tag.type].pattern.right+m}if(n.option.tags[n.prop.tag.type].space[1]&&!m.match(n.option.tags[n.prop.tag.type].pattern.space_right)){e=n.option.tags[n.prop.tag.type].pattern.right.length;m=m.substring(0,e)+" "+m.substring(e)}c(n.elem.combo_input).val(f+""+g+""+m);k=f.length+g.length;n._setCaretPosition(n,k)}n.prop.prev_value=c(n.elem.combo_input).val();n._hideResults(n)}if(n.option.bind_to){c(n.elem.combo_input).trigger(n.option.bind_to,l)}c(n.elem.combo_input).focus();c(n.elem.combo_input).change();n._setCssFocusedInput(n)},_getCurrentLine:function(e){if(c(e.elem.result_area).is(":hidden")){return false}var f=c(e.elem.results).children("li."+e.css_class.select);if(c(f).length){return f}else{return false}},_nextLine:function(f){var h=f._getCurrentLine(f);var e;if(!h){e=-1}else{e=c(f.elem.results).children("li").index(h);c(h).removeClass(f.css_class.select)}e++;if(e<c(f.elem.results).children("li").length){var g=c(f.elem.results).children("li").eq(e);f._setSubInfo(f,g);c(g).addClass(f.css_class.select);f._setCssFocusedResults(f)}else{f._setCssFocusedInput(f)}f._scrollWindow(f,false)},_prevLine:function(f){var h=f._getCurrentLine(f);var e;if(!h){e=c(f.elem.results).children("li").length}else{e=c(f.elem.results).children("li").index(h);c(h).removeClass(f.css_class.select)}e--;if(e>-1){var g=c(f.elem.results).children("li").eq(e);f._setSubInfo(f,g);c(g).addClass(f.css_class.select);f._setCssFocusedResults(f)}else{f._setCssFocusedInput(f)}f._scrollWindow(f,false)}})}));