define(["dojo/_base/declare","alfresco/services/BaseService","dojo/_base/lang","meeting/utils/base","alfresco/core/CoreXhr","alfresco/dialogs/AlfDialog","alfresco/core/topics"],function(b,a,f,e,c,d,g){return b([a,c],{idStoreMeeting:"MEETING_STORE",negData:null,constructor:function(h){f.mixin(this,h);this.alfSubscribe("ADD_LEVEL",f.hitch(this,this.addLevel),true);this.alfSubscribe("EDIT_LEVEL",f.hitch(this,this.editLevel),true);this.alfSubscribe("EDIT_APPROVAL",f.hitch(this,this.editCurrentNode),true)},veryfy:function(){var j=e.getById("APPROVAL_NEGOTIATORS_TREE_LIST");var h=j.getValue();var n=e.getById("SELECT_TTPE_APPROVAL");var k=e.getById("DURATION");var q=e.getById("TYPE_TASK_APPROVAL");var p=e.getById("APPROVAL_NAME");var l=e.getById("USER_DOC_SIGNER");if(h==null||!k.getValue()||!p.getValue()){this.alfPublish("ALF_DISPLAY_NOTIFICATION",{message:"Введены не все данные!"},true);return false}var o=e.getStoreById(this.idStoreMeeting);if(l.getValue()=="on"){l=true}else{l=false}var m="";if(typeof currentNode!="undefined"&&currentNode){m=currentNode.data.id}this.negData={documentNodeRef:o.nodeRef,negotiationLevelNodeRef:m,negotiators:h,type:n.getValue(),duration:k.getValue(),levelName:p.getValue(),useDocSigner:l,processType:q.getValue()};return true},editLevel:function(){if(typeof editNode!="undefined"&&editNode){currentNode=editNode;if(!this.veryfy()){return}if(this.negData){this.sendNegotiationListData(this.negData,this.refreshApproval);this.alfPublish("ADD_LEVEL_VISIBLE",{visible:true},true)}else{this.alfPublish("ALF_DISPLAY_NOTIFICATION",{message:"Не удалось получить данные из формы ввода. Перезагрузите страницу и повторите попытку."},true)}}},addLevel:function(){currentNode=null;if(!this.veryfy()){return}if(this.negData){this.sendNegotiationListData(this.negData,this.refreshApproval)}else{this.alfPublish("ALF_DISPLAY_NOTIFICATION",{message:"Не удалось получить данные из формы ввода. Перезагрузите страницу и повторите попытку."},true)}},clearForm:function(){var k=e.getById("APPROVAL_NEGOTIATORS_TREE_LIST");var m=e.getById("SELECT_TTPE_APPROVAL");var l=e.getById("DURATION");var h=e.getById("TYPE_TASK_APPROVAL");var j=e.getById("APPROVAL_NAME");k.setValue(null);m.setValue(0);l.setValue(null);h.setValue(0);j.setValue("")},refreshApproval:function(){this.alfPublish("REFRESH_APPROVAL",null,true);this.clearForm()},sendNegotiationListData:function(j,h){Alfresco.util.Ajax.jsonPost({method:"POST",url:"/share/proxy/alfresco/negotiation/set-negotiation-list-info",dataObj:j,successCallback:{fn:h,scope:this}})},editCurrentNode:function(){if(typeof currentNode!="undefined"&&currentNode){_this=this;setNegotiationLevelDetails=function(l){_this.clearForm();var n=e.getById("APPROVAL_NEGOTIATORS_TREE_LIST");var p=e.getById("SELECT_TTPE_APPROVAL");var o=e.getById("DURATION");var k=e.getById("TYPE_TASK_APPROVAL");var m=e.getById("APPROVAL_NAME");o.setValue(l.duration);p.setValue(l.type);k.setValue(l.processType);m.setValue(l.levelName);var j=l.negotiators;for(i=0;i<j.length;i++){_this.alfPublish("ADD_NEGOTIATORS_TO_LIST",{value:{nodeRef:j[i].nodeRef,name:j[i].fullName}},true)}_this.alfPublish("ADD_LEVEL_VISIBLE",{visible:false},true)};editNode=currentNode;Alfresco.util.Ajax.jsonGet({method:"GET",url:"/share/proxy/alfresco/negotiation/get-negotiation-level-info?levelNodeRef="+currentNode.data.id,successCallback:{fn:function h(j){if(j.serverResponse.status==200){setNegotiationLevelDetails(j.json)}else{console.log("Error getting negotiation list")}},scope:this}})}else{this.alfPublish("ALF_DISPLAY_NOTIFICATION",{message:"Не выбран этап согласования"},true)}}})});