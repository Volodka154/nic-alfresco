define(["dojo/_base/declare","alfresco/services/BaseService","dojo/_base/lang","meeting/utils/base","alfresco/core/CoreXhr","alfresco/dialogs/AlfDialog","alfresco/core/topics",],function(b,a,f,e,c,d,g){return b([a,c],{idFormTabMeeting:"TAB_MEETING",idGridUsersTabMeeting:"USERS_GRID_MAIN_FORM_MEETING",idGridProgrammeTabMeeting:"PROGRAMME_GRID_MAIN_FORM_MEETING",idGridProtocolTabMeeting:"PROTOCOL_GRID_MAIN_FORM_MEETING",idStoreMeeting:"MEETING_STORE",idRoomControl:"MEETING_ROOM_CONTROL",confirmationRequired:false,constructor:function(h){f.mixin(this,h);this.alfSubscribe("CANCEL_MEETING_EVENT",f.hitch(this,this.cancelMeeting));this.alfSubscribe("CREATE_MEETING_EVENT",f.hitch(this,this.createMeeting));this.alfSubscribe("UPDATE_MEETING_EVENT",f.hitch(this,this.updateMeeting));this.alfSubscribe("UPDATE_AND_CLOSE_MEETING_EVENT",f.hitch(this,this.updateAndCloseMeeting));this.alfSubscribe("MEETING_CREATE_PROTOCOL",f.hitch(this,this.createProtocol));this.alfSubscribe("MEETING_CANCEL_NEGOTIATION",f.hitch(this,this.cancelNegotiation));this.alfSubscribe("MEETING_CANCEL_SIGNER",f.hitch(this,this.cancelSigner));this.alfSubscribe("MEETING_TO_NEGOTIATION",f.hitch(this,this.toNegotiation));this.alfSubscribe("MEETING_SEND_TO_EXECUTE_EVENT",f.hitch(this,this.toExecute));this.alfSubscribe("MEETING_SEND_ROUTE_EVENT",f.hitch(this,this.sendRoutEvent));this.alfSubscribe("MEETING_TO_REGISTER_EVENT",f.hitch(this,this.toRegisterEvent));this.alfSubscribe("MEETING_REGISTER_AND_SEND_TO_EXECUTE",f.hitch(this,this.toRegisterAndExecuteEvent));this.alfSubscribe("MEETING_TO_ARCHIVE",f.hitch(this,this.toArchive));this.alfSubscribe("MEETING_SEND_INVITATION",f.hitch(this,this.sendInvitation));this.alfSubscribe("MEETING_COMPLETE_CREATE",f.hitch(this,this.completeCreate));this.alfSubscribe("MEETING_SELECT_ROOM",f.hitch(this,this.selectRoom),true);this.alfSubscribe("MEETING_CANCEL_CONFIRM_ROOM",f.hitch(this,this.cancelConfirmRoom),true);___this=this},createProtocol:function(){var h=e.getStoreById(this.idStoreMeeting);this.serviceXhr({url:"/share/proxy/alfresco/meeting/createProtocol?documentNodeRef="+h.nodeRef,method:"GET",successCallback:this.createProtocolSus,callbackScope:this})},createProtocolSus:function(h){if(h.result=="successful"){this.alfPublish("ALF_DISPLAY_NOTIFICATION",{message:"Протокол сформирован. Обновите список вложений"},true)}else{if(h.result){this.alfPublish("ALF_DISPLAY_NOTIFICATION",{message:h.result},true)}}},cancelConfirmRoom:function(){var h=e.getStoreById(this.idStoreMeeting);this.serviceXhr({url:"/share/proxy/alfresco/workflow/cancel-workflow?processName=activiti$meetingSelectRoom&packageNodeRef="+h.nodeRef,method:"GET",successCallback:this.cancelConfirmRoomSussess,callbackScope:this})},cancelConfirmRoomSussess:function(){this.alfPublish("CHANGE_MEETING_LOCATION",{name:"",nodeRef:""},true);this.setState("Черновик")},toArchive:function(){this.setState("В архиве")},setState:function(k,j,i){this.alfPublish("CHANGE_MEETING_STATE_CONTROL",k);var h=e.getFormValuesById(this.idFormTabMeeting);__this=this;__valueMeeting=h;__valueMeeting["prop_btl-meeting_state"]=k;__setSate=function(){__this.alfPublish("UPDATE_SORE",{nodeRef:__this.documentNodeRef,Callback:function(){__this.alfPublish("CHANGE_STATE_MEETING_DOCUMENT",{state:k})}},true)};if(!i){this.updateMeeting({stateName:k,callBack:__setSate})}else{__setSate()}},selectRoom:function(h){if(h.prop_calendar){this.alfPublish("CHANGE_MEETING_START_DATE",h.prop_calendar.startTime,true);this.alfPublish("CHANGE_MEETING_END_DATE",h.prop_calendar.endTime,true);this.alfPublish("CHANGE_MEETING_LOCATION",{name:h.prop_calendar.roomContent,nodeRef:h.prop_calendar.room},true);this.clearInviteUsers();if(h.prop_calendar.roomObject.confirmationRequired){_payload=h;this.updateMeeting({callBack:this.createTaskSelectRoom})}}},createTaskSelectRoom:function(){_this=this;this.selectRoomPropCalendar=_payload.prop_calendar;var h=e.getStoreById(this.idStoreMeeting);this.serviceXhr({url:"/share/proxy/alfresco/api/workflow/activiti%24meetingSelectRoom/formprocessor",method:"POST",data:{assoc_packageItems_added:h.nodeRef,"assoc_btl-meetingWF_room_added":_payload.prop_calendar.room},successCallback:this.sendmeetingSelectRoomSussess,failureCallback:function(){_this.alfPublish("ALF_DISPLAY_PROMPT",{message:"При формировании задания подтверждения переговорной произошла ошибка. Повторите запрос позже или обратитесь к администратору. Без подтверждения данной переговорной нельзя завершить подготовку мероприятия."},true)},callbackScope:this})},clearInviteUsers:function(){var m=e.getFormValuesById(this.idGridProgrammeTabMeeting);isquery=false;for(var k=0;k<m.length;k++){var j=m[k];var h=j["prop_btl-meetingParticipant_invite"];if(h&&h!="Ожидает повторную отправку"&&h!="Ожидает решения"){isquery=true;break}}if(isquery){var l={};l.dialogTitle="Сбросить результаты приглашений?";l.dialogConfirmationButtonTitle="Да";l.dialogCancellationButtonTitle="Нет";l.formSubmissionTopic="PRESS_MEETING_CLEAR_USERS_INVITE_ALL";l.widgets=[];this.alfPublish("ALF_CREATE_FORM_DIALOG_REQUEST",l,true)}},sendmeetingSelectRoomSussess:function(){this.setState("Подтверждение переговорной");this.alfPublish("ALF_DISPLAY_PROMPT",{message:"Задание на подтверждение переговорной отправлено"},true)},createMeetingRequest:function(i){var h={};h.type="btl-meeting:meetingDataType";h.alf_destination=i.alf_destination;h.data=i;this.serviceXhr({url:"/share/proxy/alfresco/createNode",method:"POST",data:h,successCallback:this.addMetaMeeting,callbackScope:this})},createMeeting:function(i){var h=e.getFormValuesById(this.idFormTabMeeting);if(!h){return false}this.alfPublish("CREATE_MEETING_BUTTON_DISABLE",null,true);if(!h["prop_btl-meeting_regDate"]){h["prop_btl-meeting_regDate"]=""}if(!h["prop_btl-meeting_endDate"]){h["prop_btl-meeting_endDate"]=""}if(!h["prop_btl-meeting_startDate"]){h["prop_btl-meeting_startDate"]=""}if(h["assoc_btl-meeting_room"]){h["assoc_btl-meeting_room_added"]=h["assoc_btl-meeting_room"];_valueMeeting=h;this.serviceXhr({url:"/share/proxy/alfresco/meeting/meeting-room-info?nodeRef="+h["assoc_btl-meeting_room"],method:"GET",successCallback:this.romInfoSus,callbackScope:this})}else{this.createMeetingRequest(h)}},romInfoSus:function(h){if(h.confirmationRequired){this.confirmationRequired=true;_valueMeeting["prop_btl-meeting_state"]="Подтверждение переговорной"}this.createMeetingRequest(_valueMeeting)},addMetaMeeting:function(i,h){this.documentNodeRef=i.result;var j={foo:"bar"};history.pushState(j,document.title,"meeting-rooms?nodeRef="+this.documentNodeRef);var k=e.getFormValuesById(this.idFormTabMeeting);if(k["assoc_btl-meeting_room"]){this.addMetaMeetingRoomSus()}else{__this=this;__valueMeeting=k;this.alfPublish("UPDATE_SORE",{nodeRef:this.documentNodeRef,Callback:function(){__this.setState(__valueMeeting["prop_btl-meeting_state"],null,true)}},true)}},addMetaMeetingRoomSus:function(){var h=e.getFormValuesById(this.idFormTabMeeting);__this=this;__valueMeeting=h;if(this.confirmationRequired){this.serviceXhr({url:"/share/proxy/alfresco/api/workflow/activiti%24meetingSelectRoom/formprocessor",method:"POST",data:{assoc_packageItems_added:this.documentNodeRef,"assoc_btl-meetingWF_room_added":h["assoc_btl-meeting_room"]},successCallback:this.sendmeetingSelectRoomSussessAfterCreate,callbackScope:this})}else{this.alfPublish("UPDATE_SORE",{nodeRef:this.documentNodeRef,Callback:function(){__this.setState(__valueMeeting["prop_btl-meeting_state"])}},true)}},sendmeetingSelectRoomSussessAfterCreate:function(){this.alfPublish("ALF_DISPLAY_PROMPT",{message:"Задание на подтверждение переговорной отправлено"},true);this.alfPublish("UPDATE_SORE",{nodeRef:this.documentNodeRef,Callback:function(){__this.setState(__valueMeeting["prop_btl-meeting_state"])}},true)},updateAndCloseMeeting:function(){this._close=true;this.updateMeeting()},cancelMeeting:function(){var h=e.getStoreById("MEETING_STORE");if(h.redirect){window.location.replace(h.redirect)}else{if(window.parent.document!=document){if(typeof window.parent.document.frameCancel=="function"){window.parent.document.frameCancel();return}}window.location.replace("/share")}},updateMeeting:function(k){var j=e.getFormValuesById(this.idFormTabMeeting);if(!j["prop_btl-meeting_regDate"]){j["prop_btl-meeting_regDate"]=""}if(!j["prop_btl-meeting_endDate"]){j["prop_btl-meeting_endDate"]=""}if(!j["prop_btl-meeting_startDate"]){j["prop_btl-meeting_startDate"]=""}if(k&&k.stateName){j["prop_btl-meeting_state"]=k.stateName}var h=e.getStoreById(this.idStoreMeeting);if(h.nodeRef){this.documentNodeRef=h.nodeRef}if(this.documentNodeRef){var i={};i.nodeRef=this.documentNodeRef;i.data=j;this.serviceXhr({url:"/share/proxy/alfresco/updateNode",method:"POST",data:i,successCallback:(k&&k.callBack)?k.callBack:this.updateForm,successMessage:"Документ успешно сохранен.",callbackScope:this})}else{console.error("Не найден nodeRef документа для обновления")}},updateForm:function(i,h){this.alfServicePublish(g.DISPLAY_NOTIFICATION,{message:h.successMessage});if(this._close){if(window.parent.document!=document){if(typeof window.parent.document.frameSave=="function"){window.parent.document.frameSave()}}else{window.location.replace("/share")}}else{this.alfPublish("PRESS_MEETING_REFRESH_USERS",null,true)}},sendRoutEvent:function(i){this.alfPublish("CHANGE_STATE_MEETING_DOCUMENT",{state:"На исполнении"});var h=e.getFormValuesById(this.idFormTabMeeting)},isHasProtokol:function(i){var h=e.getStoreById(this.idStoreMeeting);this.serviceXhr({url:"/share/proxy/alfresco/get-children-protocol?nodeRef="+h.nodeRef+"&type=btl-meetingProtocol:meetingProtocolDataType",method:"GET",successCallback:this.isHasProtokolSus,hasProtocolCallBack:i,_this:this,callbackScope:this});return false},isHasProtokolSus:function(i,h){if(i.items.length>0){h.hasProtocolCallBack(h._this)}else{h._this.alfPublish("ALF_DISPLAY_NOTIFICATION",{message:"Не заполнен протокол"},true)}},toRegisterEvent:function(h){this.isHasProtokol(this.registrte)},registrte:function(h){h.serviceXhr({url:"/share/proxy/alfresco/filters/association?type=btl-regJournal:regJournalData&s_field=name&field=name&filter=doctype:5",method:"GET",successCallback:h.registerJoyrnalGet,callbackScope:h})},registerJoyrnalGet:function(i){if(i.result&&i.result.length>0){var h=e.getStoreById(this.idStoreMeeting);this.serviceXhr({url:"/share/proxy/alfresco/action/registrateDoc?nodeRef="+h.nodeRef+"&regJournalRef="+i.result[0].nodeRef+"&prop_btl-documentwf_shtamp=false",method:"GET",successCallback:this.registrateSusses,callbackScope:this})}else{this.alfPublish("ALF_DISPLAY_NOTIFICATION",{message:"Не найден журнал регистрации"},true)}},registrateSusses:function(h){if(this.runToExecute){if(h.number){this.alfPublish("CHANGE_STATE_MEETING_DOCUMENT",{state:"Зарегистрирован"});this.alfPublish("CHANGE_MEETING_REGNUMBER_CONTROL",h.number,true);this.execute(this)}}else{this.alfPublish("CHANGE_MEETING_REGNUMBER_CONTROL",h.number,true);this.setState("Зарегистрирован")}},toRegisterAndExecuteEvent:function(){console.log("click registerAndExecute sending="+___this.getSendingToExecute());if(!___this.getSendingToExecute()){___this.setSendingToExecute(true);console.log("set sending="+___this.getSendingToExecute());___this.toRegisterAndExecute(___this)}},toRegisterAndExecute:function(i){var h=e.getStoreById(i.idStoreMeeting);Alfresco.util.Ajax.request({url:"/share/proxy/alfresco/get-children-protocol?nodeRef="+h.nodeRef+"&type=btl-meetingProtocol:meetingProtocolDataType",successCallback:{fn:function(k){console.log("protocol.len="+k.json.items.length);if(k.json.items.length>0){Alfresco.util.Ajax.request({url:"/share/proxy/alfresco/filters/association?type=btl-regJournal:regJournalData&s_field=name&field=name&filter=doctype:5",successCallback:{fn:function(m){console.log("regJournal "+Boolean(m.json.result)+" len="+m.json.result.length);if(m.json.result&&m.json.result.length>0){Alfresco.util.Ajax.request({url:"/share/proxy/alfresco/action/registrateAndExecuteDoc?nodeRef="+h.nodeRef+"&regJournalRef="+m.json.result[0].nodeRef+"&prop_btl-documentwf_shtamp=false",successCallback:{fn:function(o){i.setState("На исполнении");console.log("registrateAndExecuteDoc completed");var n=i.setSendingToExecute;setTimeout(function(){n(false)},1000)}},failureCallback:{fn:function(p){console.log("registrateAndExecuteDoc failure");if(p.serverResponse.status===500){var o=Alfresco.util.parseJSON(p.serverResponse.responseText);Alfresco.util.PopupManager.displayPrompt({title:"Ошибка!",text:o.message})}var n=i.setSendingToExecute;setTimeout(function(){n(false)},1000)},scope:i},scope:i,execScripts:true})}else{i.alfPublish("ALF_DISPLAY_NOTIFICATION",{message:"Не найден журнал регистрации"},true);var l=i.setSendingToExecute;setTimeout(function(){l(false)},1000)}}},failureCallback:{fn:function(n){console.log("failureCallback2 "+n.serverResponse.status);if(n.serverResponse.status===500){var m=Alfresco.util.parseJSON(n.serverResponse.responseText);Alfresco.util.PopupManager.displayPrompt({title:"Ошибка!",text:m.message})}var l=i.setSendingToExecute;setTimeout(function(){l(false)},1000)},scope:i},scope:i,execScripts:true})}else{i.alfPublish("ALF_DISPLAY_NOTIFICATION",{message:"Не заполнен протокол"},true);var j=i.setSendingToExecute;setTimeout(function(){j(false)},1000)}}},failureCallback:{fn:function(l){console.log("failureCallback1 "+l.serverResponse.status);if(l.serverResponse.status===500){var k=Alfresco.util.parseJSON(l.serverResponse.responseText);Alfresco.util.PopupManager.displayPrompt({title:"Ошибка!",text:k.message})}var j=i.setSendingToExecute;setTimeout(function(){j(false)},1000)},scope:i},scope:i,execScripts:true})},sendingToExecute:false,setSendingToExecute:function(h){___this.sendingToExecute=h},getSendingToExecute:function(){return ___this.sendingToExecute},toExecute:function(){if(!___this.getSendingToExecute()){___this.isHasProtokol(___this.execute)}},execute:function(i){i.setSendingToExecute(true);var h=e.getStoreById(i.idStoreMeeting);i.serviceXhr({url:"/share/proxy/alfresco/meeting/meeting-create-task",method:"POST",data:{nodeRef:h.nodeRef},successCallback:i.toExecuteSusses,callbackScope:i})},toExecuteSusses:function(){this.setState("На исполнении");var h=this.setSendingToExecute;setTimeout(function(){h(false)},1000)},sendingInvitation:false,setSendingInvitation:function(h){this.sendingInvitation=h},getSendingInvitation:function(){return this.sendingInvitation},sendInvitation:function(i){var h=e.getStoreById(this.idStoreMeeting);if(i.items){if(i.items.length==0){this.alfServicePublish(g.DISPLAY_NOTIFICATION,{message:'Не заполнен раздел "Программа". Приглашения не разосланы'});return}}else{var j=e.getFormValuesById(this.idGridProgrammeTabMeeting);if(j.length==0){this.serviceXhr({url:"/share/proxy/alfresco/get-children?nodeRef="+h.nodeRef+"&type=btl-meetingProgramm:meetingProgrammDataType",method:"GET",successCallback:this.sendInvitation,callbackScope:this});return}}if(!this.getSendingInvitation()){Alfresco.util.Ajax.jsonGet({url:Alfresco.constants.PROXY_URI+"getting/get-meeting-participants?nodeRef="+h.nodeRef,successCallback:{fn:function(o){var p;if(o.json!=null){p=o.json.participants}else{var n=JSON.parse(o.serverResponse.responseText);p=n.participants}if(p&&p.length>0){var k=false;for(var m=0;m<p.length;m++){var l=p[m];if(!l["prop_btl-meetingParticipant_invite"]||l["prop_btl-meetingParticipant_invite"]=="Ожидает повторную отправку"){k=true;break}}if(k&&!this.getSendingInvitation()){this.setSendingInvitation(true);this.serviceXhr({url:"/share/proxy/alfresco/api/workflow/activiti%24meetingInvite/formprocessor",method:"POST",data:{assoc_packageItems_added:h.nodeRef},successCallback:this.sendInvitationSuccess,callbackScope:this})}else{this.alfServicePublish(g.DISPLAY_NOTIFICATION,{message:"Всем участникам уже отправлены приглашения"})}}else{this.alfServicePublish(g.DISPLAY_NOTIFICATION,{message:"Не указаны участники"})}},scope:this}})}},sendInvitationSuccess:function(){this.alfServicePublish(g.DISPLAY_NOTIFICATION,{message:"Приглашения разосланы"});var i=this.alfPublish;var h=this.setSendingInvitation;setTimeout(function(){i("PRESS_MEETING_REFRESH_USERS",true,true);h(false)},3000)},completeCreate:function(){var h=e.getStoreById(this.idStoreMeeting);if(h.nodeRef){var i=e.getFormValuesById(this.idFormTabMeeting);if(!i["assoc_btl-meeting_room"]&&!i["assoc_btl-meeting_room_added"]){this.alfPublish("ALF_DISPLAY_NOTIFICATION",{message:"Не указано место проведения"},true);return}if(!i["assoc_btl-meeting_secretary"]&&!i["assoc_btl-meeting_secretary_added"]){this.alfPublish("ALF_DISPLAY_NOTIFICATION",{message:"Не указан секретарь"},true);return}if(!i["assoc_btl-meeting_chairman"]&&!i["assoc_btl-meeting_chairman"]){this.alfPublish("ALF_DISPLAY_NOTIFICATION",{message:"Не указан председатель"},true);return}_state=h.state;this.serviceXhr({url:"/share/proxy/alfresco/meeting/meeting-room-info?nodeRef="+i["assoc_btl-meeting_room"],method:"GET",successCallback:this.roomInfoCompleteSus,callbackScope:this})}else{console.error("Не найден nodeRef документа для обновления")}},roomInfoCompleteSus:function(h){if(h.confirmationRequired&&_state!="Переговорная подтверждена"){this.alfPublish("ALF_DISPLAY_NOTIFICATION",{message:"Не получено подтверждение переговорной"},true)}else{this.toPreparedGetUsers()}},toPreparedGetUsers:function(){var h=e.getStoreById(this.idStoreMeeting);this.serviceXhr({url:"/share/proxy/alfresco/get-children-user?nodeRef="+h.nodeRef+"&type=btl-meetingParticipant:meetingParticipantDataType",method:"GET",successCallback:this.toPrepared,callbackScope:this})},toPrepared:function(n){var l=e.getFormValuesById(this.idFormTabMeeting);var o=e.getFormValuesById(this.idGridUsersTabMeeting);var m=[];for(var k=0;k<n.items.length;k++){var j=n.items[k];if(l["assoc_btl-meeting_chairman"]!=j["prop_btl-meetingParticipant_emp-ref"]){m.push(j["prop_btl-meetingParticipant_emp-ref"])}}if(m.length>0){var h=e.getStoreById(this.idStoreMeeting);_this=this;this.serviceXhr({url:"/share/proxy/alfresco/negotiation/set-negotiation-list-info",method:"POST",data:{documentNodeRef:h.nodeRef,duration:2,levelName:"Согласование",negotiationLevelNodeRef:"",negotiators:m,processType:"0",type:"0",signer:l["assoc_btl-meeting_chairman"],useDocSigner:true},successCallback:function(){_this.setState("Подготовлен")},callbackScope:this})}else{this.setState("Подготовлен")}},toNegotiation:function(){this.isHasProtokol(this.negotiation)},negotiation:function(i){var h=e.getStoreById(i.idStoreMeeting);__this=i;Alfresco.util.Ajax.request({url:"/share/proxy/alfresco/workflow/start-workflow?processName=activiti$Negotiation&packageNodeRef="+h.nodeRef,successCallback:{fn:function(j){__this.cancelMeeting()}},successMessage:"Согласование запущено",failureCallback:{fn:function(k){if(k.serverResponse.status===500){var j=Alfresco.util.parseJSON(k.serverResponse.responseText);Alfresco.util.PopupManager.displayPrompt({title:"Ошибка!",text:j.message})}},scope:i},scope:i,execScripts:true})},cancelNegotiation:function(){var h=e.getStoreById(this.idStoreMeeting);_this=this;Alfresco.util.Ajax.request({url:"/share/proxy/alfresco/workflow/cancel-workflow?processName=activiti$Negotiation&packageNodeRef="+h.nodeRef,successCallback:{fn:function(i){_this.setState("На доработке")}},successMessage:"Согласование прервано",failureCallback:{fn:function(j){if(j.serverResponse.status===500){var i=Alfresco.util.parseJSON(j.serverResponse.responseText);Alfresco.util.PopupManager.displayPrompt({title:"Ошибка!",text:i.message})}},scope:this},scope:this,execScripts:true})},cancelSigner:function(){var h=e.getStoreById(this.idStoreMeeting);_this=this;Alfresco.util.Ajax.request({url:"/share/proxy/alfresco/workflow/cancel-workflow?processName=activiti$Signing&packageNodeRef="+h.nodeRef,successCallback:{fn:function(i){_this.setState("На доработке")}},successMessage:"Подписание прервано",failureCallback:{fn:function(j){if(j.serverResponse.status===500){var i=Alfresco.util.parseJSON(j.serverResponse.responseText);Alfresco.util.PopupManager.displayPrompt({title:"Ошибка!",text:i.message})}},scope:this},scope:this,execScripts:true})}})});