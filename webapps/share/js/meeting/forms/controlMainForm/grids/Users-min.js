define(["dojo/_base/declare","../../../grids/_Grid","dojo/_base/lang","meeting/utils/base","alfresco/core/CoreXhr","alfresco/core/topics","jquery"],function(b,a,f,e,c,g,d){return b([a],{state:"",documentNodeRef:null,Url:"get-children-user",loadData:false,clearInvitatCount:0,type:"btl-meetingParticipant:meetingParticipantDataType",pageModel:{location:"remote",rPP:10,strRpp:"{0}",rPPOptions:[10,25,50]},colModel:[{title:"nodeRef",width:100,dataType:"string",dataIndx:"nodeRef",hidden:true},{title:"nodeRefEmployee",width:100,dataType:"string",dataIndx:"prop_btl-meetingParticipant_emp-ref",hidden:true},{title:"Сотрудник",width:170,dataType:"string",dataIndx:"prop_btl-meetingParticipant_emp-content"},{title:"Приглашение",width:150,dataType:"string",dataIndx:"prop_btl-meetingParticipant_invite"},{title:"Отсутствовал",width:80,dataIndx:"prop_btl-meetingParticipant_absence",render:function(h){var j=h.rowIndx+"_"+Math.random().toString(36).substr(2,9)+"_checkbox";var i=(h.cellData)?"checked":"";return'<div class="checkbox"><input type="checkbox" id="'+j+'" '+i+' ><label for="'+j+'"></label></div>'}},{title:"",width:20,render:function(h){return'<div style="margin: 0 auto; width: 24px;"><button type="button" title="Удалить" class="delete-btn" role="button"><span class="delete-btn-icon"></span></button></div>'}}],postMixInProperties:function(){this.inherited(arguments);var h=e.getStoreById("MEETING_STORE");handleAlfSubscribe=h.handleAlfSubscribe;handleAlfSubscribe.push(this.alfSubscribe("USERS_PANE_MAIN_FORM_MEETING_SHOW",f.hitch(this,this.showData),true));handleAlfSubscribe.push(this.alfSubscribe("ADD_USERS_MEETING_GET_USERS",f.hitch(this,this.addUsers),true));handleAlfSubscribe.push(this.alfSubscribe("CHANGE_STATE_MEETING_DOCUMENT",f.hitch(this,this.setState),true));handleAlfSubscribe.push(this.alfSubscribe("PRESS_MEETING_CLEAR_USERS_INVITE",f.hitch(this,this.clearInvitatUsers),true));handleAlfSubscribe.push(this.alfSubscribe("PRESS_MEETING_CLEAR_USERS_INVITE_ALL",f.hitch(this,this.clearInvitatAllUsers),true));handleAlfSubscribe.push(this.alfSubscribe("PRESS_MEETING_REFRESH_USERS",f.hitch(this,this.refreshUsers),true));handleAlfSubscribe.push(this.alfSubscribe(this.id+"DELETE_ROW__SUCCESS",f.hitch(this,this.deleteRowSuccess),true));if(!this.state&&this.storeId){var h=e.getStoreById(this.storeId);if(h.document){this.documentNodeRef=h.nodeRef;this.rootNodeRef=this.documentNodeRef;this.loadData=true}}},refreshUsers:function(){this.loadDataDataGrid({nodeRef:this.documentNodeRef})},postCreate:function(){var h=this;this.inherited(arguments);this.grid.on("pqgridrefresh pqgridrefreshrow",function(){var i=d(this);var k=i.find("button.delete-btn");if(!h.documentNodeRef||h._disabled){k.css("display","none")}k.unbind("click").bind("click",function(l){var n=d(this).closest("tr"),m=i.pqGrid("getRowIndx",{$tr:n}).rowIndx;h.deleteRow(m,i)});var j=i.find(".checkbox input[type=checkbox]");if(!h.documentNodeRef||h._disabled){j.change(function(){d(this)[0].checked=!d(this)[0].checked})}else{j.unbind("click").bind("click",function(n){var m=d(this).closest("tr"),l=i.pqGrid("getRowIndx",{$tr:m}).rowIndx;h.editRow(l,i,this.checked)})}})},clearInvitatAllUsers:function(){var j=this.grid.pqGrid("getData",{dataIndx:["nodeRef","prop_btl-meetingParticipant_invite","prop_btl-meetingParticipant_emp-content"]});this.clearInvitatCount=0;for(var h=0;h<j.length;h++){var k=j[h];this.clearInvitatRow(k)}},clearInvitatRow:function(i){var h=i["prop_btl-meetingParticipant_invite"];if(h&&h!="Ожидает повторную отправку"&&h!="Ожидает решения"){this.clearInvitatCount++;this.serviceXhr({url:"/share/proxy/alfresco/api/node/"+i.nodeRef.replace("://","/")+"/formprocessor",method:"POST",data:{"prop_btl-meetingParticipant_invite":"Ожидает повторную отправку"},successCallback:this.successClearInvitatRow,callbackScope:this})}},successClearInvitatRow:function(){this.clearInvitatCount--;if(this.clearInvitatCount==0){this.alfPublish("PRESS_MEETING_REFRESH_USERS",true,true)}},clearInvitatUsers:function(){var h=this.grid.pqGrid("selection",{type:"row",method:"getSelection"});this.clearInvitatCount=0;var k=false;if(h&&h.length>0){for(var j=0;j<h.length;j++){var l=h[j].rowData;this.clearInvitatRow(l)}}},deleteRow:function(i,h){if(this.documentNodeRef){var j=h.pqGrid("getRowData",{rowIndx:i});if(j["prop_btl-meetingParticipant_invite"]=="Ожидает решения"){this.alfPublish("ALF_DISPLAY_NOTIFICATION",{message:"Данному участнику направлено задание приглашения. Удалить его нельзя."},true);return}this.alfPublish("ALF_CRUD_DELETE",{requiresConfirmation:true,url:"slingshot/datalists/list/node/"+j.nodeRef.replace("://","/"),confirmationTitle:"Удаление участника",responseTopic:this.id+"DELETE_ROW",noRefresh:true,item:{rowIndx:i},confirmationPrompt:"Вы уверены что хотите удалить участника "+j["prop_btl-meetingParticipant_emp-content"]+"?",successMessage:"Участник "+j["prop_btl-meetingParticipant_emp-content"]+" успешно удален."},true)}else{this.grid.pqGrid("deleteRow",{rowIndx:i})}},editRow:function(j,h,i){if(this.documentNodeRef){var k=h.pqGrid("getRowData",{rowIndx:j});this.serviceXhr({url:"/share/proxy/alfresco/api/node/"+k.nodeRef.replace("://","/")+"/formprocessor",method:"POST",data:{"prop_btl-meetingParticipant_absence":i},callbackScope:this})}},addUsers:function(i){if(i.users){var j=this;var h=[];i.users.forEach(function(k){h.push({nodeRef:"","prop_btl-meetingParticipant_emp-ref":k.nodeRef,"prop_btl-meetingParticipant_emp-content":k.name,"prop_btl-meetingParticipant_invite":"","prop_btl-meetingParticipant_absence":false})});if(this.documentNodeRef||i.documentRef){this.serviceXhr({url:"/share/proxy/alfresco/meeting/create-meta",method:"POST",data:{nodeRef:(this.documentNodeRef)?this.documentNodeRef:i.documentRef,users:h},successCallback:this.successCallback,callbackScope:this})}else{h.forEach(function(k){j.grid.pqGrid("addRow",{rowData:k})})}}if(i.documentRef){setTimeout(this.alfPublish("PRESS_MEETING_REFRESH_USERS",true,true),3000)}else{this.grid.pqGrid("refreshDataAndView")}},successCallback:function(i,h){if(i.items&&i.items.users){var j=this;i.items.users.forEach(function(k){j.grid.pqGrid("addRow",{rowData:k})});this.alfServicePublish(g.DISPLAY_NOTIFICATION,{message:h.successMessage})}},deleteRowSuccess:function(h){this.grid.pqGrid("deleteRow",{rowIndx:h.data.data.item.rowIndx})},setState:function(h){this.state=h.state;if(h.nodeRef){this.documentNodeRef=h.nodeRef}this.grid.pqGrid("refreshDataAndView")},})});