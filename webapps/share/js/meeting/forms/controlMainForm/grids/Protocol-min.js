define(["dojo/_base/declare","alfresco/core/Core","../../../grids/_Grid","dojo/_base/lang","alfresco/core/CoreXhr","meeting/utils/base"],function(b,g,a,f,d,e){return b([a],{Url:"get-children-protocol",type:"btl-meetingProtocol:meetingProtocolDataType",pageModel:{location:"remote",rPP:10,strRpp:"{0}",rPPOptions:[10,25,50]},colModel:[{title:"nodeRef",width:100,dataType:"string",dataIndx:"nodeRef",hidden:true},{title:"Вопрос",width:200,dataType:"string",dataIndx:"assoc_btl-meetingProtocol_question_val"},{title:"Вопрос",width:200,dataType:"string",dataIndx:"assoc_btl-meetingProtocol_question_added",hidden:true},{title:"Решение",width:200,dataType:"string",dataIndx:"prop_btl-meetingProtocol_decision"},{title:"Ответственный",width:130,dataType:"string",dataIndx:"assoc_btl-meetingProtocol_employee_val"},{title:"Ответственный",width:200,dataType:"string",dataIndx:"assoc_btl-meetingProtocol_employee_added",hidden:true},{title:"Срок исполнения",width:100,dataType:"date",dataIndx:"prop_periodOfExecution"},{title:"Требуется контроль",width:50,dataType:"string",dataIndx:"prop_btl-meetingProtocol_onControl",hidden:true},{title:"Требуется контроль",width:50,dataType:"string",dataIndx:"prop_btl-meetingProtocol_onControl_img"},{title:"Контролер",width:130,dataType:"string",dataIndx:"assoc_btl-meetingProtocol_controller_val"},{title:"Контролер",width:200,dataType:"string",dataIndx:"assoc_btl-meetingProtocol_controller_added",hidden:true},{title:"",width:50,render:function(i){return'<div style="margin: 0 auto; width: 24px;"><button type="button" title="Удалить" class="delete-btn" role="button"><span class="delete-btn-icon"></span></button></div>'}}],postMixInProperties:function(){this.inherited(arguments);var i=e.getStoreById("MEETING_STORE");handleAlfSubscribe=i.handleAlfSubscribe;handleAlfSubscribe.push(this.alfSubscribe("BTL_CREATE_FORM_PROTOCOL",f.hitch(this,this.onCreateFormProtocol),true));handleAlfSubscribe.push(this.alfSubscribe("ADD_PROTOCOL_MEETING_PROGRAMM_TOPIC",f.hitch(this,this.addProtocol),true));handleAlfSubscribe.push(this.alfSubscribe("EDIT_PROTOCOL_MEETING_PROGRAMM_TOPIC",f.hitch(this,this.editProtocol),true));handleAlfSubscribe.push(this.alfSubscribe("ALF_EDIT_PROTOCOL",f.hitch(this,this.editFormProtocol),true));handleAlfSubscribe.push(this.alfSubscribe("PROTOCOL_PANE_MAIN_FORM_MEETING_SHOW",f.hitch(this,this.showData),true));handleAlfSubscribe.push(this.alfSubscribe(this.id+"DELETE_ROW__SUCCESS",f.hitch(this,this.deleteRowSuccess),true));if(!this.state&&this.storeId){var i=e.getStoreById(this.storeId);if(i.document){this.documentNodeRef=i.nodeRef;this.rootNodeRef=this.documentNodeRef}}},postCreate:function(){var i=this;this.inherited(arguments);this.grid.on("pqgridrefresh pqgridrefreshrow",function(){var j=$(this);var k=j.find("button.delete-btn");if(!i.documentNodeRef||i._disabled){k.css("display","none")}k.unbind("click").bind("click",function(l){var n=$(this).closest("tr"),m=j.pqGrid("getRowIndx",{$tr:n}).rowIndx;i.deleteRow(m,j)})})},setEventsDataGrid:function(){var i=this;if(!i._disabled){this.grid.pqGrid({rowDblClick:function(j,k){i.editFormProtocol()}})}},deleteRow:function(j,i){if(this.documentNodeRef){var k=i.pqGrid("getRowData",{rowIndx:j});this.alfPublish("ALF_CRUD_DELETE",{requiresConfirmation:true,url:"slingshot/datalists/list/node/"+k.nodeRef.replace("://","/"),confirmationTitle:"Удаление протокола",responseTopic:this.id+"DELETE_ROW",noRefresh:true,item:{rowIndx:j},confirmationPrompt:"Вы уверены что хотите удалить протокол "+k["prop_btl-meetingProtocol_decision"]+"?",successMessage:"Протокол "+k["prop_btl-meetingProtocol_decision"]+" успешно удален."},true)}else{this.grid.pqGrid("deleteRow",{rowIndx:j})}},deleteRowSuccess:function(i){this.grid.pqGrid("deleteRow",{rowIndx:i.data.data.item.rowIndx})},editFormProtocol:function(){var i=this.grid.pqGrid("selection",{type:"row",method:"getSelection"});if(i&&i.length>0){var l=i[0].rowData;var k={};k.config={};k.data=l;k.data.rowId=i[0].rowIndx;k.config.dialogTitle="Редактировать протокол";k.config.dialogConfirmationButtonTitle="Сохранить";k.config.dialogCancellationButtonTitle="Отмена";if(k.data.prop_periodOfExecution){var j=k.data.prop_periodOfExecution;if(j.substr(2,1)=="."){k.data.prop_periodOfExecution=j.substr(6,4)+"-"+j.substr(3,2)+"-"+j.substr(0,2)}}k.config.formSubmissionTopic="EDIT_PROTOCOL_MEETING_PROGRAMM_TOPIC";this.alfPublish("BTL_CREATE_FORM_PROTOCOL",k,true)}},editProtocol:function(l){var j={};var i="Нет";if(l["prop_btl-meetingProtocol_onControl"]){i="Да"}else{if(l["assoc_btl-meetingProtocol_controller"]){l["assoc_btl-meetingProtocol_controller_removed"]=l["assoc_btl-meetingProtocol_controller"];l["assoc_btl-meetingProtocol_controller"]="";l["assoc_btl-meetingProtocol_controller_added"]="";l["assoc_btl-meetingProtocol_controller_val"]=""}}var k=l["prop_btl-meetingProtocol_periodOfExecution"];if(k){j["prop_btl-meetingProtocol_periodOfExecution"]=l["prop_btl-meetingProtocol_periodOfExecution"];k=k.substr(8,2)+"."+k.substr(5,2)+"."+k.substr(0,4);j.prop_periodOfExecution=k}else{l["prop_btl-meetingProtocol_periodOfExecution"]=""}l["prop_btl-meetingProtocol_question-content"]=l["assoc_btl-meetingProtocol_question_values"];l["prop_btl-meetingProtocol_question-ref"]=l["assoc_btl-meetingProtocol_question"];j.rowId=l.rowId;j.nodeRef=l.nodeRef;j["prop_btl-meetingProtocol_decision"]=l["prop_btl-meetingProtocol_decision"];j["assoc_btl-meetingProtocol_employee_val"]=l["assoc_btl-meetingProtocol_employee_val"];j["assoc_btl-meetingProtocol_employee_added"]=l["assoc_btl-meetingProtocol_employee"];j["prop_btl-meetingProtocol_onControl"]=l["prop_btl-meetingProtocol_onControl"];j["prop_btl-meetingProtocol_onControl_img"]=i;j["assoc_btl-meetingProtocol_controller_val"]=l["assoc_btl-meetingProtocol_controller_val"];j["assoc_btl-meetingProtocol_controller_added"]=l["assoc_btl-meetingProtocol_controller"];j["assoc_btl-meetingProtocol_question_val"]=l["assoc_btl-meetingProtocol_question_values"];j["assoc_btl-meetingProtocol_question_added"]=l["assoc_btl-meetingProtocol_question"];l["prop_btl-meetingProtocol_controller-content"]=l["assoc_btl-meetingProtocol_controller_val"];l["prop_btl-meetingProtocol_controller-ref"]=l["assoc_btl-meetingProtocol_controller"];l["prop_btl-meetingProtocol_employee-ref"]=l["assoc_btl-meetingProtocol_employee"];l["prop_btl-meetingProtocol_employee-content"]=l["assoc_btl-meetingProtocol_employee_val"];if(l.nodeRef){this.serviceXhr({url:"/share/proxy/alfresco/api/node/"+l.nodeRef.replace("://","/")+"/formprocessor",method:"POST",data:l,successCallback:this.grid.pqGrid("updateRow",{rowIndx:j.rowId,row:j}),callbackScope:this})}else{this.grid.pqGrid("updateRow",{rowIndx:j.rowId,row:j})}},addProtocol:function(k){var i="Нет";if(k["prop_btl-meetingProtocol_onControl"]){i="Да"}var m=this;var l={nodeRef:"","prop_btl-meetingProtocol_decision":k["prop_btl-meetingProtocol_decision"],"prop_btl-meetingProtocol_onControl":k["prop_btl-meetingProtocol_onControl"],"prop_btl-meetingProtocol_onControl_img":i,"assoc_btl-meetingProtocol_employee_added":k["assoc_btl-meetingProtocol_employee_added"],"assoc_btl-meetingProtocol_employee_val":k["assoc_btl-meetingProtocol_employee_val"],"prop_btl-meetingProtocol_employee-ref":k["assoc_btl-meetingProtocol_employee"],"prop_btl-meetingProtocol_employee-content":k["assoc_btl-meetingProtocol_employee_val"],"assoc_btl-meetingProtocol_controller_added":k["assoc_btl-meetingProtocol_controller_added"],"assoc_btl-meetingProtocol_controller_val":k["assoc_btl-meetingProtocol_controller_val"],"prop_btl-meetingProtocol_controller-content":k["assoc_btl-meetingProtocol_controller_val"],"prop_btl-meetingProtocol_controller-ref":k["assoc_btl-meetingProtocol_controller"],"assoc_btl-meetingProtocol_question_added":k["assoc_btl-meetingProtocol_question_added"],"assoc_btl-meetingProtocol_question_val":k["assoc_btl-meetingProtocol_question_values"],"prop_btl-meetingProtocol_question-content":k["assoc_btl-meetingProtocol_question_values"],"prop_btl-meetingProtocol_question-ref":k["assoc_btl-meetingProtocol_question"]};var j=k["prop_btl-meetingProtocol_periodOfExecution"];if(j){l["prop_btl-meetingProtocol_periodOfExecution"]=k["prop_btl-meetingProtocol_periodOfExecution"];j=j.substr(8,2)+"."+j.substr(5,2)+"."+j.substr(0,4);l.prop_periodOfExecution=j}if(this.documentNodeRef||k.documentNodeRef){l.alf_destination=(this.documentNodeRef)?this.documentNodeRef:k.documentNodeRef;if(k.rowId!=null){l.rowId=k.rowId}this.serviceXhr({url:"/share/proxy/alfresco/api/type/btl-meetingProtocol%3ameetingProtocolDataType/formprocessor",method:"POST",data:l,successCallback:this.updateProtocolGrid,callbackScope:this})}else{this.grid.pqGrid("addRow",{rowData:l})}},updateProtocolGrid:function(i,j){j.data.nodeRef=i.persistedObject;if(j.data.rowId!=null){this.grid.pqGrid("updateRow",{rowIndx:j.data.rowId,row:j.data})}else{this.grid.pqGrid("addRow",{rowData:j.data})}},loadDataToDataGrid:function h(j,i){j.items.forEach(function(m,l,k){if(m["prop_btl-meetingProtocol_onControl"]==true){j.items[l]["prop_btl-meetingProtocol_onControl_img"]="Да"}else{j.items[l]["prop_btl-meetingProtocol_onControl_img"]="Нет"}});this.setDataDataGrid(j.items)},onCreateFormProtocol:function(i){this.data=i.data;this.rootNodeRef=i.rootNodeRef;var j={};j.dialogTitle=i.config.dialogTitle;j.contentWidth="900px";j.dialogConfirmationButtonTitle=i.config.dialogConfirmationButtonTitle;j.dialogCancellationButtonTitle=i.config.dialogCancellationButtonTitle;j.formSubmissionTopic=i.config.formSubmissionTopic;j.widgets=this.getWidgets();this.alfPublish("ALF_CREATE_FORM_DIALOG_REQUEST",j,true)},getWidgets:function c(){var i=[{name:"alfresco/forms/ControlRow",config:{widgets:[{name:"btl/widgets/base/ClassicWindow",id:"WIN_DELEGATES",config:{title:"Вопрос",style:"width: 383px;",widgets:[{name:"meeting/choices/_Choice",config:{name:"assoc_btl-meetingProtocol_question",header:"Выбрать вопрос",loadData:true,width:360,height:222,labelButton:"Выбрать",labelText:"Вопрос",single:false,value:(this.data!==null)?this.data["assoc_btl-meetingProtocol_question_added"]:"",urlList:"/share/proxy/alfresco/filters/association",dataUrl:{type:"btl-meetingProgramm:meetingProgrammDataType",s_field:"btl-meetingProgramm:question",field:"btl-meetingProgramm:question",extra:"PARENT:'"+this.documentNodeRef+"'"},itemUrl:"/share/proxy/alfresco/picker/associationItems",dataItemUrl:{type:"btl-meetingProgramm:meetingProgrammDataType",field:"btl-meetingProgramm:question"}}},]}},{name:"btl/widgets/base/ClassicWindow",id:"WIN_DELEGATES",config:{title:"Решение",style:"width: 383px;",widgets:[{name:"alfresco/forms/controls/TextArea",config:{name:"prop_btl-meetingProtocol_decision",label:"Описание:",rows:"4",value:(this.data!==null)?this.data["prop_btl-meetingProtocol_decision"]:"",requirementConfig:{initialValue:true}}},{name:"meeting/dateTextBox/_DateTextBox_95",config:{name:"prop_btl-meetingProtocol_periodOfExecution",label:"Срок исполнения:",value:(this.data!==null)?this.data.prop_periodOfExecution:"",style:{},requirementConfig:{initialValue:true}}},{name:"meeting/choices/_Choice",config:{name:"assoc_btl-meetingProtocol_employee",header:"Выбрать ответственного",labelButton:"Выбрать",labelText:"Ответственный:",value:(this.data!==null)?this.data["assoc_btl-meetingProtocol_employee_added"]:"",urlList:"/share/proxy/alfresco/filters/association",dataUrl:{type:"btl-emp:employee-content",s_field:"btl-people:fio",field:"btl-people:fio"},itemUrl:"/share/proxy/alfresco/picker/associationItem",dataItemUrl:{type:"btl-emp:employee-content",field:"btl-people:fio"},requirementConfig:{initialValue:true}}},{name:"alfresco/forms/controls/CheckBox",id:"prop_btl-meetingProtocol_onControl",config:{label:"Требуется контроль",style:"margin-top: -3px;",name:"prop_btl-meetingProtocol_onControl",fieldId:"PROTOCOL_ON_CONTROL_CHECK",value:(this.data!==null)?this.data["prop_btl-meetingProtocol_onControl"]:"",checked:true}},{name:"meeting/forms/controlMainForm/choices/ProtocolController",config:{value:(this.data!==null)?this.data["assoc_btl-meetingProtocol_controller_added"]:"",}}]}}]}}];if(this.data!==null){i.push({name:"alfresco/forms/controls/DojoValidationTextBox",config:{name:"nodeRef",value:this.data.nodeRef,visibilityConfig:{initialValue:false}}},{name:"alfresco/forms/controls/DojoValidationTextBox",config:{name:"rowId",value:this.data.rowId,visibilityConfig:{initialValue:false}}})}else{i.push({name:"alfresco/forms/controls/DojoValidationTextBox",config:{name:"alf_destination",value:this.rootNodeRef,visibilityConfig:{initialValue:false}}})}return i}})});