define(["dojo/_base/declare","../../../grids/_Grid","dojo/_base/lang","meeting/utils/base","alfresco/core/topics","jquery","dojo/domReady!"],function(b,a,e,d,f,c){return b([a],{Url:"get-children",type:"btl-meetingProgramm:meetingProgrammDataType",pageModel:{location:"remote",rPP:10,strRpp:"{0}",rPPOptions:[10,25,50]},colModel:[{title:"nodeRef",width:100,dataType:"string",dataIndx:"nodeRef",hidden:true},{title:"Вопрос",width:400,dataType:"string",dataIndx:"prop_btl-meetingProgramm_question"},{title:"Докладчик",width:300,dataType:"string",dataIndx:"prop_btl-meetingProgramm_employees-content"},{title:"Докладчик nodeRefs",width:100,dataType:"string",dataIndx:"prop_btl-meetingProgramm_employees-ref",hidden:true},{title:"",width:50,render:function(g){return'<div style="margin: 0 auto; width: 24px;"><button type="button" title="Удалить" class="delete-btn" role="button"><span class="delete-btn-icon"></span></button></div>'}},{title:"",width:1,dataType:"string"}],postMixInProperties:function(){this.inherited(arguments);var g=d.getStoreById("MEETING_STORE");handleAlfSubscribe=g.handleAlfSubscribe;handleAlfSubscribe.push(this.alfSubscribe("ADD_QUESTION_MEETING_PROGRAMM_TOPIC",e.hitch(this,this.addQuestion),true));handleAlfSubscribe.push(this.alfSubscribe("EDIT_PROGRAMME_MEETING_PROGRAMM_TOPIC",e.hitch(this,this.editProgramme),true));handleAlfSubscribe.push(this.alfSubscribe("PROGRAMME_PANE_MAIN_FORM_MEETING_SHOW",e.hitch(this,this.showData),true));handleAlfSubscribe.push(this.alfSubscribe("PRESS_MEETING_REFRESH_PROGRAMME",e.hitch(this,this.refreshProgramme),true));handleAlfSubscribe.push(this.alfSubscribe("ALF_EDIT_PROGRAMM",e.hitch(this,this.editFormProgramme),true));handleAlfSubscribe.push(this.alfSubscribe("BTL_CREATE_FORM_PROGRAMM",e.hitch(this,this.onCreateFormProgramme),true));handleAlfSubscribe.push(this.alfSubscribe(this.id+"DELETE_ROW__SUCCESS",e.hitch(this,this.deleteRowSuccess),true));if(!this.state&&this.storeId){var g=d.getStoreById(this.storeId);if(g.document){this.documentNodeRef=g.nodeRef;this.rootNodeRef=this.documentNodeRef}}},refreshProgramme:function(){this.loadDataDataGrid({nodeRef:this.documentNodeRef})},postCreate:function(){var g=this;this.inherited(arguments);this.grid.on("pqgridrefresh pqgridrefreshrow",function(){var h=c(this);var i=h.find("button.delete-btn");if(!g.documentNodeRef||g._disabled){i.css("display","none")}i.unbind("click").bind("click",function(j){var l=c(this).closest("tr"),k=h.pqGrid("getRowIndx",{$tr:l}).rowIndx;g.deleteRow(k,h)})})},setEventsDataGrid:function(){var g=this;if(!g._disabled){this.grid.pqGrid({rowDblClick:function(h,i){g.editFormProgramme()}})}},editFormProgramme:function(){var g=this.grid.pqGrid("selection",{type:"row",method:"getSelection"});if(g&&g.length>0){var i=g[0].rowData;var h={};h.config={};h.data=i;h.data.rowId=g[0].rowIndx;h.config.dialogTitle="Редактировать вопрос";h.config.dialogConfirmationButtonTitle="Сохранить";h.config.dialogCancellationButtonTitle="Отмена";h.config.formSubmissionTopic="EDIT_PROGRAMME_MEETING_PROGRAMM_TOPIC";this.alfPublish("BTL_CREATE_FORM_PROGRAMM",h,true)}},editProgramme:function(h){var g={};g.rowId=h.rowId;g.nodeRef=h.nodeRef;g["prop_btl-meetingProgramm_employees-ref"]=h["assoc_btl-meetingProgramm_employees"];g["prop_btl-meetingProgramm_employees-content"]=h["assoc_btl-meetingProgramm_employees_val"];g["assoc_btl-meetingProgramm_employees_added"]=h["assoc_btl-meetingProgramm_employees_added"];g["assoc_btl-meetingProgramm_employees_removed"]=h["assoc_btl-meetingProgramm_employees_removed"];g["prop_btl-meetingProgramm_question"]=h["prop_btl-meetingProgramm_question"];if(h.nodeRef){this.serviceXhr({url:"/share/proxy/alfresco/api/node/"+h.nodeRef.replace("://","/")+"/formprocessor",method:"POST",data:g,successCallback:this.grid.pqGrid("updateRow",{rowIndx:g.rowId,row:g}),callbackScope:this})}else{this.grid.pqGrid("updateRow",{rowIndx:g.rowId,row:g})}},addQuestion:function(h){var i=this;var g=[];if(h.programme){g=h.programme}else{g.push({nodeRef:"","prop_btl-meetingProgramm_employees-ref":h["assoc_btl-meetingProgramm_employees"],"prop_btl-meetingProgramm_employees-content":h["assoc_btl-meetingProgramm_employees_val"],"prop_btl-meetingProgramm_question":h["prop_btl-meetingProgramm_question"]})}if(this.documentNodeRef||h.documentRef){this.serviceXhr({url:"/share/proxy/alfresco/meeting/create-meta",method:"POST",data:{nodeRef:(this.documentNodeRef)?this.documentNodeRef:h.documentRef,programme:g},successMessage:"Вопрос успешно добален.",successCallback:this.successCallback,callbackScope:this})}else{g.forEach(function(j){i.grid.pqGrid("addRow",{rowData:j})})}if(h.documentRef){setTimeout(this.alfPublish("PRESS_MEETING_REFRESH_PROGRAMME",true,true),3000)}else{this.grid.pqGrid("refreshDataAndView")}},successCallback:function(h,g){if(h.items&&h.items.programme){var i=this;h.items.programme.forEach(function(j){i.grid.pqGrid("addRow",{rowData:j})});this.alfServicePublish(f.DISPLAY_NOTIFICATION,{message:g.successMessage})}},deleteRowSuccess:function(g){this.grid.pqGrid("deleteRow",{rowIndx:g.data.data.item.rowIndx})},deleteRow:function(h,g){_rowIndx=h;_grid=g;_this=this;if(this.documentNodeRef){this.serviceXhr({url:"/share/proxy/alfresco/get-children-protocol?nodeRef="+this.documentNodeRef+"&type=btl-meetingProtocol:meetingProtocolDataType",method:"GET",successCallback:this.deleteProgRow,callbackScope:this})}else{this.grid.pqGrid("deleteRow",{rowIndx:h})}},deleteProgRow:function(j){var h=_grid.pqGrid("getRowData",{rowIndx:_rowIndx});for(var g=0;g<j.items.length;g++){if(j.items[g]["assoc_btl-meetingProtocol_question_added"].indexOf(h.nodeRef)>-1){_this.alfPublish("ALF_DISPLAY_NOTIFICATION",{message:"Нельзя удалить вопрос т.к. он используется в протоколе"},true);return}}_this.alfPublish("ALF_CRUD_DELETE",{requiresConfirmation:true,url:"slingshot/datalists/list/node/"+h.nodeRef.replace("://","/"),confirmationTitle:"Удаление вопроса",responseTopic:_this.id+"DELETE_ROW",noRefresh:true,item:{rowIndx:_rowIndx},confirmationPrompt:"Вы уверены что хотите удалить вопрос "+h["prop_btl-meetingProgramm_question"]+"?",successMessage:"Вопрос "+h["prop_btl-meetingProgramm_question"]+" успешно удален."},true)},onCreateFormProgramme:function(g){this.data=g.data;this.rootNodeRef=g.rootNodeRef;var h={};h.dialogTitle=g.config.dialogTitle;h.contentHeight="320px";h.dialogConfirmationButtonTitle=g.config.dialogConfirmationButtonTitle;h.dialogCancellationButtonTitle=g.config.dialogCancellationButtonTitle;h.formSubmissionTopic=g.config.formSubmissionTopic;h.widgets=this.getWidgets();this.alfPublish("ALF_CREATE_FORM_DIALOG_REQUEST",h,true)},getWidgets:function(){var g=[{name:"btl/widgets/base/TextBox",config:{name:"prop_btl-meetingProgramm_question",value:(this.data!==null)?this.data["prop_btl-meetingProgramm_question"]:"",label:"Вопрос",style:{},labelStyle:{width:"unset"}}},{name:"meeting/forms/controlMainForm/choices/ProgrammEmployees",id:"ASSOC_BTL_MEETING_PROGRAMM_EMPLOYEES",config:{value:(this.data!==null)?this.data["prop_btl-meetingProgramm_employees-ref"]:"",storeId:this.storeId}}];if(this.data!==null){g.push({name:"alfresco/forms/controls/DojoValidationTextBox",config:{name:"nodeRef",value:this.data.nodeRef,visibilityConfig:{initialValue:false}}},{name:"alfresco/forms/controls/DojoValidationTextBox",config:{name:"rowId",value:this.data.rowId,visibilityConfig:{initialValue:false}}})}else{g.push({name:"alfresco/forms/controls/DojoValidationTextBox",config:{name:"alf_destination",value:this.rootNodeRef,visibilityConfig:{initialValue:false}}})}return g},})});