define(["dojo/_base/declare","alfresco/core/Core","dojo/_base/lang","alfresco/core/CoreXhr","meeting/utils/base","dojo/store/Memory","dojo/store/Cache","dojo/store/Observable","dijit/_WidgetBase","dijit/_TemplatedMixin","dojo/text!./templates/tree.html"],function(e,f,b,c,d,h,i,g,a,j,k){return e([a,j,f,c],{templateString:k,style:"border: 1px solid #ccc; min-height: 54px;width: 273px;",isLoad:false,getValue:function(){return null},cssRequirements:[{cssFile:"./css/tree.css"}],postMixInProperties:function(){var l=d.getStoreById("MEETING_STORE");handleAlfSubscribe=l.handleAlfSubscribe;handleAlfSubscribe.push(this.alfSubscribe("MOVE_UP_APPROVAL",b.hitch(this,this.moveUp),true));handleAlfSubscribe.push(this.alfSubscribe("MOVE_DOWN_APPROVAL",b.hitch(this,this.moveDown),true));handleAlfSubscribe.push(this.alfSubscribe("DELETE_APPROVAL",b.hitch(this,this.deleteCurrentNode),true));handleAlfSubscribe.push(this.alfSubscribe("REFRESH_APPROVAL",b.hitch(this,this.refreshNegotiationList),true))},load:function(){if(this.isLoad){return}loadLevelNegotiators=function(n,l){for(var m=0;m<l.length;m++){var p=l[m];var o=new YAHOO.widget.TextNode({id:p.nodeRef,label:p.fullName,labelStyle:"icon-emp",expanded:false,isLeaf:true},n)}_listTree.render()};loadDataForNode=function(n,m){if(n.depth==0){levelNodeRef=n.data.id;Alfresco.util.Ajax.jsonGet({url:Alfresco.constants.PROXY_URI+"negotiation/get-negotiators-for-level?negotiationLevelNodeRef="+levelNodeRef,successCallback:{fn:function l(o){if(o.serverResponse.status==200){loadLevelNegotiators(n,o.json.negotiators)}else{console.log("Error getting negotiation list")}},scope:this}})}m()};_listTree=new YAHOO.widget.TreeView(this.domNode.getElementsByTagName("div")[0]);_listTree.setDynamicLoad(loadDataForNode);_listTree.subscribe("focusChanged",this.onNegotiationListFocusChanged.bind(this));this.listTree=_listTree;this.refreshNegotiationList();this.isLoad=true},refreshNegotiationList:function(){var l=d.getStoreById("MEETING_STORE");this.getNegotiationList(l.nodeRef)},moveUp:function(){if(currentNode){var l=currentNode.data.id;this.changePosition(l,-1,this.refreshNegotiationList)}},moveDown:function(){if(currentNode){var l=currentNode.data.id;this.changePosition(l,1,this.refreshNegotiationList)}},deleteCurrentNode:function(){if(currentNode){var l=currentNode.data.id;this.deleteNode(l,this.refreshNegotiationList)}},deleteNode:function(l,n){var m={type:"cm:folder"};Alfresco.util.Ajax.jsonPost({method:"POST",url:"/share/proxy/alfresco/slingshot/doclib/action/files?alf_method=delete",dataObj:{nodeRefs:[l]},successCallback:{fn:n,scope:this}})},changePosition:function(m,l,n){Alfresco.util.Ajax.jsonGet({method:"GET",url:"/share/proxy/alfresco/negotiation/change-position-in-negotiation-list?nodeRef="+m+"&increment="+l,successCallback:{fn:n,scope:this}})},onNegotiationListFocusChanged:function(l){if(l.newNode!=null){currentNode=l.newNode;this.alfPublish("DISABLE_NAVIGATE_BUTTON",{disabled:false,all:true},true);if(currentNode.depth>0){this.alfPublish("DISABLE_NAVIGATE_BUTTON",{disabled:true,id:"editNavigateButton"},true)}}},getNegotiationList:function(m){_listTree=this.listTree;loadLevelsInfo=function(r){var n=_listTree.getRoot();for(var p=0;p<r.length;p++){var t=r[p];var s=" (Параллельно)";if(t.levelType==1){s=" (Последовательно)"}var o=t.levelName+s;if(t.negotiationType==0){if(o.indexOf("Согласование")==-1){o="Согласование. "+o}}else{if(t.negotiationType==1){if(o.indexOf("Подписание")==-1){o="Подписание. "+o}}}var q=new YAHOO.widget.TextNode({id:t.nodeRef,label:o,expanded:true},n)}_listTree.render()};_listTree.removeChildren(_listTree.getRoot());Alfresco.util.Ajax.jsonGet({url:Alfresco.constants.PROXY_URI+"negotiation/get-negotiation-list?documentNodeRef="+m,successCallback:{fn:function l(n){if(n.serverResponse.status==200){loadLevelsInfo(n.json.levels)}else{console.log("Error getting negotiation list")}},scope:this}})},postCreate:function(){this.load();this.inherited(arguments)},validate:function(){if(this.getValue()==null){this.alfPublish("ALF_INVALID_CONTROL",{name:this.name,fieldId:this.fieldId});this.showValidationFailure()}else{this.alfPublish("ALF_VALID_CONTROL",{name:this.name,fieldId:this.fieldId});this.hideValidationFailure()}}})});