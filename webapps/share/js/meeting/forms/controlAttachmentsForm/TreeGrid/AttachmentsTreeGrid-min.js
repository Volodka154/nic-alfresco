define(["dojo/_base/declare","dijit/_WidgetBase","dijit/_TemplatedMixin","dojo/topic","dojo/_base/lang","dojo/text!./templates/AttachmentsTreeGrid.html","btlUI/uiLib","meeting/utils/base","alfresco/core/Core","jquery",],function(e,h,j,f,a,i,b,c,g,d){return e([h,j,g],{templateString:i,parentNodeRef:"",url:"",isLoad:false,formId:"",singIcon:"icon-is-sing",colModel:[{name:"nodeRef",key:true,search:false,hidden:true},{name:"webDavServiceURL",label:"webDavServiceURL",search:false,hidden:true},{name:"webDavURL",label:"webDavURL",search:false,hidden:true},{name:"name",label:"Название",search:false,width:170},{name:"versionLabel",search:false,label:"Версия",width:75,fixed:true},{name:"signIcon",search:false,label:"ЭЦП",width:25,fixed:true,hidden:true},{name:"modifier",search:false,label:"Автор",width:100,fixed:true},{name:"modifiedDate",search:false,label:"Дата добавления",width:100},{name:"attachmentComment",search:false,classes:"attachment-comment",label:"Описание документа/Комментарий к версии",width:250},{name:"preview",search:false,hidden:true},{name:"currentVersionLabel",search:false,hidden:true},{name:"isSignedEcp",search:false,hidden:true}],loadonce:false,hideHeader:false,isPrimary:true,signIcon:"<span class='icon-is-sing btl-icon-16' style='margin: 0 5px;'></span>",cssRequirements:[{cssFile:"/share/res/extension/css/attachment-tree-grid.css"}],postMixInProperties:function(){this.uid=this.formId;var k=c.getStoreById("MEETING_STORE");handleAlfSubscribe=k.handleAlfSubscribe;handleAlfSubscribe.push(this.alfSubscribe("refreshAttachmentsGrid",a.hitch(this,this.refreshAttachmentsGrid),true));handleAlfSubscribe.push(this.alfSubscribe("selectTabAttachments",a.hitch(this,this.selectTabAttachments),true));handleAlfSubscribe.push(this.alfSubscribe("SELECT_ROW_ATTACHMENTS_TREE_GRID",a.hitch(this,this.selectRowEvent),true));handleAlfSubscribe.push(this.alfSubscribe("ALF_UPLOAD_DIALOG_OK_CLICK",a.hitch(this,this.refreshAttachmentsGrid),true));handleAlfSubscribe.push(this.alfSubscribe("TRIGGER_CURRENT_ROW_DATA_ATTACHMENTS",a.hitch(this,this.topicRowData),true));handleAlfSubscribe.push(this.alfSubscribe("SELECT_ATTACHMENTS_TAB",a.hitch(this,this.start),true));this.inherited(arguments)},selectTabAttachments:function(){if(!this.isLoad){this.start()}},refreshAttachmentsGrid:function(k){if(!this.nodeGrid){this.start()}this.nodeGrid.trigger("reloadGrid")},selectRowEvent:function(k){if(k.uid!=this.uid){if(this.nodeGrid){this.nodeGrid.find("tr").removeClass("ui-state-highlight")}}},topicRowData:function(){if(this.grid){var l=this.grid.jqGrid("getGridParam","selrow");if(l){var k=this.grid.getRowData(l);this.alfPublish("SELECT_ROW_ATTACHMENTS_TREE_GRID",k,true);this.grid.trigger("onSelectRow",[k]);if(document.getElementById(l)){document.getElementById(l).classList.add("ui-state-highlight")}}}},getCurrentRowData:function(){var l=this.grid.jqGrid("getGridParam","selrow"),k=this.grid.getRowData((l)?l:0);return k},start:function(){if(this.isLoad){return}var n=this;if(!this.url){this.url='/share/proxy/alfresco/common/get-attachments-tree?objectType=btl-tasksAttachments:tasksAttachmentsDataType&qualifyStr=AND PARENT:"'+this.parentNodeRef+'"&allVersions=true'}this.nodeGrid=d("#"+this.uid);var l=this.nodeGrid.jqGrid({url:this.url,colModel:this.colModel,width:600,search:false,hoverrows:false,viewrecords:true,zIndex:0,gridview:true,height:"auto",treeGrid:true,ExpandColumn:"name",treedatatype:"json",treeGridModel:"adjacency",treeReader:{parent_id_field:"rootVersion",level_field:"level",leaf_field:"isLeaf",expanded_field:"expanded",loaded:"loaded",},loadonce:this.loadonce,rowNum:100,datatype:"json",onSelectRow:function(p){var o=l.getRowData(p);o.uid=n.uid;n.alfPublish("SELECT_ROW_ATTACHMENTS_TREE_GRID",o,true);l.trigger("onSelectRow",[o]);document.getElementById(p).classList.add("ui-state-highlight")},loadComplete:function(p){if(n.domNode){l.setGridWidth(600);if(n.isPrimary&&p&&p.rows.length>0){var o=p.rows[0];o.uid=n.uid;l.setSelection(o.nodeRef,false);n.alfPublish("SELECT_ROW_ATTACHMENTS_TREE_GRID",o,true)}}},beforeProcessing:function(p,o,q){if(p&&p.rows.length>0){p=n.beforeProcess(p.rows)}}});var m=d.fn.jqGrid.expandNode,k=d.fn.jqGrid.collapseNode;d.jgrid.extend({expandNode:function(p){var o=n.grid.getRowData(p._id_);o.signIcon="";n.grid.setRowData(p._id_,o);return m.call(this,p)},collapseNode:function(q){var p=n.grid.getRowData(q._id_);var r=n.grid.getLocalRow(q._id_);var o=n.grid.getNodeChildren(r);o.forEach(function(s){if(s.isSignedEcp){p.signIcon=n.signIcon;n.grid.setRowData(q._id_,p)}});return k.call(this,q)}});document.getElementById(this.filePreviewContainerId).style.width="600px";if(this.hideHeader){d("#gview_"+this.uid+" .ui-jqgrid-htable").hide()}d(window).bind("resize",function(){l.setGridWidth((n.domNode)?n.domNode.clientWidth:0)}).trigger("resize");this.inherited(arguments);this.grid=l;this.isLoad=true},beforeProcess:function(k){var l=this;k.forEach(function(m){if(m.isSignedEcp){l.grid.showCol("signIcon");m.signIcon=l.signIcon}m.modifier=b.getShotFIO(m.modifier)});return k},setDataFromServer:function(){var k=this;Alfresco.util.Ajax.request({method:"GET",url:this.url,successCallback:{fn:function(l){this.nodeGrid.jqGrid("clearGridData");if(this.nodeGrid.get(0).p.treeGrid){var m;if(l.json.rows.length>0){m=k.beforeProcess(l.json.rows)}this.nodeGrid.get(0).addJSONData({total:1,page:1,records:m.length,rows:m})}else{this.nodeGrid.jqGrid("setGridParam",{datatype:"local",data:l.json.rows,rowNum:l.json.rows.length})}this.nodeGrid.trigger("reloadGrid")},scope:this}})}})});