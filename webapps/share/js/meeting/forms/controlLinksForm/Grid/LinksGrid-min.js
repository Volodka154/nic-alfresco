define(["dojo/_base/declare","dijit/_WidgetBase","dijit/_TemplatedMixin","dojo/topic","dojo/_base/lang","dojo/text!./templates/LinksGrid.html","btlUI/uiLib","meeting/utils/base","alfresco/core/Core","alfresco/core/CoreXhr","dojo/_base/lang","jquery",],function(f,i,k,g,a,j,b,d,h,c,a,e){return f([i,k,h,c],{templateString:j,parentNodeRef:"",url:"",isLoad:false,formId:"",singIcon:"icon-is-sing",colModel:[{name:"nodeRef",key:true,search:false,hidden:true},{name:"name",label:"Название",search:false,},{name:"link_val",search:false,label:"Тип ссылки",fixed:true},{name:"nodeRefLinkType",search:false,hidden:true},{name:"typeRK",search:false,hidden:true},{name:"nodeRefRK",search:false,hidden:true},{name:"isEditable",search:false,hidden:true}],loadonce:false,hideHeader:false,isPrimary:true,signIcon:"<span class='icon-is-sing btl-icon-16' style='margin: 0 5px;'></span>",postMixInProperties:function(){this.uid=this.uidGrid;var l=d.getStoreById("MEETING_STORE");handleAlfSubscribe=l.handleAlfSubscribe;handleAlfSubscribe.push(this.alfSubscribe("SELECT_ROW_LINKS_GRID",a.hitch(this,this.selectRowEvent),true));handleAlfSubscribe.push(this.alfSubscribe("REFRESH_LINKS_GRID",a.hitch(this,this.setDataFromServer),true));handleAlfSubscribe.push(this.alfSubscribe("TRIGGER_CURRENT_ROW_DATA_LINKS",a.hitch(this,this.topicRowData),true));handleAlfSubscribe.push(this.alfSubscribe("selectTabLinks",a.hitch(this,this.selectTabLinks),true));handleAlfSubscribe.push(this.alfSubscribe("DATAGRID_GET_WIDGET_LINK_DATA",a.hitch(this,this.getInfo),true));handleAlfSubscribe.push(this.alfSubscribe("DATAGRID_DELETE_WIDGET_LINK",a.hitch(this,this.deleteLink),true));this.inherited(arguments)},selectTabLinks:function(){if(!this.isLoad){this.startup()}else{this.refreshLinksGrid()}},refreshLinksGrid:function(){this.nodeGrid.trigger("reloadGrid")},postCreate:function(){this.parentNodeRef=this.documentNodeRef;this.formId=this.uidGrid},selectRowEvent:function(l){if(l.uid!=this.uid){this.nodeGrid.find("tr").removeClass("ui-state-highlight")}},topicRowData:function(){if(!this.grid){return}var m=this.grid.jqGrid("getGridParam","selrow");if(m){var l=this.grid.getRowData(m);this.alfPublish("SELECT_ROW_LINKS_GRID",l,true);this.grid.trigger("onSelectRow",[l]);if(document.getElementById(m)){document.getElementById(m).classList.add("ui-state-highlight")}}},getCurrentRowData:function(){var m=this.grid.jqGrid("getGridParam","selrow"),l=this.grid.getRowData((m)?m:0);return l},getInfo:function(){var m=this.getCurrentRowData();if(m&&m!=0){var l={};l.config={};l.data={};l.data.nodeRef=m.nodeRef;l.rootNodeRef=this.parentNodeRef;l.data["prop_btl-link_docType"]=m.typeRK;l.data["assoc_btl-link_linkObject"]=m.nodeRefRK;l.data["assoc_btl-link_linkType"]=m.nodeRefLinkType;l.config.dialogTitle="Редактировать ссылку";l.config.dialogConfirmationButtonTitle="Сохранить";l.config.dialogCancellationButtonTitle="Отмена";l.config.formSubmissionTopic="BTL_EDIT_WIDGET_LINK";this.alfPublish("BTL_CREATE_FORM_WIDGET_LINK",l,true)}},deleteLink:function(){var l=this.getCurrentRowData();if(l&&l!=0){if(!confirm("Вы действительно хотите удалить ссылку: "+l.name+" ?")){return}nodeRefs=[];nodeRefs.push(l.nodeRef);this.serviceXhr({url:"/share/proxy/alfresco/slingshot/doclib/action/files?alf_method=delete",method:"POST",data:{nodeRefs:nodeRefs},successCallback:this.setDataFromServer(),callbackScope:this})}},startup:function(){if(this.isLoad){return}var o=this;if(!this.url){this.url="/share/proxy/alfresco/search/widget-links?nodeRef="+this.parentNodeRef+"&pq_datatype=JSON"}this.nodeGrid=e("#"+this.uid);var m=this.nodeGrid.jqGrid({url:this.url,colModel:this.colModel,width:1000,search:false,autowidth:true,hoverrows:false,viewrecords:true,zIndex:0,gridview:true,height:"auto",treeGrid:true,ExpandColumn:"name",treedatatype:"json",treeGridModel:"adjacency",treeReader:{parent_id_field:"rootVersion",level_field:"level",leaf_field:"isLeaf",expanded_field:"expanded",loaded:"loaded",},loadonce:this.loadonce,rowNum:100,datatype:"json",onSelectRow:function(q){var p=m.getRowData(q);p.uid=o.uid;o.alfPublish("SELECT_ROW_LINKS_GRID",p,true);m.trigger("onSelectRow",[p]);document.getElementById(q).classList.add("ui-state-highlight")},loadComplete:function(q){if(o.domNode){m.setGridWidth(1000);if(o.isPrimary&&q&&q.rows&&q.rows.length>0){var p=q.rows[0];p.uid=o.uid;m.setSelection(p.nodeRef,false);o.alfPublish("SELECT_ROW_LINKS_GRID",p,true)}}},beforeProcessing:function(q,p,r){if(q&&q.rows&&q.rows.length>0){q=o.beforeProcess(q.rows)}},ondblClickRow:function(q){var p=m.getRowData(q);if(p.typeRK=="btl-meeting:meetingDataType"){window.location.href="/share/page/hdp/ws/meeting-rooms?nodeRef="+p.nodeRefRK}else{window.location.href="/share/page/btl-edit-metadata?nodeRef="+p.nodeRefRK}}});var n=e.fn.jqGrid.expandNode,l=e.fn.jqGrid.collapseNode;e.jgrid.extend({expandNode:function(q){var p=o.grid.getRowData(q._id_);p.signIcon="";o.grid.setRowData(q._id_,p);return n.call(this,q)},collapseNode:function(r){var q=o.grid.getRowData(r._id_);var s=o.grid.getLocalRow(r._id_);var p=o.grid.getNodeChildren(s);p.forEach(function(t){if(t.isSignedEcp){q.signIcon=o.signIcon;o.grid.setRowData(r._id_,q)}});return l.call(this,r)}});if(document.getElementById(this.filePreviewContainerId)){document.getElementById(this.filePreviewContainerId).style.width=o.domNode.clientWidth}if(this.hideHeader){e("#gview_"+this.uid+" .ui-jqgrid-htable").hide()}e(window).bind("resize",function(){m.setGridWidth(o.domNode?o.domNode.clientWidth:1000)}).trigger("resize");this.inherited(arguments);this.grid=m;this.isLoad=true},beforeProcess:function(l){var m=this;l.forEach(function(n){if(n.isSignedEcp){m.grid.showCol("signIcon");n.signIcon=m.signIcon}});return l},setDataFromServer:function(){var l=this;Alfresco.util.Ajax.request({method:"GET",url:this.url,successCallback:{fn:function(m){this.nodeGrid.jqGrid("clearGridData");if(this.nodeGrid.get(0).p.treeGrid){var n;if(m.json.rows.length>0){n=l.beforeProcess(m.json.rows)}this.nodeGrid.get(0).addJSONData({total:1,page:1,records:n.length,rows:n})}else{this.nodeGrid.jqGrid("setGridParam",{datatype:"local",data:m.json.rows,rowNum:m.json.rows.length})}this.nodeGrid.trigger("reloadGrid")},scope:this}})}})});