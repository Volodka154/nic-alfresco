define(["dojo/_base/declare","alfresco/core/Core","dojox/calendar/Calendar","dojo/_base/lang","alfresco/core/CoreXhr","meeting/utils/base","dojo/store/Memory","dojo/store/Cache","dojo/store/Observable","dijit/_WidgetBase","dijit/_TemplatedMixin","dojo/text!./templates/Calendar.html"],function(f,g,b,c,d,e,i,j,h,a,k,l){return f([a,k,g,d],{templateString:l,room:null,roomObject:null,roomContent:"",style:"position:relative;width:850px;height:635px",startTime:null,endTime:null,inputData:null,cssRequirements:[{cssFile:"./css/calendarRooms.css"}],getValue:function(){if(this.room&&this.startTime&&this.endTime){return{roomObject:this.roomObject,room:this.room,roomContent:this.roomContent,startTime:this.startTime,endTime:this.endTime}}else{return null}},postMixInProperties:function(){this.alfSubscribe("LOAD_CALENDAR_ROOM",c.hitch(this,this.loadCalendar),true);this.alfSubscribe("UPDATE_NEW_MEETING_CALENDAR_ROOM",c.hitch(this,this.updateNewMeeting),true)},itemDoubleClick:function(m){this.alfPublish("ALF_DISPLAY_PROMPT",{message:("0"+m.item.startTime.getHours()).slice(-2)+":"+("0"+m.item.startTime.getMinutes()).slice(-2)+" - "+("0"+m.item.endTime.getHours()).slice(-2)+":"+("0"+m.item.endTime.getMinutes()).slice(-2)+" "+m.item.summary,title:"Информация"},true)},updateNewMeeting:function(r){this.calendar.store.remove("new_meeting");var n=(r.startTime)?r.startTime:this.startTime;var q=(r.endTime)?r.endTime:this.endTime;if(n.getHours()==0){n=this.startTime;this.alfPublish("MEETING_START_DATE_TIME_UPDATE",{data:this.startTime},true)}if(q.getHours()==0){q=this.endTime;this.alfPublish("MEETING_END_DATE_TIME_UPDATE",{data:this.endTime},true)}if(q.getTime()<n.getTime()){this.updateNewMeeting({startTime:q,endTime:n});this.alfPublish("MEETING_START_DATE_TIME_UPDATE",{data:this.startTime},true);this.alfPublish("MEETING_END_DATE_TIME_UPDATE",{data:this.endTime},true);return}var m=new Date();m.setTime(m.getTime()-(10*60*1000));if(n.getTime()<m.getTime()){m=new Date();var o=new Date(m);o.setTime(o.getTime()+(60*60*1000));this.updateNewMeeting({startTime:m,endTime:o});return}if(n.getHours()<8){n.setHours(8);n.setMinutes(0)}if(n.getHours()>=21){var p=new Date(n);p.setTime(p.getTime()+(24*60*60*1000));p.setHours(8);p.setMinutes(0);p.setMilliseconds(0);var o=new Date(p);o.setTime(o.getTime()+(60*60*1000));this.updateNewMeeting({startTime:p,endTime:o});return}if(this.checkIntersectionTime({startTime:n,endTime:q})){return}if(this.checkMinimalTime({startTime:n,endTime:q})){return true}this.startTime=n;this.endTime=q;this.calendar.store.remove("new_meeting");this.alfPublish("MEETING_START_DATE_TIME_UPDATE",{data:this.startTime},true);this.alfPublish("MEETING_END_DATE_TIME_UPDATE",{data:this.endTime},true);this.calendar.store.add({id:"new_meeting",summary:"Выберите время",startTime:n,endTime:q})},checkIntersectionTime:function(p){for(var o=0;o<this.calendar.items.length;o++){var m=this.calendar.items[o];if(m.id=="new_meeting"){continue}if((m.startTime.getTime()<p.startTime.getTime()&&m.endTime.getTime()>p.startTime.getTime())||(m.startTime.getTime()<p.endTime.getTime()&&m.endTime.getTime()>p.endTime.getTime())||(p.startTime.getTime()<m.startTime.getTime()&&p.endTime.getTime()>m.startTime.getTime())||(p.startTime.getTime()<m.endTime.getTime()&&p.endTime.getTime()>m.endTime.getTime())||(p.startTime.getTime()==m.startTime.getTime()&&p.endTime.getTime()==m.endTime.getTime())){var n=new Date(m.endTime);n.setTime(n.getTime()+(60*60*1000));this.updateNewMeeting({startTime:new Date(m.endTime),endTime:n});return true}}return false},checkMinimalTime:function(m){if((m.endTime.getTime()-m.startTime.getTime())<(30*60*1000)){var n=new Date(m.startTime);n.setTime(n.getTime()+(30*60*1000));this.updateNewMeeting({startTime:m.startTime,endTime:n});return true}return false},itemEdit:function(n,m){if(n.id!="new_meeting"){return false}else{if(this.startTime&&this.startTime.getTime()==n.startTime.getTime()&&this.endTime&&this.endTime.getTime()==n.endTime.getTime()){return true}if(this.checkIntersectionTime(n)){return true}if(this.checkMinimalTime(n)){return true}if(!this.startTime||this.startTime.getTime()!=n.startTime.getTime()){this.startTime=n.startTime;this.alfPublish("MEETING_START_DATE_TIME_UPDATE",{data:n.startTime},true)}if(!this.endTime||this.endTime.getTime()!=n.endTime.getTime()){this.endTime=n.endTime;this.alfPublish("MEETING_END_DATE_TIME_UPDATE",{data:n.endTime},true)}return true}},load:function(n){this.domNode.innerHTML="";if(!n){n=[]}var m=new Date();if(this.inputData&&this.inputData.date&&this.inputData.date.getTime()>m.getTime()){m=this.inputData.date}var p=new Date(m);p.setTime(m.getTime()+(60*60*1000));if(this.startTime&&this.endTime){m=this.startTime;p=this.endTime}n.push({id:"new_meeting",summary:"Выберите время",startTime:m,endTime:p});this.calendar=new b({date:m,store:new h(new i({data:n})),cssClassFunc:function(r){if(r.id=="new_meeting"){return"selectCalendar"}else{return""}},dateInterval:(this.calendar)?this.calendar.dateInterval:"week",columnViewProps:{minHours:8,maxHours:22,timeSlotDuration:30,hourSize:37},style:this.style,isItemMoveEnabled:this.itemEdit.bind(this),isItemResizeEnabled:this.itemEdit.bind(this),onItemDoubleClick:this.itemDoubleClick.bind(this),formatItemTimeFunc:function(u,t,r,s){return t.dateLocaleModule.format(s.startTime,{selector:"time",timePattern:"HH':'mm"})+" - "+t.dateLocaleModule.format(s.endTime,{selector:"time",timePattern:"HH':'mm"})}});for(var o=0;o<this.calendar.items.length;o++){var q=this.calendar.items[o];if(q.id=="new_meeting"){this.itemEdit(q);break}}this.calendar.placeAt(this.domNode);this.calendar.startup();this.validate()},successLoadData:function(o){var n=[];if(o.meetings){for(var m=0;m<o.meetings.length;m++){var p=o.meetings[m];n.push({id:p.nodeRef,summary:p.theme,startTime:new Date(p.startTime),endTime:new Date(p.endTime)})}}this.load(n)},loadCalendar:function(n){var m=[];if(n!=null){this.roomObject=n.roomObject;this.room=n.room;this.roomContent=n.roomContent;this.serviceXhr({url:"/share/proxy/alfresco/meeting/get-meeting-by-room?room="+n.room,method:"GET",successCallback:this.successLoadData,callbackScope:this})}},postCreate:function(){this.loadCalendar(null)},})});