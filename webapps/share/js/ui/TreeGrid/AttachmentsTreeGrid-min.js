define(["dojo/_base/declare","dijit/_WidgetBase","dijit/_TemplatedMixin","dojo/topic","dojo/text!./templates/AttachmentsTreeGrid.html","../uiLib","jquery","jqgrid-locale-ru","jqgrid",],function(c,b,e,a,d,g,f){return c([b,e],{templateString:d,parentNodeRef:"",contentType:"btl-tasksAttachments:tasksAttachmentsDataType",url:"",formId:"",singIcon:"icon-is-sing",colModel:[{name:"nodeRef",key:true,search:false,hidden:true},{name:"webDavServiceURL",label:"webDavServiceURL",search:false,hidden:true},{name:"webDavURL",label:"webDavURL",search:false,hidden:true},{name:"name",label:"Название",search:false,width:170},{name:"versionLabel",search:false,label:"Версия",width:40,fixed:true},{name:"signIcon",search:false,label:"ЭЦП",width:25,fixed:true,hidden:true},{name:"modifier",search:false,label:"Автор",width:100,fixed:true},{name:"modifiedDate",search:false,label:"Дата добавления",width:100},{name:"attachmentComment",index:"attachmentComment",search:false,classes:"attachment-comment",label:"Описание документа/Комментарий к версии",width:250},{name:"preview",search:false,hidden:true},{name:"currentVersionLabel",search:false,hidden:true},{name:"isSignedEcp",search:false,hidden:true},{name:"created",search:false,hidden:true},{name:"category",search:true,sortable:true,label:"Категория",width:130},{name:"select",hidden:true}],isPrimary:true,signIcon:"<span class='icon-is-sing btl-icon-16' style='margin: 0 5px;'></span>",cssRequirements:[{cssFile:"/share/res/extension/css/attachment-tree-grid.css"}],postMixInProperties:function(){this.uid=this.formId+"-tree-version-attach";a.subscribe("refreshAttachmentsGrid",this.refreshAttachmentsGrid.bind(this));a.subscribe("SELECT_ROW_ATTACHMENTS_TREE_GRID",this.selectRowEvent.bind(this));this.inherited(arguments)},refreshAttachmentsGrid:function(){this.setDataFromServer()},selectRowEvent:function(h){if(h.uid!=this.uid){this.nodeGrid.find("tr").removeClass("ui-state-highlight")}},startup:function(){var k=this;if(!this.url){this.url="/share/proxy/alfresco/common/get-attachments-tree?objectType="+this.contentType+'&qualifyStr=AND PARENT:"'+this.parentNodeRef+'"&allVersions=true'}this.nodeGrid=f("#"+this.uid);var i=this.nodeGrid.jqGrid({datatype:"jsonstring",colModel:this.colModel,gridview:true,width:this.domNode.clientWidth,height:"auto",treeGrid:true,treeGridModel:"adjacency",treedatatype:"local",ExpandColumn:"name",loadonce:true,treeReader:{parent_id_field:"rootVersion",level_field:"level",leaf_field:"isLeaf",expanded_field:"expanded",loaded:"loaded",},onSelectRow:function(m){var l=i.getRowData(m);l.uid=k.uid;a.publish("SELECT_ROW_ATTACHMENTS_TREE_GRID",l);i.trigger("onSelectRow",[l]);document.getElementById(m).classList.add("ui-state-highlight")},rowattr:function(l){if(l.select){return{"class":"select-category"}}}});var j=f.fn.jqGrid.expandNode,h=f.fn.jqGrid.collapseNode;f.jgrid.extend({expandNode:function(m){var l=k.grid.getRowData(m._id_);l.signIcon="";k.grid.setRowData(m._id_,l);return j.call(this,m)},collapseNode:function(n){var m=k.grid.getRowData(n._id_);var o=k.grid.getLocalRow(n._id_);var l=k.grid.getNodeChildren(o);l.forEach(function(p){if(p.isSignedEcp){m.signIcon=k.signIcon;k.grid.setRowData(n._id_,m)}});return h.call(this,n)}});if(this.hideHeader){f("#gview_"+this.uid+" .ui-jqgrid-htable").hide()}f(window).bind("resize",function(){i.setGridWidth(k.domNode.clientWidth)}).trigger("resize");this.inherited(arguments);this.grid=i;window.grid=i;k.setDataFromServer()},beforeProcess:function(j){var k=this;var h={};j.forEach(function(l){if(l.category!=null){h[l.category]=null}if(l.isSignedEcp){k.grid.showCol("signIcon");l.signIcon=k.signIcon}l.modifier=g.getShotFIO(l.modifier)});if(this.isPrimary){var i=f("#gs_category");if(i.length>0){i.empty().append('<option value="">Все</option>');Object.keys(h).forEach(function(l){i.append('<option value="'+l+'">'+l+"</option>")})}else{this.nodeGrid.jqGrid("setColProp","category",{stype:"select",searchoptions:{value:":Все;"+Object.keys(h).map(function(l){return l+":"+l}).join(";"),sopt:["eq"]}});this.nodeGrid.jqGrid("filterToolbar",{stringResult:true})}}return j},setDataFromServer:function(){var h=this;Alfresco.util.Ajax.request({method:"GET",url:this.url,successCallback:{fn:function(i){this.nodeGrid.jqGrid("clearGridData");i.json.rows=i.json.rows.sort(function(n,m){var o=n.grade-m.grade;if(o!==0){return o}if(n.category===m.category){return 0}else{return n.category>m.category?1:-1}});if(this.nodeGrid.get(0).p.treeGrid){var l;if(i.json.rows.length>0){l=h.beforeProcess(i.json.rows);this.nodeGrid.get(0).addJSONData({total:1,page:1,records:l.length,rows:l})}}else{this.nodeGrid.jqGrid("setGridParam",{datatype:"local",datastr:i.json.rows,rowNum:i.json.rows.length})}if(h.isPrimary&&i.json&&i.json.rows.length>0){var k=i.json.rows[0];window.defRowDataGrid=k;k.uid=h.uid;var j=h.linkDownloadEcpElemId;f.ajax({url:"/share/proxy/alfresco/is-signed-file?nodeRef="+k.nodeRef,success:function(m){if(typeof j!="undefined"){var n=typeof i.json.downloadUrl=="undefined"?JSON.parse(m):m;if(n.isSigned){f("#"+j).attr("href",n.downloadUrl);f("#documentDownloadButton").css("display","block")}}},scope:h});h.grid.setSelection(k.nodeRef,false);a.publish("SELECT_ROW_ATTACHMENTS_TREE_GRID",k)}h.grid.setGridWidth(h.domNode.clientWidth)},scope:this}})}})});