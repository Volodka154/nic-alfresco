define(["dojo/_base/declare","dojo/dom","dijit/Dialog","dijit/registry","dojo/text!./templates/AddAttachmentsDialog.html","dojo/topic"],function(d,f,a,b,e,c){return d([a],{templateString:e,parentNodeRef:null,contentType:"btl-tasksAttachments:tasksAttachmentsDataType",title:"Добавить вложение",style:"width: 400px;",nodeRefCurrentDocument:"",attachments_load_file_name:null,attachment_category_container:null,attachment_category_select:null,attachments_content:null,idAttachmentsGrid:"",formId:"",selectedFileName:"",postMixInProperties:function(){this.inherited(arguments);this.uid=b.getUniqueId(this.declaredClass.replace(/\./g,"_"))},show:function(h){this.formId=h;this.cleanForm();var g=document.getElementById(this.uid+"_attachments_load_file_name");g.parentElement.style.marginLeft="5%";g.parentElement.style.paddingTop="10px";g.parentElement.style.width="90%";g.style.marginTop="25px";this.inherited(arguments)},postCreate:function(){this.inherited(arguments);this.domNode.classList.add("alfresco-dialog-AlfDialog");this.fileUpload=Alfresco.getFileUploadInstance();this.attachments_load_file_name=document.getElementById(this.uid+"_attachments_load_file_name");this.attachment_category_select=document.getElementById(this.uid+"_attachment_category_select");this.attachment_category_container=document.getElementById(this.uid+"_attachment_category_container");this.attachments_content=document.getElementById(this.uid+"_attachments_content");this.uploadConfig={mode:this.fileUpload.MODE_SINGLE_UPLOAD,destination:this.parentNodeRef+"&"+this.contentType,contentType:this.contentType,onFileUploadComplete:{fn:function(j){var k=j.successful.length;if(k!=0){this.nodeRefCurrentDocument=j.successful[0].nodeRef;var i="Документ: "+j.successful[0].fileName;this.attachments_load_file_name.innerHTML=i;if(this.projectEditCrutch){document.getElementById(this.projectEditCrutch.displayFieldName).innerHTML=i;document.getElementById(this.projectEditCrutch.refFieldName).innerHTML=this.nodeRefCurrentDocument;this.projectEditCrutch.blockField();this.onSubmit()}this.selectedFileName=j.successful[0].fileName}},scope:this}};var g=$(this.attachment_category_select);var h=$(this.attachment_category_container);Alfresco.util.Ajax.jsonGet({url:Alfresco.constants.PROXY_URI+"attachments/get-categories?docRef="+this.parentNodeRef,responseType:"json",successCallback:{scope:this,fn:function(i){g.append($("<option/>",{value:"",text:"Без категории"}));if(i.json.length>0){i.json.forEach(function(j){g.append($("<option/>",{value:j.nodeRef,text:j.categoryName}))});g.find("option:nth-child(2)").attr("selected","true");h.show()}}}})},fileUploadPress:function(){if(this.parentNodeRef){if(this.fileUpload.uploader===null){this.fileUpload.show(this.uploadConfig);this.fileUpload.uploader.panel.cancel();YAHOO.util.Dom.addClass(this.fileUpload.uploader.panel.element,"dijitPopup")}this.fileUpload.show(this.uploadConfig);this.fileUpload.uploader.suppliedConfig.contentType=this.contentType;this.fileUpload.uploader.panel.mask.style.zIndex=999;this.fileUpload.uploader.panel.element.style.zIndex=1001}else{console.error("Не указан корневой елемент для загрузки вложений")}},onSubmit:function(){this.hide();this.addPropetries();if(typeof addedFiles!=="undefined"&&addedFiles){addedFiles.push(this.selectedFileName)}var g=$("#"+this.formId+"_addedLinksList");text=g.html();if(text!=""){text="<br>"+text}g.html(this.selectedFileName+text);g.removeAttr("hidden")},onCancel:function(){this.containerAttachmentsDialogClose();this.hide();this.cleanForm()},containerAttachmentsDialogClose:function(){if(this.nodeRefCurrentDocument){this.deleteFileAttachment(this.nodeRefCurrentDocument,null)}},deleteFileAttachment:function(g,i){var h={type:"${type}"};Alfresco.util.Ajax.jsonPost({method:"POST",url:"/share/proxy/alfresco/slingshot/doclib/action/files?alf_method=delete",dataObj:{nodeRefs:[g]},successCallback:{fn:i,scope:this}})},addPropetries:function(){var g=this.attachments_content.value;data={nodeRef:this.nodeRefCurrentDocument,description:g,parentNodeRef:this.parentNodeRef,categoryRef:(this.attachment_category_select.value||"")};Alfresco.util.Ajax.request({method:"GET",url:Alfresco.constants.PROXY_URI+"events/add-properties",dataObj:data,successCallback:{fn:this.refreshAttachmentsGrid,scope:this}})},refreshAttachmentsGrid:function(){this.cleanForm();c.publish("refreshAttachmentsGrid")},cleanForm:function(){this.attachments_load_file_name.innerHTML="Документ: ";this.attachments_content.value="";this.nodeRefCurrentDocument=""}})});