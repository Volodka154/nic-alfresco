define(["dojo/_base/declare","dojo/dom","dijit/Dialog","dijit/registry","dojo/text!./templates/DowloadFromScaner.html","dojo/topic","dojo/on","jquery"],function(e,h,b,c,f,d,a,g){return e([b],{templateString:f,parentNodeRef:null,title:"Добавить вложение",style:"width: 400px;",attachments_load_file_name:null,attachments_content:null,idAttachmentsGrid:"",isLoadingConfig:false,isDevice:true,clientIP:"",port:80,postMixInProperties:function(){this.inherited(arguments);this.uid=c.getUniqueId(this.declaredClass.replace(/\./g,"_"));this.port=(localStorage.getItem("btlScanSettingPort"))?localStorage.getItem("btlScanSettingPort"):"80"},_onKey:function(){},postCreate:function(){this.inherited(arguments);this.domNode.classList.add("alfresco-dialog-AlfDialog");this.attachments_name=document.getElementById(this.uid+"_name_content");this.attachments_content=document.getElementById(this.uid+"_attachments_content");this.inputPort=document.getElementById(this.uid+"_input-port");this.inputIP=document.getElementById(this.uid+"_input-ip");this.selectDPI=document.getElementById(this.uid+"_select-dpi");this.selectColorMode=document.getElementById(this.uid+"_select-color-mode");this.selectFormatList=document.getElementById(this.uid+"_select-format-list");this.submit=document.getElementById(this.uid+"_attachments_dialog_load_btn");this.inputPort.value=(localStorage.getItem("btlScanSettingPort"))?localStorage.getItem("btlScanSettingPort"):"80";this.inputIP.value=(localStorage.getItem("btlScanSettingClientIp"))?localStorage.getItem("btlScanSettingClientIp"):"";a(this.selectDPI,"change",function(i){localStorage.setItem("btlScanSettingDPI",this.value)});a(this.selectColorMode,"change",function(i){localStorage.setItem("btlScanSettingColorMode",this.value)});a(this.selectFormatList,"change",function(i){localStorage.setItem("btlScanSettingFormatList",this.value)});this.submit.disabled=true},show:function(){this.inherited(arguments)},openDialog:function(){this.inputPort.value=(localStorage.getItem("btlScanSettingPort"))?localStorage.getItem("btlScanSettingPort"):"80";this.inputIP.value=(localStorage.getItem("btlScanSettingClientIp"))?localStorage.getItem("btlScanSettingClientIp"):"";if(!this.isLoadingConfig){this.getScanInfo("")}if(this.isDevice){this.show()}},fileUploadPress:function(){var n=this;require(["loading"],function(o){g("#"+n.id).LoadingOverlay("show")});var i="http://127.0.0.1:"+n.inputPort.value+"/TWAIN@Web/";var j=this.selectDPI.options[this.selectDPI.selectedIndex].value;var k=this.selectColorMode.options[this.selectColorMode.selectedIndex].value;var m=this.selectFormatList.options[this.selectFormatList.selectedIndex].value;var l={};l={method:"Scan","Form.Source":"0","Form.FileName":"scan","Form.FileCounter":"","Form.Dpi":j,"Form.ScanFeed":"null","Form.ColorMode":k,"Form.CompressionFormat":"100*jpg","Form.Format":m,"Form.SaveAs":"1",isPackage:"true"};g.ajax({async:true,url:i,crossDomain:true,type:"POST",dataType:"json",data:l,success:function(p){var o="http://"+n.clientIP+":"+n.inputPort.value+"/TWAIN@Web/download?fileId0="+p.temp+"&fileName0="+p.file+"&saveAs=1";n.saveScanOnServer(encodeURIComponent(o))},error:function(q,o){var p=q.responseText;if(p==undefined||p==""){p="Возникла неизвестная ошибка"}require(["loading"],function(r){g.LoadingOverlay("hide")});alert(p)},complete:function(o){}})},onSubmit:function(){this.hide()},updatePort:function(){this.port=this.inputPort.value;this.clientIP=this.inputIP.value;localStorage.setItem("btlScanSettingPort",this.port);localStorage.setItem("btlScanSettingClientIp",this.clientIP);this.getScanInfo("Настройки успешно обновленны")},getScanInfo:function(l){if(this.xhr){this.xhr.abort()}var i="http://127.0.0.1:"+this.port+"/TWAIN@Web/";var n="GetScannerParameters";var j="sourceIndex:0";var m=this;j={method:"GetScannerParameters",sourceIndex:0};try{this.xhr=g.ajax({async:true,url:i,crossDomain:true,type:"POST",dataType:"json",data:j,success:function(r){if(r.sources){g.ajax({async:true,url:i,crossDomain:true,type:"POST",dataType:"json",data:{method:"GetIp"},success:function(w){m.clientIP=w.ip;m.inputIP.value=m.clientIP;m.submit.disabled=false;if(l){require(["dojo/topic"],function(x){x.publish("ALF_DISPLAY_NOTIFICATION",{message:l})})}m.isLoadingConfig=true},error:function(y,w){var x=y.responseText;if(x==undefined||x==""){x="Возникла неизвестная ошибка"}m.submit.disabled=true;alert(x)}});var t=0;var v=(localStorage.getItem("btlScanSettingDPI"))?localStorage.getItem("btlScanSettingDPI"):null;m.removeOptions(m.selectDPI);var p=r.flatbedResolutions;if(p&&p.length>0){p.forEach(function(x){var w=document.createElement("option");w.value=x.key;w.text=x.value;m.selectDPI.add(w);if(v&&v==x.key){m.selectDPI.selectedIndex=t}++t})}t=0;var o=(localStorage.getItem("btlScanSettingColorMode"))?localStorage.getItem("btlScanSettingColorMode"):null;m.removeOptions(m.selectColorMode);var q=r.pixelTypes;if(q&&q.length>0){q.forEach(function(x){var w=document.createElement("option");w.value=x.key;w.text=x.value;m.selectColorMode.add(w);if(o&&o==x.key){m.selectColorMode.selectedIndex=t}++t})}t=0;var s=(localStorage.getItem("btlScanSettingFormatList"))?localStorage.getItem("btlScanSettingFormatList"):null;m.removeOptions(m.selectFormatList);var u=r.allowedFormats;if(u&&u.length>0){u.forEach(function(x){var w=document.createElement("option");w.value=x.key;w.text=x.value;m.selectFormatList.add(w);if(s&&s==x.key){m.selectFormatList.selectedIndex=t}++t})}m.selectDPI.disabled=false;m.selectFormatList.disabled=false;m.selectColorMode.disabled=false;m.attachments_content.disabled=false;m.attachments_name.disabled=false;m.submit.disabled=false}else{m.submit.disabled=true;m.isDevice=false;alert("Устройство не определено")}},error:function(q,o){var p=q.responseText;if(p==undefined||p==""){p="Не удалось подключиться к ScanService(TWAIN@Web)."}m.submit.disabled=true;alert(p)}})}catch(k){}},saveScanOnServer:function(m){var n=this;var i=encodeURIComponent(this.attachments_name.value);var l=encodeURIComponent(this.attachments_content.value);var j=this.parentNodeRef;var k={name:i,nodeRef:j,url:m,desc:l};g.ajax({async:true,url:"/share/proxy/alfresco/common/save-file-from-scan",crossDomain:true,type:"GET",data:k,success:function(o){d.publish("refreshAttachmentsGrid");require(["loading","dojo/topic"],function(q,p){g("#"+n.id).LoadingOverlay("hide");p.publish("ALF_DISPLAY_NOTIFICATION",{message:"Файл успешно загружен"})})},error:function(q,o){var p=q.responseText;if(p==undefined||p==""){p="Не удалось подключиться к ScanService(TWAIN@Web)."}require(["loading"],function(r){g("#"+n.id).LoadingOverlay("hide")});alert(p)}})},onCancel:function(){this.hide();this.cleanForm()},cleanForm:function(){this.attachments_name.value="";this.attachments_content.value="";this.inputPort.value="";this.inputIP.value=""},removeOptions:function(j){var k;for(k=j.options.length-1;k>=0;k--){j.remove(k)}}})});