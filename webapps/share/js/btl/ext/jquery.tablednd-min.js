(function(a){if(typeof define==="function"&&define.amd){define(["jquery","jqueryui"],a)}else{a(jQuery)}}(function(a){a.tableDnD={currentTable:null,dragObject:null,mouseOffset:null,oldY:0,build:function(b){this.each(function(){this.tableDnDConfig=a.extend({onDragStyle:null,onDropStyle:null,onDragClass:"tDnD_whileDrag",onDrop:null,onDragStart:null,scrollAmount:5,serializeRegexp:/[^\-]*$/,serializeParamName:null,dragHandle:null},b||{});a.tableDnD.makeDraggable(this)});a(document).bind("mousemove",a.tableDnD.mousemove).bind("mouseup",a.tableDnD.mouseup);return this},makeDraggable:function(d){var c=d.tableDnDConfig;if(d.tableDnDConfig.dragHandle){var b=a("td."+d.tableDnDConfig.dragHandle,d);b.each(function(){a(this).mousedown(function(f){a.tableDnD.dragObject=this.parentNode;a.tableDnD.currentTable=d;a.tableDnD.mouseOffset=a.tableDnD.getMouseOffset(this,f);if(c.onDragStart){c.onDragStart(d,this)}return false})})}else{var e=a("tr",d);e.each(function(){var f=a(this);if(!f.hasClass("nodrag")){f.mousedown(function(g){if(g.target.tagName=="TD"){a.tableDnD.dragObject=this;a.tableDnD.currentTable=d;a.tableDnD.mouseOffset=a.tableDnD.getMouseOffset(this,g);if(c.onDragStart){c.onDragStart(d,this)}return false}}).css("cursor","move")}})}},updateTables:function(){this.each(function(){if(this.tableDnDConfig){a.tableDnD.makeDraggable(this)}})},mouseCoords:function(b){if(b.pageX||b.pageY){return{x:b.pageX,y:b.pageY}}return{x:b.clientX+document.body.scrollLeft-document.body.clientLeft,y:b.clientY+document.body.scrollTop-document.body.clientTop}},getMouseOffset:function(e,d){d=d||window.event;var c=this.getPosition(e);var b=this.mouseCoords(d);return{x:b.x-c.x,y:b.y-c.y}},getPosition:function(d){var c=0;var b=0;if(d.offsetHeight==0){d=d.firstChild}if(d&&d.offsetParent){while(d.offsetParent){c+=d.offsetLeft;b+=d.offsetTop;d=d.offsetParent}c+=d.offsetLeft;b+=d.offsetTop}return{x:c,y:b}},mousemove:function(h){if(a.tableDnD.dragObject==null){return}var e=a(a.tableDnD.dragObject);var c=a.tableDnD.currentTable.tableDnDConfig;var j=a.tableDnD.mouseCoords(h);var g=j.y-a.tableDnD.mouseOffset.y;var d=window.pageYOffset;if(document.all){if(typeof document.compatMode!="undefined"&&document.compatMode!="BackCompat"){d=document.documentElement.scrollTop}else{if(typeof document.body!="undefined"){d=document.body.scrollTop}}}if(j.y-d<c.scrollAmount){window.scrollBy(0,-c.scrollAmount)}else{var b=window.innerHeight?window.innerHeight:document.documentElement.clientHeight?document.documentElement.clientHeight:document.body.clientHeight;if(b-(j.y-d)<c.scrollAmount){window.scrollBy(0,c.scrollAmount)}}if(g!=a.tableDnD.oldY){var f=g>a.tableDnD.oldY;a.tableDnD.oldY=g;if(c.onDragClass){e.addClass(c.onDragClass)}else{e.css(c.onDragStyle)}var i=a.tableDnD.findDropTargetRow(e,g);if(i){if(f&&a.tableDnD.dragObject!=i){a.tableDnD.dragObject.parentNode.insertBefore(a.tableDnD.dragObject,i.nextSibling)}else{if(!f&&a.tableDnD.dragObject!=i){a.tableDnD.dragObject.parentNode.insertBefore(a.tableDnD.dragObject,i)}}}}return false},findDropTargetRow:function(g,h){var k=a.tableDnD.currentTable.rows;for(var f=0;f<k.length;f++){var j=k[f];var c=this.getPosition(j).y;var b=parseInt(j.offsetHeight)/2;if(j.offsetHeight==0){c=this.getPosition(j.firstChild).y;b=parseInt(j.firstChild.offsetHeight)/2}if((h>c-b)&&(h<(c+b))){if(j==g){return null}var d=a.tableDnD.currentTable.tableDnDConfig;if(d.onAllowDrop){if(d.onAllowDrop(g,j)){return j}else{return null}}else{var e=a(j).hasClass("nodrop");if(!e){return j}else{return null}}return j}}return null},mouseup:function(d){if(a.tableDnD.currentTable&&a.tableDnD.dragObject){var c=a.tableDnD.dragObject;var b=a.tableDnD.currentTable.tableDnDConfig;if(b.onDragClass){a(c).removeClass(b.onDragClass)}else{a(c).css(b.onDropStyle)}a.tableDnD.dragObject=null;if(b.onDrop){b.onDrop(a.tableDnD.currentTable,c)}a.tableDnD.currentTable=null}},serialize:function(){if(a.tableDnD.currentTable){return a.tableDnD.serializeTable(a.tableDnD.currentTable)}else{return"Error: No Table id set, you need to set an id on your table and every row"}},serializeTable:function(e){var b="";var d=e.id;var f=e.rows;for(var c=0;c<f.length;c++){if(b.length>0){b+="&"}var g=f[c].id;if(g&&g&&e.tableDnDConfig&&e.tableDnDConfig.serializeRegexp){g=g.match(e.tableDnDConfig.serializeRegexp)[0]}b+=d+"[]="+g}return b},serializeTables:function(){var b="";this.each(function(){b+=a.tableDnD.serializeTable(this)});return b}};a.fn.extend({tableDnD:a.tableDnD.build,tableDnDUpdate:a.tableDnD.updateTables,tableDnDSerialize:a.tableDnD.serializeTables})}));