define(["dojo/_base/declare","btl/widgets/base/DataGrid","alfresco/core/CoreXhr","alfresco/core/Core","dojo/_base/lang","service/constants/Default","dijit/registry"],function(s,n,i,a,t,l,j){var h=function(w){var u=document.elementFromPoint(w.clientX,w.clientY);if(u==null){return null}var v=u.closest(".dijitTreeNodeHover");if(v==null||!v.hasAttributes){return null}if(v.parentNode!=null){var x=v.parentNode.getAttribute("class");if(x!=null&&!e(x)){return null}}var y=v.getAttribute("id");if(y!=null){return j.byId(y)}return null};var d=function(){var u=document.getElementById("ID_TREE_DEPART");var v=u.getElementsByClassName("dijitTreeRowSelected");if(v.length==0){return null}var w=v[0].parentNode.getAttribute("id");if(w==null){return null}return j.byId(w)};var r=function(B,x,u,z){var y=false;if(z==null){return y}if(u==z){return y}if(u=="all"&&z==""){return y}if(u==""&&z=="all"){return y}var v=new Object();if(u!=null&&u!=""){v["assoc_btl-emp_department_removed"]=u}if(z!=""&&z!="all"){v["assoc_btl-emp_department_added"]=z}var w={};w.nodeRef=x;B.alfLog("log","btl_DataGridDepartment__transferEmployee",w);B.serviceXhr({url:"/share/proxy/alfresco/api/node/"+x.replace("://","/")+"/formprocessor",method:"POST",sync:true,data:v,successCallback:y=true,callbackScope:this});if(y){B.alfPublish("DATAGRID_EDIT_ROW",w);var A=d();if(A.item.id!="all"){B.deleteRowFromStore()}}return y};var e=function(u){return u.indexOf("dijitTreeNodeContainer")!=-1};return s([n,i,a],{title:"",Url:"search/employee",colModel:[],filterModel:{on:true,mode:"AND",header:true},selectionModel:{type:"row",mode:"single"},allChild:false,type:"dep_children_employee",parentTreeType:"btl-depart:department-folder",toolbar:{cls:"pq-toolbar-crud",items:[{type:'<span><input id="checkboxAllChild" type="checkbox" onchange="window.employeeGrid.allChild = this.checked; window.employeeGrid.loadDataDataGrid(window.employeeGrid.dataEmployee);" >Отображать все дочерние</span>'}]},postMixInProperties:function c(){this.inherited(arguments);this.alfSubscribe("BTL_EDIT_DEPARTAMENT_EMPLOYEE",t.hitch(this,this.editDepEmployee),true);this.alfSubscribe("DATAGRID_DELETE_EMLPOYEE",t.hitch(this,this.deleteEmployee),true);this.alfSubscribe("DATAGRID_GET_EMLPOYEE_DATA",t.hitch(this,this.getEmployeeData),true)},gridAutoSize:function b(){var u=document.documentElement.offsetHeight;u-=document.getElementById("SHARE_HEADER").offsetHeight;u-=50;var v=document.documentElement.offsetWidth-document.getElementById("MAIN_LIST_MENU").offsetWidth-document.getElementById("ID_TREE_DEPART").offsetWidth;v-=30;return{height:u,width:v}},loadDataToDataGrid:function o(v,u){this.setDataDataGrid(v.items);window.employeeGrid=this},editDepEmployee:function k(u){this.alfLog("log","btl_DepartmentService__editDepartment",u);this.employee=u;this.serviceXhr({url:"/share/proxy/alfresco/api/node/"+u.nodeRef.replace("://","/")+"/formprocessor",method:"POST",data:this.employee,successCallback:function(){this.loadDataDataGrid(this.data)},callbackScope:this})},deleteEmployee:function g(){var u=this.grid.pqGrid("selection",{type:"row",method:"getSelection"});if(u&&u.length>0){var w=u[0].rowData;var v={};v.requiresConfirmation=true;v.confirmationTitle="Удаление сотрудника";v.confirmationPrompt="Вы действительно хотите удалить: "+w.surname+" "+w.firstname+" ?";v.nodeRef=w.nodeRef;v.responseTopic="BTL_SING_REMOVE_EMPLOYEE";this.alfPublish("BTL_MSG_DELETE_DIALOG",v,true);this.alfLog("log","alfresco_EmployeeDataGrid__deleteEmployee",w)}},getEmployeeData:function q(){var u=this.grid.pqGrid("selection",{type:"row",method:"getSelection"});if(u&&u.length>0){var w=u[0].rowData;var v={};v.config={};v.data=w;v.data.rowId=u[0].rowIndx;v.config.dialogTitle="formEmployee.title";v.config.dialogConfirmationButtonTitle="edit.title";v.config.dialogCancellationButtonTitle="cancel.title";v.config.formSubmissionTopic="BTL_EDIT_EMPLOYEE";this.alfPublish("BTL_CREATE_FORM_EMPLOYEE",v,true)}},edit:function f(u){this.serviceXhr({url:"/share/proxy/alfresco/search/employee?nodeRef="+u+"&&oneInfo=true",method:"GET",successCallback:function(v){this.employee=v.items[0];var w={};w.dialogTitle="Редактирование РК сотрудника";w.dialogConfirmationButtonTitle="Сохранить";w.dialogCancellationButtonTitle="Отмена";w.formSubmissionTopic="BTL_EDIT_DEPARTAMENT_EMPLOYEE";w.widgets=this.getWidgets();w.dialogId="FORM_DEPARTAMENT_EMPLOYEE";w.contentWidth="1250px";this.alfPublish("ALF_CREATE_FORM_DIALOG_REQUEST",w,true)},callbackScope:this})},getWidgets:function p(){var H=[{value:"Мужской",label:"Мужской"},{value:"Женский",label:"Женский"}];var S=[];var W={name:"alfresco/forms/controls/DojoValidationTextBox",id:"btl-emp_firstname",config:{label:"btl-emp_firstname.title",name:"prop_btl-emp_firstname",value:(this.employee!==null)?this.employee.firstname:"",requirementConfig:{initialValue:true},validationConfig:[{validation:"minLength",errorMessage:"Поле обязательно для заполнения",length:1}]}};var R={name:"alfresco/forms/controls/DojoValidationTextBox",id:"btl-emp_middlename",config:{label:"btl-emp_middlename.title",name:"prop_btl-emp_middlename",value:(this.employee!==null)?this.employee.middlename:""}};var E={name:"alfresco/forms/controls/DojoValidationTextBox",config:{label:"btl-emp_surname.title",name:"prop_btl-emp_surname",value:(this.employee!==null)?this.employee.surname:"",requirementConfig:{initialValue:true},validationConfig:[{validation:"minLength",errorMessage:"Поле обязательно для заполнения",length:1}]}};var Z={name:"alfresco/forms/controls/DojoValidationTextBox",config:{label:"btl-emp_position.title",name:"prop_btl-emp_position",value:(this.employee!==null)?this.employee.position:"",requirementConfig:{initialValue:true}}};var aa={name:"btl/widgets/base/btlChoice",id:"ASSOC_BTL_EMP_POSITION",config:{name:"assoc_btl-emp_position",value:(this.employee!==null)?this.employee.position_ref:"",header:"Выбрать должность",labelText:"Должность",labelButton:"...",urlList:"/share/proxy/alfresco/filters/association",dataUrl:{type:"btl-pos:employee-position",s_field:"name",field:"name"},itemUrl:"/share/proxy/alfresco/picker/associationItem",dataItemUrl:{type:"btl-pos:employee-position",field:"name"}}};var N={name:"btl/widgets/base/btlChoice",id:"ASSOC_BTL_EMP_DEPARTMENT",config:{name:"assoc_btl-emp_department",header:"Выбрать подразделение",value:(this.employee!==null)?this.employee.department_ref:"",labelText:"btl-person_department.title",labelButton:"...",urlList:"/share/proxy/alfresco/filters/association",dataUrl:{type:"btl-depart:department-folder",s_field:"name",field:"name"},itemUrl:"/share/proxy/alfresco/picker/associationItem",dataItemUrl:{type:"btl-depart:department-folder",field:"name"}}};var C={name:"btl/widgets/base/btlChoice",id:"ASSOC_BTL_EMP_DIRECTOR",config:{name:"assoc_btl-emp_director",header:"Выбрать руководителя",value:(this.employee!==null)?this.employee.director_ref:"",labelText:"btl-person_director.title",labelButton:"...",urlList:"/share/proxy/alfresco/filters/association",dataUrl:{type:"btl-emp:employee-content",s_field:"surname",field:"surname,firstname,middlename"},itemUrl:"/share/proxy/alfresco/picker/associationItem",dataItemUrl:{type:"btl-emp:employee-content",field:"surname,firstname,middlename"}}};var u={name:"btl/widgets/base/btlChoice",id:"ASSOC_BTL_EMP_USER_ALFRESCO",config:{name:"assoc_btl-emp_user_alfresco",header:"Выбрать аккаунт пользователя Alfresco",value:(this.employee!==null)?this.employee.user_alfresco_ref:"",labelText:"Пользователь Alfresco",labelButton:"Выбрать",urlList:"/share/proxy/alfresco/filters/association",dataUrl:{type:"cm:person",s_field:"userName",field:"userName",userAlfresco:true},itemUrl:"/share/proxy/alfresco/picker/associationItem",dataItemUrl:{type:"cm:person",field:"userName"}}};var w={name:"btl/widgets/base/btlChoice",id:"ASSOC_BTL_EMP_DELEGATES",config:{name:"assoc_btl-emp_delegates",header:"Выбрать заместителей",value:(this.employee!==null)?this.employee.delegates_ref:"",labelText:"",single:false,height:"255px",labelButton:"Выбрать",urlList:"/share/proxy/alfresco/filters/association",dataUrl:{type:"btl-emp:employee-content",s_field:"surname",field:"surname,firstname,middlename"},itemUrl:"/share/proxy/alfresco/picker/associationItems",dataItemUrl:{type:"btl-emp:employee-content",field:"surname,firstname,middlename"},excluded:(this.employee!==null)?[this.employee.nodeRef.toString()]:[]}};var G={name:"btl/widgets/base/TextBox",config:{label:"btl-emp_phone.title",name:"prop_btl-emp_phone",style:{width:"300px"},value:(this.employee!==null)?this.employee.phone:""}};var y={name:"btl/widgets/base/TextBox",config:{label:"btl-emp_mobile.title",name:"prop_btl-emp_mobile",style:{width:"300px"},value:(this.employee!==null)?this.employee.mobile:""}};var Y={name:"btl/widgets/base/TextBox",config:{label:"btl-emp_fax.title",name:"prop_btl-emp_fax",style:{width:"300px"},value:(this.employee!==null)?this.employee.fax:""}};var T={name:"btl/widgets/base/TextBox",config:{label:"btl-emp_email.title",name:"prop_btl-emp_email",style:{width:"300px"},value:(this.employee!==null)?this.employee.email:""}};var v={name:"btl/widgets/base/TextBox",config:{label:"btl-emp_tabnum.title",name:"prop_btl-emp_tabnum",style:{width:"250px"},value:(this.employee!==null)?this.employee.tabnum:""}};var X={name:"alfresco/forms/controls/DojoTextarea",config:{label:"btl-emp_information.title",name:"prop_btl-emp_information",value:(this.employee!==null)?this.employee.information:""}};var V={name:"alfresco/forms/controls/DojoCheckBox",config:{label:"btl-emp_close_choice.title",name:"prop_btl-emp_close_choice",value:(this.employee!==null)?this.employee.close_choice:""}};var L={name:"alfresco/forms/controls/Select",config:{label:"btl-emp_sex.title",name:"prop_btl-emp_sex",value:(this.employee!==null)?this.employee.sex:"",optionsConfig:{fixed:H}}};var K={name:"alfresco/forms/controls/CheckBox",config:{label:"Отключен",name:"prop_btl-emp_notActual",value:(this.employee!==null)?this.employee.notActual:false}};var M={name:"alfresco/forms/controls/CheckBox",config:{label:"Не уведомлять по почте",name:"prop_btl-emp_not_email_notify",value:(this.employee!==null)?this.employee.not_email_notify:false}};if(this.employee!==null){S.push({name:"alfresco/forms/controls/DojoValidationTextBox",config:{name:"nodeRef",value:this.employee.nodeRef,visibilityConfig:{initialValue:false}}},{name:"alfresco/forms/controls/DojoValidationTextBox",config:{name:"rowId",value:this.employee.rowId,visibilityConfig:{initialValue:false}}})}else{S.push({name:"alfresco/forms/controls/DojoValidationTextBox",config:{name:"alf_destination",value:this.rootNodeRef,visibilityConfig:{initialValue:false}}})}var z={name:"btl/widgets/base/ClassicWindow",config:{title:"Контактная информация",widgets:[]}};var U={name:"btl/widgets/base/ClassicWindow",id:"WIN_DELEGATES",config:{title:"Заместители",style:"width: 383px;",widgets:[]}};var Q={name:"btl/widgets/base/ClassicWindow",config:{title:"",widgets:[]}};var P={name:"btl/widgets/base/ClassicWindow",config:{widthPc:"37",title:"Дополнительная информация",widgets:[]}};var O={name:"alfresco/forms/ControlColumn",config:{widgets:[]}};var x={name:"alfresco/forms/ControlColumn",config:{widgets:[]}};var D={name:"alfresco/forms/ControlRow",config:{widgets:[]}};var F={name:"alfresco/forms/ControlRow",config:{widgets:[]}};var J={name:"alfresco/forms/ControlRow",config:{widgets:[]}};var I={name:"alfresco/forms/ControlRow",config:{widgets:[]}};var B={name:"alfresco/forms/ControlColumn",config:{widgets:[]}};var A={name:"alfresco/forms/ControlColumn",config:{widgets:[]}};P.config.widgets.push(L,v,u,K,M);J.config.widgets.push(E,W,R);I.config.widgets.push(aa,N,C);B.config.widgets.push(J,I);Q.config.widgets.push(B);z.config.widgets.push(G,y,T,Y);U.config.widgets.push(w);D.config.widgets.push(z,P,U);A.config.widgets.push(Q,D);S.push(A);return S},setEventsDataGrid:function m(){_this=this;this.grid.pqGrid({rowDblClick:function(u,v){window.employeeGrid.getEmployeeData()},rowMouseDown:function(w,z){var B=w.pageX;var A=w.pageY;var v=null;var u=null;var y=_this.grid.pqGrid("getRowData",{rowIndx:z.rowIndx});var x=y.nodeRef;w.preventDefault();window.onmousemove=function(F){var E=F.pageX-B;var C=F.pageY-A;if(Math.abs(E)<3&&Math.abs(C)<3){return}var H=0;var G=0;var D="/share/res/js/btl/widgets/base/css/images/";u=h(F);D+=(u!=null)?"IconUserGreen.png":"IconUserGrey.png";if(v==null){v=new Image();v.src=D;if(v.parentNode!=document.body){document.body.appendChild(v)}v.style.zIndex=9999;v.style.position="absolute";if(!v){return}H=B;G=A}else{v.src=D}v.style.left=F.pageX-H+10+"px";v.style.top=F.pageY-G+10+"px";return false};window.onmouseup=function(C){window.onmouseup=null;window.onmousemove=null;if(v!=null){v.hidden=true}var D=r(_this,x,y.department_ref,u!=null?u.item.id:null)}},showTitle:false})},})});