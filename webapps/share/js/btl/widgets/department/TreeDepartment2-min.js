define(["dojo/_base/declare","btl/widgets/base/Tree","alfresco/documentlibrary/_AlfDocumentListTopicMixin","dojo/_base/lang","alfresco/core/CoreXhr","dojo/store/Observable","service/constants/Default","btl/service/FormContactor","dijit/registry"],function(o,k,a,r,e,h,g,n,f){getSelectedNode=function(){return this.tree.get("selectedItems")[0]};var d=function(v,s){var t=document.elementFromPoint(v.clientX,v.clientY);if(t==null){return null}var u=s?t.closest(".dijitTreeNodeFocused"):t.closest(".dijitTreeNodeHover");if(u==null||!u.hasAttributes){return null}var w=u.getAttribute("id");if(w!=null){return f.byId(w)}return null};var b=function(){var s=document.getElementById("ID_TREE_DEPART");var t=s.getElementsByClassName("dijitTreeRowSelected");if(t.length==0){return null}var u=t[0].parentNode.getAttribute("id");if(u==null){return null}return f.byId(u)};var p=function(x,u,w){var v=false;var s=new Object();s.nodeRefs=[u];var t={};t.nodeRef=u;x.alfLog("log","btl_TreeDepartment__transferDepartment",t);x.serviceXhr({url:"/share/proxy/alfresco/slingshot/doclib/action/move-to/node/"+w.replace("://","/"),method:"POST",sync:true,data:s,successCallback:v=true,callbackScope:this});return v};return o([k,a,e],{i18nRequirements:[{i18nFile:"./i18n/Contactor.properties"}],onClickTopic:"DATAGRID_LOAD_DATA",rootLabel:"departmentTreeRootLabel.label",Url:"/tree/departmentTree2",query:"",publishTopic:"TREE_DEPART_CLICK",type:"btl-depart:department-folder",getInfoUrl:"search/department",postMixInProperties:function i(){this.inherited(arguments);this.alfSubscribe("TREE_GET_INFO_DEPARTAMENT",r.hitch(this,this.getInfo),true);this.alfSubscribe("TREE_DELETE_DEPARTAMENT",r.hitch(this,this.deleteNode),true);this.alfSubscribe("TREE_CREATE_DEPARTAMENT",r.hitch(this,this.createDepartment),true)},getInfo:function j(){var s=this.tree.get("selectedItems")[0];this.serviceXhr({url:"/share/proxy/alfresco/"+this.getInfoUrl+"?nodeRef="+s.id,method:"GET",successCallback:this.edit,callbackScope:this})},edit:function q(t,s){this.alfLog("log","alfresco_TreeDepartment__edit response",t);this.alfLog("log","alfresco_TreeDepartment__edit originalRequestConfig",s);var u={};u.config={};u.data=t;u.config.dialogTitle="formEditDepartment.title.label";u.config.dialogConfirmationButtonTitle="edit.title";u.config.dialogCancellationButtonTitle="cancel.title";u.config.formSubmissionTopic="BTL_EDIT_DEPARTAMENT";this.alfPublish("BTL_CREATE_FORM_DEPARTAMENT",u,true)},deleteNode:function l(){var s=this.tree.get("selectedItems")[0];var t={};t.requiresConfirmation=true;t.confirmationTitle="deleteDepartment.title.label";t.confirmationPrompt="Вы действительно хотите удалить: "+s.name+"?";t.nodeRef=s.id;t.responseTopic="BTL_SING_REMOVE_DEPARTAMENT",this.alfPublish("BTL_MSG_DELETE_DIALOG",t,true)},createDepartment:function l(t){var s=this.tree.get("selectedItems")[0];t.rootNodeRef=s.id;this.alfPublish("BTL_CREATE_FORM_DEPARTAMENT",t,true)},getIconClass:function(s,t){if(s.id==""||s.id=="all"){return"dijitIconUsers"}else{if(s.type=="Организация"){return"dijitIconPackage"}else{if(s.type=="Подразделение"){return"dijitIconSample"}else{return t?"dijitFolderOpened":"dijitFolderClosed"}}}},addTreeElements:function c(t,v,s){try{this.Store.add({id:s[v].nodeRef,name:s[v].name,parent:s[v].parentNodeRef,hasChildren:s[v].hasChildren,type:s[v].orgType})}catch(u){this.alfLog("log","alfresco_navigation_Tree__addTreeElements error",u)}this.alfLog("log","alfresco_navigation_Tree__addTreeElements",this.Store)},onMouseDown:function m(y){var w=this;var u=event.pageX;var s=event.pageY;var A=null;var z=d(event,true);var x=b(y);if(x==null||x!=z){return}var v=x.domNode.className.indexOf("dijitTreeIsRoot")!=-1;var t=x.item.id!="";if(v||!t){return}var B=x.item.id;y.preventDefault();window.onmousemove=function(F){if(F.buttons!=1){if(A!=null){A.hidden=true}window.onmouseup=null;window.onmousemove=null;return}var E=F.pageX-u;var C=F.pageY-s;if(Math.abs(E)<3&&Math.abs(C)<3){return}var H=0;var G=0;var D="/share/res/js/btl/widgets/base/css/images/";z=d(F,false);D+=(z!=null&&z.item.id!=""&&z!=x)?"folder-closed-yellow-16.png":"folder-closed-16.png";if(A==null){A=new Image();A.src=D;if(A.parentNode!=document.body){document.body.appendChild(A)}A.style.zIndex=9999;A.style.position="absolute";if(!A){return}H=u;G=s}else{A.src=D}A.style.left=F.pageX-H+10+"px";A.style.top=F.pageY-G+10+"px";return false};window.onmouseup=function(C){window.onmouseup=null;window.onmousemove=null;if(A!=null){A.hidden=true}if(z!=null&&z.item.id!=""&&z!=x){p(w,x.item.id,z.item.id)}}},})});