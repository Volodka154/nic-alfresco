define(["dojo/_base/declare","btl/widgets/base/Tree","alfresco/documentlibrary/_AlfDocumentListTopicMixin","dojo/_base/lang","alfresco/core/CoreXhr","dojo/store/Observable","service/constants/Default","btl/service/FormContactor","dijit/registry"],function(q,m,b,r,g,k,j,o,h){getSelectedNode=function(){return this.tree.get("selectedItems")[0]};var f=function(v,s){var t=document.elementFromPoint(v.clientX,v.clientY);if(t==null){return null}var u=s?t.closest(".dijitTreeNodeFocused"):t.closest(".dijitTreeNodeHover");if(u==null||!u.hasAttributes){return null}var w=u.getAttribute("id");if(w!=null){return h.byId(w)}return null};var c=function(){var s=document.getElementById("ID_TREE_GROUP");var t=s.getElementsByClassName("dijitTreeRowSelected");if(t.length==0){return null}var u=t[0].parentNode.getAttribute("id");if(u==null){return null}return h.byId(u)};var l=function(x,u,t){var w=false;var s=new Object();s.nodeRefs=[u];var v={};v.nodeRef=u;x.alfLog("log","btl_TreeGroup__transferGroup",v);x.serviceXhr({url:"/share/proxy/alfresco/slingshot/doclib/action/move-to/node/"+t.replace("://","/"),method:"POST",sync:true,data:s,successCallback:w=true,callbackScope:this});return w};return q([m,b,g],{i18nRequirements:[{i18nFile:"./i18n/Contactor.properties"}],onClickTopic:"DATAGRID_LOAD_DATA",rootLabel:"groupTreeRootLabel.label",Url:"/tree/groupTree",query:"",publishTopic:"TREE_GROUP_CLICK",type:"btl-group:group-folder",getInfoUrl:"search/group",postMixInProperties:function a(){this.inherited(arguments);this.alfSubscribe("TREE_GET_INFO_GROUP",r.hitch(this,this.getInfo),true);this.alfSubscribe("TREE_DELETE_GROUP",r.hitch(this,this.deleteNode),true);this.alfSubscribe("TREE_CREATE_GROUP",r.hitch(this,this.createGroup),true)},getInfo:function e(){var s=this.tree.get("selectedItems")[0];this.serviceXhr({url:"/share/proxy/alfresco/"+this.getInfoUrl+"?nodeRef="+s.id,method:"GET",successCallback:this.edit,callbackScope:this})},edit:function i(t,s){this.alfLog("log","alfresco_TreeGroup__edit response",t);this.alfLog("log","alfresco_TreeGroup__edit originalRequestConfig",s);var u={};u.config={};u.data=t;u.config.dialogTitle="formEditGroup.title.label";u.config.dialogConfirmationButtonTitle="edit.title";u.config.dialogCancellationButtonTitle="cancel.title";u.config.formSubmissionTopic="BTL_EDIT_GROUP";this.alfPublish("BTL_CREATE_FORM_GROUP",u,true)},deleteNode:function p(){var s=this.tree.get("selectedItems")[0];var t={};t.requiresConfirmation=true;t.confirmationTitle="deleteGroup.title.label";t.confirmationPrompt="Вы действительно хотите удалить: "+s.name+"?";t.nodeRef=s.id;t.responseTopic="BTL_SING_REMOVE_GROUP",this.alfPublish("BTL_MSG_DELETE_DIALOG",t,true)},createGroup:function d(t){var s=this.tree.get("selectedItems")[0];t.rootNodeRef=s.id;this.alfPublish("BTL_CREATE_FORM_GROUP",t,true)},getIconClass:function(s,t){if(!s.root&&!s.hasChildren){return"dijitIconUsers"}else{return t?"dijitFolderOpened":"dijitFolderClosed"}},onMouseDown:function n(y){var w=this;var t=event.pageX;var s=event.pageY;var A=null;var z=f(event,true);var x=c(y);if(x==null||x!=z){return}var u=x.domNode.className.indexOf("dijitTreeIsRoot")!=-1;var B=x.item.id!="";if(u||!B){return}var v=x.item.id;y.preventDefault();window.onmousemove=function(F){if(F.buttons!=1){if(A!=null){A.hidden=true}window.onmouseup=null;window.onmousemove=null;return}var E=F.pageX-t;var C=F.pageY-s;if(Math.abs(E)<3&&Math.abs(C)<3){return}var H=0;var G=0;var D="/share/res/js/btl/widgets/base/css/images/";z=f(F,false);D+=(z!=null&&z.item.id!=""&&z!=x)?"folder-closed-yellow-16.png":"folder-closed-16.png";if(A==null){A=new Image();A.src=D;if(A.parentNode!=document.body){document.body.appendChild(A)}A.style.zIndex=9999;A.style.position="absolute";if(!A){return}H=t;G=s}else{A.src=D}A.style.left=F.pageX-H+10+"px";A.style.top=F.pageY-G+10+"px";return false};window.onmouseup=function(C){window.onmouseup=null;window.onmousemove=null;if(A!=null){A.hidden=true}if(z!=null&&z.item.id!=""&&z!=x){l(w,x.item.id,z.item.id)}}},})});