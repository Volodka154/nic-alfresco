define(["dojo/_base/declare","btl/widgets/base/DataGrid","dojo/_base/lang","btlExtension/windowChoiceItem/window_choice_item","alfresco/core/CoreXhr","dojo/topic","dijit/Dialog","dojox/timing/_base","dojo/dom-construct","dijit/registry"],function(r,m,v,b,i,o,e,n,h,j){return r([m,i],{title:"Список первых исполнителей",Url:"filters/resource-executor",colModel:[],height:"100%",filterModel:{on:true,mode:"AND",header:true},pageModel:{type:"local",rPP:100,strRpp:"{0}",rPPOptions:[100,250,500]},extra:"&extra=ASPECT:'btl-people:firstExecutor'",editable:false,title:"Список первых исполнителей",editDialog:null,row:null,rowId:null,colModel:[{title:"nodeRef",width:100,dataType:"string",dataIndx:"nodeRef",hidden:true},{title:"Ф.И.О.",width:200,dataType:"string",align:"right",dataIndx:"name"},{title:"Ранг",width:50,dataType:"integer",align:"right",dataIndx:"rank"},{title:"Пользователь Alfresco",width:200,dataType:"integer",align:"right",dataIndx:"user"},{title:"",width:120,dataType:"string",align:"right"}],postMixInProperties:function c(){this.inherited(arguments);this.alfSubscribe("DATAGRID_DELETE_FIRST_EXECUTORS",v.hitch(this,this.deleteFirstExecutors),true);this.alfSubscribe("DATAGRID_GET_FIRST_EXECUTORS_DATA",v.hitch(this,this.getFirstExecutorsData),true);this.alfSubscribe("DATAGRID_EDIT_FIRST_EXECUTORS_DATA",v.hitch(this,this.updateRow),true);this.alfSubscribe("BTL_CREATE_FORM_FIRST_EXECUTORS",v.hitch(this,this.onCreateFormFirstExecutors),true);this.createEditDialog()},gridAutoSize:function a(){var w=document.documentElement.offsetHeight;w-=document.getElementById("SHARE_HEADER").offsetHeight;w-=80;width=document.documentElement.offsetWidth-document.getElementById("MAIN_LIST_MENU").offsetWidth;width-=30;return{height:w,width:width}},refreshDataDataGrid:function q(){this.loadDataDataGrid({nodeRef:this.rootNodeRef})},setEventsDataGrid:function l(){var x=this;this.grid.pqGrid({rowDblClick:function(y,z){x.getFirstExecutorsData()}});this.grid.pqGrid("option","height",document.getElementById("MAIN_WIDGET").offsetHeight);this.choiceItem=new Alfresco.WindowChoiceItem(this.id+"-btn-add-link").setOptions({header:"Выбор из справочника сотрудников:",single:false,url:"/share/proxy/alfresco/filters/resource-executor",renderData:"items",placeHolder:"Поиск по фамилии",dataUrl:{extra:" !ASPECT:'btl-people:firstExecutor'"}});this.choiceItem.dialogCreate();this.choiceItem.setEvents();this.choiceItem.onOk.subscribe(function w(){var y=this.getValues();if(y!=null){y.forEach(function(z){x.createFirstExecutors(z)})}})},onCreateFormFirstExecutors:function s(w){this.alfLog("log","alfresco_onCreateFormFirstExecutors",w);this.choiceItem.dialog.show()},createFirstExecutors:function f(w){this.alfLog("log","alfresco_createFirstExecutors__getWidgets",w);this.serviceXhr({url:"/share/proxy/alfresco/api/node/"+w.nodeRef.replace("://","/")+"/formprocessor",method:"POST",data:{"prop_btl-people_rank":0},successCallback:this.successAddFirstExecutor,failureCallback:this.failureAddFirstExecutor,callbackScope:this,row:{nodeRef:w.nodeRef,name:w.name,rank:0}})},successAddFirstExecutor:function u(x,w){o.publish("ALF_DISPLAY_NOTIFICATION",{message:"Добавлен новый первый исполнитель."});this.grid.pqGrid("addRow",{rowData:w.row})},failureAddFirstExecutor:function u(x,w){var x=x;failureDialog=new e({title:"Ошибка при добавление первого исполнителя!",content:x.message,style:"width: 300px"});failureDialog.show()},editFirstExecutors:function p(w){this.serviceXhr({url:"/share/proxy/alfresco/api/node/"+w.nodeRef.replace("://","/")+"/formprocessor",method:"POST",data:{"prop_btl-people_rank":w.rank},successCallback:this.updateRow(this.rowId,w),failureCallback:this.failureDelFirstExecutor,callbackScope:this})},deleteFirstExecutors:function t(){var w=this.grid.pqGrid("selection",{type:"row",method:"getSelection"});if(w&&w.length>0){var z=w[0].rowData;var x=w[0].rowIndx;var y={};this.serviceXhr({url:"/alfresco/s/slingshot/doclib/action/aspects/node/"+z.nodeRef.replace("://","/"),method:"POST",data:{added:[],removed:["btl-people:firstExecutor"]},successCallback:this.successDelFirstExecutor,failureCallback:this.failureDelFirstExecutor,callbackScope:this,rowIndx:x})}},successDelFirstExecutor:function u(x,w){o.publish("ALF_DISPLAY_NOTIFICATION",{message:"Удален первый исполнитель."});this.grid.pqGrid("deleteRow",{rowIndx:w.rowIndx})},failureDelFirstExecutor:function u(x,w){var x=x;failureDialog=new e({title:"Ошибка при удалении первого исполнителя!",content:x.message,style:"width: 300px"});failureDialog.show()},getFirstExecutorsData:function k(){var x=this.grid;var w=x.pqGrid("selection",{type:"row",method:"getSelection"});if(w&&w.length>0){var y=w[0].rowIndx;var z=x.pqGrid("getRowData",{rowIndx:y});this.rowId=y;this.row=z;document.getElementById("crud-form-rang").value=(z.rank)?z.rank:"";this.editDialog.show()}},createEditDialog:function d(){var z=this;var y=j.byId("crud-form");if(y){y.destroyRecursive()}this.editDialog=new e({title:"Изменить ранг",id:"crud-form",content:"",style:"width: 300px"});var w=h.create("div",{"class":"dijitDialogPaneContentArea",innerHTML:""},this.editDialog.containerNode);var B=h.create("div",{"class":"dijitDialogPaneActionBar"},this.editDialog.containerNode);h.create("label",{innerHTML:"Ранг:",style:"width:95%;"},w);function A(C){if(C.which==null){if(C.keyCode<32){return null}return String.fromCharCode(C.keyCode)}if(C.which!=0&&C.charCode!=0){if(C.which<32){return null}return String.fromCharCode(C.which)}return null}h.create("input",{type:"text",id:"crud-form-rang",style:"width:95%;",onkeypress:""},w);var x=this.editDialog;new dijit.form.Button({label:"OK",onClick:function(){z.row.rank=document.getElementById("crud-form-rang").value;z.editFirstExecutors(z.row);x.hide()}}).placeAt(B);new dijit.form.Button({label:"Отмена",onClick:function(){x.hide()}}).placeAt(B);document.getElementById("crud-form-rang").onkeypress=function(D){D=D||event;if(D.ctrlKey||D.altKey||D.metaKey){return}var C=A(D);if(C==null){return}if(C<"0"||C>"9"){return false}}},updateRow:function g(w,x){this.grid.pqGrid("updateRow",{rowIndx:w,row:x});this.grid.pqGrid("refresh")}})});