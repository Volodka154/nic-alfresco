define(["dojo/_base/declare","dijit/_WidgetBase","dijit/_TemplatedMixin","dojo/text!../base/templates/DataGrid.html","service/constants/Default","alfresco/core/Core","alfresco/core/CoreWidgetProcessing","alfresco/documentlibrary/_AlfDocumentListTopicMixin","alfresco/services/_NavigationServiceTopicMixin","dojo/dom-construct","dojo/_base/lang","alfresco/core/CoreXhr","alfresco/core/topics","btl/service/FormContactPerson","dojo/topic","jquery","jqueryui","pqgrid"],function(D,h,w,F,o,r,t,e,a,k,G,l,y,z,v,i){return D([h,w,r,t,e,a,l],{templateString:F,customCssClasses:"",getInfoContactorUrl:"search/contactor",itemContactPerson:{},actualContactor:false,all:false,contactorUrl:"/share/proxy/alfresco/search/contactor-list?",curRowIndxContactor:-1,paramsContactor:{},postMixInProperties:function f(){this.inherited(arguments);this.alfSubscribe("DATAGRID_LOAD_DATA",G.hitch(this,this.reSend),true);this.alfSubscribe("Re_Send_Delete",G.hitch(this,this.reSendDelete),true);this.alfSubscribe("DATAGRID_GET_CONTRACTORS",G.hitch(this,this.getContractors),true);this.alfSubscribe("SET_ITEM_CONTACT_PERSON_INFO",G.hitch(this,this.setContactPersonInfo),true);this.alfSubscribe("BTL_GET_INFO_CONTACTOR",G.hitch(this,this.getContactorData),true);this.alfSubscribe("DATAGRID_DELETE_CONTACTOR",G.hitch(this,this.DeteleContactor),true);this.alfSubscribe("DATAGRID_DELETE_ROW_CONTACTOR_SUCCESS",G.hitch(this,this.DeteleRowContactor),true);this.alfSubscribe("DATAGRID_DELETE_ROW_CONTACT_PERSON_SUCCESS",G.hitch(this,this.DeteleRowContactPerson),true);this.alfSubscribe("DATAGRID_EDIT_ROW_CONTACT_PERSON",G.hitch(this,this.editRowContactPerson),true);this.alfSubscribe("DATAGRID_EDIT_ROW_CONTACTOR",G.hitch(this,this.editRowContactor),true);this.alfSubscribe("DATAGRID_ADD_ROW_CONTACTOR",G.hitch(this,this.addRowContactor),true);this.alfSubscribe("DATAGRID_ADD_ROW_CONTACT_PERSON",G.hitch(this,this.addRowContactPerson),true)},reSend:function C(H){this.alfLog("log","alfresco_ContactorDataGrid__deleteContactPerson reSend",H);this.curRowIndxContactor=H.rowIndx;this.alfPublish(this.pubSubScope+"DATAGRID_LOAD_DATA",{nodeRef:H.rowData.nodeRef},true)},postCreate:function g(){var R=/^([a-zа-яё0-9]|[a-zа-яё0-9][a-zа-яё0-9/ /./-]+)$/i;var S=/^([0-9]+)$/;function J(V,W){if(W.value.length==0||R.test(W.value)){if(V.keyCode==13){require(["dojo/topic"],function(X){X.publish("DATAGRID_GET_CONTRACTORS",{})})}}else{console.log("Недопустимое значение");alert("Недопустимое значение")}}function P(V,W){if(W.value.length==0||S.test(W.value)){if(V.keyCode==13){require(["dojo/topic"],function(X){X.publish("DATAGRID_GET_CONTRACTORS",{})})}}else{console.log("Недопустимое значение");alert("Недопустимое значение")}}function L(V,W){if(W.value.length==0||S.test(W.value)){if(V.keyCode==13){require(["dojo/topic"],function(X){X.publish("DATAGRID_GET_CONTRACTORS",{})})}}else{console.log("Недопустимое значение");alert("Недопустимое значение")}}var M=[{title:"",minWidth:27,width:27,type:"detail",resizable:false,editable:false},{title:"nodeRef",width:600,dataIndx:"nodeRef",hidden:true},{title:"Название",width:500,dataIndx:"name",filter:{on:true,type:"textbox",condition:"begin",listeners:["change"]}},{title:"ИНН",width:120,dataIndx:"inn",filter:{type:"textbox",condition:"begin",listeners:["change"]}},{title:"КПП",width:120,dataIndx:"kpp",filter:{type:"textbox",condition:"begin",listeners:["change"]}},{title:"",width:120}];if(!this.all){this.paramsContactor.notActual=this.actualContactor;this.contactorUrl+="params="+encodeURI(encodeURIComponent(JSON.stringify(this.paramsContactor)))}var Q={location:"remote",sorting:"local",method:"GET",url:this.contactorUrl,getData:function(W){var V=W.items;return{curPage:W.curPage,totalRecords:W.totalRecords,data:V}}};var N=this;var T=document.documentElement.offsetHeight;T-=document.getElementById("SHARE_HEADER").offsetHeight;T-=70;var I=document.documentElement.offsetWidth-document.getElementById("MAIN_LIST_MENU").offsetWidth;I-=30;var U={width:I,flexHeight:false,collapsible:false,height:T,dataModel:Q,selectionModel:{type:"row",mode:"range",all:null,cbAll:null,cbHeader:null},pageModel:{type:"remote",rPP:25,strRpp:"{0}",rPPOptions:[25,50,100]},filterModel:{on:true,mode:"AND",header:true},editable:false,colModel:M,wrap:false,hwrap:false,numberCell:{show:false},title:"<b>Список контрагентов</b>",resizable:true,freezeCols:1,freezeRows:0,detailModel:{cache:true,collapseIcon:"ui-icon-plus",expandIcon:"ui-icon-minus",init:function(ab){var aa=ab.rowData,Z=aa.nodeRef;var Y=i.extend(true,{},O);var X={};X["btl-people:notActual"]=false;var W="params="+encodeURI(encodeURIComponent(JSON.stringify(X)));Y.dataModel.url="/share/proxy/alfresco/search/search?nodeRef="+Z+"&"+W;Y.dataModel.error=function(){N.grid.pqGrid("rowInvalidate",{rowData:aa})};var V=i("<div></div>").pqGrid(Y);return V}}};this.grid=i(this.domNode).pqGrid(U);var H=this.grid;window.gridB=H;this.grid.pqGrid({rowSelect:function(V,W){require(["dojo/topic"],function(X){X.publish("DATAGRID_LOAD_DATA",W)})}});var N=this;this.grid.pqGrid({rowDblClick:function(V,W){N.getContactorData()}});function K(V){this.alfLog("log","alfresco_ContactorDataGrid__deleteContactPerson ui",V)}var O={width:"100%",flexHeight:true,height:150,collapsible:false,pageModel:{type:"local",rPP:100,strRpp:"{0}",rPPOptions:[25,50,100]},selectionModel:{type:"row",mode:"range",all:null,cbAll:null,cbHeader:null},dataModel:{location:"remote",sorting:"local",method:"GET",getData:function(V){V.items.forEach(function(W){W.org=V.org});return{data:V.items}}},colModel:[{title:"nodeRef",width:100,dataType:"string",dataIndx:"nodeRef",hidden:true},{title:"Имя",width:100,dataType:"string",dataIndx:"firstname"},{title:"Отчество",width:100,dataType:"string",align:"right",dataIndx:"middlename"},{title:"Фамилия",width:100,dataType:"string",align:"right",dataIndx:"surname"},{title:"Пол",width:80,dataType:"string",dataIndx:"sex"},{title:"Должность",width:200,dataType:"string",dataIndx:"position",hidden:true},{title:"Пользователь Alfresco",width:200,dataType:"string",align:"right",dataIndx:"alfrescoUser_val",hidden:true},{title:"Пользователь Alfresco",width:200,dataType:"string",align:"right",dataIndx:"alfrescoUser_ref",hidden:true},{title:"Телефон",width:150,dataType:"string",dataIndx:"phone"},{title:"Мобильный телефон",width:150,dataType:"string",dataIndx:"mobile"},{title:"Сайт компании",width:150,dataType:"string",dataIndx:"site"},{title:"Email",width:150,dataType:"string",dataIndx:"email"},{title:"",editable:false,minWidth:165,sortable:false,render:function(V){return"<button type='button' class='edit_btn'>Редактировать</button>		                            <button type='button' class='delete_btn'>Удалить</button>"}},{title:"Фдрес",width:1,dataType:"string",dataIndx:"address",hidden:true},],load:function(W,X){var V=i(this);if(!V){return}if(X.dataModel.data.length<4){V.pqGrid("option","flexHeight",false);V.pqGrid("option","height",200);V.pqGrid("refresh")}else{V.pqGrid("option","flexHeight",true)}},refresh:function(){var V=i(this);if(!V){return}V.find("button.edit_btn").button({icons:{primary:"ui-icon-pencil"}}).unbind("click").bind("click",function(W){var Y=i(this).closest("tr"),X=V.pqGrid("getRowIndx",{$tr:Y}).rowIndx;var Z=V.pqGrid("getRowData",{rowIndxPage:X});require(["dojo/topic"],function(aa){aa.publish("SET_ITEM_CONTACT_PERSON_INFO",{grid:V,rowIndx:X});var ab={};ab.config={};ab.contactPerson=Z;ab.contactPerson.rowId=X;ab.config.dialogTitle="formEditContactPerson.title.label";ab.config.dialogConfirmationButtonTitle="edit.title";ab.config.dialogCancellationButtonTitle="cancel.title";ab.config.formSubmissionTopic="BTL_EDIT_CONTACT_PERSON";aa.publish("BTL_CREATE_FORM_CONTACT_PERSON",ab)});return false});V.find("button.delete_btn").button({icons:{primary:"ui-icon-close"}}).unbind("click").bind("click",function(W){var Y=i(this).closest("tr"),X=V.pqGrid("getRowIndx",{$tr:Y}).rowIndx;var Z=V.pqGrid("getRowData",{rowIndxPage:X});require(["dojo/topic"],function(aa){aa.publish("SET_ITEM_CONTACT_PERSON_INFO",{grid:V,rowIndx:X});aa.publish("Re_Send_Delete",{row:Z,rowIndx:X})})})},editable:false,numberCell:{show:false},title:"Список контактных лиц",};this.setEventsDataGrid();i(window).resize(function(){var V=N.gridAutoSize();N.grid.pqGrid("option","width",V.width);N.grid.pqGrid("option","height",V.height);N.grid.pqGrid("refreshView",{header:false})})},gridAutoSize:function c(){var H=document.documentElement.offsetHeight;H-=document.getElementById("SHARE_HEADER").offsetHeight;H-=50;var I=document.documentElement.offsetWidth-document.getElementById("MAIN_LIST_MENU").offsetWidth;I-=30;return{height:H,width:I}},getContractors:function d(){var H=this.grid.pqGrid("option","colModel");var L=[];var J=(i('input[name="name"]')[1].value)?i('input[name="name"]')[1].value:"";var N=(i('input[name="inn"]')[1].value)?i('input[name="inn"]')[1].value:"";var I=(i('input[name="kpp"]')[1].value)?i('input[name="kpp"]')[1].value:"";var K={data:[(J)?{dataIndx:"name",value:J}:{},(N)?{dataIndx:"inn",value:N}:{},(I)?{dataIndx:"kpp",value:I}:{}]};var M=encodeURIComponent(JSON.stringify(K));this.grid.pqGrid("showLoading");this.serviceXhr({url:"/share/proxy/alfresco/search/contactor-list",method:"GET",query:"pq_filter="+M,successCallback:this.setDataToDataGrid,callbackScope:this})},setDataToDataGrid:function B(I,H){this.grid.pqGrid("option","dataModel.data",I.items);this.grid.pqGrid("refreshView",{header:false});this.grid.pqGrid("hideLoading");this.alfLog("log","alfresco_DataGrid__setDataToDataGrid",this.grid)},getContactorData:function j(){var H=this.grid.pqGrid("selection",{type:"row",method:"getSelection"});if(H&&H.length>0){var I=H[0].rowData;this.serviceXhr({url:"/share/proxy/alfresco/"+this.getInfoContactorUrl+"?nodeRef="+I.nodeRef,method:"GET",successCallback:this.edit,callbackScope:this})}},setEventsDataGrid:function q(){var K=/^([a-zа-яё0-9])$/i;var I=/^([a-zа-яё0-9/ /./-])$/i;var H=/^([0-9])$/;var J=this;i('input[name="name"]').keypress(function(L){if((L.target.value.length==0&&K.test(String.fromCharCode(L.which)))||(L.target.value.length>0&&I.test(String.fromCharCode(L.which)))||L.which<32){}else{L.preventDefault()}});i('input[name="inn"]').keypress(function(L){if(H.test(String.fromCharCode(L.which))||L.which<32){}else{L.preventDefault()}});i('input[name="kpp"]').keypress(function(L){if(H.test(String.fromCharCode(L.which))||L.which<32){}else{L.preventDefault()}})},edit:function s(I,H){this.alfLog("log","alfresco_navigation_Tree__edit response",I);this.alfLog("log","alfresco_navigation_Tree__edit originalRequestConfig",H);var J={};J.config={};J.contactor=I;J.config.dialogTitle="formEditContactor.title.label";J.config.dialogConfirmationButtonTitle="create.title";J.config.dialogCancellationButtonTitle="cancel.title";J.config.formSubmissionTopic="BTL_EDIT_CONTACTOR";this.alfPublish("BTL_CREATE_FORM_CONTACTOR",J,true)},editRowContactPerson:function m(H){this.alfLog("log","alfresco_DataGridContactor__editRowContactPerson",H);this.alfLog("log","alfresco_DataGridContactor__editRowContactPerson this.itemContactPerson",this.itemContactPerson);if(typeof this.itemContactPerson.grid.pqGrid!=="undefined"){this.itemContactPerson.grid.pqGrid("updateRow",{rowIndx:this.itemContactPerson.rowIndx,row:H})}},editRowContactor:function E(H){if(this.curRowIndxContactor>-1){this.grid.pqGrid("updateRow",{rowIndx:this.curRowIndxContactor,row:H});this.grid.pqGrid("refresh")}},setContactPersonInfo:function A(H){this.itemContactPerson={grid:H.grid,rowIndx:H.rowIndx}},DeteleContactor:function n(I){var H=this.grid.pqGrid("selection",{type:"row",method:"getSelection"});if(H&&H.length>0){this.curRowIndxContactor=H[0].rowIndx;var J={};J.requiresConfirmation=true;J.confirmationTitle="deleteContactor.title.label";J.confirmationPrompt="Вы действительно хотите удалить: "+H[0].rowData.name+"?";J.nodeRef=H[0].rowData.nodeRef;J.responseTopic="BTL_SING_REMOVE_CONTACTOR";this.alfPublish("BTL_MSG_DELETE_DIALOG",J,true)}},DeteleRowContactor:function n(){this.grid.pqGrid("deleteRow",{rowIndx:this.curRowIndxContactor});var H="crudservice.generic.success.message";this.alfServicePublish(y.DISPLAY_NOTIFICATION,{message:this.message(H)})},DeteleRowContactPerson:function x(){if(typeof this.itemContactPerson.grid.pqGrid!=="undefined"){this.itemContactPerson.grid.pqGrid("deleteRow",{rowIndx:this.itemContactPerson.rowIndx});var H="crudservice.generic.success.message";this.alfServicePublish(y.DISPLAY_NOTIFICATION,{message:this.message(H)})}},reSendDelete:function b(H){var I={};I.requiresConfirmation=true;I.confirmationTitle="deleteContactor.title.label";I.confirmationPrompt="Вы действительно хотите удалить: "+H.row.surname+" "+H.row.firstname+" "+H.row.middlename+"?";I.nodeRef=H.row.nodeRef;I.responseTopic="BTL_SING_REMOVE_CONTACT_PERSON";this.alfPublish("BTL_MSG_DELETE_DIALOG",I,true)},addRowContactor:function p(H){this.grid.pqGrid("addRow",{rowData:H})},addRowContactPerson:function u(J){var I=this.grid.pqGrid("selection",{type:"row",method:"getSelection"});if(I&&I.length>0){var H=I[0].rowData.pq_detail.child;H.pqGrid("addRow",{rowData:J})}}})});