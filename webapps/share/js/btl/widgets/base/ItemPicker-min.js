define(["dojo/_base/declare","alfresco/forms/ControlColumn","dojo/_base/lang","alfresco/core/CoreXhr"],function(g,d,c,e){return g([d,e],{value:null,item:null,name:"",textBoxValue:"",labelText:"",labelButton:"",labelPicker:"",descriptionPicker:"",url:"",itemUrl:"",itemsProperty:"items",itemKey:"nodeRef",propertyToRender:"item",availableItemsLabel:"",pickedItemsLabel:"",dialogConfirmationButtonTitle:"Выбрать",dialogCancellationButtonTitle:"Отменить",loadDataPublishTopic:"ALF_CRUD_GET_ALL",widgets:[],uid:"",oldValue:null,postMixInProperties:function i(){this.inherited(arguments);this.uid=this.generateUuid();this._processingWidgets=[];if(this.value&&c.trim(this.value)!==""){this.value=this.message(this.value)}this.uid=this.generateUuid();if(this.uid&&c.trim(this.uid)!==""){this.uid=this.message(this.uid)}if(this.labelText&&c.trim(this.labelText)!==""){this.labelText=this.message(this.labelText)}if(this.labelButton&&c.trim(this.labelButton)!==""){this.labelButton=this.message(this.labelButton)}if(this.labelPicker&&c.trim(this.labelPicker)!==""){this.labelPicker=this.message(this.labelPicker)}if(this.descriptionPicker&&c.trim(this.descriptionPicker)!==""){this.descriptionPicker=this.message(this.descriptionPicker)}if(this.loadDataPublishTopic&&c.trim(this.loadDataPublishTopic)!==""){this.loadDataPublishTopic=this.message(this.loadDataPublishTopic)}if(this.url&&c.trim(this.url)!==""){this.url=this.message(this.url)}if(this.name&&c.trim(this.name)!==""){this.name=this.message(this.name)}if(this.itemUrl&&c.trim(this.itemUrl)!==""){this.itemUrl=this.message(this.itemUrl)}if(this.itemsProperty&&c.trim(this.itemsProperty)!==""){this.itemsProperty=this.message(this.itemsProperty)}if(this.itemKey&&c.trim(this.itemKey)!==""){this.itemKey=this.message(this.itemKey)}if(this.propertyToRender&&c.trim(this.propertyToRender)!==""){this.propertyToRender=this.message(this.propertyToRender)}if(this.availableItemsLabel&&c.trim(this.availableItemsLabel)!==""){this.availableItemsLabel=this.message(this.availableItemsLabel)}if(this.pickedItemsLabel&&c.trim(this.pickedItemsLabel)!==""){this.pickedItemsLabel=this.message(this.pickedItemsLabel)}if(this.dialogConfirmationButtonTitle&&c.trim(this.dialogConfirmationButtonTitle)!==""){this.dialogConfirmationButtonTitle=this.message(this.dialogConfirmationButtonTitle)}if(this.dialogCancellationButtonTitle&&c.trim(this.dialogCancellationButtonTitle)!==""){this.dialogCancellationButtonTitle=this.message(this.dialogCancellationButtonTitle)}this.alfSubscribe(this.uid+"ITEM_PICKER_SET_VALUE",c.hitch(this,this.itemPickerSetValue),true);this.alfSubscribe(this.uid+"GET_VALUE_FROM_ITEM",c.hitch(this,this.sendItemValue),true);this.alfLog("log","alfresco_itemPickerSetValue____postMixInProperties",this)},postCreate:function a(){this.oldValue=this.value;var o={name:"alfresco/forms/controls/TextBox",config:{valueSubscriptionTopic:this.uid+"ITEM_SET_VALUE",name:this.name+"_val",label:this.labelText}};var m={name:"alfresco/forms/controls/TextBox",config:{valueSubscriptionTopic:this.uid+"ITEM_SET_VALUE_ADD",name:this.name+"_added",visibilityConfig:{initialValue:false}}};var n={name:"alfresco/forms/controls/TextBox",config:{valueSubscriptionTopic:this.uid+"ITEM_SET_VALUE_DEL",name:this.name+"_removed",visibilityConfig:{initialValue:false}}};var l={name:"alfresco/forms/controls/DojoValidationTextBox",config:{valueSubscriptionTopic:this.pubSubScope+this.uid+"ITEM_SET_VALUE",name:this.name,value:this.value,visibilityConfig:{initialValue:false}}};var p={name:"alfresco/buttons/AlfButton",id:"SimplePicker",config:{label:this.labelButton,publishTopic:"ALF_CREATE_FORM_DIALOG_REQUEST",publishGlobal:true,publishPayload:{pubSubScope:"GROUP_USERS_",cancelPublishScope:"",cancelPublishTopic:"DIALOG_CANCELLED",dialogId:this.pubSubScope+"PICKER_DIALOG",dialogTitle:this.labelText,dialogConfirmationButtonTitle:this.dialogConfirmationButtonTitle,dialogCancellationButtonTitle:this.dialogCancellationButtonTitle,formSubmissionTopic:this.uid+"ITEM_PICKER_SET_VALUE",widgets:[{name:"btl/widgets/base/btlSinglePicker",config:{pubSubScope:"",label:this.labelPicker,description:this.descriptionPicker,name:"groups",singleItemMode:true,value:[this.value],uid:this.uid,loadDataPublishTopic:this.loadDataPublishTopic,loadDataPublishPayload:{alfResponseTopic:"TEST_TOPIC",alfResponseScope:"TEST_SCOPE",url:this.url,pageSize:0,page:false,startIndex:false},itemsProperty:this.itemsProperty,itemKey:this.itemKey,propertyToRender:this.propertyToRender,availableItemsLabel:this.availableItemsLabel,pickedItemsLabel:this.pickedItemsLabel}}]}}};this.widgets=[o,p,l,m,n];this.inherited(arguments);this.alfLog("log","alfresco_itemPickerSetValue____postCreate",this);this.completeWidgetSetup()},completeWidgetSetup:function k(){this.inherited(arguments);this.alfLog("log","alfresco_forms_controls_ItemPicker__completeWidgetSetup",this);if(this.value){this.itemPickerSetBaseValue()}else{this.alfPublish(this.pubSubScope+this.uid+"ITEM_SET_VALUE",{value:""},true)}},itemPickerSetBaseValue:function h(){this.serviceXhr({url:this.itemUrl+this.value,method:"GET",successCallback:this.setBaseValueItemPicker,callbackScope:this})},setBaseValueItemPicker:function b(m,l){this.alfLog("log","alfresco_ItemPicker__setBaseValueItemPicker",m);this.alfPublish(this.pubSubScope+this.uid+"ITEM_SET_VALUE",{value:m.item},true);this.item={};this.item[this.propertyToRender]=m.item;this.item[this.itemKey]=this.value},itemPickerSetValue:function j(l){this.alfLog("log","alfresco_itemPickerSetValue__postMixInProperties",l);if(l.groups.length>0){l.value=l.groups[0][this.propertyToRender];this.alfPublish(this.pubSubScope+this.uid+"ITEM_SET_VALUE",l,true);l.value=l.groups[0][this.itemKey];this.alfPublish(this.pubSubScope+this.pubSubScope+this.uid+"ITEM_SET_VALUE",l,true);if(this.oldValue!=l.value){this.alfPublish(this.pubSubScope+this.uid+"ITEM_SET_VALUE_ADD",l,true);l.value=this.oldValue;this.alfPublish(this.pubSubScope+this.uid+"ITEM_SET_VALUE_DEL",l,true)}this.item={};this.item[this.propertyToRender]=l.groups[0][this.propertyToRender];this.item[this.itemKey]=l.groups[0][this.itemKey]}else{this.alfPublish(this.pubSubScope+this.uid+"ITEM_SET_VALUE",{value:""},true);this.alfPublish(this.pubSubScope+this.pubSubScope+this.uid+"ITEM_SET_VALUE",{value:""},true);l.value=this.oldValue;this.alfPublish(this.pubSubScope+this.uid+"ITEM_SET_VALUE_DEL",l,true);this.item=null}},sendItemValue:function f(){if(this.item!==null){this.alfPublish(this.uid+"SET_ITEM",{item:this.item},true)}}})});