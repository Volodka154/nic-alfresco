define(["dojo/_base/declare","dijit/_WidgetBase","dijit/_TemplatedMixin","dojo/text!./templates/Tree.html","alfresco/core/Core","service/constants/Default","alfresco/documentlibrary/_AlfDocumentListTopicMixin","alfresco/services/_NavigationServiceTopicMixin","dojo/dom-construct","dojo/_base/lang","dojo/_base/array","dijit/tree/ObjectStoreModel","dojo/store/Memory","dojo/store/Cache","dojo/store/Observable","dijit/Tree","alfresco/core/CoreXhr","dojo/aspect","dojo/when"],function(C,u,p,D,v,r,c,a,j,E,m,g,s,z,t,A,l,x,i){return C([u,p,v,c,a,l],{i18nRequirements:[{i18nFile:"./i18n/Tree.properties"}],cssRequirements:[{cssFile:"./css/Tree.css"}],customCssClasses:"",templateString:D,siteId:null,containerId:null,rootNode:null,rootLabel:"documentlibrary.root.label",rootValue:"",filterPrefsName:"docListTreePref",showRoot:true,rootNode:null,Store:null,type:"",q_params:{},postMixInProperties:function y(){this.inherited(arguments);this.alfSubscribe("TREE_ADD_NEW_NODE",E.hitch(this,this.addNewNode),true);this.alfSubscribe("TREE_EDIT_NODE_ATTRIBUTE",E.hitch(this,this.editNodeAttribute),true);this.alfSubscribe("TREE_DELETE_NODE_FROM_STORE_SUCCESS",E.hitch(this,this.deleteNodeFromStore),true)},postCreate:function B(){this.showRoot=this.showRoot!=null?this.showRoot:true;var F=new s({data:[],getChildren:function(G){return this.query({parent:G.id})}});this.Store=new t(F);this.treeModel=new g({root:{id:this.rootNode,name:this.encodeHTML(this.message(this.rootLabel)),value:this.rootValue,root:true,path:"/"},store:this.Store,query:{}});this.tree=new A({model:this.treeModel,showRoot:this.showRoot,onClick:E.hitch(this,"onClick"),onDblClick:E.hitch(this,"onDblClick"),onOpen:E.hitch(this,"onNodeExpand"),onClose:E.hitch(this,"onNodeCollapse"),onMouseDown:E.hitch(this,"onMouseDown"),getIconClass:E.hitch(this,"getIconClass"),});this.tree.placeAt(this.domNode);this.tree.startup();this.getTreeNodeChildren(this.rootNode)},onClickTopic:"ALF_DOCUMENTLIST_PATH_CHANGED",publishTopic:"",onClick:function d(H,G,F){this.alfLog("log","Tree Node clicked",H,G,F);this.alfPublish(this.onClickTopic,{path:H.path,id:H.id,nodeRef:H.id,name:H.name,value:H.value,hasChildren:H.hasChildren,root:(!!H.root)?H.root:false,treeType:this.type});this.alfPublish(this.publishTopic,{path:H.path,type:(H.path=="/"?"root":(H.id=="all"?H.id:H.id==""?"free":""))})},onDblClick:function o(H,G,F){if(!H.root&&H.id){this.getInfo()}},onNodeExpand:function b(G,F){if(G.id&&G.id!=this.rootNode){this.getTreeNodeChildren(G.id)}if(F!=null&&F._loadDeferred!=null){this.alfLog("log","Wait for node expand before rezize",F._loadDeferred);F._loadDeferred.then(E.hitch(this,"requestSidebarResize"))}},onNodeCollapse:function b(G,F){if(F!=null&&F._collapseDeferred!=null){this.alfLog("log","Wait for node collapse before rezize",F._collapseDeferred);F._loadDeferred.then(E.hitch(this,"requestSidebarResize"))}},requestSidebarResize:function q(){this.alfPublish("ALF_RESIZE_SIDEBAR",{})},getTreeNodeChildren:function w(G){var H;if(this.q_params!==null){this.q_params.notActual=false;H="&params="+encodeURI(encodeURIComponent(JSON.stringify(this.q_params)))}var F={url:r.PROXY_URI+this.Url,query:"nodeRef="+G+"&type="+this.type+H,method:"GET",nodeRef:G,successCallback:this.loadBaseTree,callbackScope:this};this.serviceXhr(F)},loadBaseTree:function k(G,F){this.alfLog("log","Tree DATA",G.items);document.getElementById(this.tree.id).style.height="600px";if(F.nodeRef.toString()===this.rootNode.toString()){var H=this.tree.model.root;this.tree.set("path",["/"]);this.tree.set("selectedItem",H);this.tree.onClick(H)}m.forEach(G.items,E.hitch(this,"addTreeElements"))},addTreeElements:function f(G,I,F){try{this.Store.add({id:F[I].nodeRef,name:F[I].name,parent:F[I].parentNodeRef,hasChildren:F[I].hasChildren})}catch(H){this.alfLog("log","alfresco_navigation_Tree__addTreeElements error",H)}this.alfLog("log","alfresco_navigation_Tree__addTreeElements",this.Store)},addNewNode:function e(F){this.alfLog("log","Tree loadDataList do",F);try{this.Store.add({id:F.id,name:F.name,parent:F.parent,hasChildren:false})}catch(G){this.alfLog("log","Tree loadDataList error",G)}},deleteNodeFromStore:function n(G){var F=this.tree.get("selectedItems")[0];this.Store.remove(F.id)},editNodeAttribute:function h(I){var G=this.tree.get("selectedItems")[0];var F=I.attribute.name;var H=I.attribute.value;G[F]=H;this.Store.put(G)},getIconClass:function(F,G){return((F.root||F.hasChildren)?(G?"dijitFolderOpened":"dijitFolderClosed"):"dijitLeaf")},onMouseDown:function(F){},})});