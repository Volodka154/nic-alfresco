define(["dojo/_base/declare","alfresco/forms/ControlColumn","dojo/_base/lang","dojo/request/xhr","btlExtension/windowChoiceItem/window_choice_item","dijit/Dialog","dojo/_base/array","btl/widgets/base/TextBox","btl/widgets/base/SearchBox","alfresco/forms/ControlRow","alfresco/lists/AlfList","alfresco/lists/views/AlfListView","alfresco/lists/views/layouts/Row","alfresco/lists/views/layouts/Cell","alfresco/renderers/PropertyLink","alfresco/buttons/AlfButton","alfresco/forms/controls/DojoValidationTextBox","alfresco/forms/controls/TextBox","btl/widgets/base/button/ChoiceButton","btl/widgets/base/button/DeleteButton"],function(f,c,b,e,i,j,h){return f([c],{value:null,item:null,name:"",single:true,placeHolder:"Поиск",header:"Выбрать",dataUrl:{},dataItemUrl:{},renderData:"result",propertyToRender:"name",search:true,widgets:[],oldValue:null,inputStyle:{width:"290px"},height:null,width:null,excluded:[],currentValues:null,publishTopic:null,title:"",labelText:"",labelButton:"...",requirementConfig:{initialValue:false},defaultValue:null,_isDefaultValue:false,loadData:false,cssRequirements:[{cssFile:"/share/res/extension/css/icon.css"}],postMixInProperties:function l(){this.id=this.generateUuid();this.inherited(arguments);this.alfSubscribe(this.id+"_BTL_CHOICE_OPEN_DIALOG",b.hitch(this,this.showChoiceDialog),true);this.alfSubscribe(this.id+"_BTL_BTN_CLEAN_VALUE",b.hitch(this,this.clickBtnCleanValue),true);this.alfSubscribe(this.id+"_BTL_CLICK_HINT",b.hitch(this,this.clickHint),true);this.alfSubscribe(this.id+"_BTL_CLEAN_ITEM",b.hitch(this,this.clickClearItem),true);if(this.single){this.width=(this.width)?this.width:"300";this.height=(this.height)?this.height:"22"}else{this.width=(this.width)?this.width:"300";this.height=(this.height)?this.height:"100"}},clickClearItem:function(q){q.nodeRef;var o=[];for(var p=0;p<this.widgetTextBox.currentData.items.length;p++){if(this.widgetTextBox.currentData.items[p].nodeRef!=q.nodeRef){o.push(this.widgetTextBox.currentData.items[p])}}this.widgetTextBox.onDataLoadSuccess({items:o});this.setDelValue(q.nodeRef);this.widgetTextBox_values.setValue(this.getResponseContentNames(this.widgetTextBox.currentData.items,"name"));this.currentValues=this.widgetTextBox_values.getValue();this.value=this.deleteValue(this.value,q.nodeRef);this.nodeRefTextBox.setValue(this.value)},deleteValue:function(q,o){var p=q;if(p.indexOf(o)>=0){p=p.replace(","+o,"");p=p.replace(o+",","");p=p.replace(o,"")}return p},setDelValue:function(q){var o=this.widgetTextBox_del.getValue();if(o.indexOf(q)<0){if(o.length>0){o+=","}o+=q}this.widgetTextBox_del.setValue(o);var p=this.widgetTextBox_add.getValue();this.widgetTextBox_add.setValue(this.deleteValue(p,q))},postCreate:function(){this.oldValue=this.value;if(!this.value&&this.defaultValue){this.value=this.defaultValue;this._isDefaultValue=true}var u=this;if(this.single){var o={name:"btl/widgets/base/SearchBox",widthPx:(this.width)?this.width:"300",id:this.id+"_val",config:{style:this.inputStyle,parentID:this.id,name:this.name+"_val",label:this.labelText,url:this.urlList,dataUrl:this.dataUrl,requirementConfig:this.requirementConfig}};var r={name:"btl/widgets/base/button/ChoiceButton",style:"margin-left: 0px; margin-right: 0px; margin-top: 23px; margin-left: -12px;",widthPx:"20",config:{onClick:function(){u.alfPublish(u.id+"_BTL_CHOICE_OPEN_DIALOG",{},true)}}}}else{var o={name:"alfresco/lists/AlfList",id:this.id+"_val",config:{noDataMessage:"",label:this.labelText,name:this.name+"_val",currentData:{items:[]},style:"width: "+this.width+"px; height:"+this.height+"px; border: 1px solid #d3d3d3; border-radius: 3px; overflow-y: auto; margin-bottom:10px;",widgets:[{name:"alfresco/lists/views/AlfListView",config:{widgets:[{name:"alfresco/lists/views/layouts/Row",config:{widgets:[{name:"alfresco/lists/views/layouts/Cell",config:{widgets:[{name:"alfresco/renderers/Property",config:{propertyToRender:"name"}},{name:"alfresco/renderers/PublishAction",config:{style:"float: right;",altText:"Удалить",iconClass:"delete-16",publishPayloadType:"PROCESS",publishPayloadModifiers:["processCurrentItemTokens"],publishTopic:this.id+"_BTL_CLEAN_ITEM",publishGlobal:true,publishPayload:{nodeRef:"{nodeRef}"},}}]}}]}}]}}]}};var s={name:"alfresco/forms/controls/TextBox",id:this.id+"_values",config:{name:this.name+"_values",visibilityConfig:{initialValue:false}}};var w={name:"alfresco/buttons/AlfButton",id:this.id+"_btn_clean_value",config:{title:"Удалить всех заместителей",label:"Очистить",style:"margin-bottom:10px;",publishGlobal:true,publishTopic:this.id+"_BTL_BTN_CLEAN_VALUE",visibilityConfig:{initialValue:false}}};var r={name:"alfresco/buttons/AlfButton",id:this.id+"_btn",config:{label:this.labelButton,style:"margin-bottom:10px;",publishGlobal:true,publishTopic:this.id+"_BTL_CHOICE_OPEN_DIALOG"}}}var q={name:"alfresco/forms/controls/TextBox",id:this.id+"_added",config:{name:this.name+"_added",visibilityConfig:{initialValue:false}}};var p={name:"alfresco/forms/controls/TextBox",id:this.id+"_removed",config:{name:this.name+"_removed",visibilityConfig:{initialValue:false}}};var v={name:"alfresco/forms/controls/DojoValidationTextBox",id:this.id+"_",config:{name:this.name,value:this.value,requirementConfig:this.requirementConfig,visibilityConfig:{initialValue:false}}};if(this.single){var w={name:"btl/widgets/base/button/DeleteButton",widthPx:"20",id:this.id+"_btn_clean_value",config:{onClick:function(){u.alfPublish(u.id+"_BTL_BTN_CLEAN_VALUE",{},true)}}};var x={name:"alfresco/forms/ControlRow",config:{style:"width:370px",widgetMarginRight:0,widgets:[o,r,w]}};this.widgets=[x,v,q,p]}else{this.widgets=[o,v,q,p,r,w,s]}this.inherited(arguments);if(this.single){this.row=this._processingWidgets[0];this.widgetTextBox=this.row._processingWidgets[0];this.btnCleanValue=this.row._processingWidgets[2];this.btnCleanValue.setDisabled((this.value)?false:true)}else{this.widgetTextBox=this._processingWidgets[0];this.widgetTextBox_values=this._processingWidgets[6]}this.nodeRefTextBox=this._processingWidgets[1];this.widgetTextBox_add=this._processingWidgets[2];this.widgetTextBox_del=this._processingWidgets[3];this.nodeRefTextBox.setValue(this.value);this.widgetTextBox_add.setValue((this._isDefaultValue)?this.value:"");this.widgetTextBox_del.setValue("");if(this.single){this.widgetTextBox.objNodeRefTextBox=this.nodeRefTextBox;this.widgetTextBox.objBtnCleanValue=this.btnCleanValue}this.choiceItem=new Alfresco.WindowChoiceItem(this.id).setOptions({header:this.header,search:this.search,single:this.single,url:this.urlList,renderData:this.renderData,renderName:this.propertyToRender,placeHolder:this.placeHolder,dataUrl:this.dataUrl,excluded:this.excluded,loadData:this.loadData,requirementConfig:this.requirementConfig});this.choiceItem.dialogCreate();this.choiceItem.setEvents();var u=this;this.choiceItem.onOk.subscribe(function t(){if(u.single){if(this.getValue()==null||u.value!=this.getValue().nodeRef){u.widgetTextBox.setValue((this.getValue()!=null)?this.getValue().name:"");u.nodeRefTextBox.setValue((this.getValue()!=null)?this.getValue().nodeRef:"");u.widgetTextBox_add.setValue((this.getValue()!=null)?this.getValue().nodeRef:"");u.widgetTextBox_del.setValue(u.value);u.value=(this.getValue()!=null)?this.getValue().nodeRef:"";if(this.getValue()==null){u.btnCleanValue.setDisabled(true);if(u.fieldId){u.alfPublish((u.publishTopic)?u.publishTopic:"_valueChangeOf_"+u.fieldId,{fieldId:u.fieldId,name:u.name,value:{}},(u.publishTopic)?true:false)}}else{u.btnCleanValue.setDisabled(false);if(u.fieldId){u.alfPublish((u.publishTopic)?u.publishTopic:"_valueChangeOf_"+u.fieldId,{fieldId:u.fieldId,name:u.name,value:this.getValue()},(u.publishTopic)?true:false)}}}}else{var y=(this.getValuesNodeRef()!=null)?this.getValuesNodeRef().join(","):"";u.widgetTextBox_add.setValue(y);u.nodeRefTextBox.setValue(y);u.widgetTextBox_del.setValue(u.cleanOldValue(y));u.widgetTextBox.onDataLoadSuccess(u.addManyValues(this.getValues()));u.currentValues=this.getValues();u.widgetTextBox_values.setValue((this.getValuesName()!=null)?this.getValuesName().join(","):"");if(u.fieldId){u.alfPublish((u.publishTopic)?u.publishTopic:"_valueChangeOf_"+u.fieldId,{fieldId:u.fieldId,name:u.name,value:this.getValues()},(u.publishTopic)?true:false)}}});this.Dialog=new j({content:document.getElementById(u.id+"-dlgWinChoice"),style:"width: 1000px; height: 600px"});this.setBaseValueXhr()},showChoiceDialog:function g(){if(this.disabled){return}if(this.single){if(this.widgetTextBox.getValue()&&this.value){this.choiceItem.setValue(this.nodeRefTextBox.getValue(),this.widgetTextBox.getValue())}else{this.widgetTextBox.setValue("")}}else{if(this.widgetTextBox.currentData.items.length>0){this.choiceItem.setValues(this.widgetTextBox.currentData.items)}else{this.choiceItem.values=[]}}this.choiceItem.dialog.show()},setBaseValueXhr:function n(){if(this.value){this.dataItemUrl.nodeRef=this.value;var o=this;dojo.xhrGet({url:this.itemUrl,content:this.dataItemUrl,handleAs:"json",load:function(p){o.setBaseValue(p)}})}},setBaseValue:function a(o){var p=this;if(this.single){this.widgetTextBox.setValue(o.item)}else{this.widgetTextBox.onDataLoadSuccess(this.addManyValues(o.items));this.choiceItem.setValues(o.items);this.widgetTextBox_values.setValue(this.getResponseContentNames(o.items,"name"))}},getResponseContentNames:function(q,o){var r="";for(var p=0;p<q.length;p++){if(r.length>0){r+=","}r+=q[p][o]}return r},addManyValues:function k(o){if(o!=null){var q=this;var p=[];o.forEach(function(r){p.push({name:r.name,nodeRef:r.nodeRef})});return{items:p}}return{items:[]}},cleanOldValue:function d(q){var o=[];if(!q||q.length==0){return(this.value)?this.value.split(","):[]}if(this.value){var p=this.value.split(",");if(p.length>0){p.forEach(function(r){if(q.indexOf(r)<0){o.push(r)}})}}return o},setValue:function(o){this.widgetTextBox.setValue((o)?o.name:"");this.nodeRefTextBox.setValue((o)?o.nodeRef:"");this.widgetTextBox_add.setValue((o)?o.nodeRef:"");if(this.value!=""){this.widgetTextBox_del.setValue(this.value)}this.value=(o)?o.nodeRef:"";if(this.value==""){this.btnCleanValue.setDisabled(true)}else{this.btnCleanValue.setDisabled(false)}if(this.fieldId){this.alfPublish((this.publishTopic)?this.publishTopic:"_valueChangeOf_"+this.fieldId,{fieldId:this.fieldId,name:this.name,value:o},(this.publishTopic)?true:false)}},clickHint:function(o){this.setValue(o)},setDefaultValue:function(o){this.value=o;this.nodeRefTextBox.setValue(this.value);this.widgetTextBox_add.setValue(this.value);this.setBaseValueXhr()},clickBtnCleanValue:function m(){if(this.single){this.widgetTextBox_del.setValue(this.nodeRefTextBox.getValue());this.widgetTextBox.setValue("");this.nodeRefTextBox.setValue("");this.widgetTextBox_add.setValue("");this.choiceItem.curItem={};this.choiceItem.value={};this.value="";this.btnCleanValue.setDisabled(true)}else{this.nodeRefTextBox.setValue("");this.widgetTextBox_add.setValue("");this.widgetTextBox_values.setValue("");var p=(this.oldValue)?this.oldValue.split(","):[];var q=(this.currentValues)?this.currentValues.split(","):[];var o=p.concat(q);this.widgetTextBox_del.setValue(o.join(","));this.currentValues=null;this.choiceItem.values={};this.choiceItem.curItems={};this.widgetTextBox.onDataLoadSuccess(this.addManyValues(null));this.value=""}if(this.fieldId){this.alfPublish((this.publishTopic)?this.publishTopic:"_valueChangeOf_"+this.fieldId,{fieldId:this.fieldId,name:this.name,value:{}},(this.publishTopic)?true:false)}},setVisible:function(o){this.domNode.style.display=(o)?"block":"none"},setDisable:function(o){this.disabled=o;this.btnCleanValue.setDisabled(o);this.widgetTextBox.textBox.setDisabled(true)}})});