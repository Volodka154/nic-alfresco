define(["dojo/_base/declare","btl/widgets/base/TextBox","dojo/text!./templates/SearchBox.html","dojo/on","dojo",],function(b,e,d,a,c){return b([e],{templateString:d,per_page:5,page_num:1,countSymbolBiforeHint:2,dataUrl:"",url:"",objNodeRefTextBox:null,objBtnCleanValue:null,style:{width:"290px"},postCreate:function(){this.inherited(arguments);this.inputField=this.domNode.querySelector('input[name="'+this.name+'"]');this.inputField.addEventListener("keydown",this.eventKeyDown.bind(this),true);this._listValue.addEventListener("mouseover",this.eventMouseOver.bind(this));var h=a(this.domNode,"input",this.eventInput.bind(this));var f=a(this.inputField,"blur",this.eventBlur.bind(this));var g=a(this._listValue,"mousedown",this.eventListValueClick.bind(this))},eventMouseOver:function(g){var h=g.target;if(!h.classList.contains("selected")){var f=this._listValue.querySelector(".selected");if(f){f.classList.remove("selected")}h.classList.add("selected")}},eventKeyDown:function(g){if(g.keyCode==40){var f=this.getSelectedHint();if(f){f.classList.remove("selected");if(f.nextElementSibling){f.nextElementSibling.classList.add("selected")}else{this._listValue.firstChild.classList.add("selected")}}else{if(this._listValue.firstChild){this._listValue.firstChild.classList.add("selected")}else{this.getHints("")}}g.preventDefault()}if(g.keyCode==38){var f=this.getSelectedHint();if(f){f.classList.remove("selected");if(f.previousElementSibling){f.previousElementSibling.classList.add("selected")}else{this._listValue.lastChild.classList.add("selected")}}else{this._listValue.lastChild.classList.add("selected")}g.preventDefault()}if(g.keyCode==13){var f=this.getSelectedHint();if(f){this.setValueSearchBox(f.getAttribute("name"),f.getAttribute("nodeRef"))}g.preventDefault()}},getSelectedHint:function(){var f=this._listValue.querySelector(".selected");if(f){return f}return null},eventFocus:function(){if(this._listValue.innerHTML!=""&&this.inputField.length>=this.countSymbolBiforeHint){this._listValue.style.display="block"}},eventBlur:function(f){if(!this.objNodeRefTextBox.getValue()){this.inputField.value="";this.objBtnCleanValue.setDisabled(true)}this._listValue.style.display="none"},eventInput:function(f){this._listValue.innerHTML="";this.objNodeRefTextBox.setValue("");if(f.target.value.length>=this.countSymbolBiforeHint){this.getHints(encodeURI(f.target.value))}},eventListValueClick:function(f){this.setValueSearchBox(f.target.getAttribute("name"),f.target.getAttribute("nodeRef"))},setValueSearchBox:function(f,g){this.alfPublish(this.parentID+"_BTL_CLICK_HINT",{name:f,nodeRef:g},true);this._listValue.innerHTML="";this._listValue.style.display="none"},getHints:function(g){var i=this;var h={url:this.url,handleAs:"json",content:{per_page:this.per_page,page_num:this.page_num,type:this.dataUrl.type,field:this.dataUrl.field,s_field:this.dataUrl.s_field,extra:this.dataUrl.extra,filter:this.dataUrl.filter,nodeRef:this.dataUrl.nodeRef,q_word:g},load:function(j){i.showHints(j.result)},error:function(j){}};if(!this.dataUrl.type||!this.dataUrl.field||!this.dataUrl.s_field){alert("Не верные параметры поика")}else{var f=c.xhrGet(h)}},showHints:function(g){this.cleanList();var f=this._listValue;f.style.display="block";g.forEach(function(i){var h=f.appendChild(document.createElement("li"));h.setAttribute("nodeRef",i.nodeRef);h.setAttribute("name",i.name);h.setAttribute("title",i.name);h.innerHTML=i.name})},cleanList:function(){this._listValue.innerHTML=""}})});