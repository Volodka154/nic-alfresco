(function(){var b=YAHOO.util.Dom,u=YAHOO.util.Event;Alfresco.CheckListDeadlines=function p(v){this.name="Alfresco.CheckListDeadlines";this.id=v;this.eventSetValue=new YAHOO.util.CustomEvent("setValue",this);this.eventLoadSuccess=new YAHOO.util.CustomEvent("loadSuccess",this);return this};Alfresco.CheckListDeadlines.prototype={options:{url:"/share/proxy/alfresco/search/periodOfExecution",dataUrl:{type:"0"},renderData:"items",renderName:"name",iconCheck:""},tableMainBody:null,endDate:null,value:{},eventSetValue:null,eventLoadSuccess:null,waitForAndDo:function n(w,x,y,v){function A(C){return C&&{}.toString.call(C)==="[object Function]"}function z(){function D(){var F=true;for(var E=0;E<w.length;E++){if($("#"+w[E]).length==0){F=false;break}}return F}var C=A(w)?w:D;return setInterval(function(){if(C()){var E="";for(var F=0;F<w.length;F++){E+=w[F]+", "}x.call(v);clearInterval(B)}},100)}var B=z();setTimeout(function(){clearInterval(B)},y?y:10000)},waitReadyAndDo:function f(){this.value={};this.waitForAndDo([this.id],this.onReady,null,this);return this},setOptions:function h(v){if("dataUrl" in v){this.options.dataUrl=YAHOO.lang.merge(this.options.dataUrl,v.dataUrl);delete v.dataUrl}return this},init:function m(){Alfresco.constants.MM=new Alfresco.DatePicker(this.id+"-endTime",this.id+"-value").setOptions({currentValue:"",showTime:false,submitTime:false,mandatory:false,minToday:true}).setMessages({"form.control.date-picker.choose":"Дата завершения:","form.control.date-picker.entry.date.format":"dd.MM.yyyy"})},getCurrentEndDateValue:function c(){return document.getElementById(this.id+"-value").innerHTML},setCurrentEndDateValue:function r(v){document.getElementById(this.id+"-value").value=this.formatDate(v);document.getElementById(this.id+"-endTime-date").value=v},onReady:function o(){this.formCreate();this.loadData();this.init()},getCheckedNodeRefs:function t(){var v=[];var x=this.tableMainBody.querySelectorAll(".checked");for(var w=0;w<x.length;w++){v.push(x[w].cells[2].innerHTML)}return v},calculateDate:function q(C,I,F){var z="";var x="";if(C==1){var D=new Date();var G=(D.getDate().toString().length==1)?"0"+D.getDate():D.getDate();var H=((D.getMonth()+1).toString().length==1)?"0"+(D.getMonth()+1):(D.getMonth()+1);var y=D.getFullYear();D.setDate(D.getDate()+Number(I));var E=(D.getDate().toString().length==1)?"0"+D.getDate():D.getDate();var A=((D.getMonth()+1).toString().length==1)?"0"+(D.getMonth()+1):(D.getMonth()+1);var w=D.getFullYear();var v="/share/proxy/alfresco/utils/get-workschedule-duration?dateFormat=dd.MM.yyyy&fromDate="+G+"."+H+"."+y+"&toDate="+E+"."+A+"."+w;var B=new XMLHttpRequest();B.open("GET",v,false);B.send(null);datetext=B.responseText.substring(9);z=datetext;x=E+"."+A+"."+w}else{if(I){z=I;var D=new Date();var G=D.getDate();var H=D.getMonth()+1;var y=D.getFullYear();var v="/share/proxy/alfresco/utils/get-workschedule-completion-date?dateFormat=yyyy-MM-dd&fromDate="+y+"-"+H+"-"+G+"&duration="+I;var B=new XMLHttpRequest();B.open("GET",v,false);B.send(null);datetext=B.responseText.substring(9,19);x=datetext.substring(8,10)+"."+datetext.substring(5,7)+"."+datetext.substring(0,4)}else{x="";z=""}}this.setValue(F,x,z)},setValue:function i(w,v,x){if(!this.isEmpty(this.value)){if(Number(this.value.duration)==0||(Number(x)>0&&Number(this.value.duration)>Number(x))){this.value.duration=x;this.value.date=v;this.value.nodeRef=w;this.eventSetValue.fire()}}else{this.value.duration=x;this.value.date=v;this.value.nodeRef=w;this.eventSetValue.fire()}},getValue:function e(){return(!this.isEmpty(this.value))?{duration:this.value.duration,date:this.formatDate(this.value.date),nodeRef:this.value.nodeRef}:null},formatDate:function j(w){if(w){var v=w.split(".");w=v[2]+"-"+v[1]+"-"+v[0]}return w},formCreate:function o(){var A=document.getElementById(this.id);var w=document.createElement("table");w.width="100%";w.style.cursor="default";var y=document.createElement("thead");var F=y.insertRow(-1);var z=F.insertCell(0);z.style="width:5px;";var x=F.insertCell(1);x.innerHTML="Срок исполнения";var D=F.insertCell(2);b.setStyle(D,"display","none");b.setStyle(D,"width","1px");var E=F.insertCell(3);b.setStyle(E,"display","none");b.setStyle(E,"width","1px");var B=F.insertCell(4);b.setStyle(B,"display","none");b.setStyle(B,"width","1px");var C=F.insertCell(5);b.setStyle(C,"display","none");b.setStyle(C,"width","1px");var v=document.createElement("tbody");y.setAttribute("onselectstart","return false");y.setAttribute("onmousedown","return false");this.tableMainBody=v;w.appendChild(v);A.insertBefore(w,A.firstChild)},loadData:function g(){function v(z){var A=document.createElement("div");A.innerHTML=z.trim();return A.firstChild}var x=function y(C){var B=C.json[this.options.renderData];var z=document.getElementById(this.id);if(B.length>0){var F=v("<span><b>Сроки<b></b></b></span>");z.insertBefore(F,z.firstChild)}else{z.parentElement.style.display="none"}var E;for(var D=0,A=B.length;D<A;D++){E=B[D];this.createItemCheck(E.nodeRef,E[this.options.renderName],E.time,E.dayType)}this.eventLoadSuccess.fire()};var w={url:this.options.url,dataObj:this.options.dataUrl,successCallback:{fn:x,scope:this}};Alfresco.util.Ajax.request(w)},createItemCheck:function s(F,E,w,z){var H=this.tableMainBody.insertRow(-1);H.id=F;var x=H.insertCell(0);b.setStyle(x,"width","15px");var v=H.insertCell(1);v.innerHTML=E;var C=H.insertCell(2);b.setStyle(C,"display","none");b.setStyle(C,"width","1px");C.innerHTML=F;var B=H.insertCell(3);b.setStyle(B,"display","none");b.setStyle(B,"width","1px");B.innerHTML=w;var y=H.insertCell(4);b.setStyle(y,"display","none");b.setStyle(y,"width","1px");y.innerHTML=z;var G=function D(J){if(b.hasClass(H,"checked")){b.removeClass(H,"checked");b.removeClass(H.cells[0],"icon-check-list");var I=this.getChecked();if(I.length>0){I.sort(this.compareDuration);this.value={};this.calculateDate(I[0].dayType,I[0].duration,I[0].nodeRef)}else{this.value={};this.eventSetValue.fire()}}else{b.addClass(H,"checked");b.addClass(H.cells[0],"icon-check-list");this.calculateDate(z,w,F)}};var A=u.addListener(H,"click",G,this,true)},isEmpty:function d(v){return Object.keys(v).length===0},compareDuration:function a(w,v){if(w.duration==""){return true}if(v.duration==""){return false}return w.duration-v.duration},getChecked:function k(){var v=[];var x=this.tableMainBody.querySelectorAll(".checked");for(var w=0;w<x.length;w++){v.push({nodeRef:x[w].cells[2].innerHTML,dayType:x[w].cells[4].innerHTML,duration:x[w].cells[3].innerHTML})}return v.sort(this.compareDuration)},clean:function l(){var w=this.tableMainBody.querySelectorAll(".checked");for(var v=0;v<w.length;v++){b.removeClass(w[v],"checked");b.removeClass(w[v].cells[0],"icon-check-list");this.value={};this.eventSetValue.fire()}},preSets:function(v){var w=this;if(v&&v.length>0){v.forEach(function(x){var y=document.getElementById(x);b.addClass(y,"checked");b.addClass(y.cells[0],"icon-check-list");w.calculateDate(y.cells[4].textContent,y.cells[3].textContent,x)})}}}})();