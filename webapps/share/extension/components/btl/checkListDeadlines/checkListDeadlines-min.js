(function(){var b=YAHOO.util.Dom,s=YAHOO.util.Event;Alfresco.CheckListDeadlines=function n(t){Alfresco.CheckListDeadlines.superclass.constructor.call(this,"Alfresco.CheckListDeadlines",t,[]);this.eventSetValue=new YAHOO.util.CustomEvent("setValue",this);this.eventLoadSuccess=new YAHOO.util.CustomEvent("loadSuccess",this);return this};YAHOO.extend(Alfresco.CheckListDeadlines,Alfresco.component.Base,{options:{url:"/share/proxy/alfresco/search/periodOfExecution",dataUrl:{type:"0"},renderData:"items",renderName:"name",iconCheck:""},tableMainBody:null,endDate:null,value:{},eventSetValue:null,eventLoadSuccess:null,setOptions:function g(t){if("dataUrl" in t){this.options.dataUrl=YAHOO.lang.merge(this.options.dataUrl,t.dataUrl);delete t.dataUrl}Alfresco.CheckListDeadlines.superclass.setOptions.call(this,t);return this},init:function l(){Alfresco.constants.MM=new Alfresco.DatePicker(this.id+"-endTime",this.id+"-value").setOptions({currentValue:"",showTime:false,submitTime:false,mandatory:false,minToday:true}).setMessages({"form.control.date-picker.choose":"Дата завершения:","form.control.date-picker.entry.date.format":"dd.MM.yyyy"})},getCurrentEndDateValue:function c(){return document.getElementById(this.id+"-value").innerHTML},setCurrentEndDateValue:function p(t){document.getElementById(this.id+"-value").value=this.formatDate(t);document.getElementById(this.id+"-endTime-date").value=t},onReady:function m(){this.formCreate();this.loadData();this.init()},getCheckedNodeRefs:function r(){var t=[];var v=this.tableMainBody.querySelectorAll(".checked");for(var u=0;u<v.length;u++){t.push(v[u].cells[2].innerHTML)}return t},calculateDate:function o(A,G,D){var x="";var v="";if(A==1){var B=new Date();var E=(B.getDate().toString().length==1)?"0"+B.getDate():B.getDate();var F=((B.getMonth()+1).toString().length==1)?"0"+(B.getMonth()+1):(B.getMonth()+1);var w=B.getFullYear();B.setDate(B.getDate()+Number(G));var C=(B.getDate().toString().length==1)?"0"+B.getDate():B.getDate();var y=((B.getMonth()+1).toString().length==1)?"0"+(B.getMonth()+1):(B.getMonth()+1);var u=B.getFullYear();var t="/share/proxy/alfresco/utils/get-workschedule-duration?dateFormat=dd.MM.yyyy&fromDate="+E+"."+F+"."+w+"&toDate="+C+"."+y+"."+u;var z=new XMLHttpRequest();z.open("GET",t,false);z.send(null);datetext=z.responseText.substring(9);x=datetext;v=C+"."+y+"."+u}else{if(G){x=G;var B=new Date();var E=B.getDate();var F=B.getMonth()+1;var w=B.getFullYear();var t="/share/proxy/alfresco/utils/get-workschedule-completion-date?dateFormat=yyyy-MM-dd&fromDate="+w+"-"+F+"-"+E+"&duration="+G;var z=new XMLHttpRequest();z.open("GET",t,false);z.send(null);datetext=z.responseText.substring(9,19);v=datetext.substring(8,10)+"."+datetext.substring(5,7)+"."+datetext.substring(0,4)}else{v="";x=""}}this.setValue(D,v,x)},setValue:function h(u,t,v){if(!this.isEmpty(this.value)){if(Number(this.value.duration)==0||(Number(v)>0&&Number(this.value.duration)>Number(v))){this.value.duration=v;this.value.date=t;this.value.nodeRef=u;this.eventSetValue.fire()}}else{this.value.duration=v;this.value.date=t;this.value.nodeRef=u;this.eventSetValue.fire()}},getValue:function e(){return(!this.isEmpty(this.value))?{duration:this.value.duration,date:this.formatDate(this.value.date),nodeRef:this.value.nodeRef}:null},formatDate:function i(u){if(u){var t=u.split(".");u=t[2]+"-"+t[1]+"-"+t[0]}return u},formCreate:function m(){var y=document.getElementById(this.id);var u=document.createElement("table");u.width="100%";u.style.cursor="default";var w=document.createElement("thead");var D=w.insertRow(-1);var x=D.insertCell(0);x.style="width:5px;";var v=D.insertCell(1);v.innerHTML="Срок исполнения";var B=D.insertCell(2);b.setStyle(B,"display","none");b.setStyle(B,"width","1px");var C=D.insertCell(3);b.setStyle(C,"display","none");b.setStyle(C,"width","1px");var z=D.insertCell(4);b.setStyle(z,"display","none");b.setStyle(z,"width","1px");var A=D.insertCell(5);b.setStyle(A,"display","none");b.setStyle(A,"width","1px");var t=document.createElement("tbody");w.setAttribute("onselectstart","return false");w.setAttribute("onmousedown","return false");this.tableMainBody=t;u.appendChild(t);y.insertBefore(u,y.firstChild)},loadData:function f(){var u=function v(y){var x=y.json[this.options.renderData],A;for(var z=0,w=x.length;z<w;z++){A=x[z];this.createItemCheck(A.nodeRef,A[this.options.renderName],A.time,A.dayType)}this.eventLoadSuccess.fire()};var t={url:this.options.url,dataObj:this.options.dataUrl,successCallback:{fn:u,scope:this}};Alfresco.util.Ajax.request(t)},createItemCheck:function q(D,C,u,x){var F=this.tableMainBody.insertRow(-1);F.id=D;var v=F.insertCell(0);b.setStyle(v,"width","15px");var t=F.insertCell(1);t.innerHTML=C;var A=F.insertCell(2);b.setStyle(A,"display","none");b.setStyle(A,"width","1px");A.innerHTML=D;var z=F.insertCell(3);b.setStyle(z,"display","none");b.setStyle(z,"width","1px");z.innerHTML=u;var w=F.insertCell(4);b.setStyle(w,"display","none");b.setStyle(w,"width","1px");w.innerHTML=x;var E=function B(H){if(b.hasClass(F,"checked")){b.removeClass(F,"checked");b.removeClass(F.cells[0],"icon-check-list");var G=this.getChecked();if(G.length>0){G.sort(this.compareDuration);this.value={};this.calculateDate(G[0].dayType,G[0].duration,G[0].nodeRef)}else{this.value={};this.eventSetValue.fire()}}else{b.addClass(F,"checked");b.addClass(F.cells[0],"icon-check-list");this.calculateDate(x,u,D)}};var y=s.addListener(F,"click",E,this,true)},isEmpty:function d(t){return Object.keys(t).length===0},compareDuration:function a(u,t){if(u.duration==""){return true}if(t.duration==""){return false}return u.duration-t.duration},getChecked:function j(){var t=[];var v=this.tableMainBody.querySelectorAll(".checked");for(var u=0;u<v.length;u++){t.push({nodeRef:v[u].cells[2].innerHTML,dayType:v[u].cells[4].innerHTML,duration:v[u].cells[3].innerHTML})}return t.sort(this.compareDuration)},clean:function k(){var u=this.tableMainBody.querySelectorAll(".checked");for(var t=0;t<u.length;t++){b.removeClass(u[t],"checked");b.removeClass(u[t].cells[0],"icon-check-list");this.value={};this.eventSetValue.fire()}},preSets:function(t){var u=this;if(t&&t.length>0){t.forEach(function(v){var w=document.getElementById(v);b.addClass(w,"checked");b.addClass(w.cells[0],"icon-check-list");u.calculateDate(w.cells[4].textContent,w.cells[3].textContent,v)})}}})})();