var windowSettingTasksAndDocs;require(["jquery","jqueryui","dojo/domReady!"],function(e){var u=document.createElement("div");var m=[];var v="windowSettingTasksAndDocs-dlgSetting";var a=new Event("moveEl");var n=null;var r=e(document).width();var c=e(document).height();var x=600;var q=new YAHOO.widget.SimpleDialog(v,{width:x+"px",fixedcenter:false,x:r/2-x/2,y:150,modal:true,visible:false,draggable:true});var h=function(z,y){try{if(n){s()}}catch(z){}sessionStorage.removeItem("menuTasksAndDocsItem");q.hide()};var j=function(z,y){this.hide();n=null};var w=[{text:"Да",handler:h},{text:"Нет",handler:j,isDefault:true}];q.cfg.queueProperty("buttons",w);q.setHeader('Настройки дашлета "Мои задачи и документы"');q.setBody("Загрузка конфигурации...");q.render(document.body);q.cancelEvent.subscribe(function(){});var p=this;q.showEvent.subscribe(function(){i()});windowSettingTasksAndDocs=q;function i(){var y=new XMLHttpRequest();y.open("GET","/share/proxy/alfresco/user-setting",true);y.send();y.onreadystatechange=function(){if(y.readyState!=4){return}switch(Number(y.status)){case 200:try{var z=JSON.parse(y.responseText)}catch(A){alert("Некорректный ответ "+A.message)}m=[];o(z);break;case 0:break;default:alert(y.status+": "+y.statusText);break}}}function o(B){q.setBody("");u.innerHTML="";n=JSON.parse(B.setting);for(menu in n){var I=document.createElement("div");I.setAttribute("name",n[menu].id);I.classList.add("sortable-task-and-docs");var O=document.createElement("div");O.classList.add("sortable-task-and-docs-head");var E=document.createElement("span");var N=document.createElement("span");E.textContent=n[menu].name;N.textContent="Отображаемое название";O.appendChild(E);O.appendChild(N);I.appendChild(O);if(n[menu].submenu.main){var D=n[menu].submenu.main;var J=document.createElement("ul");J.setAttribute("name",D.id);m.push(D.id);if(D.value.length>1){D.value.sort(sortByPosition)}for(item in D.value){var M=document.createElement("li");var z=document.createElement("div");z.classList.add("item-block");M.setAttribute("name",D.value[item].id);z.textContent=D.value[item].name;M.classList.add("sortable-task-and-docs-item");var A=document.createElement("span");A.setAttribute("name","isVisible");var L=document.createElement("span");L.setAttribute("name","isMain");var G=document.createElement("input");G.setAttribute("name","aliasName");G.classList.add("item-input");if(D.value[item].aliasName){G.value=D.value[item].aliasName}if(D.value[item].visible){A.classList.add("icon-visible","btl-icon-16")}else{A.classList.add("icon-not-visible","btl-icon-16")}if(D.value[item].isMain){L.classList.add("icon-on-check","btl-icon-16")}else{L.classList.add("icon-off-check","btl-icon-16")}A.addEventListener("click",g.bind(this,D.value[item]));L.addEventListener("click",d.bind(this,D.value[item]));G.addEventListener("change",l.bind(this,D.value[item]));M.addEventListener("moveEl",b.bind(this,D.value[item]));z.appendChild(L);z.appendChild(A);M.appendChild(z);M.appendChild(G);J.appendChild(M)}I.appendChild(J)}for(submenu in n[menu].submenu){if(submenu=="main"){continue}var K=n[menu].submenu[submenu];var H=document.createElement("ul");H.setAttribute("name",K.id);m.push(K.id);var y=document.createElement("div");y.classList.add("sortable-task-and-docs-head-submenu");var C=document.createElement("h4");C.textContent=K.name;y.appendChild(C);if(K.value.length>1){K.value.sort(sortByPosition)}for(item in K.value){var M=document.createElement("li");var z=document.createElement("div");z.classList.add("item-block");M.setAttribute("name",K.value[item].id);z.textContent=K.value[item].name;M.classList.add("sortable-task-and-docs-item");var A=document.createElement("span");A.setAttribute("name","isVisible");var L=document.createElement("span");L.setAttribute("name","isMain");var G=document.createElement("input");G.setAttribute("name","aliasName");G.classList.add("item-input");if(K.value[item].aliasName){G.value=K.value[item].aliasName}if(K.value[item].visible){A.classList.add("icon-visible","btl-icon-16")}else{A.classList.add("icon-not-visible","btl-icon-16")}if(K.value[item].isMain){L.classList.add("icon-on-check","btl-icon-16")}else{L.classList.add("icon-off-check","btl-icon-16")}A.addEventListener("click",g.bind(this,K.value[item]));L.addEventListener("click",d.bind(this,K.value[item]));G.addEventListener("change",l.bind(this,D.value[item]));M.addEventListener("moveEl",b.bind(this,K.value[item]));z.appendChild(L);z.appendChild(A);M.appendChild(z);M.appendChild(G);H.appendChild(M)}I.appendChild(y);I.appendChild(H)}u.appendChild(I)}var F=document.createElement("div");F.style="clear: both;";u.appendChild(F);q.setBody(u);f()}function f(){m.forEach(function(z){var y=e("#"+v+" ul[name='"+z+"']");y.sortable({cursor:"move",stop:function(D,E){var C=E.item[0].parentNode.children;for(var B=0,A=C.length;B<A;B++){C[B].dispatchEvent(a)}}});y.disableSelection()})}function g(z,y){if(y.currentTarget.parentNode.children.isMain.classList.contains("icon-off-check")){y.currentTarget.classList.toggle("icon-visible");y.currentTarget.classList.toggle("icon-not-visible");(z.visible)?z.visible=false:z.visible=true}}function l(z,y){z.aliasName=y.target.value}function d(z,y){if(y.currentTarget.parentNode.children.isVisible.classList.contains("icon-not-visible")){e(y.currentTarget.parentNode.children.isVisible).trigger("click")}e("#"+v+" span.icon-on-check").removeClass(["icon-on-check"]).addClass("icon-off-check");y.currentTarget.classList.remove("icon-off-check");y.currentTarget.classList.add("icon-on-check");k();z.isMain=true}function k(){if(n){for(menu in n){for(submenu in n[menu].submenu){var y=n[menu].submenu[submenu];for(var z=0;y.value[z];z++){if(y.value[z].isMain){delete y.value[z].isMain}}}}}}function t(z){var y=z.parentNode;if(z.nodeName.toLowerCase()=="li"&&y.nodeName.toLowerCase()=="ul"){for(var A=0,z=z.previousSibling;z&&z!=y;){z.nodeName.toLowerCase()=="li"&&A++,z=z.previousSibling}return A+1}}function b(A,z){var y=t(z.currentTarget);A.position=y}function s(){var y=JSON.stringify(n);Alfresco.util.Ajax.jsonPost({method:"POST",url:"/share/proxy/alfresco/set-user-setting",dataObj:{config:y},successCallback:{fn:callback,scope:this}})}});function callback(a){location.reload();require(["dojo/topic"],function(b){b.publish("ALF_DISPLAY_NOTIFICATION",{message:"Применение настроек."})})}function sortByPosition(d,c){return d.position-c.position};