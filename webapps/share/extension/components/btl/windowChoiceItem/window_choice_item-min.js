(function(){var d=YAHOO.util.Dom,G=YAHOO.util.Event;var y=/^([a-zа-яё0-9/ //\//\.\/\\/-]+)$/i;Alfresco.WindowChoiceItem=function n(I){Alfresco.WindowChoiceItem.superclass.constructor.call(this,"Alfresco.WindowChoiceItem",I,[]);this.onOk=new YAHOO.util.CustomEvent("ok",this);this.selectedItems=null;this.dialog=null;return this};YAHOO.extend(Alfresco.WindowChoiceItem,Alfresco.component.Base,{options:{dataUrl:{page_num:0,per_page:20,q_word:"",type:"cm:content",extra:"",data:"",field:"name",s_field:"name",classes:""},currentValue:"",url:"/share/proxy/alfresco/filters/association",header:"",waitHeader:"Загрузка...",emptyMessage:"Нет данных для отображения",blockMessage:"*Для поиска введите значение и нажмите Enter",renderName:"name",renderData:"result",placeHolder:"Поиск",renderTotalRecords:"cnt_whole",excluded:[],search:true,single:true,loadData:false},selectedItems:null,dialog:null,mainDiv:null,iconPlus:'<img  src="/share/res/components/form/images/plus-16.png" title="Добавить" tabindex="0">',iconDelete:'<img  src="/share/res/components/form/images/remove-icon-16.png" title="Удалить" tabindex="0">',curItem:{},value:null,values:{},input:null,errorMsgInput:null,tBodyLeft:null,tBodyRight:null,leftDiv:null,loadingDiv:null,loadedItems:0,totalItems:0,onOk:null,oldValue:{},curItems:{},focused:null,Ajax:null,btnCancelLoad:null,specSymbolMas:["!","+","=","_","*","(",")","&","@","#","$","%","^",'"',"№","?",":",">","<",",",";","|","`","~","'","[","]"],setOptions:function o(I){if("dataUrl" in I){this.options.dataUrl=YAHOO.lang.merge(this.options.dataUrl,I.dataUrl);delete I.dataUrl}Alfresco.WindowChoiceItem.superclass.setOptions.call(this,I);if(this.widgets.dialog){this.widgets.dialog.setHeader(this.options.header);this.widgets.dialog.setBody(this.formDialog());this.widgets.dialog.render(document.body);this.setEvents()}return this},onReady:function D(){this.dialogCreate();this.setEvents()},scrollEvent:function B(){var I=this;G.on(this.leftDiv,"scroll",function(K,J){if(parseInt(I.leftDiv.scrollHeight)-parseInt(I.leftDiv.scrollTop)===parseInt(I.leftDiv.clientHeight)){I.getPageData()}},this,true)},inputEvent:function H(){},onClickButtonCancelLoad:function l(){var I=this;G.on(this.btnCancelLoad,"click",function(K,J){I.Ajax.abort()})},onkeypressInputEvent:function x(){var I=this;function J(K){if(K.which==null){if(K.keyCode<32){return null}return String.fromCharCode(K.keyCode)}if(K.which!=0&&K.charCode!=0){if(K.which<32){return null}return String.fromCharCode(K.which)}return null}this.input.onkeypress=function(L){L=L||event;if(L.keyCode==13){if(I.input.value.length==0||y.test(I.input.value)){I.errorMsgInput.classList.add("displayNone");I.options.dataUrl.q_word=encodeURI(I.input.value);I.cleanData();I.getPageData()}else{I.errorMsgInput.classList.remove("displayNone")}return}if(L.ctrlKey||L.altKey||L.metaKey){return}var K=J(L);if(K==null||I.specSymbolMas.indexOf(K)>-1){return false}}},setEvents:function k(){this.inputEvent();this.scrollEvent();this.onkeypressInputEvent();this.onClickButtonCancelLoad()},dialogCreate:function k(){this.widgets.dialog=new YAHOO.widget.SimpleDialog(this.id+"-dlgWinChoice",{width:"1000px",fixedcenter:true,modal:true,visible:false,draggable:false});var L=function(M){if(this.callback.argument.curItem!=null&&!this.callback.argument.isEmpty(this.callback.argument.curItem)){this.callback.argument.value={nodeRef:this.callback.argument.curItem.item.id,name:this.callback.argument.curItem.item.innerText.replace(/(^\s+|\s+$)/g,"")}}this.callback.argument.pressOk();this.hide()};var J=function(N,M){this.callback.argument.cleanData();this.callback.argument.curItem={};this.callback.argument.curItems={};this.callback.argument.input.value="";this.callback.argument.tBodyRight.innerHTML="";this.callback.argument.options.dataUrl.q_word="";this.hide()};var K=[{text:"Да",handler:L},{text:"Нет",handler:J,isDefault:true}];this.widgets.dialog.cfg.queueProperty("buttons",K);this.widgets.dialog.setHeader(this.options.header);this.widgets.dialog.setBody(this.formDialog());this.widgets.dialog.render(document.body);this.widgets.dialog.callback.argument=this;this.widgets.dialog.cancelEvent.subscribe(function(){this.callback.argument.widgets.dialog.hide();this.callback.argument.cleanData();this.callback.argument.curItem={};this.callback.argument.curItems={};this.callback.argument.input.value="";this.callback.argument.options.dataUrl.q_word="";this.callback.argument.tBodyRight.innerHTML=""});this.widgets.dialog.showEvent.subscribe(function I(){this.callback.argument.cleanData();this.callback.argument.curItem={};this.callback.argument.curItems={};this.callback.argument.options.dataUrl.q_word="";this.callback.argument.tBodyRight.innerHTML="";this.callback.argument.renderCurrentValue();if(this.callback.argument.options.loadData){this.callback.argument.getPageData()}});this.dialog=this.widgets.dialog;d.addClass(this.dialog.element,"dijitPopup");this.message=new YAHOO.widget.Panel(this.id+"message",{width:"100px",fixedcenter:true,close:true,draggable:false,zindex:999,modal:true,visible:false});this.message.setHeader("");this.message.setBody("");this.message.render(document.body)},formDialog:function F(){var K=document.createElement("div");K.id="window-choice-item";var J=document.createElement("div");J.className="loading";var Q=document.createElement("img");Q.setAttribute("src","/share/res/js/lib/loading/loading.gif");Q.setAttribute("style","position: absolute; left: 17%; top: 45%;");J.appendChild(Q);var N=document.createElement("button");N.textContent="Отменить";N.setAttribute("style","width: 100px;");N.className="closeLoad";this.btnCancelLoad=N;J.appendChild(N);var V=document.createElement("div");V.className="topDiv";var O=document.createElement("span");var U=document.createElement("input");U.setAttribute("placeholder",this.options.placeHolder);var W=document.createElement("div");W.className="errorMsgBlock";var M=document.createElement("span");M.innerHTML='<i style="color:red;">Введены недопустимые символы</i>';M.className="displayNone";this.errorMsgInput=M;W.appendChild(M);var P=document.createElement("div");P.className="msgBlock";P.innerHTML='<i style="color:blue;">'+this.options.blockMessage+"</i>";V.appendChild(P);V.appendChild(U);V.appendChild(W);V.appendChild(O);this.input=U;if(!this.options.search){V.className="displayNone"}var I=document.createElement("div");I.className="bottomDiv";K.appendChild(V);K.appendChild(I);K.appendChild(J);var R=document.createElement("div");R.className="bottomLeftDiv";var T=document.createElement("div");T.className="bottomRightDiv";I.appendChild(R);I.appendChild(T);var Y=document.createElement("table");var S=document.createElement("table");Y.className="table";S.className="table";R.appendChild(Y);T.appendChild(S);var X=document.createElement("tbody");var L=document.createElement("tbody");Y.appendChild(X);S.appendChild(L);this.loadingDiv=J;this.tBodyLeft=X;this.tBodyRight=L;this.leftDiv=R;this.mainDiv=K;return K},getPageData:function p(){this.options.dataUrl.page_num++;function I(Q){var P=Q[this.options.renderData],S;this.loadedItems+=(P)?P.length:0;this.totalItems=Q[this.options.renderTotalRecords];for(var R=0,O=P.length;R<O;R++){S=P[R];if(this.inArray(S.nodeRef,this.options.excluded)){continue}if(!this.isEmpty(this.curItem)&&S.nodeRef==this.curItem.item.id){continue}if(S.nodeRef in this.curItems){continue}this.createPicker(S.nodeRef,S[this.options.renderName],S.data,this.tBodyLeft,this.iconPlus,"plus")}this.loadMore();if(this.tBodyLeft.childElementCount===0){this.tBodyLeft.innerHTML=this.options.emptyMessage}this.hideLoading();if(this.options.search){if(this.focused){this.focused.focus()}}}var K=function J(O){this.hideLoading();this.message.setHeader("Ошибка");this.message.setBody(O.json.message);this.message.show()};if(this.options.search){this.focused=document.querySelector("input:focus")}if(this.Ajax==null){var L="?";for(key in this.options.dataUrl){L+=(encodeURIComponent(this.options.dataUrl[key]))?(encodeURIComponent(key)+"="+encodeURIComponent(this.options.dataUrl[key])+"&"):""}var M=new XMLHttpRequest();M.open("GET",this.options.url+L,true);M.send(L);this.showLoading();var N=this;this.Ajax=M;M.onreadystatechange=function(){if(M.readyState!=4){return}switch(Number(M.status)){case 200:try{var O=JSON.parse(M.responseText);I.call(N,O);N.hideLoading();N.Ajax=null}catch(P){N.hideLoading();N.Ajax=null;alert("Некорректный ответ "+P.message)}break;case 0:N.hideLoading();N.Ajax=null;break;default:N.hideLoading();N.Ajax=null;alert(M.status+": "+M.statusText);break}}}},createPicker:function C(J,K,M,L,R,N){var U=document.createElement("tr");U.className="row";U.id=J;U.itemData=M;U.className=N;L.appendChild(U);var I=document.createElement("td");I.innerHTML='<div class="winChoiceItem">'+K+"</div>";U.appendChild(I);var T=document.createElement("td");U.appendChild(T);var P=document.createElement("span");P.innerHTML=R;P.id=this.id+"_"+J+"-icon";T.appendChild(P);var S=function Q(V){this.clickPicker(V,{item:U,tdIcon:P})};var O=YAHOO.util.Event.addListener(P.id,"click",S,this,true);return{item:U,tdIcon:P}},plusClick:function t(J,I){I.innerHTML=this.iconDelete;this.tBodyRight.appendChild(J);YAHOO.util.Dom.removeClass(J,"plus");if(!this.isEmpty(this.curItem)){this.deleteClick(this.curItem.item,this.curItem.tdIcon)}if(this.options.single){this.setCurrentItem(J,I)}else{this.curItems[J.id]={item:J,tdIcon:I}}},deleteClick:function q(J,I){if(this.tBodyLeft.childElementCount===0){this.tBodyLeft.innerHTML=""}I.innerHTML=this.iconPlus;YAHOO.util.Dom.addClass(J,"plus");this.tBodyLeft.appendChild(J);if(this.options.single){this.curItem={};this.value={}}else{delete this.curItems[J.id]}if(this.input.value){this.cleanData();this.getPageData()}},clickPicker:function q(J,I){if(YAHOO.util.Dom.hasClass(I.item,"plus")){this.plusClick(I.item,I.tdIcon)}else{this.deleteClick(I.item,I.tdIcon)}},cleanData:function z(J,I){this.tBodyLeft.innerHTML="";this.options.dataUrl.page_num=0;this.loadedItems=0;this.totalItems=0},loadMore:function E(){if(this.loadedItems<this.totalItems){if(this.leftDiv.scrollHeight===this.leftDiv.clientHeight){this.getPageData()}}},getValue:function w(I){if(!this.isEmpty(this.curItem)){if(!I){return this.value}else{return{nodeRef:this.curItem.item.id,name:this.curItem.item}}}return null},getValues:function g(I){if(!this.isEmpty(this.curItems)){var J=new Array();for(key in this.curItems){if(I){J.push({nodeRef:this.curItems[key].item.id,name:this.curItems[key].item.innerHTML})}else{J.push({nodeRef:this.curItems[key].item.id,name:this.curItems[key].item.textContent})}}return J}return null},getValuesNodeRef:function b(){if(!this.isEmpty(this.curItems)){var I=new Array();for(key in this.curItems){I.push(this.curItems[key].item.id)}return I}return null},getValuesName:function f(){if(!this.isEmpty(this.curItems)){var I=new Array();for(key in this.curItems){I.push(this.curItems[key].item.textContent)}return I}return null},pressOk:function a(){this.onOk.fire()},isEmpty:function e(I){return Object.keys(I).length===0},inArray:function s(J,K){for(var I=0;I<K.length;I++){if(K[I]==J){return true}}return false},setCurrentItem:function u(J,I){this.curItem.item=J;this.curItem.tdIcon=I},setValue:function v(J,I){this.value={nodeRef:J,name:I.replace(/(^\s+|\s+$)/g,"")};this.oldValue={nodeRef:J,name:I.replace(/(^\s+|\s+$)/g,"")}},setValues:function v(I){if(I!=null&I!=""){this.values={};this.curItems={};for(i=0,j=I.length;i<j;i++){this.values[I[i].nodeRef]=I[i].name}}},renderCurrentValue:function r(){if(this.options.single){if(this.value!=null&&!this.isEmpty(this.value)){this.curItem=this.createPicker(this.value.nodeRef,this.value.name,{},this.tBodyRight,this.iconDelete,"")}}else{if(!this.isEmpty(this.values)){for(key in this.values){this.curItems[key]=this.createPicker(key,this.values[key],{},this.tBodyRight,this.iconDelete,"")}}}},getOldValue:function A(){if(this.value.nodeRef!=this.oldValue.nodeRef){return this.oldValue}return null},getData:function c(){if(!this.isEmpty(this.curItem)){return this.curItem.item.itemData}return null},showLoading:function h(){d.setStyle(this.loadingDiv,"display","block")},hideLoading:function m(){d.setStyle(this.loadingDiv,"display","none")}})})();