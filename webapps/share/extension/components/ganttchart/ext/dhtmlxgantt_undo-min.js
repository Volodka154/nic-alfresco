gantt.config.undo_steps=10,gantt.config.undo=!0,gantt.config.redo=!0,gantt.undo=function(){this._undo.undo()},gantt.getUndoStack=function(){return this._undo._undoStack},gantt.getRedoStack=function(){return this._undo._redoStack},gantt.redo=function(){this._undo.redo()},gantt.config.undo_types={link:"link",task:"task"},gantt.config.undo_actions={update:"update",remove:"remove",add:"add"},gantt._undo={_undoStack:[],_redoStack:[],maxSteps:10,undo_enabled:!0,redo_enabled:!0,_push:function(a,b){if(b.commands.length){for(a.push(b);a.length>this.maxSteps;){a.shift()}return b}},_pop:function(a){return a.pop()},undo:function(){if(this.updateConfigs(),this.undo_enabled){var a=this._pop(this._undoStack);gantt.callEvent("onBeforeUndo",[a])!==!1&&a&&(this._applyAction(this.action.invert(a)),this._push(this._redoStack,a)),gantt.callEvent("onAfterUndo",[])}},redo:function(){if(this.updateConfigs(),this.redo_enabled){var a=this._pop(this._redoStack);gantt.callEvent("onBeforeRedo",[a])!==!1&&a&&(this._applyAction(a),this._push(this._undoStack,a)),gantt.callEvent("onAfterRedo",[])}},_applyAction:function(d){var f=null,g=this.command.entity,b=this.command.type,c={};c[g.task]={add:"addTask",update:"updateTask",remove:"deleteTask",isExists:"isTaskExists"},c[g.link]={add:"addLink",update:"updateLink",remove:"deleteLink",isExists:"isLinkExists"},gantt.batchUpdate(function(){for(var h=0;h<d.commands.length;h++){f=d.commands[h];var a=c[f.entity][f.type],e=c[f.entity].isExists;f.type==b.add?gantt[a](f.oldValue,f.oldValue.parent,f.oldValue.$index):f.type==b.remove?gantt[e](f.value.id)&&gantt[a](f.value.id):f.type==b.update&&gantt[a](f.value.id,f.value)}})},logAction:function(a){this._push(this._undoStack,a),this._redoStack=[]},action:{create:function(a){return{commands:a?a.slice():[]}},invert:function(d){for(var g=gantt.copy(d),h=gantt._undo.command,b=0;b<d.commands.length;b++){var c=g.commands[b]=h.invert(g.commands[b]);if(c.type==h.type.update){var f=c.value;c.value=c.oldValue,c.oldValue=f}}return g}},command:{create:function(c,d,f,b){return{entity:b,type:f,value:gantt.copy(c),oldValue:gantt.copy(d||c)}},invert:function(a){var b=gantt.copy(a);return b.type=this.inverseCommands(a.type),b},entity:null,type:null,inverseCommands:function(a){switch(a){case this.type.update:return this.type.update;case this.type.remove:return this.type.add;case this.type.add:return this.type.remove;case this.type.load:return this.type.clear;case this.type.clear:return this.type.load;default:return gantt.assert(!1,"Invalid command "+a),null}}},monitor:{_batchAction:null,_batchMode:!1,_ignore:!1,startIgnore:function(){this._ignore=!0},stopIgnore:function(){this._ignore=!1},startBatchAction:function(){this.timeout&&clearTimeout(this.timeout),this.timeout=setTimeout(function(){gantt._undo.monitor.stopBatchAction()},10),this._ignore||this._batchMode||(this._batchMode=!0,this._batchAction=gantt._undo.action.create())},stopBatchAction:function(){if(!this._ignore){var a=gantt._undo;this._batchAction&&a.logAction(this._batchAction),this._batchMode=!1,this._batchAction=null}},_storeCommand:function(a){var b=gantt._undo;if(b.updateConfigs(),b.undo_enabled){if(this._batchMode){this._batchAction.commands.push(a)}else{var c=b.action.create([a]);b.logAction(c)}}},_storeEntityCommand:function(d,g,h,b){var c=gantt._undo,f=c.command.create(d,g,h,b);this._storeCommand(f)},_storeTaskCommand:function(a,b){this._storeEntityCommand(a,this.getInitialTask(a.id),b,gantt._undo.command.entity.task)},_storeLinkCommand:function(a,b){this._storeEntityCommand(a,this.getInitialLink(a.id),b,gantt._undo.command.entity.link)},onTaskAdded:function(a){this._ignore||this._storeTaskCommand(a,gantt._undo.command.type.add)},onTaskUpdated:function(a){this._ignore||this._storeTaskCommand(a,gantt._undo.command.type.update)},onTaskDeleted:function(c){if(!this._ignore){if(this._storeTaskCommand(c,gantt._undo.command.type.remove),this._nestedTasks[c.id]){for(var d=this._nestedTasks[c.id],f=0;f<d.length;f++){this._storeTaskCommand(d[f],gantt._undo.command.type.remove)}}if(this._nestedLinks[c.id]){for(var b=this._nestedLinks[c.id],f=0;f<b.length;f++){this._storeLinkCommand(b[f],gantt._undo.command.type.remove)}}}},onLinkAdded:function(a){this._ignore||this._storeLinkCommand(a,gantt._undo.command.type.add)},onLinkUpdated:function(a){this._ignore||this._storeLinkCommand(a,gantt._undo.command.type.update)},onLinkDeleted:function(a){this._ignore||this._storeLinkCommand(a,gantt._undo.command.type.remove)},_initialTasks:{},_nestedTasks:{},_nestedLinks:{},_getLinks:function(a){return a.$source.concat(a.$target)},setNestedTasks:function(d,h){for(var k=null,b=[],c=this._getLinks(gantt.getTask(d)),f=0;f<h.length;f++){k=this.setInitialTask(h[f]),c=c.concat(this._getLinks(k)),b.push(k)}for(var g={},f=0;f<c.length;f++){g[c[f]]=!0}var j=[];for(var f in g){j.push(this.setInitialLink(f))}this._nestedTasks[d]=b,this._nestedLinks[d]=j},setInitialTask:function(a){if(!this._initialTasks[a]||!this._batchMode){var b=gantt.copy(gantt.getTask(a));b.$index=gantt.getTaskIndex(a),this._initialTasks[a]=b}return this._initialTasks[a]},getInitialTask:function(a){return this._initialTasks[a]},_initialLinks:{},setInitialLink:function(a){return this._initialLinks[a]&&this._batchMode||(this._initialLinks[a]=gantt.copy(gantt.getLink(a))),this._initialLinks[a]},getInitialLink:function(a){return this._initialLinks[a]}}},gantt._undo.updateConfigs=function(){gantt._undo.maxSteps=gantt.config.undo_steps,gantt._undo.command.entity=gantt.config.undo_types,gantt._undo.command.type=gantt.config.undo_actions,gantt._undo.undo_enabled=!!gantt.config.undo,gantt._undo.redo_enabled=!!gantt.config.undo&&!!gantt.config.redo},function(){function q(a){return c.setInitialTask(a),!0}function j(a,d,i){a&&(a.id==d&&(a.id=i),a.parent==d&&(a.parent=i))}function f(e,i,d){j(e.value,i,d),j(e.oldValue,i,d)}function m(a,d,i){a&&(a.source==d&&(a.source=i),a.target==d&&(a.target=i))}function h(a,d,i){m(a.value,d,i),m(a.oldValue,d,i)}function u(l,w,d){for(var n=gantt._undo,v=0;v<l.length;v++){for(var x=l[v],i=0;i<x.commands.length;i++){x.commands[i].entity==n.command.entity.task?f(x.commands[i],w,d):x.commands[i].entity==n.command.entity.link&&h(x.commands[i],w,d)}}}function b(v,y,A){for(var d=gantt._undo,l=0;l<v.length;l++){for(var w=v[l],x=0;x<w.commands.length;x++){var z=w.commands[x];z.entity==d.command.entity.link&&(z.value&&z.value.id==y&&(z.value.id=A),z.oldValue&&z.oldValue.id==y&&(z.oldValue.id=A))}}}var c=gantt._undo.monitor,p={onBeforeUndo:"onAfterUndo",onBeforeRedo:"onAfterRedo"};for(var g in p){gantt.attachEvent(g,function(){c.startIgnore()}),gantt.attachEvent(p[g],function(){c.stopIgnore()})}for(var k=["onTaskDragStart","onAfterTaskDelete","onBeforeBatchUpdate"],g=0;g<k.length;g++){gantt.attachEvent(k[g],function(){c.startBatchAction()})}gantt.attachEvent("onBeforeTaskDrag",q),gantt.attachEvent("onLightbox",q),gantt.attachEvent("onBeforeTaskAutoSchedule",function(a){q(a.id)}),gantt.attachEvent("onBeforeTaskDelete",function(a){q(a);var d=[];gantt.eachTask(function(e){d.push(e.id)},a),c.setNestedTasks(a,d)}),gantt.attachEvent("onAfterTaskAdd",function(a,d){c.onTaskAdded(d)}),gantt.attachEvent("onAfterTaskUpdate",function(a,d){c.onTaskUpdated(d)}),gantt.attachEvent("onAfterTaskDelete",function(a,d){c.onTaskDeleted(d)}),gantt.attachEvent("onAfterLinkAdd",function(a,d){c.onLinkAdded(d)}),gantt.attachEvent("onAfterLinkUpdate",function(a,d){c.onLinkUpdated(d)}),gantt.attachEvent("onAfterLinkDelete",function(a,d){c.onLinkDeleted(d)}),gantt.attachEvent("onTaskIdChange",function(a,d){var i=gantt._undo;u(i._undoStack,a,d),u(i._redoStack,a,d)}),gantt.attachEvent("onLinkIdChange",function(a,d){var i=gantt._undo;b(i._undoStack,a,d),b(i._redoStack,a,d)}),gantt.attachEvent("onGanttReady",function(){gantt._undo.updateConfigs()})}();