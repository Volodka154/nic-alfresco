gantt.config.undo_steps=10;gantt.config.undo=true;gantt.config.redo=true;gantt.undo=function(){this._undo.undo()};gantt.getUndoStack=function(){return this._undo._undoStack};gantt.getRedoStack=function(){return this._undo._redoStack};gantt.redo=function(){this._undo.redo()};gantt.config.undo_types={link:"link",task:"task"};gantt.config.undo_actions={update:"update",remove:"remove",add:"add"};gantt._undo={_undoStack:[],_redoStack:[],maxSteps:10,undo_enabled:true,redo_enabled:true,_push:function(a,b){if(!b.commands.length){return}a.push(b);while(a.length>this.maxSteps){a.shift()}return b},_pop:function(a){return a.pop()},undo:function(){this.updateConfigs();if(!this.undo_enabled){return}var a=this._pop(this._undoStack);if(gantt.callEvent("onBeforeUndo",[a])!==false){if(a){this._applyAction(this.action.invert(a));this._push(this._redoStack,a)}}gantt.callEvent("onAfterUndo",[])},redo:function(){this.updateConfigs();if(!this.redo_enabled){return}var a=this._pop(this._redoStack);if(gantt.callEvent("onBeforeRedo",[a])!==false){if(a){this._applyAction(a);this._push(this._undoStack,a)}}gantt.callEvent("onAfterRedo",[])},_applyAction:function(b){var e=null,d=this.command.entity,c=this.command.type;var a={};a[d.task]={add:"addTask",update:"updateTask",remove:"deleteTask",isExists:"isTaskExists"};a[d.link]={add:"addLink",update:"updateLink",remove:"deleteLink",isExists:"isLinkExists"};gantt.batchUpdate(function(){for(var g=0;g<b.commands.length;g++){e=b.commands[g];var h=a[e.entity][e.type],f=a[e.entity]["isExists"];if(e.type==c.add){gantt[h](e.oldValue,e.oldValue.parent,e.oldValue.$index)}else{if(e.type==c.remove){if(gantt[f](e.value.id)){gantt[h](e.value.id)}}else{if(e.type==c.update){gantt[h](e.value.id,e.value)}}}}})},logAction:function(a){this._push(this._undoStack,a);this._redoStack=[]},action:{create:function(a){return{commands:a?a.slice():[]}},invert:function(e){var b=gantt.copy(e);var a=gantt._undo.command;for(var c=0;c<e.commands.length;c++){var f=b.commands[c]=a.invert(b.commands[c]);if(f.type==a.type.update){var d=f.value;f.value=f.oldValue;f.oldValue=d}}return b}},command:{create:function(d,b,c,a){return{entity:a,type:c,value:gantt.copy(d),oldValue:gantt.copy(b||d)}},invert:function(b){var a=gantt.copy(b);a.type=this.inverseCommands(b.type);return a},entity:null,type:null,inverseCommands:function(a){switch(a){case this.type.update:return this.type.update;case this.type.remove:return this.type.add;case this.type.add:return this.type.remove;case this.type.load:return this.type.clear;case this.type.clear:return this.type.load;default:gantt.assert(false,"Invalid command "+a);return null}}},monitor:{_batchAction:null,_batchMode:false,_ignore:false,startIgnore:function(){this._ignore=true},stopIgnore:function(){this._ignore=false},startBatchAction:function(){if(this.timeout){clearTimeout(this.timeout)}this.timeout=setTimeout(function(){gantt._undo.monitor.stopBatchAction()},10);if(this._ignore||this._batchMode){return}this._batchMode=true;this._batchAction=gantt._undo.action.create()},stopBatchAction:function(){if(this._ignore){return}var a=gantt._undo;if(this._batchAction){a.logAction(this._batchAction)}this._batchMode=false;this._batchAction=null},_storeCommand:function(c){var a=gantt._undo;a.updateConfigs();if(!a.undo_enabled){return}if(this._batchMode){this._batchAction.commands.push(c)}else{var b=a.action.create([c]);a.logAction(b)}},_storeEntityCommand:function(e,b,c,d){var a=gantt._undo;var f=a.command.create(e,b,c,d);this._storeCommand(f)},_storeTaskCommand:function(b,a){this._storeEntityCommand(b,this.getInitialTask(b.id),a,gantt._undo.command.entity.task)},_storeLinkCommand:function(b,a){this._storeEntityCommand(b,this.getInitialLink(b.id),a,gantt._undo.command.entity.link)},onTaskAdded:function(a){if(!this._ignore){this._storeTaskCommand(a,gantt._undo.command.type.add)}},onTaskUpdated:function(a){if(!this._ignore){this._storeTaskCommand(a,gantt._undo.command.type.update)}},onTaskDeleted:function(b){if(!this._ignore){this._storeTaskCommand(b,gantt._undo.command.type.remove);if(this._nestedTasks[b.id]){var d=this._nestedTasks[b.id];for(var c=0;c<d.length;c++){this._storeTaskCommand(d[c],gantt._undo.command.type.remove)}}if(this._nestedLinks[b.id]){var a=this._nestedLinks[b.id];for(var c=0;c<a.length;c++){this._storeLinkCommand(a[c],gantt._undo.command.type.remove)}}}},onLinkAdded:function(a){if(!this._ignore){this._storeLinkCommand(a,gantt._undo.command.type.add)}},onLinkUpdated:function(a){if(!this._ignore){this._storeLinkCommand(a,gantt._undo.command.type.update)}},onLinkDeleted:function(a){if(!this._ignore){this._storeLinkCommand(a,gantt._undo.command.type.remove)}},_initialTasks:{},_nestedTasks:{},_nestedLinks:{},_getLinks:function(a){return a.$source.concat(a.$target)},setNestedTasks:function(h,f){var c=null,g=[],e=this._getLinks(gantt.getTask(h));for(var d=0;d<f.length;d++){c=this.setInitialTask(f[d]);e=e.concat(this._getLinks(c));g.push(c)}var a={};for(var d=0;d<e.length;d++){a[e[d]]=true}var b=[];for(var d in a){b.push(this.setInitialLink(d))}this._nestedTasks[h]=g;this._nestedLinks[h]=b},setInitialTask:function(b){if(!this._initialTasks[b]||!this._batchMode){var a=gantt.copy(gantt.getTask(b));a.$index=gantt.getTaskIndex(b);this._initialTasks[b]=a}return this._initialTasks[b]},getInitialTask:function(a){return this._initialTasks[a]},_initialLinks:{},setInitialLink:function(a){if(!this._initialLinks[a]||!this._batchMode){this._initialLinks[a]=gantt.copy(gantt.getLink(a))}return this._initialLinks[a]},getInitialLink:function(a){return this._initialLinks[a]}}};gantt._undo.updateConfigs=function(){gantt._undo.maxSteps=gantt.config.undo_steps;gantt._undo.command.entity=gantt.config.undo_types;gantt._undo.command.type=gantt.config.undo_actions;gantt._undo.undo_enabled=!!gantt.config.undo;gantt._undo.redo_enabled=(!!gantt.config.undo)&&(!!gantt.config.redo)};(function(){var j=gantt._undo.monitor;var f={onBeforeUndo:"onAfterUndo",onBeforeRedo:"onAfterRedo"};for(var e in f){gantt.attachEvent(e,function(){j.startIgnore()});gantt.attachEvent(f[e],function(){j.stopIgnore()})}var d=["onTaskDragStart","onAfterTaskDelete","onBeforeBatchUpdate"];for(var e=0;e<d.length;e++){gantt.attachEvent(d[e],function(){j.startBatchAction()})}function h(i){j.setInitialTask(i);return true}gantt.attachEvent("onBeforeTaskDrag",h);gantt.attachEvent("onLightbox",h);gantt.attachEvent("onBeforeTaskAutoSchedule",function(i){h(i.id)});gantt.attachEvent("onBeforeTaskDelete",function(m){h(m);var i=[];gantt.eachTask(function(n){i.push(n.id)},m);j.setNestedTasks(m,i)});gantt.attachEvent("onAfterTaskAdd",function(m,i){j.onTaskAdded(i)});gantt.attachEvent("onAfterTaskUpdate",function(m,i){j.onTaskUpdated(i)});gantt.attachEvent("onAfterTaskDelete",function(m,i){j.onTaskDeleted(i)});gantt.attachEvent("onAfterLinkAdd",function(m,i){j.onLinkAdded(i)});gantt.attachEvent("onAfterLinkUpdate",function(m,i){j.onLinkUpdated(i)});gantt.attachEvent("onAfterLinkDelete",function(m,i){j.onLinkDeleted(i)});function g(i,n,m){if(!i){return}if(i.id==n){i.id=m}if(i.parent==n){i.parent=m}}function l(n,m,i){g(n.value,m,i);g(n.oldValue,m,i)}function b(n,i,m){if(!n){return}if(n.source==i){n.source=m}if(n.target==i){n.target=m}}function k(n,m,i){b(n.value,m,i);b(n.oldValue,m,i)}function a(q,s,o){var m=gantt._undo;for(var p=0;p<q.length;p++){var r=q[p];for(var n=0;n<r.commands.length;n++){if(r.commands[n].entity==m.command.entity.task){l(r.commands[n],s,o)}else{if(r.commands[n].entity==m.command.entity.link){k(r.commands[n],s,o)}}}}}function c(q,t,o){var m=gantt._undo;for(var p=0;p<q.length;p++){var r=q[p];for(var n=0;n<r.commands.length;n++){var s=r.commands[n];if(s.entity==m.command.entity.link){if(s.value&&s.value.id==t){s.value.id=o}if(s.oldValue&&s.oldValue.id==t){s.oldValue.id=o}}}}}gantt.attachEvent("onTaskIdChange",function(n,m){var i=gantt._undo;a(i._undoStack,n,m);a(i._redoStack,n,m)});gantt.attachEvent("onLinkIdChange",function(n,m){var i=gantt._undo;c(i._undoStack,n,m);c(i._redoStack,n,m)});gantt.attachEvent("onGanttReady",function(){gantt._undo.updateConfigs()})})();