require(["jquery","pqgrid","combobox","pqselect","jquery-ui.datepicker-ru","jquery.datepicker.extension.range","dojo/domReady!"],function(a){createMenuAndAndGridDiv();loadCounters();clickMainMenu();a(window).resize(function(){if(!a(".mask").is(":visible")){if(refreshTimeout!=null){clearTimeout(refreshTimeout)}refreshTimeout=setTimeout(function(){getActiveGrid().pqGrid("refreshView")},500)}})});var refreshTimeout=null;var services={};function clickMainMenu(){whenElementIsReady("#"+sessionStorage.getItem("menuTasksAndDocsItem"),function(a){$(a).click()})}function whenElementIsReady(a,b,c){if(c==null||c<25){setTimeout(function(){var d=$(a);if(d.length>0){d.each(function(f,e){b(e)})}else{whenElementIsReady(a,b,(c||0)+1)}},100)}}function loadCounters(){Object.keys(services).forEach(function(b){var a=services[b].url;if(a!=null&&services[b].count===true){Alfresco.util.Ajax.jsonGet({url:"/share/proxy/alfresco/"+a+"?count=true",successCallback:{fn:function(c){var d;if(c.json.func==="mail_input"&&c.json.noReadCount!=null){d=c.json.noReadCount}else{if(c.json.cnt_whole!=null){d=c.json.cnt_whole}else{d=c.json.count}}setMenuItemCounterValue(b,d)}}})}})}function createMenuAndAndGridDiv(){var a=window.BTL.settingTaskAndDocument;Object.keys(a).forEach(function(b){var d=a[b];var c=$('<div id="'+d.id+'"></div>');Object.keys(d.submenu).forEach(function(g){var h=d.submenu[g];var e=h.value.filter(function(i){return i.visible});if(e.length>0){var f=$('<div id="'+h.id+'"></div>');if(h.name!=null){f.append($('<div class="title"><h3>'+h.name+"</h3></div>"))}else{c.append($('<div class="title"><h3>'+d.name+"</h3></div>"))}e.sort(function(j,i){return j.position-i.position}).forEach(function(j){if(j.isMain){sessionStorage.setItem("menuTasksAndDocsItem",j.id)}services[j.id]=j;var i='<div id="'+j.id+'" class="item-menu"><span>'+(j.aliasName||j.name)+"</span>";if(j.count===true){i+='&nbsp;<span class="count">(<img height="10" width="10" src="/share/res/components/images/lightbox/loading.gif"/>)</span>'}i+="</div>";f.append($(i));createGridDiv(j.id)});c.append(f)}});if(c.find("div").length>1){$("#left-column-tasks-and-documents_dashlet").append(c)}})}function getGridContainerId(a){return a+"_gridContainer"}function getGridId(a){return a+"_grid"}function getGroupToggleId(a){return a+"_group-toggle"}function geUpdateButtonId(a){return a+"_update-btn"}function geDeleteButtonId(a){return a+"_delete-btn"}function getSpecialControlToggleId(a){return a+"_special-toggle"}function getUrgentlyToggleId(a){return a+"_urgently-toggle"}function getFilterAllId(a){return a+"_filterAll"}function getFilterWeekId(a){return a+"_filterWeek"}function getFilterMonthId(a){return a+"_filterMonth"}function getFilterYearId(a){return a+"_filterYear"}function getFilterOverdueId(a){return a+"_filterOverdue"}function getWeekStartDate(b){if(b==null){b=new Date()}b.setHours(0,0,0,0);var a=b.getDay(),c=b.getDate()-a+(a===0?-6:1);return new Date(b.setDate(c))}function getWeekEndDate(b){if(b==null){b=new Date()}b.setHours(0,0,0,0);var a=b.getDay(),c=b.getDate()-a+(a===0?0:7);return new Date(b.setDate(c))}function getMonthStartDate(a){if(a==null){a=new Date()}a.setHours(0,0,0,0);return new Date(a.setDate(1))}function getMonthEndDate(a){if(a==null){a=new Date()}a.setHours(0,0,0,0);return new Date(a.setDate(daysInMonth(a)))}function getYearStartDate(a){if(a==null){a=new Date()}return new Date(a.getFullYear(),0,1)}function getYearEndDate(a){if(a==null){a=new Date()}return new Date(a.getFullYear(),11,31)}function getYesterday(a){if(a==null){a=new Date()}a.setHours(0,0,0,0);return new Date(a.setDate(a.getDate()-1))}function toFormattedStr(a){a.setHours(-(a.getTimezoneOffset()/60));return a.toISOString().substr(0,10).split("-").reverse().join(".")}function createGridDiv(c){var a=getGridId(c);var b='<div id="'+getGridContainerId(c)+'" style="display: none">';if(services[c].gridType==="task-local"){b+='<div>    <div class="first-filters">      <div class="item-first-filters active" id="'+getFilterAllId(a)+'">Все задачи</div>      <div class="item-first-filters" id="'+getFilterWeekId(a)+'">Задачи на неделю <span class="count">(<img height="10" width="10" src="/share/res/components/images/lightbox/loading.gif"/>)</span></div>      <div class="item-first-filters" id="'+getFilterMonthId(a)+'">Задачи на месяц <span class="count">(<img height="10" width="10" src="/share/res/components/images/lightbox/loading.gif"/>)</span></div>      <div class="item-first-filters" id="'+getFilterYearId(a)+'">Задачи на год <span class="count">(<img height="10" width="10" src="/share/res/components/images/lightbox/loading.gif"/>)</span></div>      <div class="item-first-filters background-red color-white" id="'+getFilterOverdueId(a)+'">Просроченные <span class="count">(<img height="10" width="10" src="/share/res/components/images/lightbox/loading.gif"/>)</span></div>      <div class="clean"></div>    </div>  </div>'}b+=' <div id="'+a+'"></div></div>';$("#right-column-tasks-and-documents_dashlet").append($(b))}function daysInMonth(a){return 33-new Date(a.getFullYear(),a.getMonth(),33).getDate()}function refreshLocalGridDataAndView(b){var a=$("#"+b);clearHeaderFilters(a);switchActiveTabFilter(a,"#"+getFilterAllId(b));a.pqGrid("option","dataModel.location","remote");a.pqGrid("refreshDataAndView")}function refreshRemoteGridDataAndView(b){var a=$("#"+b);if(a.pqGrid("option","groupModel")!==null&&a.pqGrid("option","groupToggleId")!=null){$("#"+a.pqGrid("option","groupToggleId")).click()}else{clearHeaderFilters(a);a.pqGrid("refreshDataAndView")}}function toggleGrouping(b){var a=$("#"+b);var d=a.pqGrid("option","groupToggleId");var c=$("#"+d).prop("checked");var e=null;if(c){e={dataIndx:["doc_a"],title:["<b style='font-weight:bold;'>{0}</b>"],dir:["up"]}}a.pqGrid("option","groupModel",e);setTimeout(function(){a.pqGrid("refreshView")},100)}function fillLocalFilter(a,b,c){var d=a.pqGrid("getColumn",{dataIndx:c}).filter;d.cache=null;d.options=b.reduce(function(g,f){var e=f[c];if(g.indexOf(e)===-1){g.push(e)}return g},[]).map(function(e){var f={};f[c]=e;return f})}var loaderImageHtml='<img height="10" width="10" src="/share/res/components/images/lightbox/loading.gif"/>';function showMenuItemCounterLoader(a){$("#"+a).find(".count").html("("+loaderImageHtml+")")}function setMenuItemCounterValue(b,a){$("#"+b).find(".count").html("("+a+")")}function clearHeaderFilters(a){var b=false;a.pqGrid("getColModel").forEach(function(c){var d=c.filter;if(d!=null){if(!b){b=(d.value||"").length!==0||(d.value2||"").length!==0}d.value=null;d.value2=null;d.cache=null}});if(b){a.pqGrid("filter",{oper:"replace",data:[]})}}function setFilterDateRange(b,e,d,c,a,f){b.pqGrid("filter",{oper:"replace",data:[{dataIndx:e,condition:"between",value:d,value2:c}]});if(a===undefined||a===true){b.find('input[name="duration"].pq-from').val(d)}if(f===undefined||f===true){b.find('input[name="duration"].pq-to').val(c)}}function contItemsBetweenDates(a,d,c,b){return a.reduce(function(f,e){var g=e[b];if(g!=null&&g.length>0){g=new Date(e[b].split(".").reverse());if(g!=null&&d<=g&&g<=c){f++}}return f},0)}function clearGrouping(a){if(a.pqGrid("option","groupModel")!==null&&a.pqGrid("option","groupToggleId")!=null){$("#"+a.pqGrid("option","groupToggleId")).click()}}function countForTabFilters(a,d){var b=a.pqGrid("option","gridId");var g=$("#"+a.pqGrid("option","containerGridId"));var h=contItemsBetweenDates(d,getWeekStartDate(),getWeekEndDate(),"duration");g.find("#"+getFilterWeekId(b)).find(".count").html("("+h+")");var f=contItemsBetweenDates(d,getMonthStartDate(),getMonthEndDate(),"duration");g.find("#"+getFilterMonthId(b)).find(".count").html("("+f+")");var e=contItemsBetweenDates(d,getYearStartDate(),getYearEndDate(),"duration");g.find("#"+getFilterYearId(b)).find(".count").html("("+e+")");var c=contItemsBetweenDates(d,new Date(0),getYesterday(),"duration");g.find("#"+getFilterOverdueId(b)).find(".count").html("("+c+")")}function getGridHeight(a){if($("#"+getFilterAllId(a)).length>0){return 842}else{return 879}}function getActiveGridId(){var a=$(".item-menu.active");if(a.length>0){return getGridId(a[0].id)}else{return null}}function getActiveGrid(){return $("#"+getActiveGridId())}function _refreshGrid(){$(".item-menu.active").click()}function isCompleteMe(){var a=$(".item-menu.active");if(a.length>0){return a[0].id.indexOf("delegateMe")>=0}else{return false}}function switchActiveTabFilter(a,c){var b=a.pqGrid("option","containerGridId");$("#"+b).find(".item-first-filters.active").removeClass("active");$(c).addClass("active")}function changeSimpleFilter(b,c,e){var a=$("#"+b);var d=a.pqGrid("option","colModel").filter(function(f){return f.filter!=null&&f.dataIndx!==c}).map(function(f){return{dataIndx:f.dataIndx,condition:f.filter.condition,value:f.filter.value,value2:f.filter.value2,}});d.push({dataIndx:c,condition:"equal",value:e});a.pqGrid("filter",{oper:"replace",data:d});a.pqGrid("refreshView",{header:false})}function selectAllChange(b,a){var c=$(b).prop("checked");$("#"+a).pqGrid("selection",{type:"row",all:"all",method:c?"selectAll":"removeAll"})}function replyMails(c){var a=$("#"+c);var e=a.pqGrid("option","dataModel.data").filter(function(f){return f.sel===true}).map(function(f){return f.nodeRef});if(e.length>0){var d="/share/page/arm/mailMessage?formId=mailMessage&reply="+e.toString();var b=createFormIFrame(d);document.frameCancel=function(){b.hide()};document.frameSave=function(){b.hide()};b.show()}else{Alfresco.util.PopupManager.displayMessage({text:"Нет выбранных элементов",displayTime:1})}}function deleteSelectedMails(b){var a=$("#"+b);a.pqGrid("showLoading");var d=a.pqGrid("option","dataModel.data").filter(function(e){return e.sel===true}).map(function(e){return e.nodeRef});if(d.length>0){var c=window.confirm("Вы действительно хотите удалить выбранные письма?");if(c){Alfresco.util.Ajax.jsonPost({url:"/share/proxy/alfresco/mailMessage/delete",dataObj:{nodes:d,gridId:b},successCallback:{fn:function(e){Alfresco.util.PopupManager.displayMessage({text:"Письма удалены",displayTime:1});a.pqGrid("hideLoading");refreshLocalGridDataAndView(b)}}})}}else{Alfresco.util.PopupManager.displayMessage({text:"Нет выбранных элементов",displayTime:1});a.pqGrid("hideLoading")}}function deleteSelected(c){var a=$("#"+c);var e=a.pqGrid("option","dataModel.data").filter(function(h){return h.sel===true}).map(function(h){return h.nodeRef});if(e.length>0){var d=window.confirm("Вы действительно хотите удалить выбранные документы?");if(d){var g=a.pqGrid("option","dataModel.data");a.pqGrid("showLoading");var b=[];var f=[];$.each(g,function(h,i){if(i.sel==true){f.push(h);b.push(i.nodeRef)}});a.pqGrid("selection",{type:"row",all:"all",method:"removeAll"});f.forEach(function(h){a.pqGrid("deleteRow",{rowIndx:h})});if(b.length==0){refreshTable(a)}else{a.pqGrid("option","isResetData",true);Alfresco.util.Ajax.jsonPost({url:"/share/proxy/alfresco/slingshot/doclib/action/files?alf_method=delete",dataObj:{nodeRefs:b},successCallback:{fn:function(h){refreshTable(a)}},failureCallback:{fn:function(h){refreshTable(a);Alfresco.util.PopupManager.displayPrompt({title:"Ошибка удаления",text:getFormattedDateTime(new Date())+"\nОдин или несколько документов удалить не удалось"})}}})}}}else{Alfresco.util.PopupManager.displayMessage({text:"Нет выбранных элементов",displayTime:1});a.pqGrid("hideLoading")}}function refreshTable(a){a.pqGrid("hideLoading");a.pqGrid("refreshDataAndView")}function initLocalReviewGrid(f,a,e){var b=[{title:"Вид документа",minWidth:100,width:150,dataType:"string",dataIndx:"type",filter:{type:"select",condition:"equal",valueIndx:"type",labelIndx:"type",prepend:{"":""},value:"",listeners:["change"],init:function(){$(this).pqSelect({singlePlaceholder:"Все",searchRule:"contain",width:"100%"})}}},{title:"Тип",minWidth:100,width:150,dataType:"string",align:"center",dataIndx:"level",filter:{type:"select",condition:"equal",valueIndx:"level",labelIndx:"level",prepend:{"":""},value:"",listeners:["change"],init:function(){$(this).pqSelect({singlePlaceholder:"Все",searchRule:"contain",width:"100%"})}}},{title:"Наименование",minWidth:150,width:350,dataType:"string",dataIndx:"name",filter:{type:"textbox",condition:"contain",listeners:["keyup"]}},{title:"Дата регистрации",minWidth:160,width:160,dataType:"date",dataIndx:"regDate",filter:{type:"textbox",condition:"between",init:function(){$(this).css({zIndex:3,position:"relative"}).datepicker({dateFormat:"dd-mm-yy",yearRange:"-20:+20",changeYear:true,changeMonth:true})},listeners:["change"]}},{title:"Рег. Номер",minWidth:80,width:160,dataType:"string",dataIndx:"regNum",filter:{type:"textbox",condition:"contain",listeners:["keyup"]}},{title:"Инициатор/Контрагент",minWidth:100,width:350,dataType:"string",dataIndx:"author",filter:{type:"textbox",condition:"contain",listeners:["keyup"]}},{title:"",minWidth:1,maxWidth:1,width:1,dataType:"",dataIndx:""}];var c={location:"local",sorting:"local",dataType:"JSON",method:"GET",url:"/share/proxy/alfresco/"+services[e].url,getUrl:function(g){showMenuItemCounterLoader(e);return{url:$(this).pqGrid("option","dataModel.url")}},getData:function(h){if(h.items.length===0){clearGrouping($(this))}var g=$(this);setMenuItemCounterValue(e,h.items.length);fillLocalFilter(g,h.items,"type");fillLocalFilter(g,h.items,"level");return{data:h.items}},error:function(g,i,h){console.error(i,h)}};var d={width:"100%",height:getGridHeight(a),colModel:b,dataModel:c,gridId:a,containerGridId:f,menuItemId:e,pageModel:{type:"local",rPP:50,strRpp:"{0}",rPPOptions:[50,250,500]},filterModel:{on:true,mode:"AND",header:true},showTitle:false,toolbar:{cls:"pq-toolbar-crud",items:[]},editable:false,collapsible:false,showBottom:true,beforeFilter:function(g,h){clearGrouping($(this))},rowDblClick:function(i,j){var h=false;var k=null;var g="";if(j.rowData&&j.rowData.type==="Договор"){g="/share/page/arm/contract?nodeRef="+j.rowData.nodeRef}else{g="/share/page/btl-review?nodeRef="+j.rowData.nodeRef;h=true;k="reviewForm"}if(h){createAndShowForm(j.rowData.nodeRef,{formId:k})}else{window.location.href=g}require(["dojo/topic"],function(l){l.publish("ALF_DISPLAY_NOTIFICATION",{message:"Перенаправление на документ."})})},beforeTableView:function(g,h){if($(this).pqGrid("option","dataModel.location")!=="local"){$(this).pqGrid("option","dataModel.location","local")}}};d.updateButtonId=geUpdateButtonId(a);d.toolbar.items.push({type:'<button id="'+d.updateButtonId+'" type="button" title="Обновить " class="ui-button ui-widget ui-state-default ui-corner-all ui-button-text-icon-primary" role="button"><span class="ui-button-icon-primary ui-icon ui-icon-refresh"></span><span class="ui-button-text">Обновить</span></button>'});if(services[e].deletable){d.colModel.unshift({title:'<input type="checkbox" onclick="selectAllChange(this, \''+a+"')\">",dataIndx:"sel",minWidth:30,width:30,align:"center",type:"checkBoxSelection",cls:"ui-state-default",resizable:false,sortable:false});d.deleteButtonId=geDeleteButtonId(a);d.toolbar.items.push({type:'<button id="'+d.deleteButtonId+'" type="button" onclick="deleteSelected(\''+a+'\')" title="Удалить выбранные" class="ui-button ui-widget ui-state-default ui-corner-all ui-button-text-icon-primary" role="button">    <span class="ui-button-icon-primary ui-icon ui-icon-cancel"></span>    <span class="ui-button-text">Удалить выбранные</span></button>'})}$("#"+a).pqGrid(d);$("#"+f).addClass("initialized");if(d.updateButtonId!=null){$("#"+d.updateButtonId).click(function(){refreshLocalGridDataAndView(a)})}}function initLocalTasksGrid(f,a,e){var b=[{title:"",dataType:"string",dataIndx:"nodeRef",hidden:true},{title:"",dataType:"string",dataIndx:"specControl",hidden:true,},{title:"",dataType:"string",dataIndx:"urgently",hidden:true,},{title:"Тип задачи",minWidth:100,width:150,dataType:"string",dataIndx:"type",filter:{type:"select",condition:"equal",prepend:{"":""},valueIndx:"type",labelIndx:"type",listeners:["change"],init:function(){$(this).pqSelect({singlePlaceholder:"Все",searchRule:"contain",width:"100%"})}}},{title:"Файл",minWidth:40,width:40,dataType:"string",dataIndx:"existFile"},{title:"Наименование задачи",minWidth:160,width:200,dataType:"string",dataIndx:"name_a",filter:{type:"textbox",condition:"contain",listeners:["keyup"]}},{title:"Документ/Проект",minWidth:120,width:200,dataType:"string",dataIndx:"doc_a",filter:{type:"textbox",condition:"contain",listeners:["keyup"]}},{title:"Дата регистрации",minWidth:160,width:160,dataType:"date",dataIndx:"regDate",filter:{type:"textbox",condition:"between",init:function(){$(this).css({zIndex:3,position:"relative"}).datepicker({dateFormat:"dd-mm-yy",yearRange:"-20:+20",changeYear:true,changeMonth:true})},listeners:["change"]}},{title:"Инициатор",minWidth:110,width:110,dataType:"string",dataIndx:"author",filter:{type:"textbox",condition:"contain",listeners:["keyup"]}},{title:"Исполнитель",minWidth:110,width:110,dataType:"string",dataIndx:"executor",filter:{type:"textbox",condition:"contain",listeners:["keyup"]}},{title:"ШИФР",minWidth:70,width:70,dataType:"string",dataIndx:"cipher",filter:{type:"textbox",condition:"contain",listeners:["keyup"]}},{title:"Срок исполнения",minWidth:160,width:160,dataType:"date",dataIndx:"duration",filter:{type:"textbox",condition:"between",init:function(){$(this).css({zIndex:3,position:"relative"}).datepicker({dateFormat:"dd-mm-yy",yearRange:"-20:+20",changeYear:true,changeMonth:true})},listeners:["change"]}},{title:"Контрагент",minWidth:100,width:150,dataType:"string",dataIndx:"contractor",filter:{type:"select",condition:"equal",prepend:{"":""},valueIndx:"contractor",labelIndx:"contractor",listeners:["change"],init:function(){$(this).pqSelect({singlePlaceholder:"Все",searchRule:"contain",width:"100%"})}}},{title:"Статус",minWidth:100,width:200,dataType:"string",dataIndx:"status",filter:{type:"select",condition:"equal",prepend:{"":""},valueIndx:"status",labelIndx:"status",listeners:["change"],init:function(){$(this).pqSelect({singlePlaceholder:"Все",searchRule:"contain",width:"100%"})}}},{title:"",minWidth:1,maxWidth:1,width:1,dataType:"",dataIndx:""}];var c={location:"local",sorting:"local",dataType:"JSON",method:"GET",url:"/share/proxy/alfresco/"+services[e].url,getUrl:function(g){showMenuItemCounterLoader(e);return{url:$(this).pqGrid("option","dataModel.url")}},getData:function(h){if(h.items.length===0){clearGrouping($(this))}var g=$(this);setMenuItemCounterValue(e,h.items.length);fillLocalFilter(g,h.items,"status");fillLocalFilter(g,h.items,"type");fillLocalFilter(g,h.items,"contractor");countForTabFilters(g,h.items);return{data:h.items}},error:function(g,i,h){console.error(i,h)}};var d={width:"100%",height:getGridHeight(a),colModel:b,dataModel:c,gridId:a,containerGridId:f,menuItemId:e,pageModel:{type:"local",rPP:50,strRpp:"{0}",rPPOptions:[50,250,500]},groupModel:{dataIndx:["doc_a"],title:["<b style='font-weight:bold;'>{0}</b>"],dir:["up"]},selectionModel:{type:"none",cbHeader:false,cbAll:true},filterModel:{on:true,mode:"AND",header:true},showTitle:false,toolbar:{cls:"pq-toolbar-crud",items:[]},editable:false,collapsible:false,showBottom:true,beforeFilter:function(g,h){clearGrouping($(this))},rowDblClick:function(g,h){h.rowData.rowIndx=h.rowIndx;taskAndDocumentOpenModalRowData(h.rowData,{isCompleteMe:isCompleteMe()});require(["dojo/topic"],function(i){i.publish("ALF_DISPLAY_NOTIFICATION",{message:"Перенаправление на задачу."})})},cellClick:function(g,h){h.rowData.rowIndx=h.rowIndx;if(h.dataIndx==="name_a"){taskAndDocumentOpenModalRowData(h.rowData,{isCompleteMe:isCompleteMe()})}},beforeTableView:function(g,h){if($(this).pqGrid("option","dataModel.location")!=="local"){$(this).pqGrid("option","dataModel.location","local")}}};if(services[e].toolbar.docGroup===true){d.groupToggleId=getGroupToggleId(a);d.toolbar.items.push({type:'<label style="font-weight: 600;color: #333;"><input type="checkbox" id="'+d.groupToggleId+'" checked>Группировка по документу</label>'},{type:'<span class="pq-separator"></span>'})}if(services[e].toolbar.urgently===true){d.urgentlyToggleId=getUrgentlyToggleId(a);d.toolbar.items.push({type:'<label style="font-weight: 600;color:#fb3838"><input type="checkbox" id="'+d.urgentlyToggleId+'"><u>Срочные документы</u></input></label>'},{type:'<span class="pq-separator"></span>'})}if(services[e].toolbar.specialControl===true){d.specialControlToggleId=getSpecialControlToggleId(a);d.toolbar.items.push({type:'<label style="font-weight: 600;color:#fb3838"><input type="checkbox" id="'+d.specialControlToggleId+'"><u>Особый контроль</u></input></label>'},{type:'<span class="pq-separator"></span>'})}d.updateButtonId=geUpdateButtonId(a);d.toolbar.items.push({type:'<button id="'+d.updateButtonId+'" type="button" title="Обновить " class="ui-button ui-widget ui-state-default ui-corner-all ui-button-text-icon-primary" role="button"><span class="ui-button-icon-primary ui-icon ui-icon-refresh"></span><span class="ui-button-text">Обновить</span></button>'});if(services[e].deletable){d.colModel.unshift({title:'<input type="checkbox" onclick="selectAllChange(this, \''+a+"')\">",dataIndx:"sel",minWidth:30,width:30,align:"center",type:"checkBoxSelection",cls:"ui-state-default",resizable:false,sortable:false});d.deleteButtonId=geDeleteButtonId(a);d.toolbar.items.push({type:'<button id="'+d.deleteButtonId+'" type="button" onclick="deleteSelected(\''+a+'\')" title="Удалить выбранные" class="ui-button ui-widget ui-state-default ui-corner-all ui-button-text-icon-primary" role="button">    <span class="ui-button-icon-primary ui-icon ui-icon-cancel"></span>    <span class="ui-button-text">Удалить выбранные</span></button>'})}$("#"+a).pqGrid(d);$("#"+f).addClass("initialized");if(d.groupToggleId!=null){$("#"+d.groupToggleId).change(function(){toggleGrouping(a)})}if(d.updateButtonId!=null){$("#"+d.updateButtonId).click(function(){refreshLocalGridDataAndView(a)})}if(d.urgentlyToggleId!=null){$("#"+d.urgentlyToggleId).change(function(){changeSimpleFilter(a,"urgently",this.checked?"true":"")})}if(d.specialControlToggleId!=null){$("#"+d.specialControlToggleId).change(function(){changeSimpleFilter(a,"specControl",this.checked?"true":"")})}$("#"+getFilterAllId(a)).click(function(h){var g=$("#"+a);g.find("select.pq-select").val([]).pqSelect("refreshData");switchActiveTabFilter(g,this);setFilterDateRange(g,"duration","","")});$("#"+getFilterWeekId(a)).click(function(j){var g=$("#"+a);g.find("select.pq-select").val([]).pqSelect("refreshData");switchActiveTabFilter(g,this);var i=toFormattedStr(getWeekStartDate(new Date()));var h=toFormattedStr(getWeekEndDate(new Date()));setFilterDateRange(g,"duration",i,h)});$("#"+getFilterMonthId(a)).click(function(j){var g=$("#"+a);g.find("select.pq-select").val([]).pqSelect("refreshData");switchActiveTabFilter(g,this);var i=toFormattedStr(getMonthStartDate(new Date()));var h=toFormattedStr(getMonthEndDate(new Date()));setFilterDateRange(g,"duration",i,h)});$("#"+getFilterYearId(a)).click(function(j){var g=$("#"+a);g.find("select.pq-select").val([]).pqSelect("refreshData");switchActiveTabFilter(g,this);var i=toFormattedStr(getYearStartDate(new Date()));var h=toFormattedStr(getYearEndDate(new Date()));setFilterDateRange(g,"duration",i,h)});$("#"+getFilterOverdueId(a)).click(function(j){var g=$("#"+a);g.find("select.pq-select").val([]).pqSelect("refreshData");switchActiveTabFilter(g,this);var i=toFormattedStr(new Date(0));var h=toFormattedStr(getYesterday(new Date()));setFilterDateRange(g,"duration",i,h,false,true)})}function initRemoteTasksGrid(h,c,g){var a=getDefaultPq();var b=[{"0":"Резолюция по Входящему"},{"1":"Задание по Исходящему"},{"2":"Резолюция по Внутреннему"},{"3":"Задание по Проекту"},{"4":"Инициативное задание"},{"5":"Задание по НТД"},{"7":"Задание по мероприятию"},{"8":"Задание по ОРД"},{"9":"Задание по договору"}];var d=[{title:"nodeRef",dataType:"string",dataIndx:"nodeRef",hidden:true},{title:"Тип задачи",minWidth:100,width:150,dataType:"string",dataIndx:"btl-task:taskType",sortable:false,filter:{type:"select",style:"height:32px;",condition:"equal",options:b,prepend:{"":""},listeners:["change"],init:function(){$(this).pqSelect({singlePlaceholder:"Все",searchRule:"contain",width:"100%"})}}},{title:"Файл",minWidth:40,width:40,dataType:"string",dataIndx:"fileExists",sortable:false},{title:"Наименование задачи",minWidth:160,width:200,dataType:"string",dataIndx:"btl-task:name",filter:{type:"textbox",condition:"contain",listeners:["change"]}},{title:"Документ/Проект",minWidth:120,width:200,dataType:"string",dataIndx:"doc_a",sortable:false},{title:"Режим исполнения",minWidth:80,wdth:80,dataType:"string",dataIndx:"runtime",sortable:false},{title:"Инициатор",minWidth:110,width:110,dataType:"string",dataIndx:"btl-task:author-content",filter:{type:"textbox",condition:"contain",listeners:["change"]}},{title:"Исполнитель",minWidth:110,width:110,dataType:"string",dataIndx:"btl-task:actualExecutor-content",filter:{type:"textbox",condition:"contain",listeners:["change"]}},{title:"ШИФР",minWidth:70,width:70,dataType:"string",dataIndx:"btl-task:project-content",filter:{type:"textbox",condition:"contain",listeners:["change"]}},{title:"Срок исполнения",minWidth:160,width:160,dataType:"date",dataIndx:"btl-task:endDate",filter:{type:"textbox",condition:"between",init:function(){$(this).css({zIndex:3,position:"relative"}).datepicker({dateFormat:"dd-mm-yy",yearRange:"-20:+20",changeYear:true,changeMonth:true})},listeners:["change"]}},{title:"Фактическая дата завершения",minWidth:160,width:160,dataType:"date",dataIndx:"btl-task:actualEndDate",filter:{type:"textbox",condition:"between",init:function(){$(this).css({zIndex:3,position:"relative"}).datepicker({dateFormat:"dd-mm-yy",yearRange:"-20:+20",changeYear:true,changeMonth:true})},listeners:["change"]}},{title:"Контрагент",minWidth:100,width:150,dataType:"string",dataIndx:"btl-task:contractor",filter:{type:"textbox",condition:"contain",listeners:["change"]}},{title:"Статус",minWidth:100,width:150,dataType:"string",dataIndx:"btl-task:state"},{title:"",minWidth:1,maxWidth:1,width:1,dataType:"",dataIndx:""}];var e={location:"remote",sorting:"remote",dataType:"JSON",method:"GET",data:a.dataCache,sortIndx:"btl-task:actualEndDate",sortDir:"down",getUrl:function(i){if($(this).pqGrid("option","isInit2")!==true){$(this).pqGrid("option","isInit2",true);$(this).pqGrid("option","currentCountId",c+"CurrentCount");$(this).pqGrid("option","totalCountId",c+"TotalCount");$(this).pqGrid("option","dataUrl","/share/proxy/alfresco/"+services[g].url);addPaginationBlock($(this))}return getUrl2($(this),a)},getData:function(i){return getData2($(this),i,a)},error:function(i,k,j){error2(i,k,j)}};var f={width:"100%",height:getGridHeight(c),selectionModel:{type:"none",subtype:"incr",cbHeader:false,cbAll:true},dataModel:e,collapsible:false,editable:false,showTitle:false,colModel:d,filterModel:{on:true,mode:"AND",header:true},gridId:c,containerGridId:h,toolbar:{cls:"pq-toolbar-crud",items:[]},beforeSort:function(i,j){beforeSort2($(this))},beforeFilter:function(i,j){beforeFilter2($(this))},beforeTableView:function(i,j){beforeTableView2(j,a,$(this))},rowDblClick:function(i,j){openForm(j.rowData);require(["dojo/topic"],function(k){k.publish("ALF_DISPLAY_NOTIFICATION",{message:"Перенаправление на задачу."})})}};if(services[g].toolbar.docGroup===true){f.groupToggleId=getGroupToggleId(c);f.toolbar.items.push({type:'<label style="font-weight: 600;color: #333;"><input type="checkbox" id="'+f.groupToggleId+'">Группировка по документу</label>'},{type:'<span class="pq-separator"></span>'})}f.updateButtonId=geUpdateButtonId(c);f.toolbar.items.push({type:'<button id="'+f.updateButtonId+'" type="button" title="Обновить " class="ui-button ui-widget ui-state-default ui-corner-all ui-button-text-icon-primary" role="button"><span class="ui-button-icon-primary ui-icon ui-icon-refresh"></span><span class="ui-button-text">Обновить</span></button>'});$("#"+c).pqGrid(f);$("#"+h).addClass("initialized");if(f.groupToggleId!=null){$("#"+f.groupToggleId).change(function(){localGroup(this.checked?"doc_a":null,$("#"+c),a)})}if(f.updateButtonId!=null){$("#"+f.updateButtonId).click(function(){refreshRemoteGridDataAndView(c)})}}function initRemoteDocsGrid(g,b,f,h){var a=getDefaultPq();var c=[{title:"Вид документа",minWidth:100,width:150,dataType:"string",dataIndx:"type",sortable:false},{title:"Тип",minWidth:100,width:150,dataType:"string",align:"center",dataIndx:"btl-document:docType-content",filter:{type:"textbox",condition:"contain",listeners:["change"]}},{title:"Файл",minWidth:40,width:40,dataType:"string",dataIndx:"existFile",sortable:false},{title:"Наименование",minWidth:150,width:350,dataType:"string",dataIndx:"name",sortable:false},{title:"Дата регистрации",minWidth:160,width:160,dataType:"date",dataIndx:"btl-document:regDate",filter:{type:"textbox",condition:"between",init:function(){$(this).css({zIndex:3,position:"relative"}).datepicker({dateFormat:"dd-mm-yy",yearRange:"-20:+20",changeYear:true,changeMonth:true})},listeners:["change"]}},{title:"Рег. Номер",minWidth:80,width:150,dataType:"string",dataIndx:"btl-document:regNumber",filter:{type:"textbox",condition:"contain",listeners:["change"]}},{title:"Инициатор",minWidth:110,width:150,dataType:"string",dataIndx:"author",sortable:false},{title:"Статус",minWidth:100,width:150,dataType:"string",dataIndx:"btl-document:state",filter:{type:"textbox",condition:"contain",listeners:["change"]}},{title:"",minWidth:1,maxWidth:1,width:1,dataType:"",dataIndx:""}];var d={location:"remote",sorting:"remote",dataType:"JSON",method:"GET",data:a.dataCache,sortIndx:"btl-document:regDate",sortDir:"down",getUrl:function(i){if($(this).pqGrid("option","isInit2")!==true){$(this).pqGrid("option","isInit2",true);$(this).pqGrid("option","currentCountId",b+"CurrentCount");$(this).pqGrid("option","totalCountId",b+"TotalCount");$(this).pqGrid("option","dataUrl","/share/proxy/alfresco/"+services[f].url);addPaginationBlock($(this))}return getUrl2($(this),a)},getData:function(i){return getData2($(this),i,a)},error:function(i,k,j){error2(i,k,j)}};var e={width:"100%",height:getGridHeight(b),selectionModel:{type:"none",subtype:"incr",cbHeader:false,cbAll:true},dataModel:d,collapsible:false,editable:false,showTitle:false,colModel:c,filterModel:{on:true,mode:"AND",header:true},gridId:b,containerGridId:g,toolbar:{cls:"pq-toolbar-crud",items:[]},beforeSort:function(i,j){beforeSort2($(this))},beforeFilter:function(i,j){beforeFilter2($(this))},beforeTableView:function(i,j){beforeTableView2(j,a,$(this))},rowDblClick:function(k,l){var j=false;var m=null;var i="";if(l.rowData&&l.rowData.type==="Договор"){i="/share/page/arm/contract?nodeRef="+l.rowData.nodeRef}else{i="/share/page/btl-edit-metadata?nodeRef="+l.rowData.nodeRef;if(h){j=true;m=h}}if(j){createAndShowForm(l.rowData.nodeRef,{formId:m})}else{window.location.href=i}require(["dojo/topic"],function(n){n.publish("ALF_DISPLAY_NOTIFICATION",{message:"Перенаправление на документ."})})}};e.updateButtonId=geUpdateButtonId(b);e.toolbar.items.push({type:'<button id="'+e.updateButtonId+'" type="button" title="Обновить " class="ui-button ui-widget ui-state-default ui-corner-all ui-button-text-icon-primary" role="button"><span class="ui-button-icon-primary ui-icon ui-icon-refresh"></span><span class="ui-button-text">Обновить</span></button>'});if(services[f].deletable){e.colModel.unshift({title:'<input type="checkbox" onclick="selectAllChange(this, \''+b+"')\">",dataIndx:"sel",minWidth:30,width:30,align:"center",type:"checkBoxSelection",cls:"ui-state-default",resizable:false,sortable:false});e.deleteButtonId=geDeleteButtonId(b);e.toolbar.items.push({type:'<button id="'+e.deleteButtonId+'" type="button" onclick="deleteSelected(\''+b+'\')" title="Удалить выбранные" class="ui-button ui-widget ui-state-default ui-corner-all ui-button-text-icon-primary" role="button">    <span class="ui-button-icon-primary ui-icon ui-icon-cancel"></span>    <span class="ui-button-text">Удалить выбранные</span></button>'})}$("#"+b).pqGrid(e);$("#"+g).addClass("initialized");if(e.updateButtonId!=null){$("#"+e.updateButtonId).click(function(){refreshRemoteGridDataAndView(b)})}}function initLocalMailsGrid(f,a,e){var b=[{title:'<input type="checkbox" onclick="selectAllChange(this, \''+a+"')\">",dataIndx:"sel",minWidth:30,width:30,align:"center",type:"checkBoxSelection",cls:"ui-state-default",resizable:false,sortable:false},{title:"Файл",minWidth:40,width:40,dataType:"string",dataIndx:"fileExists",sortable:false,resizable:false},{title:"Тема",minWidth:120,width:400,dataType:"string",dataIndx:"theme",filter:{type:"textbox",condition:"contain",listeners:["change"]}},{title:"Отправитель",minWidth:150,width:200,dataType:"string",dataIndx:"author-content",filter:{type:"textbox",condition:"contain",listeners:["change"]}},{title:"Получатель",minWidth:150,width:200,dataType:"string",dataIndx:"recipients-content",filter:{type:"textbox",condition:"contain",listeners:["change"]}},{title:"Дата отправки",minWidth:160,width:160,dataType:"date",dataIndx:"regDate",filter:{type:"textbox",condition:"between",init:function(){$(this).css({zIndex:3,position:"relative"}).datepicker({dateFormat:"dd-mm-yy",yearRange:"-20:+20",changeYear:true,changeMonth:true})},listeners:["change"]}},{title:"Время отправки",minWidth:160,width:160,dataType:"string",dataIndx:"regTime"},{title:"",minWidth:1,maxWidth:1,width:1,dataType:"",dataIndx:""}];var c={location:"local",sorting:"local",dataType:"JSON",method:"GET",url:"/share/proxy/alfresco/"+services[e].url,sortIndx:"regDate",sortDir:"down",getUrl:function(g){showMenuItemCounterLoader(e);return{url:$(this).pqGrid("option","dataModel.url")}},getData:function(g){if(g.items.length===0){clearGrouping($(this))}if(g.func==="mail_input"){setMenuItemCounterValue(e,g.noReadCount)}else{setMenuItemCounterValue(e,g.cnt_whole)}g.items.forEach(function(h){if(g.func&&g.func=="mail_input"){if(h.readRefs.indexOf(Alfresco.constants.USERNAME)<0){h.pq_rowcls="rowcls_bold"}}});return{data:g.items}},error:function(g,i,h){console.error(i,h)}};var d={width:"100%",height:getGridHeight(a),colModel:b,dataModel:c,gridId:a,containerGridId:f,menuItemId:e,pageModel:{type:"local",rPP:50,strRpp:"{0}",rPPOptions:[50,250,500]},filterModel:{on:true,mode:"AND",header:true},selectionModel:{type:"none",cbHeader:false,cbAll:true},showTitle:false,toolbar:{cls:"pq-toolbar-crud",items:[]},editable:false,collapsible:false,showBottom:true,rowDblClick:function(g,h){h.rowData.rowIndx=h.rowIndx;openModalTaskAndDocument(h.rowData.nodeRef,"","/share/page/arm/mailMessage?nodeRef="+h.rowData.nodeRef,h.rowData)},beforeFilter:function(g,h){clearGrouping($(this))},beforeTableView:function(g,h){if($(this).pqGrid("option","dataModel.location")!=="local"){$(this).pqGrid("option","dataModel.location","local")}}};d.updateButtonId=geUpdateButtonId(a);d.toolbar.items.push({type:'<button id="'+d.updateButtonId+'" type="button" title="Обновить " class="ui-button ui-widget ui-state-default ui-corner-all ui-button-text-icon-primary" role="button">     <span class="ui-button-icon-primary ui-icon ui-icon-refresh"></span>     <span class="ui-button-text">Обновить</span></button>'},{type:'<span class="pq-separator"></span>'},{type:"<button  onclick=\"deleteSelectedMails('"+a+'\')" type="button"  title="Удалить выбранные" class="ui-button ui-widget ui-state-default ui-corner-all ui-button-text-icon-primary" role="button">      <span class="ui-button-icon-primary ui-icon ui-icon-cancel"></span>      <span class="ui-button-text">Удалить выбранные</span> </button>'},{type:"<button  onclick=\"replyMails('"+a+'\')" type="button"  title="Ответить" class="ui-button ui-widget ui-state-default ui-corner-all ui-button-text-icon-primary" role="button">      <span class="ui-button-icon-primary ui-icon ui-icon-arrowreturn-1-w"></span>      <span class="ui-button-text">Ответить</span> </button>'});$("#"+a).pqGrid(d);$("#"+f).addClass("initialized");if(d.updateButtonId!=null){$("#"+d.updateButtonId).click(function(){refreshLocalGridDataAndView(a)})}}(function(){require(["jquery","pqgrid","combobox","pqselect","jquery-ui.datepicker-ru","jquery.datepicker.extension.range","dojo/domReady!"],function(a){Object.keys(services).forEach(function(b){a("#"+b).click(function(){var c=a(".item-menu.active");if(c.length>0){a("#"+getGridContainerId(c[0].id)).hide();c.removeClass("active")}a(this).addClass("active");sessionStorage.setItem("menuTasksAndDocsItem",this.id);var e=getGridContainerId(this.id);var f=a("#"+e);f.show();var d=getGridId(this.id);switch(services[this.id].gridType){case"task-local":if(!f.hasClass("initialized")){initLocalTasksGrid(e,d,this.id)}refreshLocalGridDataAndView(d);break;case"task-remote":if(!f.hasClass("initialized")){initRemoteTasksGrid(e,d,this.id)}else{refreshRemoteGridDataAndView(d)}break;case"review-local":if(!f.hasClass("initialized")){initLocalReviewGrid(e,d,this.id)}refreshLocalGridDataAndView(d);break;case"docs-remote":if(!f.hasClass("initialized")){initRemoteDocsGrid(e,d,this.id,services[this.id].formId)}else{refreshRemoteGridDataAndView(d)}break;case"mails-local":if(!f.hasClass("initialized")){initLocalMailsGrid(e,d,this.id)}refreshLocalGridDataAndView(d);break;default:console.error("TODO!#")}document.openRow={}})})})})();function getUrlByType(c,b){var a="";switch(c){case"Согласование":a="/share/page/btl-negotiation-task?taskId="+b;break;case"Подписание":a="/share/page/btl-signing-task?taskId="+b;break;case"Доработка":a="/share/page/btl-revision-task?taskId="+b;break;case"Ознакомление":a="/share/page/btl-familiarized-task?taskId="+b;break;default:a="/share/page/task-edit?taskId="+b}return a}function taskAndDocumentOpenModalRowData(c,a){var b="";if(document.openRow&&document.openRow.viewMode&&document.openRow.viewMode=="old"){b="/share/page/btl-edit-metadata?nodeRef="+c.nodeRef}else{b="/share/page/btl-execution?nodeRef="+c.nodeRef}if(c.nodeRef.indexOf("activiti")>-1){b=getUrlByType(c.type,c.nodeRef)}openModalTaskAndDocument(c.nodeRef,c.status,b,c,a)}function openModalTaskAndDocument(d,a,c,e,b){if(typeof simpleDialogFormStarting=="undefined"){simpleDialogFormStarting=false}if(!simpleDialogFormStarting){document.openRow={};document.openRow.nodeRef=d;document.openRow.status=a;document.openRow.gridIndex=e.rowIndx;document.frameSave=function(f){document.getElementById("modalWindowShadowTD").style.display="none";document.body.style.overflow="";if(document.modalSimpleDialogForm){document.modalSimpleDialogForm.hide()}_refreshGrid()};document.frameCancel=function(f){document.getElementById("modalWindowShadowTD").style.display="none";document.body.style.overflow="";if(document.modalSimpleDialogForm){document.modalSimpleDialogForm.hide()}_refreshGrid()};createAndOpenForm(e,c,true,b)}}function openForm(d){var b="/share/page/btl-execution?nodeRef="+d.nodeRef;if(d.nodeRef.indexOf("activiti")>-1){var a=false;switch(d.type){case"Согласование":b="/share/page/btl-negotiation-task?taskId="+d.nodeRef;break;case"Подписание":b="/share/page/btl-signing-task?taskId="+d.nodeRef;break;case"Доработка":b="/share/page/btl-revision-task?taskId="+d.nodeRef;break;case"Ознакомление":b="/share/page/btl-familiarized-task?taskId="+d.nodeRef;a=true;break;default:b="/share/page/task-edit?taskId="+d.nodeRef}}var c=b.includes("btl-execution");if(a||c){var e=null;if(c){e="taskExecutionForm"}else{switch(d.type){case"Ознакомление":e="familiarizedForm";break}}createAndShowForm(d.nodeRef,{formId:e})}else{window.location.href=b}}function tasksAndDocumentsDashletSetSetting(){windowSettingTasksAndDocs.show()}function hasRow(c,b){var e=false;var a=c;do{var d=getActiveGrid().pqGrid("getRowData",{rowIndxPage:a});if(d){if(d.nodeRef){e=d.nodeRef.includes("activiti");if(!e){return{result:true,index:a}}}else{return false}}else{return false}a=b?a+1:a-1}while(e);return false}document.hasNext=function(){if(document.openRow){if(document.openRow.nodeRef.includes("activiti")){return false}else{return hasRow(document.openRow.gridIndex+1,true)}}else{console.log("document.openRow is null")}return false};document.openNextTask=function(){if(document.openRow){console.log("log","!row:["+(document.openRow.gridIndex)+"], nodeRef:["+document.openRow.nodeRef+"]");const a=document.hasNext();if(a){var b=getActiveGrid().pqGrid("getRowData",{rowIndxPage:a.index});b.rowIndx=a.index;taskAndDocumentOpenModalRowData(b,{isCompleteMe:isCompleteMe()})}}else{console.log("document.openRow is null")}};